"object"!=typeof globalThis&&(globalThis=window),(this.webpackJsonp=this.webpackJsonp||[]).push([[18],{"+eUS":function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var i=s("jDHv"),n=s("+ExH"),r=s("YEoC"),a=s("oRsZ"),o=s("IpiK"),d=s("d04y"),l=s("pRxM"),c=s("b3Jv"),h=s("4IGy"),u=s("xS/Y"),g=s("rdC+"),m=s("pP8i"),p=s("75G/");const f=(e,t)=>{if(t===r.a.IDB)switch(e){case"Core":return a.a.useIdb;case"MsgInfo":return o.a.useIdb;case"Qos":return d.a.useIdb;case"Reaction":return l.a.useIdb;case"Search":return c.a.useIdb;case"Storage":return h.a.useIdb;case"Res":return u.a.useIdb;case"SecureLocalstorage":return g.a.useIdb;case"ZLog":return m.a.useIdb;case"Media":return p.a.useIdb;default:return}if(t===r.a.SQLite)switch(e){case"Core":return a.a.useSqlite;case"MsgInfo":return o.a.useSqlite;case"Qos":return d.a.useSqlite;case"Reaction":return l.a.useSqlite;case"Search":return c.a.useSqlite;case"Storage":return h.a.useSqlite;case"Res":return u.a.useSqlite;case"SecureLocalstorage":return g.a.useSqlite;case"ZLog":return m.a.useSqlite;case"Media":return p.a.useSqlite;default:return}};var v=s("kFM4"),b=s("teaq"),y=s("PhBv"),I=s("1UUk");function _(e){Object(v.a)("RunMode",e),e!==r.e.Unknown&&(i.ModuleContainer.resolve(I.b).install(),e!==r.e.Background&&(setTimeout((()=>{const e=i.ModuleContainer.resolve(y.b);e.install(n.a),e.start()}),1),i.ModuleContainer.resolve(b.b).install(f)))}},"0rWR":function(e,t,s){"use strict";var i,n=s("jDHv"),r=s("Mgpg"),a=s("YEoC"),o=s("PmZf"),d=s("x9oK"),l=s("UJ0r");let c=n.ModuleContainer.injectable()(i=function(e,t){return n.ModuleContainer.inject(r.ZLoggerFactory)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===r.ZLoggerFactory?Object:r.ZLoggerFactory])(i=class extends l.a{constructor(e){super(),this.logger=void 0,this.dbSchema=null,this.logger=e.createZLogger("db",["adapter-manager"])}async getDatabaseAdapter(e,t){const s={database:e,version:t.version,type:t.type};this.logger.zsymb(0,10285,3e4,(()=>["creating",s]));const i=this.getAdapterFactoryToken(t.type),r=n.ModuleContainer.resolve(i),a=await r.createAdapter(e,t);return this.logger.zsymb(0,10285,30001,(()=>["create success",s])),a.addEventListener(o.a.UnexpectedError,(e=>{this.dispatchEvent(new o.d(e.error))})),a}canUse(e){return e!==a.a.SQLite||this.canIUseSQLite()}canIUseSQLite(){return!1}getAdapterFactoryToken(e){return e===a.a.IDB?d.b:d.c}getExistedPartitionKeys(e,t){const s=this.getAdapterFactoryToken(t);return n.ModuleContainer.resolve(s).getExistedPartitionKeys(e)}})||i)||i)||i)||i;n.ModuleContainer.registerSingleton(l.b,c)},27:function(e,t){},"5yGw":function(e,t,s){"use strict";var i,n=s("jDHv"),r=s("Mgpg"),a=s("DI/x"),o=s("PmZf"),d=s("1UUk"),l=s("d/or"),c=s("teaq");let h=n.ModuleContainer.injectable()(i=function(e,t){return n.ModuleContainer.inject(l.a)(e,void 0,0)}(i=function(e,t){return n.ModuleContainer.inject(r.ZLoggerFactory)(e,void 0,1)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===l.a?Object:l.a,void 0===r.ZLoggerFactory?Object:r.ZLoggerFactory])(i=class{constructor(e,t){this.settingsManager=e,this.configFactory=void 0,this.configCache=void 0,this.logger=void 0,this.logger=t.createZLogger("db",["config"]),this.configCache=new Map}install(e){this.configFactory=e;n.ModuleContainer.resolve(d.b).addEventListener(o.a.SessionChange,(()=>{this.clearCache()}))}getDatabaseConfigs(e){const t=this.configCache.get(e);return t||this.createConfigCache(e)}clearCache(){const e=this.configCache.values();let t=e.next();for(;!t.done;){t.value.forEach((e=>e.clearCache())),t=e.next()}this.configCache.clear()}createConfigCache(e){const t=[],s=this.getCurrentConfig(e);if(s){t.push(s);const i=this.getConfigForMigrate(e,s.type);i&&t.push(i)}return this.configCache.set(e,t),t}getConfigForMigrate(e,t){const s=this.settingsManager;let i,n=s.getPreferredAdapter(e);if(n!==t){if(n&&(i=this.configFactory(e,n)),!n||!i){const t=s.preferAdapters;for(let s=0;s<t.length&&(n=t[s],i=this.configFactory(e,n),!i);s++);}return i&&t!==n?i:void 0}}getCurrentConfig(e){const t=this.settingsManager.getCurrentAdapterType(e);if("number"!=typeof t)throw new a.g(`${t} is not a valid AdapterType value!`);return this.configFactory(e,t)}})||i)||i)||i)||i)||i;n.ModuleContainer.registerSingleton(c.b,h)},BtX6:function(e,t,s){s("E2g8").polyfill()},HPcM:function(e,t,s){"use strict";s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return r}));var i=s("jDHv");const n=Object(i.define)("zlog-sentry-bucket"),r=Object(i.define)("zlog-regular-bucket")},K8kB:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s("jDHv");const n=Object(i.define)("zlog-write-scheduler")},KdAX:function(e,t,s){"use strict";var i=s("jDHv"),n=s("W8fB"),r=s("UJDs"),a=s("7FSS"),o=(s("j6JD"),s("VTBJ"));const d=s("4JQ2"),l={intro:e=>l.eol(e),info:e=>e,debug:e=>e,warning:e=>e,error:e=>e,placeholder:e=>e,tick:e=>e,header:e=>d.green(e),sourcemap:e=>d.gray(e),level:e=>e,bold:e=>d.bold(e),eol:e=>e+"\n\n"},c=(Object(o.a)(Object(o.a)({},l),{},{intro:e=>l.eol(d.bgWhite.black(e)),info:e=>d.white(e),debug:e=>d.blue(e),warning:e=>d.yellow(e),error:e=>d.red(e),tick:e=>d.black.bgWhite.bold(` ${e} `),header:e=>e}),l);s("CDcE");const h={display:!0,style:"font-size: 11px; color: gray"},u={display:!1,style:"font-size: 11px; color: gray; margin-bottom: 8px"};function g(e){let{lineMeta:t,template:s,args:i}=e;if("number"==typeof s)return"Error: expected template as string. Got number?! ["+t.id1+":"+t.id2+"]";const n=[t.module,t.features.join("/")].map((e=>e||"?")).join("|");let r=i.map((e=>function(e){let t=e;if("function"==typeof e)try{t=e()}catch(s){a.a.error("ZLogSanitizer: failed to exec func. Please make sure your func executable"+s),t=e.toString()}return t}(e)));1===r.length&&1===i.length&&"function"==typeof i[0]&&Array.isArray(r[0])&&(r=r[0]);const o=function(e,t){if(null===e)return"";const s="{}";let i=0;for(;-1!==e.search(s)&&i<t.length;)switch(typeof t[i++]){case"number":e=e.replace(s,"%d");break;case"string":default:e=e.replace(s,"%s");break;case"object":e=e.replace(s,"%o")}return e}(s,r).trim(),d=(t.id1.toString().substring(t.id1.toString().indexOf("src")),t.id2,""),l=[];return h.display&&n.trim()&&l.push(c.sourcemap(n.trim())+"\n"),u.display&&d.trim()&&l.push(c.sourcemap(d)+"\n"),o.trim()&&l.push(o.trim()),r.length>0?(r.unshift(l.join(" ")),r):[l.join(" ")]}var m;let p=Object(i.injectable)()(m=class{write(e){const t=g(e);switch(e.lineMeta.level){case r.b.info:a.a.log.apply(null,t);break;case r.b.warn:a.a.warn.apply(null,t);break;case r.b.debug:a.a.debug.apply(null,t);break;case r.b.error:a.a.error.apply(null,t);break;default:a.a.log.apply(null,t)}}})||m;i.ModuleContainer.registerSingleton(n.a,p)},KhD4:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s("jDHv");const n=Object(i.define)("dal-db-path")},Lp8g:function(e,t){globalThis.hasOwnProperty("$recoilDebugStates")&&(globalThis.$recoilDebugStates.push=function(){this.length>=100&&Array.prototype.splice.apply(this,[0,Math.round(this.length/2)]);for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];Array.prototype.push.apply(this,t)})},Lq8m:function(e,t,s){"use strict";var i,n=s("jDHv"),r=s("Uzj0"),a=s("Mgpg"),o=s("zpw2"),d=s("SGbk"),l=s("pjo1");let c=n.ModuleContainer.injectable()(i=function(e,t){return n.ModuleContainer.inject(a.ZLoggerFactory)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===a.ZLoggerFactory?Object:a.ZLoggerFactory])(i=class{constructor(e){this.loggerFactory=e,this.logger=void 0,this.logger=this.loggerFactory.createZLogger("db",["client"])}createQueryBuilder(e){const t=r.c.map(e,((e,t)=>this.createBuilder(e,t))),s=Object.keys(e);return t.deleteAllDatabases=Object(d.a)((async()=>{const e=s.map((e=>t[e].deleteThisDatabase()));await Promise.all(e)})),t.closeAllDatabases=Object(d.a)((async()=>{const e=s.map((e=>t[e].closeThisDatabase()));await Promise.all(e)})),t}createBuilder(e,t,s){return new o.a(e,t,s)}})||i)||i)||i)||i;n.ModuleContainer.registerSingleton(l.a,c)},SGbk:function(e,t,s){"use strict";function i(e){let t={};return async function(){for(var s=arguments.length,i=new Array(s),n=0;n<s;n++)i[n]=arguments[n];const r=i.length?i.join("-"):"";if(!t[r])return t[r]=!0,e(...i)}}s.d(t,"a",(function(){return i}))},UJDs:function(e,t,s){"use strict";let i;s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return n})),function(e){e[e.info=0]="info",e[e.error=1]="error",e[e.warn=2]="warn",e[e.debug=3]="debug",e[e.critical=4]="critical"}(i||(i={}));const n={[i.info]:"info",[i.error]:"error",[i.warn]:"warn",[i.debug]:"debug",[i.critical]:"critical"}},W8fB:function(e,t,s){"use strict";s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return r})),s.d(t,"c",(function(){return a}));var i=s("jDHv");const n=Object(i.define)("sen-log-writer"),r=Object(i.define)("console-log-writer"),a=Object(i.define)("zlog-writer")},XuBa:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));const i=s("NFKh");class n{static encrypt(e){return i.AES.encrypt(e,"5dbe084b7eedNWjRref04e2rDxs01lwH",{iv:"7eb5dbe084b7eedeef04e2622d46ba00",mode:i.mode.ECB,padding:i.pad.Pkcs7})+""}static decrypt(e){return i.AES.decrypt(e,"5dbe084b7eedNWjRref04e2rDxs01lwH",{keySize:16,iv:"7eb5dbe084b7eedeef04e2622d46ba00",mode:i.mode.ECB,padding:i.pad.Pkcs7}).toString(i.enc.Utf8)}}},Y41u:function(e,t,s){"use strict";let i;s.d(t,"c",(function(){return i})),s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return r})),function(e){e.RegLogBucketStatus="RegLogBucketStatus",e.SentryLogBucketStatus="SentryLogBucketStatus",e.WriteSchedulerRequestFlush="WriteSchedulerRequestFlush",e.WriterStatus="WriterStatus",e.LogBucketRequestFlush="LogBucketRequestFlush"}(i||(i={}));class n{constructor(e,t){this.type=e,this.payload=t}}class r{constructor(e){this.type=e}}},YpjI:function(e,t){globalThis.$zcommon={},globalThis.$znode={},globalThis.$zglobalThis={},globalThis.$zresource={onClipboardChange:()=>{},onCheckIdleUpdaterBusy:()=>{},getChildUrl:()=>Promise.resolve()},globalThis.$zlogger={},globalThis.$zupdater={},globalThis.$zapp={onRequestShowPreference:()=>{},onRequestShowAbout:()=>{},beforeAppClose:()=>{}},globalThis.$zdownload={},globalThis.$zdb={},globalThis.$zmulti={},globalThis.$zcall={sendDataToNative:()=>{}},globalThis.$zsharedWorker={},globalThis.$zelectron={},globalThis.$zelectronNative={},globalThis.$zuri={onNewRequest:()=>{},onRequestOpenConv:()=>{},removeListenNewRequest:()=>{},removeListenRequestOpenConv:()=>{},onRequestOpenZavi:()=>{}},globalThis.$zscreencap={onEventOs:()=>{}},globalThis.$zlogin={},globalThis.$zperf={},globalThis.$zconfig={},globalThis.$zFileManager={trustBlob:()=>{}},globalThis.$zFeatures={},globalThis.$zwindow={closeWindow:()=>{},expandMainWindow:()=>{},focus:()=>{},onHideWindowComplete:()=>{},removeListenHideWindowComplete:()=>{},removeListenVisibilityChange:()=>{},onVisibilityChange:()=>{}},globalThis.$zsub={$zapp:globalThis.$zapp,$zscreencap:globalThis.$zscreencap,$zuri:globalThis.$zuri,$zresource:globalThis.$zresource,$zlogger:globalThis.$zlogger,$zwindow:globalThis.$zwindow,$zFileManager:globalThis.$zFileManager,$zcall:globalThis.$zcall}},cF85:function(e,t,s){"use strict";var i=s("jDHv"),n=s("x9oK"),r=s("YEoC"),a=s("PmZf"),o=s("LzQZ"),d=s("rvru"),l=s("AH6j");let c;!function(e){e.AbnormallyClose="abnormally-closed"}(c||(c={}));class h extends l.a{constructor(){super(c.AbnormallyClose)}}var u=s("xpEm"),g=s("DI/x");function m(e){return new Promise(((t,s)=>{e.onerror=()=>s(e.error),e.onsuccess=()=>t(e.result)}))}function p(e,t,s){return`Invalid filter value for this method: '${e}' - Expected type: '${t}' - Actual type: '${s}'`}function f(e,t){const s=Object(u.m)(t,{operations:{AND:u.a,OR:u.k,NOT:u.j,gt:u.c,gte:u.d,lt:u.f,lte:u.g,in:u.e,notIn:u.i,eq:u.b,notEq:u.h,contains(e,t,s){if("string"!=typeof e){const t=p("contains","string",typeof e);throw new g.l(t)}return Object(u.l)((t=>"string"==typeof t&&t.includes(e)),t,s)},startsWith(e,t,s){if("string"!=typeof e){const t=p("startsWith","string",typeof e);throw new g.l(t)}return Object(u.l)((t=>"string"==typeof t&&t.startsWith(e)),t,s)},endsWith(e,t,s){if("string"!=typeof e){const t=p("endsWith","string",typeof e);throw new g.l(t)}return Object(u.l)((t=>"string"==typeof t&&t.endsWith(e)),t,s)}}});return s(e)}class v extends l.b{constructor(e){super(),this.connectionFactory=e,this.connection=null,this.isManuallyClose=!1,this.onAbnormallyCloseListeners=[]}get hasActiveConnection(){return null!==this.connection}async getName(){return(await this.getConnection()).name}async getObjectStoreNames(){return(await this.getConnection()).objectStoreNames}async getVersion(){return(await this.getConnection()).version}async getConnection(e){void 0===e&&(e=!1);const t=async()=>{let e=null;try{e=await this.connectionFactory()}catch(t){let e=t;throw"VersionError"===t.name&&(e=new g.k(t.message)),this.dispatchEvent(new a.d(e)),t}return e.onclose=()=>{this.dispatchEvent(new h)},e};if(this.connection){if(e){if(this.isManuallyClose)throw new g.d("The database connection has manually been closed!",["idb"]);const e=this.connection;this.onAbnormallyCloseListeners.forEach((t=>{e.removeEventListener("close",t)})),this.connection=await t()}}else this.connection=await t();return this.connection}async getTransaction(e,t){let s=await this.getConnection(),i=null;try{i=s.transaction(e,t)}catch(n){if(!n||"InvalidStateError"!==n.name&&11!==n.code)throw n;s=await this.getConnection(!0),i=s.transaction(e,t)}return i}close(){this.connection&&!this.isManuallyClose&&(this.connection.close(),this.connection=null,this.isManuallyClose=!0)}}var b=s("bSii"),y=s("3wcW");class I extends y.a{constructor(e,t,s){super(e,t,!1),this._transaction=s,this.allowMissingTable=!1}async delete(){}async close(){this.instance&&this.instance.close()}async _getTables(){return Array.from(this.instance.objectStoreNames)}async _createTable(e){const t=this.instance;let s={};if(e.isNonFieldlikeEntity)s={autoIncrement:!0};else{const t=e.primaryIndex;s={keyPath:Object(b.a)(t.getRealFields()),autoIncrement:t.autoIncrement}}if(t.objectStoreNames.contains(e.tableName))return;const i=t.createObjectStore(e.tableName,s);Object.values(e.indices).map((e=>{if("primary"===e.name)return;const t=e.fields.map((e=>"object"!=typeof e?e:"length"===e.type?`${e.field.toString()}.length`:e.field));i.createIndex(e.name,Object(b.a)(t),{unique:e.unique})}))}async _createIndex(e,t){const s=this._transaction;if(!s)throw new g.u(`Can't create '${t}' due to unavailable IDBTransaction transaction!`);const i=s.objectStore(e.tableName),n=e.getIndex(t),r=n.fields.map((e=>"object"!=typeof e?e:"length"===e.type?`${e.field.toString()}.length`:e.field));var a;i.createIndex(t,1===(a=r).length?a[0]:a,{unique:n.unique})}_addColumns(e,t){return Promise.resolve()}}var _=s("VTBJ"),M=s("X2RP");class C extends M.a{constructor(e,t){super(),this.instance=e,this.transactionManager=t}getExecutorName(){return"idb"}async clear(e){let{transaction:t,meta:s}=e;const i=s.tableConfig;return m((await this.getStore(t,i,r.f.READWRITE)).clear())}async get(e){let{transaction:t,meta:s,params:i}=e;const n=i.index,r=i.key,a=s.tableConfig,o=await this.getStoreOrIndex(t,a,n),d=this.validateKey(a,n,r),l=o.get(d);return this.getResult(a,l)}async getMulti(e){let{transaction:t,meta:s,params:i}=e;const n=i.index,r=i.keys,a=s.tableConfig,o=await this.getStoreOrIndex(t,a,n),d=r.map((e=>{const t=this.validateKey(a,n,e),s=o.get(t);return this.getResult(a,s)}));return Promise.all(d)}getAll(e){return e.params.direction===r.b.PREV||e.params.direction===r.b.PREV_UNIQUE||e.params.filter||e.params.predicate||e.params.aborted||e.params.onProgress||e.params.onValue?this.getAllByCursor(e):this.getAllWithoutFilter(e)}async getAllKeyByCursor(e){let{meta:t,params:s,transaction:i}=e;const n=t.tableConfig,r=s.range&&this.toIDBKeyRange(s.range),a=(await this.getStoreOrIndex(i,n,s.index)).openKeyCursor(r,s.direction);return null===a?[]:new Promise(((e,t)=>{const i=[];a.onsuccess=()=>{const t=a.result;if(null===t||null===t.primaryKey)return void e(i);const n=t.primaryKey;i.push(n);i.length>=s.limit?e(i):t.continue()},a.onerror=()=>{t(a.error)}}))}async getAllKey(e){if(e.params.direction===r.b.PREV||e.params.direction===r.b.PREV_UNIQUE)return this.getAllKeyByCursor(e);{const{meta:t,params:s,transaction:i}=e,n=t.tableConfig,r=s.range&&this.toIDBKeyRange(s.range);return m((await this.getStoreOrIndex(i,n,s.index)).getAllKeys(r,s.limit))}}async getAndUpdate(e){const{transaction:t,params:s,meta:i}=e,n=s.index,a=s.updater,o=s.key,d=i.tableConfig,l=await this.getStoreOrIndex(t,d,n),c=this.validateKey(d,n,o),h=l.get(c),u=await this.getResult(d,h);if(void 0===u)return;const p=await this.getStore(t,d,r.f.READWRITE),f=await a(u||{});if(!f&&!1!==s.ignoreNotFound)throw new g.f("Update undefined document");const v=this.toDB(d,f),b=p.put(v);return await m(b),f}insert(e){return e.params.replace?this._insertOrReplace(e):this._insertIfNotExist(e)}insertMulti(e){return e.params.replace?this.insertOrReplaceMulti(e):this.insertIfNotExistMulti(e)}async update(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,a=await this.getStore(t,n,r.f.READWRITE);return this._update(a,this.validateKey(n,"primary",i.key),i.attributes,this.toDB(n,i.value,!1),i.ignoreNotFound).then((t=>t?this.fromDB(e.meta.tableConfig,t):t))}async updateMulti(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,a=await this.getStore(t,n,r.f.READWRITE),o=[],d=[],l=i.patches.map((t=>this._update(a,this.validateKey(n,"primary",t.key),t.attributes,this.toDB(n,t.value,!1),i.ignoreNotFound).then((t=>t?this.fromDB(e.meta.tableConfig,t):t)).then((e=>{e?o.push(e):d.push(e)}))));return Promise.all(l).then((()=>({success:o,fail:d})))}async delete(e){let{transaction:t,meta:s,params:i}=e;const n=s.tableConfig,a=(await this.getStore(t,n,r.f.READWRITE)).delete(this.validateKey(n,"primary",i.key));return this.checkReqSuccessOrFail(a)}async deleteMulti(e){let{transaction:t,meta:s,params:i}=e;const n=s.tableConfig,a=await this.getStore(t,n,r.f.READWRITE),o={success:[],fail:[]},d=i.keys.map((e=>this.checkReqSuccessOrFail(a.delete(e)).then((t=>{t?o.success.push(e):o.fail.push(e)}))));return await Promise.all(d),o}async count(e){let{transaction:t,meta:s,params:i}=e;const n=s.tableConfig,r=this.toIDBKeyRange(i.range);return m((await this.getStoreOrIndex(t,n,i.index)).count(r))}async findAndDelete(e){let{transaction:t,meta:s,params:i}=e;const n=s.tableConfig,{filter:a}=i,o=a?e=>f(e,a):null,d=this.toIDBKeyRange(i.range),l=(await this.getStore(t,n,r.f.READWRITE)).openCursor(d);return null===l?0:new Promise(((e,t)=>{let s=0,i=!1;l.onsuccess=()=>{if(i)return;const t=l.result;if(null===t||null===t.value)return i=!0,void e(s);const r=this.fromDB(n,t.value);o&&!o(r)||(t.delete(),s+=1,!i)?t.continue():e(s)},l.onerror=()=>{t(l.error)}}))}async getAllByCursor(e){let{transaction:t,meta:s,params:i,deferrer:n}=e;const r=s.tableConfig,{onProgress:a,advance:o,stepCount:d,onValue:l,predicate:c,filter:h}=i;if(c&&h){const e=new g.l("Query using both 'filter' and 'predicate' is not allowed!");return void(null==n||n.reject(e))}let u=null;(c||h)&&(u=c||(e=>f(e,h)));const m=await this.getStoreOrIndex(t,r,i.index),p=this.toIDBKeyRange(i.range),v=m.openCursor(p,i.direction);return null===v?[]:new Promise(((e,t)=>{const s=[];let n=!1,c=!!o;v.onsuccess=()=>{if(n)return;const t=v.result;if(null===t||null===t.value)return n=!0,void e(s);if(c&&o)return c=!1,void t.advance(o);const h=this.fromDB(r,t.value);l&&l(h),u&&!u(h)||(s.push(h),a&&a(s,h),n=s.length>=i.limit,n||(n=!!i.aborted&&i.aborted(s,h)),!n)?(d&&t.advance(d),t.continue()):e(s)},v.onerror=()=>{t(v.error)}}))}async getAllWithoutFilter(e){let{transaction:t,meta:s,params:i}=e;const n=s.tableConfig,r=this.toIDBKeyRange(i.range),a=(await this.getStoreOrIndex(t,n,i.index)).getAll(r,i.limit);return this.getResult(n,a)}async getStoreOrIndex(e,t,s){const i=await this.getStore(e,t,r.f.READONLY);if("primary"===s)return i;const n=t.getIndex(s);if(!n)throw new g.o(s);return i.index(n.name)}async _insertIfNotExist(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,a=await this.getTransaction(t,n,r.f.READWRITE),o=a.objectStore(n.tableName);let d=null;if(!n.isNonFieldlikeEntity){const e=n.primaryIndex;if(!e.autoIncrement){const t=Object(b.a)(e.createKey(i.value)),s=o.get(t);d=await new Promise((e=>{s.onsuccess=()=>{const t=this.fromDB(n,s.result);e(t)},s.onerror=()=>{e(null)}}))}}if(d)return Promise.resolve(d);{const e=o.add(this.toDB(n,i.value));return t?m(e).then((()=>i.value)):new Promise(((t,s)=>{a.oncomplete=()=>{t(i.value)},a.onerror=()=>{var n;0===(null===(n=e.error)||void 0===n?void 0:n.code)?t(i.value):s(e.error)}}))}}async _insertOrReplace(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,a=await this.getTransaction(t,n,r.f.READWRITE),o=a.objectStore(n.tableName).put(this.toDB(n,i.value));return t?m(o).then((()=>i.value)):new Promise(((e,t)=>{a.oncomplete=()=>{e(i.value)},a.onerror=()=>{t(o.error)}}))}async insertIfNotExistMulti(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,a=await this.getTransaction(t,n,r.f.READWRITE),o=a.objectStore(n.tableName),d=[],l=[],c=i.values.map((async e=>{let t=!1;if(!n.isNonFieldlikeEntity){const s=n.primaryIndex;if(!s.autoIncrement){const i=Object(b.a)(s.createKey(e)),r=o.get(i);t=await new Promise((e=>{r.onsuccess=()=>{const t=this.fromDB(n,r.result);let s=!1;void 0!==t&&(d.push(t),s=!0),e(s)},r.onerror=()=>{e(!1)}}))}}if(t)return;const s=o.add(this.toDB(n,e));return this.checkReqSuccessOrFail(s).then((t=>{if(t){let t=e;if(!n.isNonFieldlikeEntity){const{primaryIndex:e}=n,i=e.fields[0].field;Object.prototype.hasOwnProperty.call(t,i)||(t[i]=s.result)}d.push(t)}else l.push(e)})).catch((()=>{l.push(e)}))}));return t?Promise.all(c).then((()=>({success:d,fail:l}))):new Promise((e=>{a.oncomplete=()=>{e({success:d,fail:l})},a.onerror=()=>{e({success:d,fail:l})}}))}async insertOrReplaceMulti(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,a=await this.getTransaction(t,n,r.f.READWRITE),o=a.objectStore(n.tableName),d=[],l=[],c=i.values.map((e=>{const t=o.put(this.toDB(n,e));return this.checkReqSuccessOrFail(t).then((()=>{let s=e;if(!n.isNonFieldlikeEntity){const{primaryIndex:e}=n,i=e.fields[0].field;Object.prototype.hasOwnProperty.call(s,i)||(s[i]=t.result)}d.push(s)})).catch((()=>{l.push(e)}))}));return t?Promise.all(c).then((()=>({success:d,fail:l}))):new Promise(((e,t)=>{a.oncomplete=()=>e({success:d,fail:l}),a.onerror=()=>e({success:d,fail:l})}))}async _update(e,t,s,i,n){const r=await m(e.get(t));if(!r){if(n)return;throw new g.f("Update undefined document!")}return await m(e.put(s.reduce(((e,t)=>(e[t]=i[t],e)),r))),r}checkReqSuccessOrFail(e){return m(e).then((()=>!0)).catch((()=>!1))}getTransaction(e,t,s){const i=t.tableName;if(e>0){const t=this.transactionManager.get(e);return Promise.resolve(t.instance)}return this.instance.getTransaction([i],s)}async getStore(e,t,s){return(await this.getTransaction(e,t,s)).objectStore(t.tableName)}toIDBKeyRange(e){if(e){if(e.from&&e.to)try{return IDBKeyRange.bound(e.from,e.to,e.excludeFrom,e.excludeTo)}catch(t){throw t}return e.from?IDBKeyRange.lowerBound(e.from,e.excludeFrom):e.to?IDBKeyRange.upperBound(e.to,e.excludeTo):void 0}}getResult(e,t){return m(t).then((t=>this.fromDB(e,t)))}toDB(e,t,s){void 0===s&&(s=!0);try{e.validate(t,s)}catch(a){this.logger.zsymb(21,10311,3e4,"{}: {} (database={}, table={})",a.name,a.message,e.dbName,e.name)}const{isNonFieldlikeEntity:i}=e,n=e.getTransformConfigs(r.a.IDB);return function(e){if(0===n.length)return e;const t=e=>{if(i)return n.reduce(((e,t)=>t.toDB(e)),e);{const t=Object(_.a)({},e);return n.forEach((e=>{e.toDB(t)})),t}};return Array.isArray(e)?e.map(t):t(e)}(t=e.prepareValue(t,s,i))}fromDB(e,t){const s=e.getTransformConfigs(r.a.IDB);if(0===s.length)return t;const i=e=>(s.forEach((t=>{t.fromDB(e)})),e);return Array.isArray(t)?t.map(i):i(t)}validateKey(e,t,s){if(!e.getIndex(t).validateKey(s))throw new g.l("The query key is invalid!");return s}}class T{constructor(e,t){this.partition=e,this.instance=t}async beginTransaction(e){try{const t=e.params.tables.map((e=>this.partition.getTableConfig(e).tableName)),s=e.params.mode,i=await this.instance.getTransaction(t,s),n=e.transaction;e.deferrer.resolve(new O(n,i))}catch(t){e.deferrer.reject(t)}}}class O{constructor(e,t){this.id=e,this.instance=t,this.error=null,this.closed=void 0,this.onCloseListeners=[],this.closed=!1;const s=e=>{this.closed=!0,this.error=e,this.onCloseListeners.forEach((t=>t(e)))};t.addEventListener("complete",(()=>s(t.error))),t.addEventListener("abort",(()=>s(t.error))),t.addEventListener("error",(()=>s(t.error)))}execute(e){return e().catch((e=>{throw this.instance.abort(),e}))}onClose(e){this.onCloseListeners.push(e),this.closed&&e(this.error)}}class E extends n.a{constructor(e,t,s,i,n,r){super(e,t,s,i,n,r,{}),this.instance.addEventListener(a.a.UnexpectedError,(e=>{this.dispatchEvent(new a.d(e.error))})),this.instance.addEventListener(c.AbnormallyClose,(()=>{this.logger.zsymb(6,11310,3e4,"The database connection has abnormally closed!")}))}async doesDatabaseExist(e){try{return(await function(e){const t=globalThis.indexedDB.open(e);return new Promise(((s,i)=>{t.onupgradeneeded=function(){var s;null===(s=t.transaction)||void 0===s||s.abort(),i(new w(`No database whose name is ${e} exists`))},t.onsuccess=function(){s(t.result)},t.onerror=function(){i(t.error)}}))}(e)).close(),!0}catch(t){if(t.name===S)return!1;throw t}}async deleteThisDatabase(){if(!(await this.doesDatabaseExist(this.fullName)))return void this.logger.zsymb(6,11310,30001,`Skip db deletion due to non-existence: '${this.fullName}'`);this.instance.close();const e=indexedDB.deleteDatabase(this.fullName),t=this.instance,s=this.fullName,i=this.logger;return i.zsymb(6,11310,30002,`The database connection is manually closed due to database deletion: '${s}'`),new Promise(((n,r)=>{e.onsuccess=function(){i.zsymb(0,11310,30003,`Delete database sucessfully: '${s}'`),n()},e.onblocked=function(){t.close()},e.onerror=function(){const t=e.error;i.zsymb(0,11310,30004,`Failed to delete database: '${s}' - Error: ${t}`),r(t)}}))}closeThisDatabase(){return this.instance.hasActiveConnection?(this.instance.close(),this.logger.zsymb(6,11310,30005,`The database connection is manually closed due to manual database closing: '${this.fullName}'`),new Promise((e=>{setTimeout((()=>{e()}),1e4)}))):Promise.resolve()}static async factory(e,t){const s=new v((async function(){const s=indexedDB.open(e,t.version);s.onupgradeneeded=async e=>{if(null!==e.newVersion)try{const i=new I(t,s.result,s.transaction);await i.upgrade(e.oldVersion,e.newVersion),await i.validate()}catch(i){throw s.transaction.abort(),i}};const n=Date.now(),r=i.ModuleContainer.resolve(d.a),a=setTimeout((()=>{r.sendLongOpenRequestQos(e)}),2e4),o=await m(s).catch((e=>{throw clearTimeout(a),e})),l=Date.now();clearTimeout(a);const c=l-n;return r.sendSuccessOpenDBDurationQos(e,n,c),o.onversionchange=function(e){if(null===e.newVersion){e.target.close()}},o})),n=i.ModuleContainer.resolve(o.a),a=new T(t,s),l=new C(s,n);return t.tables.forEach((e=>e.getTransformConfigs(r.a.IDB).forEach((e=>e.init(t.cipherKey))))),new E(t,e,n,s,l,a)}}const S="NonExistedDBError";class w extends Error{constructor(e){super(e),this.name=S}}var L;let D=i.ModuleContainer.injectable()(L=class{async createAdapter(e,t){return E.factory(e,t)}async getExistedPartitionKeys(e){return[]}})||L;i.ModuleContainer.registerSingleton(n.b,D)},d951:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(e){this.executor=e,this.resolve=()=>{},this.reject=()=>{}}execute(){this.executor().then(this.resolve).catch(this.reject)}getResult(){return new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}},ebA4:function(e,t,s){"use strict";s.d(t,"c",(function(){return l})),s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return h}));var i=s("UJDs"),n=s("j6JD"),r=s("CDcE"),a=s("fsQs"),o=s("XuBa");const d=new TextEncoder;function l(e){let t=e;if(Object(r.c)(t))return t.asset=o.a.encrypt(t.asset),t;if(Object(r.b)(t))return t.args;if("function"==typeof t)try{t=e()}catch(s){t=t.toString()}return"object"==typeof t&&(t=JSON.stringify(t,Object(r.a)())),"string"==typeof t&&(t=t.replace(/\r\n|\n|\t|\r/g,"").toString()),t}function c(e,t){let{lineMeta:s,template:o,args:c}=e;if("number"==typeof o)throw new Error("Error: expected template as string. Got number?! ["+s.id1+":"+s.id2+"]");const h=Object(n.a)(s.tick),u=[s.module,s.features.join("/")].filter((e=>e)).join("|"),g=function(e,t){let s=[],i=-1;if(t.forEach(((e,t)=>{(Object(r.b)(e)||Object(r.c)(e))&&(i=t),s.push(l(e))})),1===s.length&&1===t.length&&"function"==typeof t[0]&&Array.isArray(s[0])&&(s=[...s[0]]),!e)return s.join(" ");const n="{}";let a=e;const o=[];for(s.forEach((e=>{-1!==a.search(n)?a=a.replace(n,e):o.push(e)}));-1!==a.search(n);)a=a.replace(n,"");return a.concat(" ").concat(o.join(" "))}(o,c),m="["+[s.id1,s.id2].join(":")+"]",p=i.a[s.level].toUpperCase(),f=[`${h}__${t?`${t.ss}.${t.ss_ln}`:"?.?"}`,p,u,g,m].join("\t"),v=d.encode(f.concat("\n"));return v.byteLength>a.k.file_lim?v.slice(0,a.k.file_lim):v}function h(e){const t=new ArrayBuffer(8),s=new DataView(t),i=4294967295,n=~~(e/i),r=e%i-n;return s.setUint32(0,n),s.setUint32(4,r),t}},ez9R:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s("jDHv");const n=Object(i.define)("zlog-bin-encoder")},ezdo:function(e,t,s){"use strict";var i,n=s("jDHv"),r=s("HPcM"),a=s("Y58e"),o=s("AH6j"),d=s("fsQs"),l=s("Y41u"),c=s("UJDs"),h=s("jGDt"),u=s("7FSS");const g=null===globalThis||void 0===globalThis?void 0:globalThis.performance;let m=Object(n.injectable)()(i=function(e,t){return Object(n.inject)(h.a)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===h.a?Object:h.a])(i=class extends o.b{constructor(e){super(),this._session=e,this._data=[],this._lastPing=0,this._isSessionLineReady=!1,this.add=e=>{this._data.push(e),g.now()-this._lastPing>=d.l&&(this._lastPing=g.now(),this._broadcastEvent(l.c.LogBucketRequestFlush)),this._data.length>5e4&&u.a.error(`[ZLL]: bucket size high: ${this._data.length}`)},this.getElectronApi=()=>{let e=null;try{e=$zelectron}catch(t){}return e},this._broadcastEvent=(e,t)=>{switch(e){case l.c.LogBucketRequestFlush:case l.c.RegLogBucketStatus:this.dispatchEvent(new l.b(e,t))}},this.recordSession()}get(e){return void 0===e&&(e=d.i),this._isSessionLineReady||u.a.error("[ZLL]: session line not ready. get() returns 0 untils it is ready"),this._isSessionLineReady?this._data.slice(0,e):[]}removeFirst(e){void 0===e&&(e=1),this._data.splice(0,e)}getAll(){return this._isSessionLineReady?this._data:[]}size(){return this._data.length}async recordSession(){const e=this._session.getSession();const t=`zlgvers:${e.zlgv} ps:${e.process} build:${e.env}-${e.buildType} pversion:${e.pversion} avers: bhash:${e.build}`,s={lineMeta:{type:"info",module:"Session".toUpperCase(),features:[""],level:c.b.info,id1:0,id2:0,tick:this._session.getProcessStartTime()},template:"",args:[t]};this._data.unshift(s),this._isSessionLineReady=!0}})||i)||i)||i)||i;var p;n.ModuleContainer.registerSingleton(r.a,m);let f=Object(n.injectable)()(p=class extends o.b{constructor(){super(...arguments),this._data=[]}removeFirst(e){void 0===e&&(e=1),this._data.splice(0,e)}add(e){this._data.push(e),this._broadcastEvent(l.c.LogBucketRequestFlush)}get(e){const t=this._data.slice(0,e);return this._data=this._data.slice(e),t}getAll(){return this._data}size(){return this._data.length}_broadcastEvent(e,t){switch(e){case l.c.LogBucketRequestFlush:case l.c.SentryLogBucketStatus:this.dispatchEvent(new l.b(e,t))}}})||p;n.ModuleContainer.registerSingleton(r.b,f);const v=Object(n.define)("zlogger-validator");var b,y=s("PLj1");let I=Object(n.injectable)()(b=function(e,t){return Object(n.inject)(a.a)(e,void 0,0)}(b=Reflect.metadata("design:type",Function)(b=Reflect.metadata("design:paramtypes",[void 0===a.a?Object:a.a])(b=class{constructor(e){this.config=e,this.DevOrStagingLevelConfig={[c.b.info]:!0,[c.b.error]:!0,[c.b.warn]:!0,[c.b.debug]:!0,[c.b.critical]:!0},this.ProdLevelConfig={[c.b.info]:!0,[c.b.error]:!0,[c.b.warn]:!0,[c.b.debug]:!1,[c.b.critical]:!0},this.DevOrStagingTransConfig={[c.b.info]:{toFile:!0,toConsole:!0},[c.b.error]:{toFile:!0,toConsole:!0},[c.b.warn]:{toFile:!0,toConsole:!0},[c.b.debug]:{toFile:!0,toConsole:!0},[c.b.critical]:{toFile:!0,toConsole:!0}},this.ProdTransConfig={[c.b.info]:{toFile:!0,toConsole:!0},[c.b.error]:{toFile:!0,toConsole:!0},[c.b.warn]:{toFile:!1,toConsole:!1},[c.b.debug]:{toFile:!1,toConsole:!1},[c.b.critical]:{toFile:!0,toConsole:!0}},this._ProcessBlacklist=[],d.n&&u.a.log("zlogger validator init")}validateLog(e,t,s,i){if(this._isBlackedlisted(e))return!1;switch(e){case y.b.Main:return this._validateNoConfig(t,s,i);case y.b.Web:case y.b.Login:case y.b.Photo:case y.b.SharedWorker:case y.b.Render:return this._validateUsingConfig(t,s,i);default:return this._validateNoConfig(t,s,i)}}_validateUsingConfig(e,t,s){const i=!!this.config&&this.config.get("stagingAccount"),n=!!this.config&&this.config.get("adminMode");return(!0!==(null==s?void 0:s.stagingOnly)||!1!==i||!1!=!n)&&(n||i?this.DevOrStagingLevelConfig[e]&&this.DevOrStagingTransConfig[e][t]:this.ProdLevelConfig[e]&&this.ProdTransConfig[e][t])}_validateNoConfig(e,t,s){return this.ProdLevelConfig[e]&&this.ProdTransConfig[e][t]}_isBlackedlisted(e){var t;return!!(e===y.b.Embed||this.config&&!0===(null===(t=this.config)||void 0===t?void 0:t.get("adminConfig.offLog"))||this._ProcessBlacklist.includes(e))}})||b)||b)||b)||b;n.ModuleContainer.register(v,I);const _=Object(n.define)("zsentry-log-trans"),M=Object(n.define)("zfile-log-trans"),C=Object(n.define)("zconsole-log-trans");var T,O,E,S=s("KRcn"),w=s("W8fB");let L=Object(n.injectable)()(T=function(e,t){return Object(n.inject)(r.b)(e,void 0,0)}(T=Reflect.metadata("design:type",Function)(T=Reflect.metadata("design:paramtypes",[void 0===r.b?Object:r.b])(T=class{constructor(e){this.sentryBucket=e}transport(e){throw new Error("Method not implemented.")}})||T)||T)||T)||T,D=Object(n.injectable)()(O=function(e,t){return Object(n.inject)(r.a)(e,void 0,0)}(O=function(e,t){return Object(n.inject)(v)(e,void 0,1)}(O=Reflect.metadata("design:type",Function)(O=Reflect.metadata("design:paramtypes",[void 0===r.a?Object:r.a,void 0===v?Object:v])(O=class{constructor(e,t){this.regularBucket=e,this.validator=t,this._currentProcess=void 0,this._currentProcess=Object(S.a)()}transport(e){this.validator.validateLog(this._currentProcess,e.lineMeta.level,"toFile",e.extras)&&this.regularBucket.add(e)}})||O)||O)||O)||O)||O,F=Object(n.injectable)()(E=function(e,t){return Object(n.inject)(v)(e,void 0,0)}(E=function(e,t){return Object(n.inject)(w.a)(e,void 0,1)}(E=Reflect.metadata("design:type",Function)(E=Reflect.metadata("design:paramtypes",[void 0===v?Object:v,void 0===w.a?Object:w.a])(E=class{constructor(e,t){this.validator=e,this.consoleWriter=t,this._currentProcess=void 0,this._currentProcess=Object(S.a)()}transport(e){this.validator.validateLog(this._currentProcess,e.lineMeta.level,"toConsole",e.extras)&&this.consoleWriter.write(e)}})||E)||E)||E)||E)||E;n.ModuleContainer.registerSingleton(M,D),n.ModuleContainer.registerSingleton(_,L),n.ModuleContainer.registerSingleton(C,F);var R=s("XB6V");const A=["info","warn","debug","error","critical"],P=["","F","C","T","FT","CT"];function N(){let e=0;const t={},s={};return A.forEach((i=>{P.forEach((n=>{""===n?(t[e]=`z${i}A`,s[`z${i}A`]=e,e+=1):"T"===n?(t[e]=`z${i}AT`,s[`z${i}AT`]=e,e+=1):(t[e]=`z${i}${n}`,s[`z${i}${n}`]=e,e+=1)}))})),{EnumeratedLevels:t,ReversedEnumeratedLevels:s}}Object.freeze(P),Object.freeze(A);const j=N().EnumeratedLevels,U=N().ReversedEnumeratedLevels;Object.freeze(j),Object.freeze(U);var B,k=s("h0S/");let G=Object(n.injectable)()(B=function(e,t){return Object(n.inject)(M)(e,void 0,0)}(B=function(e,t){return Object(n.inject)(_)(e,void 0,1)}(B=function(e,t){return Object(n.inject)(C)(e,void 0,2)}(B=Reflect.metadata("design:type",Function)(B=Reflect.metadata("design:paramtypes",[void 0===M?Object:M,void 0===_?Object:_,void 0===C?Object:C])(B=class extends class{}{constructor(e,t,s){super(),this.fileTransporter=e,this.sentryTransporter=t,this.consoleTransporter=s,this._instanceMap=new Map}createZLogger(e,t,s){void 0===t&&(t=[]);const i=`${e}:${t.join(":")}`,r=this._instanceMap.get(i);var a,o,d,l,g,m,p,f,v,b,y;if(r&&((null==s?void 0:s.trans)===(null===(a=r.config)||void 0===a?void 0:a.trans)&&(null==s||null===(o=s.trans)||void 0===o?void 0:o.file)===(null===(d=r.config)||void 0===d||null===(l=d.trans)||void 0===l?void 0:l.file)&&(null==s||null===(g=s.trans)||void 0===g?void 0:g.console)===(null===(m=r.config)||void 0===m||null===(p=m.trans)||void 0===p?void 0:p.console)&&(null==s||null===(f=s.trans)||void 0===f?void 0:f.sentry)===(null===(v=r.config)||void 0===v||null===(b=v.trans)||void 0===b?void 0:b.sentry)&&(null==s?void 0:s.stagingOnly)===(null===(y=r.config)||void 0===y?void 0:y.stagingOnly)))return r.logger;let I,_,M;(void 0===(null==s?void 0:s.trans)||null!=s&&s.trans.file)&&(I=this.fileTransporter),(void 0===(null==s?void 0:s.trans)||null!=s&&s.trans.console)&&(_=this.consoleTransporter),(void 0===(null==s?void 0:s.trans)||null!=s&&s.trans.sentry)&&(M=this.sentryTransporter);const C=class{constructor(e,t,s){var i=this;this.module=e,this.features=t,this.config=s,this.enabled=!0,this.Sentry=null,this.tempOffConfig={toConsole:!1,toFile:!1,toSentry:!1},this.zsentry=function(){if(i.Sentry){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];i.Sentry.captureException(new Error(t.join(" ")))}},this.zfatal=function(){},this.zsymb=function(e,t,s){if(!1===i.enabled)return;const n=j[e];for(var r=arguments.length,a=new Array(r>3?r-3:0),o=3;o<r;o++)a[o-3]=arguments[o];if(n.includes("zcritical"))return void(i.Sentry&&i.Sentry.captureException(new Error(a.join(" "))));const d=i._getLevel(n);if(n.endsWith("A"))i._transport({tick:Date.now(),level:d,id1:t,id2:s,templ:null,args:a,target:"ConsoleFile"});else if(n.endsWith("AT")){const[e,...n]=a;i._transport({tick:Date.now(),level:d,id1:t,id2:s,templ:e,args:n,target:"ConsoleFile"})}else if(n.endsWith("C")||n.endsWith("F"))i._transport({tick:Date.now(),level:d,id1:t,id2:s,templ:null,args:a,target:n.endsWith("C")?"toConsole":"toFile"});else if(n.endsWith("CT")||n.endsWith("FT")){const[e,...r]=a;i._transport({tick:Date.now(),level:d,id1:t,id2:s,templ:e,args:r,target:n.endsWith("CT")?"toConsole":"toFile"})}},this._transport=e=>{let{tick:t,level:s,id1:i,id2:r,templ:a,args:o,target:d}=e;const l=()=>({lineMeta:{type:"normal",module:this.module,features:this.features,id1:i,id2:r,level:s,tick:t},template:a,args:o,extras:{stagingOnly:this.config.stagingOnly}}),c=n.ModuleContainer.resolve(h.a);var u,g;if("ConsoleFile"===d)!1===this.tempOffConfig.toConsole&&c.isEnabledConsole()&&(null===(u=this.config.toConsole)||void 0===u||u.transport(l())),!1===this.tempOffConfig.toFile&&(null===(g=this.config.toFile)||void 0===g||g.transport(l()));else if(!1===this.tempOffConfig[d]){var m;if("toConsole"===d&&!c.isEnabledConsole())return;null===(m=this.config[d])||void 0===m||m.transport(l())}},this._getLevel=e=>{let t=e;e.endsWith("A")?t=e.replace("A",""):e.endsWith("AT")?t=e.replace("AT",""):e.endsWith("C")?t=e.replace("C",""):e.endsWith("CT")?t=e.replace("CT",""):e.endsWith("F")?t=e.replace("F",""):e.endsWith("FT")&&(t=e.replace("FT",""));let s=c.b.info;switch(t){case"zinfo":s=c.b.info;break;case"zwarn":s=c.b.warn;break;case"zerror":s=c.b.error;break;case"zdebug":s=c.b.debug}return s},this.zinfo=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zinfoC=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zinfoF=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zwarn=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zwarnC=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zwarnF=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zerror=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zerrorC=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zerrorF=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zdebug=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zdebugC=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.zdebugF=function(){throw new Error("babel-plugin-transform-zlog failed: zlog malfunction")},this.enabled=!0===function(e,t,s){if(void 0===s&&(s=!1),!k.a.includes(e)&&!1===k.c[e])return u.a.error("LogModeController:",[e,t],`module ${e} is not whitelisted`),!1;let i=!1;for(const n of t){const r=k.a.includes(n)||!(!1===k.c[e]);if(s&&!r||!r&&!i)return!1;if(r){if(i=!0,!s)return!0}else if(!i)return u.a.error("LogModeController:",[e,t],`feat ${n} is not whitelisted and requireAllFeatOn:${s}`),!1}return!0}(this.module,this.features)}disableFile(){this.tempOffConfig.toFile=!0}enableFile(){this.tempOffConfig.toFile=!1}disableConsole(){this.tempOffConfig.toConsole=!0}enableConsole(){this.tempOffConfig.toConsole=!1}static create(e,t,s){return new this(e,t,s)}pause(){this.enabled=!0}resume(){this.enabled=!1}specialTransport(e){this._transport(e)}}.create(e,t,{toFile:I,toConsole:_,toSentry:M,stagingOnly:null==s?void 0:s.stagingOnly});return this._instanceMap.set(i,{logger:C,config:s}),C}createZLoggerStaging(e,t,s){return t.push(k.b.staging),this.createZLogger(e,t,{trans:s,stagingOnly:!0})}})||B)||B)||B)||B)||B)||B;n.ModuleContainer.register(R.a,G);var x=s("yBqK"),z=s("ebA4");var V,$=s("CDcE");let W=Object(n.injectable)()(V=Reflect.metadata("design:type",Function)(V=Reflect.metadata("design:paramtypes",[])(V=class extends class{constructor(){this._TextEncoder=new TextEncoder}encodeUi8(e,t,s){return e.setUint8(t,s),t+d.b.ui8}encodeUi16(e,t,s){return e.setUint16(t,s),t+d.b.ui16}encodeUi32(e,t,s){return e.setUint32(t,s),t+d.b.ui32}encodeFloat32(e,t,s){return e.setFloat32(t,s),t+d.b.float32}encodeFloat64(e,t,s){return e.setFloat64(t,s),t+d.b.float64}encodeBigInt64(e,t,s){const i=Object(z.a)(s),n=new Uint8Array(i);for(let r=0;r<n.byteLength;r++)t=this.encodeUi8(e,t,n[r]);return t}encodeTotalSize(e,t,s){return this.encodeUi16(e,t,s)}encodeTotalSizeEnd(e,t){return this.encodeUi16(e,t,t+d.b.ui16)}encodeTick(e,t,s){const i=Object(z.a)(s),n=new Uint8Array(i);return this.copyCache(e,t,n)}encodeVers(e,t,s){if(s>32767)throw new Error("[BinEncoder] error: encoding verion is TOO BIG!");return this.encodeUi16(e,t,s)}encodeEncoderVers(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding level is TOO BIG!");return this.encodeUi8(e,t,s)}encodeLevel(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding level is TOO BIG!");return this.encodeUi8(e,t,s)}encodeHeaderNum(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding numOfHeader is TOO BIG!");return this.encodeUi8(e,t,s)}encodeStringOnly(e,t,s){const i=this._TextEncoder.encode(s),n=i.byteLength;return t=this.encodeUi8(e,t,n),this.copyCache(e,t,i)}copyCache(e,t,s){for(let i=0;i<s.byteLength;i++)t=this.encodeUi8(e,t,s[i]);return t}}{constructor(){super(),this.MemoryLogBatch=void 0,this.dv=void 0,this._lastOffset=0,this._lastTs=0,this.MemoryLogBatch=new ArrayBuffer(d.d.mem_batch_lim),this.dv=new DataView(this.MemoryLogBatch)}getLastBuffer(){return this.MemoryLogBatch.slice(0,this._lastOffset)}encode(e,t,s){try{const{lineMeta:i,args:n}=e;let r=0;r+=d.b.ui16;let a=i.tick;a<=this._lastTs&&(a=this._lastTs+1),this._lastTs=a,r=this.encodeTick(this.dv,r,a),r=this.encodeEncoderVers(this.dv,r,d.o),r=this.encodeLevel(this.dv,r,i.level),r=this.encodeUi16(this.dv,r,s.ss),r=this.encodeUi32(this.dv,r,s.ss_ln),r=this.encodeStringOnly(this.dv,r,"nVkK2oHE"),r=this.encodeUi32(this.dv,r,t),r=this.encodeUi16(this.dv,r,i.id1),r=this.encodeUi16(this.dv,r,i.id2),r=this._encodeArgs(r,this.dv,n);const o=r+d.b.ui16;return this.encodeTotalSize(this.dv,0,o),r=this.encodeTotalSize(this.dv,r,o),this._lastOffset=r,this.MemoryLogBatch.slice(0,o)}catch(i){throw u.a.error("BinEncoderImpl.encode error:",i),new Error("BinEncoderImpl.encode error")}}_allowTruncate(){const e=n.ModuleContainer.resolve(a.a),t=(null==e?void 0:e.get("adminMode"))||!1,s=e.get("stagingAccount")||!1;return!(t||s)}_encodeArgs(e,t,s){let i=!1;const n=[];if(s.length)for(let a of s)"object"==typeof a&&(i=Object($.b)(a)||Object($.c)(a)),n.push(Object(z.c)(a));let r;if(r=1===n.length&&1===s.length&&Array.isArray(n[0])&&"function"==typeof s[0]?x.encode([...n[0]]):x.encode(n),r.byteLength>d.d.line_hard_lim){const e=JSON.stringify(n,Object($.a)()).slice(0,d.d.line_hard_lim);r=x.encode(e)}else if(!i&&r.byteLength>d.d.line_soft_lim&&this._allowTruncate()){const e=JSON.stringify(n,Object($.a)()).slice(0,d.d.line_soft_lim);r=x.encode(e)}for(let a=0;a<r.byteLength;a++)e=this.encodeUi8(t,e,r[a]);return e}})||V)||V)||V;var q=s("ez9R");n.ModuleContainer.registerSingleton(q.a,W);var K=s("K8kB");var H,Q=class{constructor(e,t){void 0===e&&(e=[]),void 0===t&&(t=!0),this.tasks=e,this.alive=t}do(){return this.add(...arguments)}add(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return this.tasks=this.tasks.concat(t),this}once(e){return void 0===e&&(e=!1),this.alive=!1,e&&(async e=>this.async())()||this.sync(),this}every(e){return this.add((()=>new Promise((t=>setTimeout(t,e))))),this.forever(!0)}forever(e){return void 0===e&&(e=!1),this.alive=!0,e&&(async e=>this.async())()||this.sync(),this}cancel(){return this.alive=!1,this}async async(){for(let e of this.tasks)await e();this.alive&&this.async()}sync(){for(let e of this.tasks)e();this.alive&&this.sync()}};let J=Object(n.injectable)()(H=function(e,t){return Object(n.inject)(r.a)(e,void 0,0)}(H=Reflect.metadata("design:type",Function)(H=Reflect.metadata("design:paramtypes",[void 0===r.a?Object:r.a])(H=class extends o.b{constructor(e){super(),this.bucket=e,this.task=void 0,this.start=()=>{var e;if(null!==(e=this.task)&&void 0!==e&&e.alive)return;this.task||(this.task=new Q);const t=y.c[Object(S.a)()]||d.e;this.task.add((()=>this._broadcastEvent(l.c.WriteSchedulerRequestFlush))).every(t),this._listenEvents()},this.stop=()=>{this.task&&this.task.cancel(),this.task=void 0},this._listenEvents=()=>{this.bucket.addEventListener(l.c.LogBucketRequestFlush,this._handleFlushRequestFromBucket)},this._handleFlushRequestFromBucket=()=>{var e;this.task&&this.task.alive||(d.n&&u.a.log("Oopsie! Scheduler is somehow not running. Restarting..."),null===(e=this.task)||void 0===e||e.cancel(),this.task=void 0,this.start())}}_broadcastEvent(e){if(e===l.c.WriteSchedulerRequestFlush)this.dispatchEvent(new l.a(e))}})||H)||H)||H)||H;n.ModuleContainer.registerSingleton(K.a,J)},gpNb:function(e,t,s){"use strict";var i,n=s("jDHv"),r=s("UK4g"),a=s("YEoC"),o=s("PmZf"),d=s("rvru"),l=s("PhBv"),c=s("tHMN");let h=n.ModuleContainer.injectable()(i=function(e,t){return n.ModuleContainer.inject(l.b)(e,void 0,0)}(i=function(e,t){return n.ModuleContainer.inject(d.a)(e,void 0,1)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===l.a?Object:l.a,void 0===d.a?Object:d.a])(i=class extends c.a{constructor(e,t){super(),this.queryPlanner=e,this.dbQos=t,this.queryPlanner.addEventListener(o.a.QueryError,(e=>{this.dispatchEvent(new o.b(e.error)),this.dbQos.sendDBErrorQos(e.error)})),this.queryPlanner.addEventListener(o.a.UnexpectedError,(e=>{this.dispatchEvent(new o.d(e.error)),this.dbQos.sendDBErrorQos(e.error)}))}do(e){return this.queryPlanner.do(e)}doImmediately(e){return"Qos"===e.database&&e.trace(),this.queryPlanner.doImmediately(e)}deleteDatabase(e){return this.doImmediately({trace:function(){},type:a.d.DeleteDB,database:e,table:"",transaction:0,priority:a.c.BLOCKING,retry:r.i,timing:{},meta:{error:new Error,dead:!1,step:-1}})}deleteAllDatabases(){return this.doImmediately({trace:function(){},type:a.d.DeleteAllDBs,database:"",table:"",transaction:0,priority:a.c.BLOCKING,retry:r.i,timing:{},meta:{error:new Error,dead:!1,step:-1}})}closeDatabase(e){return this.doImmediately({trace:function(){},type:a.d.CloseDB,database:e,table:"",transaction:0,priority:a.c.BLOCKING,retry:r.i,timing:{},meta:{error:new Error,dead:!1,step:-1}})}closeAllDatabases(){return this.doImmediately({trace:function(){},type:a.d.CloseAllDBs,database:"",table:"",transaction:0,priority:a.c.BLOCKING,retry:r.i,timing:{},meta:{error:new Error,dead:!1,step:-1}})}})||i)||i)||i)||i)||i;n.ModuleContainer.registerSingleton(c.b,h)},hRcX:function(e,t,s){"use strict";var i=s("VTBJ"),n=s("jDHv"),r=s("Uzj0");const a=()=>{},o=(()=>{let e=0;return()=>++e})(),d={id:0,retry:0,success:a,error:a,execute:a};function l(e,t){const s=e.length;e.push(t),function(e,t,s){let i=s;for(;;){const s=i-1>>>1,n=e[s];if(!(void 0!==n&&h(n,t)>0))return;e[s]=t,e[i]=n,i=s}}(e,t,s)}function c(e){const t=e[0];if(void 0!==t){const s=e.pop();return s!==t&&(e[0]=s,function(e,t,s){let i=s;const n=e.length;for(;i<n;){const s=2*(i+1)-1,n=e[s],r=s+1,a=e[r];if(void 0!==n&&h(n,t)<0)void 0!==a&&h(a,n)<0?(e[i]=a,e[r]=t,i=r):(e[i]=n,e[s]=t,i=s);else{if(!(void 0!==a&&h(a,t)<0))return;e[i]=a,e[r]=t,i=r}}}(e,s,0)),t}return null}function h(e,t){const s=e.sortIndex-t.sortIndex;return 0!==s?s:e.id-t.id}let u;!function(e){e[e.BLOCKING=50]="BLOCKING",e[e.NON_BLOCKING=250]="NON_BLOCKING",e[e.IDLE=500]="IDLE",e[e.NEVER_TIMEOUT=1e3]="NEVER_TIMEOUT"}(u||(u={}));const g=new class{push(e,t){const s=Object(i.a)(Object(i.a)(Object(i.a)({},d),t),{},{id:o()});e.push(s)}getCandidate(e){return e.shift()}},m=new class{push(e,t){l(e,Object(i.a)(Object(i.a)(Object(i.a)({},d),t),{},{sortIndex:Date.now()+(t.deadline||u.NON_BLOCKING),id:o()}))}getCandidate(e){return c(e)}};class p{constructor(e,t){void 0===e&&(e=g),void 0===t&&(t=!0),this._queue=void 0,this._strategy=void 0,this._stopped=void 0,this._inactive=void 0,this._queue=[],this._strategy=e,this._stopped=!t,this._inactive=!0}run(e){this._strategy.push(this._queue,e),this._inactive&&this._run()}start(){this._stopped=!1,setTimeout((()=>{this._run()}))}stop(){this._stopped=!0,this._inactive=!0}async _run(){if(this._stopped)return void(this._inactive=!0);const e=this._strategy.getCandidate(this._queue);if(e)try{const s=await e.execute();try{null==e||e.success(s)}catch(t){}setTimeout((()=>{this._run()}))}catch(t){e.retry>0?(e.retry--,this.run(e)):null==e||e.error(t),setTimeout((()=>{this._run()}))}else this._inactive=!0}}new p(m);var f=s("Mgpg"),v=s("YEoC"),b=s("DI/x"),y=s("PmZf"),I=s("YZti"),_=s("1UUk"),M=s("MRjZ"),C=s("UJ0r"),T=s("teaq"),O=s("Abbu"),E=s("PhBv");var S;let w=n.ModuleContainer.injectable()(S=function(e,t){return n.ModuleContainer.inject(C.b)(e,void 0,0)}(S=function(e,t){return n.ModuleContainer.inject(T.b)(e,void 0,1)}(S=function(e,t){return n.ModuleContainer.inject(f.ZLoggerFactory)(e,void 0,2)}(S=Reflect.metadata("design:type",Function)(S=Reflect.metadata("design:paramtypes",[void 0===C.a?Object:C.a,void 0===T.b?Object:T.b,void 0===f.ZLoggerFactory?Object:f.ZLoggerFactory])(S=class extends E.a{constructor(e,t,s){super(),this.adapterManager=e,this.configManager=t,this.scheduler=void 0,this.pendingQueries=[],this.session=void 0,this.logger=void 0,this.adapterContainers=new Map,this.idCounter=0,this.dbSchema=void 0,this.scheduler=new p(g,!1),this.logger=s.createZLogger("db",["host","planner"]),this.adapterManager.addEventListener(y.a.UnexpectedError,(e=>{this.dispatchEvent(new y.d(e.error))}))}install(e){this.dbSchema=e}start(){this.scheduler.start();const e=n.ModuleContainer.resolve(_.b),t=e=>{this.session=e;const t=this.pendingQueries;this.pendingQueries=[],t.forEach((e=>{this.enqueue(e,{immediately:!1})}))};e.session&&t(e.session),e.addEventListener(y.a.SessionChange,(e=>{t(e.session),this.adapterContainers.clear()}))}stop(){this.scheduler.stop(),this.logger.zsymb(6,11300,3e4,"Stop!")}do(e){return new Promise(((t,s)=>{this.enqueue(Object(i.a)(Object(i.a)({},e),{},{deferrer:{resolve:t,reject:s}}),{immediately:O.a.isInTransaction(e)})})).finally((()=>{}))}doImmediately(e){return new Promise(((t,s)=>{this.enqueue(Object(i.a)(Object(i.a)({},e),{},{deferrer:{resolve:t,reject:s}}),{immediately:!0})}))}enqueue(e,t){e.meta.step=0,e.meta.id=this.idCounter++,this.scheduler.run({immediately:t.immediately,execute:()=>{try{return this.execute(e)}catch(t){if(0!==e.retry)throw e.retry-=1,t;{const s=this.createErrorForQuery(e,t);this.logger.zsymb(18,11300,30001,(()=>[s])),this.dispatchEvent(new y.d(new b.i(s.message)))}}},retry:e.retry})}trapQueryError(e){let t=null,s=()=>{};this.shouldTrapTimeoutQuery(e)&&(t=setTimeout((()=>{var t,s;const i=(null===(t=e.params)||void 0===t||null===(s=t.values)||void 0===s?void 0:s.length)||void 0,n=void 0!==i?[i]:[];e.deferrer.reject(new b.t(n))}),e.meta.timeout),e.meta.timer=t,s=()=>{clearTimeout(t)});const i=e.deferrer;e.deferrer={resolve:e=>{s(),i.resolve(e)},reject:t=>{s();const n=this.createErrorForQuery(e,t);this.dispatchEvent(new y.b(n)),i.reject(n)}}}createErrorForQuery(e,t){const s={method:I.b.getTypeName(e.type),database:e.database,table:e.table,step:e.meta.step,partition:e.meta.partitionKey,trans:e.transaction,deadline:e.meta.timeout},i=Object(M.a)(s);let n=null;const r=(e=>{const t=e.stack;if(!t)return"";const s=`${e.name}`+(e.message?`: ${e.message}`:"")+"\n";return t.startsWith(s)?t.slice(s.length):t})(e.meta.error);if(t)if(t instanceof Error){const s=t.message+` (${i})`;t instanceof DOMException?(n=new b.c(s,t.name,t.code),n.setStack(r)):t instanceof b.e?(n=t,n.message=s,n.setStack(r)):(n=e.meta.error,n.message=s,n.name=t.name,n.stack=`${n.name}: ${n.message} ${r}`)}else{let e=t?`${t}`:"Unknown reason";e+=` (${i})`,n=new b.i(e),n.setStack(r)}else{let e=`Unknown reason (${i})`;n=new b.i(e),n.setStack(r)}return n}shouldTrapTimeoutQuery(e){return!1}execute(e){e.meta.step=1,e.meta.dead=!1,e.meta.step=2,!e.meta.databaseConfig&&(this.computeDatabaseConfig(e),e.meta.dead)||(e.meta.step=3,this.isReadyForExecute(e)&&(e.meta.shouldNotTrapQuery||this.trapQueryError(e),e.meta.step=4,!e.meta.databaseName&&(this.computeDatabaseName(e),e.meta.dead)||(e.meta.step=5,e.meta.step=6,!e.meta.partitionConfig&&(this.computePartitionConfig(e),e.meta.dead)||(e.meta.step=7,!e.meta.tableConfig&&(this.computeTableConfig(e),e.meta.dead)||(e.meta.step=8,"string"!=typeof e.meta.partitionKey&&(this.computePartitionKey(e),e.meta.dead)||(e.meta.step=9,!e.meta.executor&&(this.computeDatabaseAdapter(e),e.meta.dead)||(e.meta.step=10,e.meta.executor())))))))}computeDatabaseAdapter(e){const{databaseName:t,partitionConfig:s,partitionKey:i,databaseConfig:n,tableConfig:a}=e.meta;let o=t;if(!O.a.isPartitionlessQuery(e)&&n.supportPartitionByField&&a.doesHavePartitionByField(s.type)){if(""===i)return void this.rejectQuery(e,new b.q);o=`${t}/${i}`}const d=`${o}_${s.type}`;let l=this.adapterContainers.get(d);l||(l=new r.b.Container,this.adapterContainers.set(d,l),this.adapterManager.getDatabaseAdapter(o,s).then(l.resolve).catch(l.reject)),l.value||l.promise.then((()=>(e.meta.shouldNotTrapQuery=!0,this.execute(e)))).catch((e=>{const t=new b.b(d,e.message);this.logger.zsymb(18,11300,30003,(()=>[t])),this.dispatchEvent(new y.d(t))}));const c=l.value;c?(e.meta.adapterName=c.type===v.a.IDB?"idb":"sqlite",e.meta.executor=()=>{e.meta.databaseName=o,c.execute(e)}):e.meta.dead=!0}replicate(e,t){this.do(Object(i.a)(Object(i.a)({},e),{},{transaction:0,meta:Object(i.a)(Object(i.a)({},e.meta),{},{databaseConfig:t,error:new Error}),deferrer:void 0}))}isReadyForExecute(e){return!(e.meta.databaseConfig.session&&!this.session)||(this.pendingQueries.push(e),!1)}computeDatabaseConfig(e){if(""===e.database&&(O.a.isCloseAllDBsQuery(e)||O.a.isDeleteAllDBsQuery(e))){e.meta.dead=!0;const t=this.getAllDBNames().map((t=>this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{type:O.a.isCloseAllDBsQuery(e)?v.d.CloseDB:v.d.DeleteDB,database:t,meta:Object(i.a)(Object(i.a)({},e.meta),{},{error:new Error}),deferrer:void 0}))));return void Promise.all(t).then((()=>e.deferrer.resolve())).catch(e.deferrer.reject)}const t=this.configManager.getDatabaseConfigs(e.database);if(0!==t.length){if(t.length>1&&this.shouldReplicate(e))for(let s=1;s<t.length;s++)this.replicate(e,t[s]);e.meta.databaseConfig=t[0]}else this.rejectQuery(e,new b.m(e.database))}getAllDBNames(){return Object.keys(this.dbSchema)}getTablesNameOfDB(e){const t=this.dbSchema[e];if(!t)throw new b.n(e);return Object.values(t).map((e=>e.name))}computeDatabaseName(e){var t,s;const{meta:n,table:r,database:a}=e;if(""===r&&(O.a.isCloseDBQuery(e)||O.a.isCloseAllDBsQuery(e)||O.a.isDeleteDBQuery(e)||O.a.isDeleteAllDBsQuery(e))){e.meta.dead=!0;const t=this.getTablesNameOfDB(a).map((t=>this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{table:t,meta:Object(i.a)(Object(i.a)({},e.meta),{},{error:new Error}),deferrer:void 0}))));return void Promise.all(t).then((()=>e.deferrer.resolve())).catch(e.deferrer.reject)}const o=null!==(t=null===(s=this.session)||void 0===s?void 0:s.userId)&&void 0!==t?t:"",d=n.databaseConfig.computeDatabaseName(o,r);n.databaseName=d}computePartitionConfig(e){const t=e.meta.databaseConfig.getPartition(e.table,this.session);t?e.meta.partitionConfig=t:this.rejectQuery(e,new b.p(e.table,this.session))}computeTableConfig(e){const t=e.meta.partitionConfig.getTableConfig(e.table);t?(t.dbName=e.database,e.meta.tableConfig=t):this.rejectQuery(e,new b.r(e.table))}computePartitionKey(e){const{databaseConfig:t,tableConfig:s,partitionConfig:i}=e.meta;if(t.supportPartitionByField&&s.doesHavePartitionByField(i.type))switch(e.type){case v.d.BeginTransaction:return void(e.meta.partitionKey="");case v.d.Clear:return;case v.d.Insert:return void this.computePartitionForInsertQuery(e);case v.d.InsertMulti:return void this.computePartitionForInsertMultiQuery(e);case v.d.Get:case v.d.GetAndUpdate:case v.d.Update:case v.d.Delete:return void this.computePartitionForIndexedQuery(e);case v.d.FindAndDelete:case v.d.GetAllKey:case v.d.GetAll:case v.d.Count:return void this.computePartitionForRangedQuery(e);case v.d.DeleteMulti:case v.d.GetMulti:return void this.computePartitionForGetMultiAndDeleteMultiQuery(e);case v.d.UpdateMulti:return void this.computePartitionForUpdateMultiQuery(e);case v.d.CloseDB:case v.d.DeleteDB:return void this.computePartitionForCloseDBAndDeleteDBQuery(e)}else e.meta.partitionKey=""}computePartitionForInsertQuery(e){const t=this.computePartitionKeyFromEntityValue(e.meta.tableConfig,e.params.value);void 0!==t?e.meta.partitionKey=`${t}`:this.rejectQuery(e,new b.q)}computePartitionForInsertMultiQuery(e){const t={groupByPartitions:{}};for(const i of e.params.values){const s=this.computePartitionKeyFromEntityValue(e.meta.tableConfig,i);if(void 0===s)return void this.rejectQuery(e,new b.q);t.groupByPartitions[s]||(t.groupByPartitions[s]=[]),t.groupByPartitions[s].push(i)}let s;const n=Object.entries(t.groupByPartitions);if(1===n.length)s=n[0][0],void 0!==s?e.meta.partitionKey=s:this.rejectQuery(e,new b.q);else{e.meta.dead=!0;const t=n.map((t=>{let[s,n]=t;const r=s;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:r,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{values:n}),deferrer:void 0}))}));Promise.all(t).then((t=>e.deferrer.resolve(t.flat()))).catch(e.deferrer.reject)}}computePartitionForIndexedQuery(e){const t=this.computePartitionKeyFromEntityKey(e.meta.tableConfig,e.params.key,e.params.index);void 0!==t?e.meta.partitionKey=`${t}`:this.rejectQuery(e,new b.q)}computePartitionForRangedQuery(e){var t,s;if(!e.params.range){const t=new b.s("Get all data in partitioned table");return void this.rejectQuery(e,t)}let i="";i=e.type===v.d.FindAndDelete||e.type===v.d.Count?"primary":e.params.index;const{partitionConfig:n,tableConfig:r}=e.meta;if(-1===r.getIndexPartitionField(n.type,i)){if(r.usePartitionTable){const t=new b.s("Lookup partition from query range");this.rejectQuery(e,t)}else{const t=new b.s("Get all data by index in partitioned table");this.rejectQuery(e,t)}return}if(null===(t=e.params.range)||void 0===t||!t.from||null===(s=e.params.range)||void 0===s||!s.to){const t=new b.s("Get data with open boundary in partition table");return void this.rejectQuery(e,t)}const a=e.params.range.from,o=e.params.range.to,d=this.computePartitionKeyFromEntityKey(e.meta.tableConfig,a,i);if(d!==this.computePartitionKeyFromEntityKey(e.meta.tableConfig,o,i)){const t=new b.s("Get data from multiple partition");return void this.rejectQuery(e,t)}let l=d;void 0!==l?e.meta.partitionKey=`${l}`:this.rejectQuery(e,new b.q)}computePartitionForGetMultiAndDeleteMultiQuery(e){let t="";t=e.type===v.d.DeleteMulti?"primary":e.params.index;const s={};for(const i of e.params.keys){const n=this.computePartitionKeyFromEntityKey(e.meta.tableConfig,i,t);if(void 0===n)return void this.rejectQuery(e,new b.q);s[n]||(s[n]=[]),s[n].push(i)}const n=Object.entries(s);let r;if(1===n.length)r=n[0][0],void 0!==r?e.meta.partitionKey=`${r}`:this.rejectQuery(e,new b.q);else{e.meta.dead=!0;const t=n.map((t=>{let[s,n]=t;const r=s;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:r,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{keys:n}),deferrer:void 0}))}));Promise.all(t).then((t=>e.deferrer.resolve(t.flat()))).catch(e.deferrer.reject)}}computePartitionForUpdateMultiQuery(e){const{patches:t}=e.params,s={};for(const i of t){const{key:t}=i,n=this.computePartitionKeyFromEntityKey(e.meta.tableConfig,t);if(void 0===n)return void this.rejectQuery(e,new b.q);s[n]||(s[n]=[]),s[n].push(i)}let n;const r=Object.entries(s);if(1===r.length)n=r[0][0],void 0!==n?e.meta.partitionKey=n:this.rejectQuery(e,new b.q);else{const t=r.map((t=>{let[s,n]=t;const r=s;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:r,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{patches:n}),deferrer:void 0}))}));Promise.all(t).then((t=>e.deferrer.resolve(t.flat()))).catch(e.deferrer.reject)}}async computePartitionForCloseDBAndDeleteDBQuery(e){e.meta.dead=!0;const{meta:t}=e,s=(await this.adapterManager.getExistedPartitionKeys(t.databaseName,t.databaseConfig.type)).map((t=>this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:t,error:new Error}),deferrer:void 0}))));Promise.all(s).then((()=>e.deferrer.resolve())).catch(e.deferrer.reject)}computePartitionKeyFromEntityValue(e,t){const s=e.partitionField;if(void 0!==s)return t[s]}computePartitionKeyFromEntityKey(e,t,s){void 0===s&&(s="primary");const i=e.partitionField;if(void 0!==i)return e.getIndex(s).getValue(t,i)}shouldReplicate(e){switch(e.type){case v.d.Clear:case v.d.Delete:case v.d.DeleteMulti:case v.d.FindAndDelete:case v.d.Insert:case v.d.InsertMulti:case v.d.Update:case v.d.UpdateMulti:case v.d.GetAndUpdate:case v.d.CloseDB:case v.d.CloseAllDBs:case v.d.DeleteDB:case v.d.DeleteAllDBs:return!0;default:return!1}}logQueryInfo(e){O.a.isBeginTransaction(e)?this.logger.zsymb(12,11300,30004,(()=>[I.b.getTypeName(e.type),{database:e.meta.databaseName,table:e.params.tables.join(","),transaction:e.transaction,adapter:e.meta.databaseConfig.typeName}])):this.logger.zsymb(12,11300,30005,(()=>[I.b.getTypeName(e.type),{database:e.meta.databaseName,table:e.table,transaction:e.transaction,adapter:e.meta.databaseConfig.typeName}]))}rejectQuery(e,t){e.meta.dead=!0,e.deferrer.reject(t)}})||S)||S)||S)||S)||S)||S;n.ModuleContainer.registerSingleton(E.b,w)},i15Q:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s("KRcn");class n{constructor(){this._session=null,this._processStart=void 0,this._enableConsole=void 0,this.isReady=()=>!!this._session,this.getSession=()=>{if(!this._session)throw new Error("session is not ready");return this._session},this.getProcessStartTime=()=>this._processStart,this.setSession=e=>{this._session=e},this._processStart=Date.now(),this._session={build:"a2f10c3af8386059067eb6a6600fc13a81ec8598",zlgv:"nVkK2oHE",env:"prod",buildType:"release",pversion:s("kiQV").version,process:Object(i.a)()},this._enableConsole=!1}enableConsole(){}disableConsole(){}isEnabledConsole(){return this._enableConsole}}},j6JD:function(e,t,s){"use strict";function i(e,t){"string"==typeof e&&(e=parseInt(e));const s=new Date(e),i=s.getDate(),r=s.getMonth()+1,a=(s.getFullYear(),s.getHours()),o=s.getMinutes(),d=s.getSeconds();return null!=t&&t.dayOnly?`${i}.${r}`:null!=t&&t.timeOnly?`${n(a,2)}:${n(o,2)}:${n(d,2)}`:`${i}.${r} ${n(a,2)}:${n(o,2)}:${n(d,2)}`}function n(e,t){const s=e.toString();return s.length<t?"0".repeat(t-s.length)+s:s}s.d(t,"a",(function(){return i}))},jw3m:function(e,t,s){},kiQV:function(e){e.exports=JSON.parse('{"name":"Zalo","homepage":"https://zalo.me/","version":"23.7.1","description":"Zalo - Nhắn gửi yêu thương","engines":{"npm":">=3"},"lint-staged":{"*.{js}":["node ./tools/prettier-include/index.js","eslint --quiet"],"*.{jsx,tsx,ts,scss,md,json,html,yml}":["node ./tools/prettier-include/index.js"]},"pre-commit":"check","main":"bootstrap.js","scripts":{"check":"lint-staged","preinstall":"node tools/nodeVersionCheck.js && git submodule init && git submodule update","postinstall":"npm run update-bundle-files-list && git config core.hooksPath .githooks","setup":"node tools/setup/setupMessage.js && npm install && node tools/setup/setup.js","remove-demo":"babel-node tools/removeDemo.js","start":"npm run init-zlog-vers && cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' zpc-cli run dev:web","start-zaloapp":"npm run init-zlog-vers && cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' WEB_DOMAIN=zaloapp zpc-cli run dev:web","open:src":"cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' zpc-cli run dev:web","open:dist":"cross-env BABEL_ENV=web babel-node tools/distServer.js","update-about":"babel-node tools/updateAbout.js","distwname":"babel-node tools/dist-with-name.js","send-zlog":"node ./tools/zlog/collect-zlog-templates.js","send-zlog-web":"node ./tools/zlog/collect-zlog-templates-web.js","init-zlog-vers":"node ./tools/init-zlog-vers.js","prep":"rimraf ./node_modules/.cache ./zlog-dist && npm run sass && npm run lang","update-call-hash":"babel-node tools/update-call-hash.js","update-zavi-hash":"babel-node tools/update-zavi-hash.js","lint":"esw src --color --parser babel-eslint","lint-strict":"eslint main/*.js","m-lint":"eslint src/utils/meta-info-msg/*.js src/database/base-db.js","lint:watch":"npm run lint -- --watch","clean-dist":"npm run remove-dist && mkdir dist","remove-dist":"rimraf ./dist","prebuild":"npm run clean-dist && npm run sass && npm run lang","prebuild-pc":"npm run lint-strict && rimraf ./pc-dist && mkdir pc-dist && npm run sass && npm run lang","build-dev":"cross-env WEB_ENV=dev npm run build","build-prod":"cross-env WEB_ENV=prod npm run build","build-zaloapp-prod":"cross-env WEB_ENV=prod WEB_DOMAIN=zaloapp npm run build","build-zalome-prod":"cross-env WEB_ENV=prod WEB_DOMAIN=zalome npm run build","build:local":"npm run init-zlog-vers && npm run cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' BUILD_TYPE=release zpc-cli run compile:web","build":"npm run init-zlog-vers && cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' BUILD_TYPE=release node ./tools/zpc-cli.js run compile:web","compile:main":"npm run init-zlog-vers && cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' zpc-cli run compile:main","build-pc":"npm run init-zlog-vers && cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' zpc-cli run compile:renderer","build-pc-appX":"npm run init-zlog-vers && cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' zpc-cli run compile:renderer:appx","test:cover":"babel-node node_modules/isparta/bin/isparta cover --root src --report html node_modules/mocha/bin/_mocha -- --require ./tools/testSetup.js \\"src/**/*.spec.js\\" --reporter progress","test:cover:travis":"babel-node node_modules/isparta/bin/isparta cover --root src --report lcovonly _mocha -- --require ./tools/testSetup.js \\"src/**/*.spec.js\\" && cat ./coverage/lcov.info | node_modules/coveralls/bin/coveralls.js","test:watch":"npm run test -- --watch","open:cover":"npm run test:cover && open coverage/index.html","test:electron":"electron ./test/main/download.js","test":"for f in $(find src -name *.spec.js); do NODE_PATH=./src mocha tools/testSetup.js \\"$f\\" --reporter progress; done;","wintest":"for %f in (src/utils/*.spec.js) do mocha tools/testSetup.js \\"src/utils/%f\\" done;","jest:test":"cross-env NODE_PATH=./src __PLATFORM__=WEB NODE_ENV=development jest --forceExit","jest:emoji":"cross-env NODE_PATH=./src __PLATFORM__=WEB jest test/core/parse-emoji.test.js --forceExit","jest:conversation":"cross-env NODE_PATH=./src __PLATFORM__=WEB jest --watch --testPathPattern=src/logic/conversation --forceExit","jest:log:test":"cross-env NODE_PATH=./src jest --runInBand --forceExit","jest:update":"cross-env NODE_PATH=./src jest -u","test:single":"cross-env NODE_PATH=./src mocha tools/testSetup.js src/utils/message.spec.js","test:file":"node ./test/file/test.js","test:ibparser":"cross-env NODE_PATH=./src mocha tools/testSetup.js  src/utils/inputbox-parser.spec.js","test:compare":"cross-env NODE_PATH=./src mocha tools/testSetup.js  src/utils/third-party/compare.spec.js","test:zstructures":"cross-env NODE_PATH=./src mocha tools/testSetup.js  src/utils/third-party/zstructures.spec.js","test:common":"cross-env NODE_PATH=./src mocha tools/testSetup.js src/utils/common.spec.js","test:schema":"cross-env NODE_PATH=./src jest --config= database/zdb/row-items/schema/data-validator.test.js --forceExit --detectOpenHandles","presass":"mkdirp src/static/css && mkdirp pc/static/fonts/zalo && ncp src/static/fonts/zalo/ pc/static/fonts/zalo/ && mkdirp pc/static/fonts/main  && ncp src/static/fonts/main/ pc/static/fonts/main/ ","sass":"sass src/static/scss/layout.scss src/static/css/layout.css && sass pc/static/scss/login.scss pc/static/css/login.css && sass src/static/scss/base/color-v1.scss src/static/css/color-v1.css && sass src/static/scss/base/darkmode.scss src/static/css/darkmode.css && sass src/static/scss/base/color-vtest.scss src/static/css/color-vtest.css","preelectron-start-dev":"npm run init-zlog-vers && cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' zpc-cli run dev:main","electron-start-dev":"npm run init-zlog-vers && cross-env PC=1 BABEL_ENV=pc NODE_ENV=development electron .","predebug-main":"npm run init-zlog-vers && npm run init-zlog-vers && cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' zpc-cli run dev:main","debug-main":"npm run init-zlog-vers && cross-env PC=1 BABEL_ENV=pc NODE_ENV=development electron . --inspect=9230","pc-compile":"cross-env FORCE_COLOR=1 PC=1 BABEL_ENV=pc NODE_ENV=development npm run electron-start-dev","pc-compile-2":"cross-env PC=1 BABEL_ENV=pc CLONE=1 NODE_ENV=development npm run electron-start-dev","v1-start-dev":"npm run init-zlog-vers && cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' zpc-cli run dev:renderer","pc-start-dev":"npm run init-zlog-vers && cross-env NODE_OPTIONS=\'--max-old-space-size=8192\' zpc-cli run dev:renderer","start-pc":"npm run init-zlog-vers && npm-run-all -p pc-compile pc-start-dev","prepack":"npm run build-pc && npm run compile:main","prepack:win32":"npm run build-pc && npm run compile:main","prepack:winstaller":"npm run build-pc && npm run signtool && npm run compile:main","prewinstaller":"git submodule init && git submodule update","pack":"electron-builder --dir --config electron-builder.config.js","pack:win32":"cross-env BUILD_TYPE=release npm run pack:winstaller && node ./tools/afterpack.js ia32 && babel-node tools/genPartialUpdate.js ia32 -- ","pack:winstaller:no-build":"cross-env BUILD_TYPE=release ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true electron-builder --dir --ia32 --config electron-builder.config.js","pack:winstaller":"electron-builder --dir --ia32 --config electron-builder.config.js","pack:winstaller64":"electron-builder --dir --x64 --config electron-builder.config.js","postpack":"babel-node tools/genPartialUpdate.js","postpack:win32":"babel-node tools/genPartialUpdate.js ia32","predodist":"npm run build-pc && npm run signtool && npm run compile:main","predodist:win64":"npm run predodist","predodist:win32":"npm run predodist","predodist:mac":"node ./tools/predodistmac.js && npm run predodist","dodist":"electron-builder --config electron-builder.config.js","predodist:dir":"npm run build-pc && npm run signtool && npm run compile:main","dodist:mac":"electron-builder --mac --config electron-builder.config.js","dodist:dir":"electron-builder --dir --mac --config electron-builder.config.js","dodist:win":"electron-builder --win --config electron-builder.config.js","dodist:win32":"electron-builder --ia32 --config electron-builder.config.js","dodist:win64":"electron-builder --arch x64 --config electron-builder.config.js","pack:installer":"node ./tools/prebuild.js && npm run pack:winstaller && node ./tools/afterpack.js ia32 && electron-builder --prepackaged ./dist/win-ia32-unpacked/ --ia32 --config electron-builder.config.js && babel-node tools/genPartialUpdate.js ia32 -- ","pack:installer64":"node ./tools/prebuild.js && npm run pack:winstaller && node ./tools/afterpack.js x64 && electron-builder --prepackaged ./dist/win-unpacked/ --arch x64 --config electron-builder.config.js && babel-node tools/genPartialUpdate.js x64 -- ","pack:full":"node ./tools/prebuild.js && npm run pack:winstaller && node ./tools/afterpack.js ia32 && electron-builder --prepackaged ./dist/win-ia32-unpacked/ --ia32 --config electron-builder.config.js && babel-node tools/diffModule.js","dist:win32":"cross-env ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true NODE_OPTIONS=\'--max-old-space-size=4096\' BUILD_ENV=test npm run pack:installer","dist:win64":"cross-env ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true NODE_OPTIONS=\'--max-old-space-size=4096\' BUILD_ENV=test npm run pack:installer64","dist:win32release":"cross-env ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true NODE_OPTIONS=\'--max-old-space-size=4096\' BUILD_TYPE=release BUILD_ENV=test NEED_SIGN=1 npm run pack:installer","dist:win32fullpack":"cross-env ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true NODE_OPTIONS=\'--max-old-space-size=8096\' BUILD_TYPE=release BUILD_ENV=production NEED_SIGN=1 npm run pack:full","postpack:full":"","uploadsourcemapwin":"cross-env ZLOG_TYPE=PC sentry-cli releases files Zalo%npm_package_version% upload-sourcemaps pc-dist/ --url-prefix app:///pc-dist/ && sentry-cli releases files Zalo%npm_package_version% upload-sourcemaps main-dist/ --url-prefix app:///main-dist/ && npm run send-zlog","uploadsourcemapmac":"cross-env ZLOG_TYPE=PC sentry-cli releases files Zalo$npm_package_version upload-sourcemaps pc-dist/ --url-prefix app:///pc-dist/ && sentry-cli releases files Zalo$npm_package_version upload-sourcemaps main-dist/ --url-prefix app:///main-dist/ && npm run send-zlog","uploadsourcemapweb":"cross-env ZLOG_TYPE=WEB sentry-cli releases files Zalo$npm_package_version upload-sourcemaps dist/ --url-prefix ~/ && rm -r ./dist/sourcemaps && npm run send-zlog-web","dist:win32nobuild":"electron-builder --prepackaged ./dist/win-ia32-unpacked/ --ia32 --config electron-builder.config.js&& babel-node tools/genPartialUpdate.js ia32 -- ","dist:win":"cross-env ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true npm run dodist:win","dist:appX":"(npm run dodist:appX || true) && babel-node tools/rename-appx-64.js &&  npm run dodist:appX32","dist:mac":"cross-env ARCH=x64 ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true BUILD_ENV=test npm run dodist:mac","dist:macrelease":"cross-env ARCH=x64 NODE_OPTIONS=\'--max-old-space-size=4096\' ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true BUILD_TYPE=release NEED_SIGN=1 npm run dodist:mac","dist:mac:m1":"cross-env ARCH=arm64 ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true BUILD_ENV=test npm run dodist:mac","dist:macrelease:m1":"cross-env ARCH=arm64 NODE_OPTIONS=\'--max-old-space-size=4096\' ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true BUILD_TYPE=release NEED_SIGN=1 npm run dodist:mac","dist:macnobuild":"cross-env ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true electron-builder --mac --config electron-builder.config.js","dist":"cross-env NODE_OPTIONS=\'--max-old-space-size=2048\' ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true npm run dodist","predist:appX":"npm run build-pc-appX && npm run signtool && npm run compile:main","dodist:appX":"cross-env ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true electron-builder --win AppX --config electron-builder.config.js","dodist:appX32":"cross-env ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true electron-builder --win AppX --ia32  --config electron-builder.config.js","zip-pc":"babel-node tools/zipResource.js","db:clear":"babel-node tools/clearDb.js","icon:gen":"gulp icon","icon:check":"babel-node icon/checkIconsCli.js","icon":"babel-node icon/buildIcons.js && babel-node icon/createSVGFont.js && npm run sass","icon:full":"npm run icon:check && npm run icon && npm run sass ","lang":"mkdirp src/static/lang &&  cd ./InitLang && node ./run.js","signtool":"cross-env BABEL_ENV=node babel-node tools/sign-tool-win.js","install-native":"electron-builder install-app-deps","install-native-32":"electron-builder install-app-deps --arch=ia32","pack-module":"babel-node tools/genPartialUpdate.js ia32 -- ","update-bundle-files-list":"node ./tools/get-node-modules-glob.js","upload-native-symbol":"sentry-cli upload-dif -o vng -p zalopc --wait ./.symbols"},"author":{"name":"VNG Corp.","email":"feddback@zalo.me","url":"https://zalo.me/"},"license":"MIT","dependencies":{"@babel/plugin-transform-runtime":"7.11.0","@babel/preset-env":"7.11.0","@babel/preset-react":"7.10.4","@babel/runtime-corejs3":"7.11.2","@google-cloud/secret-manager":"4.0.0","@google-cloud/storage":"6.1.0","@reduxjs/toolkit":"1.5.1","@sentry/electron":"1.1.0","@sentry/react":"6.2.4","@tensorflow/tfjs":"0.15.3","@types/generic-pool":"3.1.9","adm-zip":"0.4.13","ajv":"5.2.2","archiver":"^5.3.1","auto-launch":"^5.0.1","babel-plugin-module-resolver":"4.0.0","babel-plugin-transform-zlog":"1.17.1","big-integer":"1.6.23","bloom-filters":"1.3.8","broadcast-channel":"~4.10.0","cborg":"1.9.5","change-case":"4.1.2","chart.js":"2.7.2","check-disk-space":"2.1.0","clsx":"1.0.4","codemirror":"^5.59.0","core-js":"3.6.5","cron":"2.1.0","crypto-js":"3.1.8","decompress":"4.2.0","dompurify":"2.3.6","dropbox":"2.5.9","electron-log":"4.2.2","electron-store":"8.1.0","electron-updater":"4.0.0","es6-promise":"3.2.1","fast-memoize":"^2.5.2","file-saver":"1.3.3","file-type":"10.11.0","flatted":"3.2.5","fs-extra":"6.0.1","generic-pool":"3.7.2","glob":"7.1.2","immer":"7.0.5","jpeg-js":"0.4.1","js-yaml":"^3.8.4","jszip":"3.10.1","libphonenumber-js":"^1.10.28","lodash.debounce":"4.0.8","lodash.toarray":"4.4.0","lottie-web":"^5.1.7","lowdb":"2.1.0","lz-string":"1.4.4","mediatr-ts":"0.3.0","microm":"0.2.4","mkdirp":"^0.5.1","moment":"^2.29.1","nanoid":"3.3.3","network":"0.5.0","node-fetch":"2.6.0","node-stream-zip":"^1.15.0","node-wifi":"2.0.13","p-defer":"4.0.0","p-queue":"6.6.2","p-tap":"4.0.0","pako":"2.0.3","pdfjs-dist":"2.5.207","percentile":"1.6.0","progress-stream":"1.2.0","prop-types":"15.5.10","protobufjs":"6.11.2","quick-lru":"6.0.2","react":"16.14.0","react-codemirror2":"^7.2.1","react-custom-scrollbars":"^4.2.1","react-datetime":"file:native/zdate-time-picker","react-dom":"16.14.0","react-draggable":"^4.4.3","react-error-overlay":"6.0.7","react-input-range":"^1.3.0","react-intersection-observer":"8.25.2","react-measure":"2.0.2","react-motion":"0.5.2","react-redux":"7.2.4","react-refresh":"0.8.3","react-resizable":"^1.11.0","react-router-redux":"^4.0.8","react-simple-timefield":"3.2.5","react-transition-group":"4.4.1","react-virtualized":"9.9.0","recoil":"0.7.1","recompose":"0.30.0","redux":"4.0.5","redux-batched-subscribe":"0.1.6","redux-thunk":"2.3.0","reflect-metadata":"0.1.13","request":"2.88.0","reselect":"4.0.0","resize-observer-polyfill":"1.5.1","sift":"16.0.0","source-map-support":"0.5.19","spark-md5":"3.0.0","stackblur-canvas":"1.4.0","systeminformation":"5.6.12","tar-fs":"2.0.0","tmp":"0.0.31","tough-cookie":"^2.3.2","tsyringe":"4.6.0","unload":"git+https://zalogit2.zing.vn/zalo-pc/unload.git","unused-filename":"0.1.0","uuid":"3.1.0","workerpool":"6.1.0","xstate":"4.23.1"},"devDependencies":{"@babel/cli":"^7.0.0","@babel/core":"^7.0.0","@babel/eslint-parser":"7.12.1","@babel/node":"^7.0.0","@babel/plugin-proposal-class-properties":"7.12.1","@babel/preset-typescript":"7.12.7","@babel/register":"^7.0.0","@electron/fuses":"1.6.1","@sentry/cli":"1.51.1","@types/async":"3.2.3","@types/codemirror":"0.0.98","@types/core-js":"2.5.4","@types/dompurify":"2.3.3","@types/gulp":"4.0.6","@types/jest":"26.0.23","@types/lodash.debounce":"4.0.6","@types/lodash.toarray":"4.4.6","@types/node":"17.0.35","@types/react":"^16.8.25","@types/react-custom-scrollbars":"4.0.8","@types/react-dom":"17.0.9","@types/react-resizable":"1.7.3","@types/react-transition-group":"4.4.0","@types/react-virtualized":"9.21.12","@types/rimraf":"3.0.2","@types/sqlite3":"3.1.8","@types/workerpool":"6.1.0","@types/spark-md5":"3.0.2","@typescript-eslint/parser":"4.22.0","babel-core":"^7.0.0-bridge.0","babel-eslint":"^9.0.0","babel-jest":"^23.4.2","babel-plugin-encrypt-src":"^1.0.3","capitalize":"2.0.4","chai":"3.5.0","chalk":"1.1.3","connect":"3.6.6","combined-stream":"^1.0.8","consola":"2.15.0","coveralls":"2.11.12","cross-env":"^2.0.0-beta","debug":"4.1.1","devtron":"1.4.0","electron":"22.3.9","electron-builder":"20.44.4","electron-devtools-installer":"3.1.1","electron-download":"4.1.1","electron-notarize":"0.2.1","electron-publish":"19.53.3","enzyme":"3.3.0","eslint":"5.4.0","eslint-import-resolver-babel-module":"5.1.0","eslint-import-resolver-webpack":"0.6.0","eslint-plugin-babel":"3.3.0","eslint-plugin-import":"2.16.0","eslint-plugin-jest":"21.22.0","eslint-plugin-jsx-a11y":"2.1.0","eslint-plugin-react":"7.11.1","eslint-plugin-react-hooks":"2.4.0","eslint-watch":"2.1.14","faker":"5.5.3","globby":"11.0.1","gulp":"4.0.2","gulp-consolidate":"0.2.0","gulp-iconfont":"11.0.0","isparta":"4.0.0","jest":"23.6.0","jsftp":"1.5.5","lint-staged":"10.5.4","md5":"2.2.1","md5-file":"4.0.0","micromatch":"4.0.2","mocha":"4.1.0","ncp":"^2.0.0","node-abi":"^2.0.2","node-pre-gyp":"^0.6.37","nodemon":"1.11.0","npm":"6.14.2","npm-run-all":"2.3.0","open":"0.0.5","pre-commit":"1.2.2","prettier":"2.4.1","prompt":"1.0.0","react-hook-form":"7.31.3","react-hook-form-auto":"1.3.13","react-test-renderer":"16.5.1","recoilize":"2.0.1","redux-logger":"3.0.6","redux-perf-middleware":"1.1.0","regenerator-runtime":"0.13.7","replace":"0.3.0","rimraf":"2.5.4","serve-static":"1.13.2","shelving-mock-indexeddb":"1.0.8","sinon":"1.17.5","sinon-chai":"2.8.0","terser-webpack-plugin-legacy":"1.2.3","ts-jest":"26.5.6","ts-node":"8.10.2","typescript":"3.9.6","uglify-es":"3.3.7","uglifyjs-webpack-plugin":"1.1.6","utility-types":"3.10.0","walkdir":"0.0.12","webpack":"3.10.0","webpack-chain":"6.5.1","webpack-dev-middleware":"^2.0.4","webpack-hot-middleware":"^2.21.0","webpack-md5-hash":"0.0.5","webpack-strip":"0.1.0","webpack-virtual-modules":"0.4.3","yargs":"15.4.1"},"externals":[]}')},nUpV:function(e,t,s){"use strict";var i=s("jDHv"),n=s("YEoC"),r=(s("bSii"),s("UJ0r")),a=s("teaq");const o=n.a.IDB;var d,l=s("d/or");let c=i.ModuleContainer.injectable()(d=Reflect.metadata("design:type",Function)(d=Reflect.metadata("design:paramtypes",[])(d=class e{constructor(){this._preferAdapters=void 0,this._settings=void 0,this._preferAdapters=[],this._settings=new Map}get preferAdapters(){return this._preferAdapters}set preferAdapters(e){this._preferAdapters=e,this._settings.clear(),this.save();i.ModuleContainer.resolve(a.b).clearCache()}async load(){i.ModuleContainer.resolve(r.b);throw new Error("'zdb_setting' localStorage key is no longer in-use! Please remove it usage!")}async save(){e.deserializePreferAdapter(this._preferAdapters),e.deserializeDatabaseSettings(this._settings);throw new Error("'zdb_setting' localStorage key is no longer in-use! Please remove it usage!")}getPreferredAdapter(e){var t;return null===(t=this._settings.get(e))||void 0===t?void 0:t.preferAdapter}setPreferAdapter(e,t){let s=this._settings.get(e);s?s.preferAdapter=t:s={currentAdapter:t,preferAdapter:t},this._settings.set(e,s),this.save()}getCurrentAdapterType(e){let t=this._settings.get(e);return t||(t={currentAdapter:o},this._settings.set(e,t)),t.currentAdapter}setCurrentAdapter(e,t){let s=this._settings.get(e);s?s.currentAdapter=t:s={currentAdapter:t,preferAdapter:t},this._settings.set(e,s)}getDatabaseState(e){return this._settings.get(e)}static deserializePreferAdapter(e){return e.map((e=>e===n.a.IDB?"IDB":"SQLite"))}static serializePreferAdapter(e){return e.adapter.map((e=>"IDB"===e?n.a.IDB:n.a.SQLite))}static deserializeDatabaseSettings(e){return Array.from(e.entries())}static serializeDatabaseSettings(e){return new Map(e.databases)}})||d)||d)||d;i.ModuleContainer.registerSingleton(l.a,c)},o0oJ:function(e,t,s){(function(e){const t={};function s(e){return t[e]||(t[e]=0),t[e]+=1,100*e+t[e]}if(!e.perf){let t=()=>Date.now();const i={STARTUP:s(1),MIGRATION_DONE:s(2),MAIN_SCRIPT:s(2),LOADED_MAIN_SCRIPT:s(3),MAIN_APP_READY:s(3),LOADED_STARTUP_SCRIPT:s(2),STARTUP_BEFORE_HEAVY:s(3),CREATE_MAIN_WINDOW:s(3),SHOW_MAIN_WINDOW:s(3),MAIN_WINDOW_LOADING:s(3),MAIN_WINDOW_LOADED:s(3),APP_STARTUP:s(2),LOAD_APP_SCRIPT:s(3),APP_DID_MOUNT:s(3),CHATBOX_DID_MOUNT:s(3),SELECT_CONVERSATION:s(1),SELECTED_CONVERSATION:s(2)};e.perf={...i,perfRecords:[],record:s=>{s||(s=0);const i=[s,t()];e.perf.perfRecords.push(i)}}}}).call(this,s("kjmW"))},qLCR:function(e,t,s){"use strict";s.r(t);s("cOPa"),s("mNvP"),s("BtX6"),s("YpjI");var i=s("jDHv"),n=s("7wvk");i.ModuleContainer.registerSingleton(n.TFactoryMainless,class{constructor(){this.map=new Map,this.mainless=new Map}registerMainless(e,t){if(this.mainless.has(t))throw Error("mainless registered");this.mainless.set(t,e)}registerMethod(e,t){if(this.map.has(e))throw Error("method registered");this.map.set(e,t)}getMethodTarget(e){return this.map.get(e)}getMainless(e){const t=this.map.get(e);return this.mainless.get(t)}});var r=s("wq09");const a=i.ModuleContainer.resolve(n.TFactoryMainless),o={zip:r.b.node,unzip:r.b.node,md5:r.b.node,fileEexc:r.b.node,getDirSize:r.b.node,genThumbMacOfficeBuffer:r.b.node,genThumbWinOfficeBuffer:r.b.node},d={fileType:r.b.render,sha256:r.b.render,rmd5:r.b.render,genThumbPicBuffer:r.b.render,genPreviewThumb:r.b.render},l={sha256:r.b.web,genPreviewThumb:r.b.web,fileType:r.b.web};for(let Bh in l)a.registerMethod(Bh,l[Bh]);if("render"==__ZaBUNDLENAME__){for(let e in d)a.registerMethod(e,d[e]);for(let e in o)a.registerMethod(e,o[e])}var c=s("9jPG");class h{get instance(){return this._instance||(this._instance=new h),this._instance}constructor(){this._instance=void 0,this._do_not_use_me_pool=void 0,this._do_not_use_me_pool=Object(c.pool)(__SRC_MAINLESS_WORKER__,{workerType:"web",maxWorkers:1,minWorkers:1})}get pool(){return this.instance._do_not_use_me_pool}get proxy(){return this.pool.proxy()}exec(e,t,s){return Promise.resolve(this.execRaw(e,t,s))}execRaw(e,t,s){return this.pool.exec(e,t,s)}}const u=i.ModuleContainer.resolve(n.TFactoryMainless);{const e=new h;u.registerMainless(e,r.b.web),i.ModuleContainer.registerValue(n.TWebMainless,e)}var g=s("hzFW");class m{}class p{constructor(){this.instance=void 0}createAppPathManager(){return this.instance||(this.instance=new m),this.instance}}"function"==typeof importScripts||i.ModuleContainer.registerSingleton(g.a,p);var f=s("VTBJ"),v=s("mwIZ"),b=s.n(v),y=s("D1y2"),I=s.n(y),_=s("Y58e");i.ModuleContainer.registerSingleton(_.a,class{get(e){const t=s("NDmK").default;return b()(t,e)}set(e,t){const i=s("NDmK").default,n=Object(f.a)(Object(f.a)({},b()(i,e)),t);return I()(i,e,n)}});var M,C=s("jGDt"),T=s("igA5"),O=s("PLj1"),E=s("KRcn"),S=s("7FSS"),w=s("i15Q"),L=s("1pet");let D=Object(i.injectable)()(M=Reflect.metadata("design:type",Function)(M=Reflect.metadata("design:paramtypes",[])(M=class extends w.a{constructor(){super();const e=Object(E.a)();if(O.a.includes(e))this._enableConsole=!1;else{var t;const e=null===(t=T.a.getInstance())||void 0===t?void 0:t.getItem(L.ZLoggerLocalStorageKeys.RENDERER_CONSOLE_MODE);this._enableConsole="true"===e||!1}S.a.log("[ZLL]: Console logging",this._enableConsole?"enabled":"disabled")}enableConsole(){S.a.log("[ZLL]: Console logging enabled"),this._enableConsole=!0;const e=Object(E.a)();var t;O.a.includes(e)||(null===(t=T.a.getInstance())||void 0===t||t.setItem(L.ZLoggerLocalStorageKeys.RENDERER_CONSOLE_MODE,"true"))}disableConsole(){S.a.log("[ZLL]: Console logging disabled"),this._enableConsole=!1;const e=Object(E.a)();var t;O.a.includes(e)||(null===(t=T.a.getInstance())||void 0===t||t.setItem(L.ZLoggerLocalStorageKeys.RENDERER_CONSOLE_MODE,"false"))}})||M)||M)||M;i.ModuleContainer.registerSingleton(C.a,D);s("ezdo"),s("KdAX");var F=s("W8Xk");const R=Object(i.define)("kv-cache"),A=Object(i.define)("kv-cache-in-mem");var P;class N{constructor(e){this._prefix=void 0,this._prefix=`${e}-kv-db`}_buildKey(e){return`${this._prefix}-${e}`}async setItem(e,t){const s=this._buildKey(e),i=T.a.getInstance();return await i.setItemAsync(s,F.b(t)),t}async getItem(e){const t=this._buildKey(e),s=T.a.getInstance(),i=await s.getItemAsync(t);return Promise.resolve(i?F.a(i):void 0)}async removeItem(e){const t=this._buildKey(e),s=T.a.getInstance();return await s.removeItemAsync(t),this}}Object(i.singleton)(R)(P=class{createCache(e){return new N(`${e}`)}});var j,U=s("ndDP");class B{constructor(e,t){this._unused_name=e,this._lru=void 0,this._lru=new U.default(t)}setItem(e,t){return this._lru.set(e,t),Promise.resolve(t)}getItem(e){return Promise.resolve(this._lru.get(e))}removeItem(e){return this._lru.delete(e),Promise.resolve(this)}}Object(i.singleton)(A)(j=class{constructor(){this._registry={}}createCache(e,t){return this._registry[e]||(this._registry[e]=new B(e,t)),this._registry[e]}});s("0rWR"),s("Lq8m"),s("nUpV"),s("5yGw"),s("hRcX"),s("gpNb"),s("rhBN"),s("cF85");var k=s("4prX"),G=s("12Ui");i.ModuleContainer.registerSingleton(G.a,class{increaseSuccess(e,t,s,i,n){k.default.increaseSuccess(e,t,s,i,n)}increaseFailed(e,t,s,i,n,r,a){k.default.increaseFailed(e,t,s,i,n,r,a)}});var x=s("KhD4");i.ModuleContainer.registerSingleton(x.a,class{getAppDataPath(){throw new Error("Method not implemented.")}});var z,V=s("8/YW"),$=s("PmZf"),W=s("tHMN"),q=s("jIg3"),K=s("fsN4"),H=s("Mgpg");let Q=i.ModuleContainer.injectable()(z=function(e,t){return i.ModuleContainer.inject(W.b)(e,void 0,0)}(z=function(e,t){return i.ModuleContainer.inject(H.ZLoggerFactory)(e,void 0,1)}(z=Reflect.metadata("design:type",Function)(z=Reflect.metadata("design:paramtypes",[void 0===W.a?Object:W.a,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(z=class extends q.a{constructor(e,t){super(),this.engine=e,this.logger=void 0,this.logger=t.createZLogger("db",["browser"]),this.engine.addEventListener($.a.UnexpectedError,(e=>{this.dispatchEvent(new $.d(e.error))})),this.engine.addEventListener($.a.QueryError,(e=>{this.dispatchEvent(new $.b(e.error))}))}install(){const e=i.ModuleContainer.resolve(V.a);e.addEventListener(V.b.Authenticated,(e=>{this.authenticate(e.getSession())})),e.currentSession&&this.authenticate(e.currentSession),this.logger.zsymb(3,10296,3e4,"installed")}areYouOk(){return!0}authenticate(e){e&&(this.session=e,this.dispatchEvent(new $.c(e)),this.logger.zsymb(0,10296,30001,(()=>["authenticated",`id: ${e.userId}`])))}async closeDBs(e){const t=K.a.getInstance();let s=[];e?e.length&&(s=e.map((e=>t[e].closeThisDatabase()))):s=[t.closeAllDatabases()],await Promise.all(s)}})||z)||z)||z)||z)||z;i.ModuleContainer.registerSingleton(q.b,Q);var J,Z=s("W8fB");let X=Object(i.injectable)()(J=class{})||J;i.ModuleContainer.registerSingleton(Z.b,X);var Y=s("AH6j"),ee=s("fsQs"),te=s("HPcM");let se;!function(e){e.Binary="zlog",e.Text="log"}(se||(se={}));se.Binary,se.Text;let ie,ne;!function(e){e.PhysicalTextWriter="PhysicalTextWriter",e.PhysicalBinaryWriter="PhysicalBinaryWriter",e.PhysicalMeta="PhysicalMeta"}(ie||(ie={})),function(e){e.Init="Init",e.Idle="Idle",e.Busy="Busy",e.Paused="Paused",e.Disabled="Disabled"}(ne||(ne={}));const re=Object(i.define)("virtual-file-writer");var ae;let oe=Object(i.injectable)()(ae=function(e,t){return Object(i.inject)(te.a)(e,void 0,0)}(ae=function(e,t){return Object(i.inject)(re)(e,void 0,1)}(ae=Reflect.metadata("design:type",Function)(ae=Reflect.metadata("design:paramtypes",[void 0===te.a?Object:te.a,void 0===re?Object:re])(ae=class extends Y.b{constructor(e,t){super(),this.bucket=e,this.logWriter=t,this._mode=void 0,this.status=ne.Init,this._mode=se.Binary}async init(){ee.n&&S.a.log("DBLogWriterImpl.init()");try{await this.logWriter.loadMeta(),this._mode===se.Binary&&await this.logWriter.loadModule()}catch(e){S.a.debug("[ZLL]: DBLogWriterImpl.init() failed",e)}this.status=ne.Idle,ee.n&&S.a.log("[ZLL]: DBLogWriterImpl init() DONE",ne[this.status])}async flush(){if(this.status!==ne.Idle)return;let e=Date.now();if(0===this.bucket.size())return;ee.n&&S.a.log(`FLUSHING: ${this.bucket.size()} logs => DB`),this.status=ne.Busy;const t=this.bucket.get(ee.j),s=t.length;await this.logWriter.write(t)?(await this.logWriter.flushMetas(),this.bucket.removeFirst(s-t.length)):t.length>0&&S.a.error(`[ZLL]: flush failed: ${s-t.length}/${s}. failed:${t.length}/${s}`),this._mode===se.Binary&&await this.logWriter.flushModules(),this.status=ne.Idle,ee.n&&S.a.log(`FLUSHED: ${s-t.length}/${s} logs => DB. TOOK: ${Date.now()-e}ms`)}})||ae)||ae)||ae)||ae)||ae;var de,le=s("ebA4"),ce=s("ez9R"),he=s("XuBa"),ue=s("j6JD");const ge={id:0,current:0,currentPage:0,startups:[],ss:-1,ss_ln:-1};let me=Object(i.injectable)()(de=Reflect.metadata("design:type",Function)(de=Reflect.metadata("design:paramtypes",[])(de=class{constructor(){this._status=void 0,this.BinEncoder=null,this.DB=void 0,this.currentPage=void 0,this.module=new Map,this.metas={data:ge,updateRequired:!1},this._status=ne.Idle,this.DB=K.a.getInstance().ZLog}get status(){return this._status}async write(e){try{return this._status=ne.Busy,await this.encodeFit(e,this.metas),this._status=ne.Idle,!0}catch(t){return S.a.error(`[ZLL]: VirtualFileWriterImpl.write err ${t}`),this._status=ne.Idle,!1}}async collectAllLogs(){try{const e=(await this.DB.Pages.getAll()).map((e=>e.data.slice(0,e.curoffs))),t=new Blob(e);return await t.arrayBuffer()}catch(e){return S.a.error(`[ZLL]:VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}async read(e){try{return await this.DB.Pages.get(e)}catch(t){return void S.a.error(`[ZLL]: VirtualFileWriterImpl.reading ${e} err ${t}`)}}async delete(e){try{return await this.DB.Pages.delete(e),!0}catch(t){return S.a.error(`[ZLL]:VirtualFileWriterImpl.deleting ${e} err ${t}`),!1}}async encodeFit(e,t){var s;if(0===e.length)return;const i=[],n=ee.d.page_limit;this.currentPage&&this.currentPage.id===t.data.currentPage||(this.currentPage=await this.DB.Pages.get(t.data.currentPage),this.currentPage&&(this.currentPage.curoffs=0));let r=0;const a=n-((null===(s=this.currentPage)||void 0===s?void 0:s.curoffs)||0);let o=ee.c.OK;for(;e.length;){const t=await this.encodeBinary(e[0]);if(r+t.byteLength>a){o=ee.c.OVERSIZE_NEXTPAGE;break}i.push(new Uint8Array(t)),r+=t.byteLength,e.shift()}if(0===i.length&&o===ee.c.OVERSIZE_NEXTPAGE){if(this.currentPage&&this.currentPage.curoffs<this.currentPage.data.size){const e=this.currentPage.data.slice(0,this.currentPage.curoffs);this.currentPage.data=e,await this.DB.Pages.insert(this.currentPage,{replace:!0})}return this.nextPage(t),void(await this.DB.Metas.insert(t.data,{replace:!0}))}if(!i.length)return;const d=this.combineArrayBuffers(i);if(this.currentPage){if(d.byteLength){const e=this.currentPage.data.slice(0,this.currentPage.curoffs),t=new Blob([e,d]);this.currentPage.data=t,this.currentPage.curoffs+=d.byteLength,this.currentPage.max=ee.d.page_limit,this.currentPage.mtime=Date.now()}o===ee.c.OVERSIZE_NEXTPAGE?this.nextPage(t):t.data.current=this.currentPage.curoffs,d.byteLength&&await this.DB.Pages.insert(this.currentPage,{replace:!0});try{await this.DB.Metas.insert(t.data,{replace:!0})}catch(l){S.a.error("[ZLL]: VirtualFileWriterImpl.encodeFit err2",l)}}else{this.currentPage={id:t.data.currentPage,data:new Blob([d]),curoffs:d.byteLength,max:ee.d.page_limit,mtime:Date.now()},t.data.current=d.byteLength;try{await this.DB.Pages.insert(this.currentPage,{replace:!0}),await this.DB.Metas.insert(t.data,{replace:!0})}catch(l){S.a.error("[ZLL]:VirtualFileWriterImpl.encodeFit err",l)}}}combineArrayBuffers(e){const t=e.reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(t);let i=0;for(const n of e)s.set(new Uint8Array(n),i),i+=n.byteLength;return s.buffer}getSessionLineId(){let e=this.metas.data.ss;const t=(this.metas.data.ss_ln+1)%ee.m.SESSION_LINE_MAX;return 0===t&&(e=(e+1)%ee.m.SESSION_MAX),this.metas.data.ss=e,this.metas.data.ss_ln=t,{ss:e,ss_ln:t}}encodeText(e){const t=this.getSessionLineId();return Object(le.b)(e,t).buffer}async encodeBinary(e){this.BinEncoder||(this.BinEncoder=i.ModuleContainer.resolve(ce.a));const t=await this._getModule([e.lineMeta.module,e.lineMeta.features]),s=this.getSessionLineId();return this.BinEncoder.encode(e,t.data.id,s)}nextPage(e){const t=ee.d.page_limit,s=ee.d.file_lim,i=Math.floor(s/t),n=(e.data.currentPage+1)%i;return e.updateRequired=!0,e.data.currentPage=n,e.data.current=0,e}async loadMeta(){try{let e=await this.DB.Metas.get(0);e||(e=ge),e.startups.length>ee.a&&(e.startups=e.startups.slice(0,ee.a)),e.startups.unshift(Object(ue.a)(Date.now())),e.ss=void 0!==e.ss?e.ss:-1,e.ss_ln=-1,this.metas.data=e,this.metas.updateRequired=!1}catch(e){S.a.error(`[ZLL]: VirtualFileWriterImpl.loadMeta err ${e}`)}return await this._loadCurrentPage(),this.metas}async flushMetas(){this.metas.updateRequired&&await this.DB.Metas.insert(this.metas.data,{replace:!0,retry:1})}async loadModule(){try{const e=await this.DB.Modules.getAll();if(e){const t=e.map((e=>[he.a.decrypt(e.hash),{data:e,updateRequired:!1}]));this.module=new Map(t)}}catch(e){S.a.error(`[ZLL]: VirtualFileWriterImpl.loadModule err ${e}`)}return this.module}async flushModules(){const e=Array.from(this.module.values());for(const t of e)t.updateRequired&&(await this.DB.Modules.insert(t.data,{retry:1}),t.updateRequired=!1)}async _loadCurrentPage(){this.metas||await this.loadMeta();const e=await this.DB.Pages.get(this.metas.data.currentPage);return this.currentPage=e,e}async _getModule(e){const t=JSON.stringify(e),s=this.module.get(t);if(s)return s;const i=he.a.encrypt(t),n={data:{id:this.module.size,hash:i},updateRequired:!0};return this.module.set(t,n),n}})||de)||de)||de;i.ModuleContainer.registerSingleton(re,me),i.ModuleContainer.registerSingleton(Z.c,oe);const pe=Object(i.define)("zlog-writer-manager");var fe,ve=s("Y41u"),be=s("K8kB");let ye=Object(i.injectable)()(fe=function(e,t){return Object(i.inject)(be.a)(e,void 0,0)}(fe=function(e,t){return Object(i.inject)(Z.c)(e,void 0,1)}(fe=function(e,t){return Object(i.inject)(Z.b)(e,void 0,2)}(fe=Reflect.metadata("design:type",Function)(fe=Reflect.metadata("design:paramtypes",[void 0===be.a?Object:be.a,void 0===Z.c?Object:Z.c,void 0===Z.b?Object:Z.b])(fe=class{constructor(e,t,s){this._writeScheduler=e,this.zlogWriter=t,this.senWriter=s,this._handleFlushRequest=()=>{this.zlogWriter.flush()},this._handleWriterStatus=e=>{}}setupWriters(){this.zlogWriter.init(),this._writeScheduler.start(),this._listenEvents()}_listenEvents(){this._writeScheduler.addEventListener(ve.c.WriteSchedulerRequestFlush,this._handleFlushRequest),this.zlogWriter.addEventListener(ve.c.WriterStatus,this._handleWriterStatus)}})||fe)||fe)||fe)||fe)||fe)||fe;i.ModuleContainer.registerSingleton(pe,ye);var Ie,_e=s("OMsT"),Me=s("XS0u");let Ce=Object(i.injectable)()(Ie=class{clientDeviceInfo(){return navigator.userAgent}prepareLogBlob(e){return new Promise(((t,i)=>{let n=e.viewerKey;if(!n){n=Me.default.getLastViewKey()||"";try{var r;n=null===(r=n)||void 0===r?void 0:r.split(".")[0]}catch{}}const a=new(s("xOOu")),o=[this.collectLDBLogs(),this.collectLDBMetas(),this.collectLDBModules()];Promise.all(o).then((s=>{const[r,o,d]=s;{const e=`${Object(E.a)()}.zlog`;a.file(e,r)}{const e=`${Object(E.a)()}.meta`;a.file(e,o)}{const e=`${Object(E.a)()}.module`;a.file(e,d)}{const e="device.zinfo",t=new TextEncoder;a.file(e,t.encode(this.clientDeviceInfo()).buffer)}a.generateAsync({type:"arraybuffer",compression:"DEFLATE"}).then((s=>{if(e.bareContent)t({name:`zlog_${n}_${Date.now()}.zip`,data:new Uint8Array(s)});else{const e=new Blob([new Uint8Array(s)]);e.name=`zlog_${n}_${Date.now()}.zip`,t(e)}})).catch((e=>{i(e)}))}))}))}async collectLDBLogs(){try{const e=K.a.getInstance().ZLog,t=(await e.Pages.getAll()).map((e=>e.data)),s=new Blob(t);return await s.arrayBuffer()}catch(e){return S.a.error(`VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}async collectLDBMetas(){try{const e=K.a.getInstance().ZLog,t=await e.Metas.get(0);if(t){const e=new Blob([JSON.stringify({current:t.current,currentPage:t.currentPage,startups:t.startups})]);return await e.arrayBuffer()}return new ArrayBuffer(0)}catch(e){return S.a.error(`VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}async collectLDBModules(){try{const e=K.a.getInstance().ZLog,t=await e.Modules.getAll();if(t){const e={size:0};t.forEach((t=>{e[t.hash]=t.id,e.size++}));const s=new Blob([JSON.stringify(e)]);return await s.arrayBuffer()}return new ArrayBuffer(0)}catch(e){return S.a.error(`VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}})||Ie;i.ModuleContainer.registerSingleton(_e.a,Ce);s("jw3m");var Te=s("q1tI"),Oe=s.n(Te),Ee=s("i8i4"),Se=s.n(Ee),we=s("Jcee");class Le extends we.b{constructor(e,t,s,i){super(e,t,s),this.container=void 0,this.component=void 0,this.container=i.container,this.component=i.component}async start(){await super.start(),this.render()}render(){Se.a.render(Oe.a.createElement(this.component),this.container)}}let De,Fe;!function(e){e.Idle="Idle",e.Active="Active"}(De||(De={})),function(e){e[e.idle=0]="idle",e[e.active=1]="active"}(Fe||(Fe={}));class Re extends Y.b{constructor(e){super(),this.status=Fe.active,this.window=void 0,this.idleDelay=void 0,this.minimumIdlePeriod=void 0,this.lastIdleTime=void 0,this.focusStateChangeDebounceTimer=void 0,this.handleDocumentBlur=()=>{this.resetFocusStateChangeDebounceTimer(),this.focusStateChangeDebounceTimer=setTimeout((()=>{this.setStateToIdle()}),this.idleDelay)},this.handleDocumentFocus=()=>{this.resetFocusStateChangeDebounceTimer(),this.setStateToActive()},this.idleDelay=e.idleDelay,this.minimumIdlePeriod=e.minimumIdlePeriod,this.window=e.window||window,this.lastIdleTime=0,this.focusStateChangeDebounceTimer=null}start(){this.window.addEventListener("blur",this.handleDocumentBlur),this.window.addEventListener("focus",this.handleDocumentFocus)}stop(){this.window.removeEventListener("blur",this.handleDocumentBlur),this.window.removeEventListener("focus",this.handleDocumentFocus)}onIdle(e){return this.addEventListener(De.Idle,e)}setStateToActive(){this.status!==Fe.idle||(this.status=Fe.active,this.dispatchEvent(new Event(De.Active)))}setStateToIdle(){if(this.status!==Fe.active)return;this.isThrottlingIdleState()||(this.lastIdleTime=Date.now(),this.status=Fe.idle,this.dispatchEvent(new Event(De.Idle)))}isThrottlingIdleState(){return Date.now()-this.lastIdleTime<this.minimumIdlePeriod}resetFocusStateChangeDebounceTimer(){this.focusStateChangeDebounceTimer&&(clearTimeout(this.focusStateChangeDebounceTimer),this.focusStateChangeDebounceTimer=null)}}var Ae=s("wx14"),Pe=s("/MKj"),Ne=s("FK2X"),je=s("emRR"),Ue=s("xrk1"),Be=s("ZBGy"),ke=s("T1Xd"),Ge=s("uzdi");const xe=Object(Ge.a)();function ze(){const e=xe.useRecoilSnapshot();return xe.setSnapShot(e),null}var Ve=s("QVmZ"),$e=s("72hn"),We=s("ZlRg"),qe=s("VaDh"),Ke=s("CzFt"),He=s("h0sc"),Qe=s("L+5E"),Je=s("UiPd"),Ze=s("Yi2m"),Xe=s("6uTC"),Ye=s("c51z"),et=s("sqm0"),tt=s("NTw/");var st=s("hI9i");const it=()=>{const e=Object(Pe.f)(),t=Object(Be.d)(e),s=Object(Be.c)(),i=Object(Pe.g)((e=>({user:e.user,popup:e.popup,status:e.status,profile:e.profile,zaviState:e.zaviState,chatview:e.chatview})));return(e=>{const t=Object(Te.useCallback)((()=>{He.ModalManagerV2.openModal({windowId:"1",name:L.ModalIdentitiesDefine.SETTINGS,params:!0,forceCloseAll:!0})}),[]),s=Object(Te.useCallback)((()=>{He.ModalManagerV2.openModal({windowId:"1",name:L.ModalIdentitiesDefine.APP_INFO,params:!0})}),[]),i=Object(Te.useCallback)(((e,t)=>{Qe.a.doOpenZaviURL(t,"1")}),[]),n=Object(Te.useCallback)(((e,t)=>{var s;et.a.setFlagCopyFromCapture(!!t&&!!t.isCopyFromCap),et.a.setTimeClipboardChanged(performance.now()),null===(s=Object(tt.b)())||void 0===s||s.setTimeClipboardChanged(performance.now())}),[]),r=(t,s)=>{const i=Je.default.getFriendsSync();Qe.a.doActionWithUri(s,e,i)},a=(t,s)=>{let{term:i,data:n}=s;switch(i){case"id":Qe.a.autoOpenConversationById(n,e),n.startsWith(L.GROUPID_PREFIX)?Ze.e.logAction(2220801):n.startsWith(L.OA_ID_PREFIX)?Ze.e.logAction(2220803):Ze.e.logAction(2220802);break;case"phone":Ze.e.logAction(2220804),Qe.a.autoOpenConversationByPhone(n,e);break;case"username":Ze.e.logAction(2220805),Qe.a.autoOpenConversationByUsername(n,e);break;default:Xe.a.createError(Ye.default.str("STR_GROUP_NO_EXIST"))}};Object(Te.useEffect)((()=>($zsub.$zuri.onNewRequest(r),$zsub.$zuri.onRequestOpenConv(a),()=>{$zsub.$zuri.removeListenNewRequest(r),$zsub.$zuri.removeListenRequestOpenConv(a)})),[e]),Object(Te.useEffect)((()=>{$zsub.$zapp.onRequestShowPreference(t),$zsub.$zapp.onRequestShowAbout(s),$zsub.$zuri.onRequestOpenZavi(i),$zsub.$zresource.onClipboardChange(n)}),[])})(t),Oe.a.createElement(Ne.c,Object(Ae.a)({emitter:s,dispatch:t},i))},nt=function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return e=>{let{children:s}=e;return t.reduceRight(((e,t)=>{let[s,i={}]=t;return Oe.a.createElement(s,i,e)}),s)}}([Pe.a,{store:je.default}],[Pe.a,{store:Ke.a,context:Ke.b}],[Pe.a,{store:Ve.a,context:$e.a}],[Pe.a,{store:We.a,context:qe.a}],[Pe.a,{store:st.b,context:st.a}],[Be.b],[Ue.d],[ke.a]),rt=()=>Oe.a.createElement(nt,null,Oe.a.createElement(ze,null),Oe.a.createElement(it,null));var at;let ot=Object(i.injectable)()(at=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(at=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,1)}(at=Reflect.metadata("design:type",Function)(at=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(at=class extends Le{constructor(e,t){super("zalo",e,t,{component:rt,container:document.getElementById("app")})}async start(){this.setupIdleDetector(),await super.start()}setupIdleDetector(){const e=this.config.get("idle_detector"),t=new Re(e);t.addEventListener(De.Idle,(()=>{this.setStateToIdle()})),t.addEventListener(De.Active,(()=>this.setStateToActive())),t.start(),this.disposables.add((()=>t.stop())),document.hasFocus()?this.setStateToActive():this.setStateToIdle()}})||at)||at)||at)||at)||at;i.ModuleContainer.registerSingleton(V.a,ot);var dt=s("sxU/"),lt=s("SZ0g");i.ModuleContainer.registerValue(lt.a,new class{constructor(){this._emitter=void 0,this._emitter=dt.a.instance}emit(e){return this._emitter.emit(e.topic,e),Promise.resolve()}on(e,t){return this._emitter.on(e,t),this}off(e,t){return this._emitter.off(e,t),this}});s("ahRi");var ct=s("ptxg"),ht=s("pUq9");let ut;ut=class{getOverrideDomain(e){}getDomainConfig(){return{}}setDomainConfig(e){return this}subscribe(e){return()=>{}}},Object(i.injectable)()(ut),Object(i.singleton)(ct.a)(ut);var gt,mt,pt=s("NDmK"),ft=s("qLo6");Object(V.e)()(gt=class{onAuthenticated(e){pt.default.e2ee.enable_wasm&&ft.AesGcmWasmFactory.instance.installAndTestWasm().then((()=>{})).catch((e=>{}))}}),Object(V.e)()(mt=class{onAuthenticated(e){try{WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]))?k.default.increaseSuccess(97135,0,0):k.default.increaseFailed(97135,0,0,0,0)}catch{k.default.increaseFailed(97135,0,0,1,0)}}});s("o0oJ");var vt=s("dThN"),bt=s("z0WU"),yt=s("vSga");perf.record(perf.LOAD_APP_SCRIPT),function(){window.__loadTimer&&clearTimeout(window.__loadTimer);window.__startTime&&$zlogger.loadShellQos(Date.now()-window.__startTime)}();s("FcQj");var It=s("Ydol"),_t=s("97kL"),Mt=s("eSGF");let Ct;function Tt(){return Ct||(Ct=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger("utils",["event-bus-effects"])),Ct}const Ot={[_t.FetchActions.DELETE_EVERYONE]:(e,t)=>{Et(e.toUid,e.msgId)},[_t.FetchActions.UNDO_MULTI]:(e,t)=>{var s;null==e||null===(s=e.forEach)||void 0===s||s.call(e,(e=>Et(e.toUid||e.userId,e.msgId)))},[_t.FetchActions.UNDO]:(e,t)=>{Et(e.toUid||e.userId,e.msgId)},[_t.FetchActions.REMOVE_MEDIA]:(e,t)=>{for(let s of e.items)Et(null==e?void 0:e.conversationId,null==s?void 0:s.msgId)},[_t.ChatBoxActions.REMOVE_EXPIRED_MEDIA]:(e,t)=>{Et(null==e?void 0:e.conversationId,(null==e?void 0:e.msgIds)||(null==e?void 0:e.msgId))},[_t.ChatBoxActions.DELETE_MESSAGE]:(e,t)=>{const s=e.toUid||e.userId||e.conversation&&e.conversation.userId;s!==pt.default.sendToMeId&&Et(s,e.msgId)}};function Et(e,t){if(!e)return;if(!t)return;let s=Object(Mt.a)(t);dt.a.instance.emit("media-removed",{convId:e,msgIds:s})}It.default.subscribe((function(e,t){let s=Ot[e];if(s)try{s(t,e)}catch(i){Tt().zsymb(18,10277,3e4,"Failed to run side effect for event:"+e),Tt().zsymb(18,10277,30001,[i])}}));var St=s("2ua2");s.p;St.a.init(),bt.default.checkSupport(),bt.default.showWarningMsg();var wt,Lt=s("Kvb3"),Dt=s("QPNp");Object(i.singleton)(Lt.a)(wt=Object(V.e)()(wt=Reflect.metadata("design:type",Function)(wt=Reflect.metadata("design:paramtypes",[])(wt=class{constructor(){this._isConnectSignalChangeInfo=void 0,this._dispatch=void 0,this._authEvent=void 0,this._isConnectSignalChangeInfo=!1,this.signalInfoChange=this.signalInfoChange.bind(this)}isWeb(){return!0}bindDispatch(e){this._dispatch=e}getDispatch(){return this._dispatch}async preFormatPayload(e){let t=Object(f.a)({},e);if(t.conversation){var s,i;if(null===(s=t.conversation.userId)||void 0===s||null===(i=s.startsWith)||void 0===i?void 0:i.call(s,L.GROUPID_PREFIX)){const e=t.conversation.userId,s=await Dt.a.GroupManager.get(e);if(s&&(t.conversation.topMember=s.topMembers,t.conversation.displayName=s.displayName),t.conversation.topMember)for(const i of t.conversation.topMember){const e=Je.default.getMiniInfo(i.id);e&&(i.dName=e.dName,i.avatar=e.avatar)}}else{const e=Je.default.getMiniInfo(t.conversation.userId);e&&(t.conversation.displayName=e.dName,t.conversation.avatar=e.avatar)}}return t}signalInfoChange(e){this.isWeb()}connectSignalToFriendWorker(){this._isConnectSignalChangeInfo||(this._isConnectSignalChangeInfo=!0,Je.default.connectSignalChangeDNameAndAvatar(this.signalInfoChange))}onAuthenticated(e){this._authEvent=e}_addSession(e){var t;return(e=Object(f.a)({},e)).session=null===(t=this._authEvent)||void 0===t?void 0:t.getSession(),e}async openPhotoViewer(e){let t=await this.preFormatPayload(e);t=this._addSession(t),this.connectSignalToFriendWorker();const s=this.getDispatch();s&&s({type:_t.ChatBoxActions.SHOW_FULL_IMAGE,payload:t})}})||wt)||wt)||wt);var Ft,Rt=s("vQ8b"),At=s("smi1"),Pt=s("gEkt"),Nt=s("yzMR");let jt=Object(i.injectable)()(Ft=function(e,t){return i.ModuleContainer.inject(Nt.i)(e,void 0,0)}(Ft=function(e,t){return i.ModuleContainer.inject(Nt.h)(e,void 0,1)}(Ft=Reflect.metadata("design:type",Function)(Ft=Reflect.metadata("design:paramtypes",[void 0===Nt.i?Object:Nt.i,void 0===Nt.h?Object:Nt.h])(Ft=class{constructor(e,t){this.unreadDataManager=e,this.previewManager=t,this.menuRef=void 0,this.menuRef={}}deleteConversation(e,t){void 0===t&&(t=!0),e!=L.CONV_FILTER.STRANGER&&(bt.default.logCoreError(`[user call del conv] ${e}`),At.a.deleteConversation(e,t).then((e=>{e&&e.delConversationId&&Object(Be.f)({type:_t.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{bt.default.logCoreError("Delete conversation fail - "+JSON.stringify(e))})))}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===Pt.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]&&this.menuRef[e].close()}showConvActionMenu(e,t){if(t&&t.friendItem)return;const s=Object(f.a)({},t),i=s.userId;if(s&&!bt.default.isFakeId(i)){const e=this.previewManager.getPreviewByIDSync(i),t=Je.default.getProfileFriendByIdSync(i)||{},n=this.unreadDataManager.getUnreadByConvIdSync(i);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.type=t.type,s.unreadMark=null==n?void 0:n.unreadMark,s.smsUnreadCount=null==n?void 0:n.smsUnreadCount}this.menuRef[Pt.b].updateTargetInfo(s),this.menuRef[Pt.b].showAction(Object(f.a)({},e))}})||Ft)||Ft)||Ft)||Ft)||Ft;var Ut,Bt=s("rCQs"),kt=s("iZzu"),Gt=s("6Vk1"),xt=s("RojW"),zt=s("rXIX"),Vt=s("EFQ6"),$t=s("3xbP"),Wt=s("l+Gc"),qt=s("VTLO"),Kt=s("LJTV"),Ht=s("Enw1"),Qt=s("PoHQ"),Jt=s("M7kw"),Zt=s("Ws4b"),Xt=s("Ja3U"),Yt=s("SdS7"),es=s("WQAo"),ts=s("Gm1y"),ss=s("P6UB"),is=s("FEfs"),ns=s("h0S/");const rs={typeFilter:kt.FilterType.ALL,labelFilters:[],loaded:!1,isEnableArchivedChat:!!is.a.isEnableArchivedChat(),hasUnreadArchivedChat:!1,typeFilterSrc:kt.FilterSrcType.ALL},as="z_sendtome_bubbledot";Object(Bt.b)(kt.ConvListController)(Ut=function(e,t){return i.ModuleContainer.inject(Nt.b)(e,void 0,0)}(Ut=function(e,t){return i.ModuleContainer.inject(Gt.b)(e,void 0,1)}(Ut=function(e,t){return i.ModuleContainer.inject(Nt.i)(e,void 0,2)}(Ut=function(e,t){return i.ModuleContainer.inject(Nt.f)(e,void 0,3)}(Ut=function(e,t){return i.ModuleContainer.inject(Nt.g)(e,void 0,4)}(Ut=function(e,t){return i.ModuleContainer.inject(Nt.a)(e,void 0,5)}(Ut=Reflect.metadata("design:type",Function)(Ut=Reflect.metadata("design:paramtypes",[void 0===Nt.b?Object:Nt.b,void 0===Gt.b?Object:Gt.b,void 0===Nt.i?Object:Nt.i,void 0===Nt.f?Object:Nt.f,void 0===Nt.g?Object:Nt.g,void 0===Nt.a?Object:Nt.a])(Ut=class extends Y.b{constructor(e,t,s,i,n,r){var a;super(),a=this,this.convDataManager=e,this.labelDataManager=t,this.unreadDataManager=s,this.muteDataManager=i,this.pinDataManager=n,this.archivedChatManager=r,this.typeFilter=void 0,this.labelFilters=void 0,this.listRawAll=void 0,this.listVisible=void 0,this.listStrangers=void 0,this.listHiddens=void 0,this.listFiltered=void 0,this.newestStrangerId=void 0,this.menuRef=void 0,this.convUIListContainer=void 0,this.showedOnboarding=void 0,this.loaded=void 0,this.isEnableArchivedChat=void 0,this.typeFilterSrc=void 0,this.hasUnreadArchivedChat=void 0,this._logger=void 0,this._pm=null,this._sbc=null,this.handleMuteChange=e=>{const t=e.convId,s=e.payload,i=this.listFiltered.includes(t);this.logger.zsymb(0,10577,30002,"handleMuteChange",t,i,this.typeFilter,s),i&&(this.typeFilter===kt.FilterType.UNREAD||this.isEnableArchivedChat&&this.typeFilterSrc===kt.FilterSrcType.UNREAD)&&this.addConvToUnreadFilterV2(t)},this.deleteConversation=function(e,t){void 0===t&&(t=!0),e!=L.CONV_FILTER.STRANGER&&(a.logger.zsymb(18,10577,30006,`[user call del conv] ${e}`),At.a.deleteConversation(e,t).then((e=>{e&&e.delConversationId&&Object(Be.f)({type:_t.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{a.logger.zsymb(18,10577,30007,"Delete conversation fail - "+JSON.stringify(e))})))},this.name=kt.CONV_LIST_CONTROLLER,this.data=new Map,this.key="windowId",this.isEnableArchivedChat=!1,this.typeFilter=kt.FilterType.ALL,this.labelFilters=[],this.typeFilterSrc=kt.FilterSrcType.ALL,this.listRawAll=new Set,this.listVisible=[],this.listStrangers=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="",this.menuRef={},this.showedOnboarding=!1,this.loaded=!1,this.hasUnreadArchivedChat=!1,this.getRecentContactWithId=this.getRecentContactWithId.bind(this),this.selectConversation=this.selectConversation.bind(this),this.showBroadCastMsgModal=this.showBroadCastMsgModal.bind(this),this.markAsRead=this.markAsRead.bind(this),this.addListener()}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.conversation,[ns.b.convList])),this._logger}get previewManager(){return this._pm||(this._pm=i.ModuleContainer.resolve(Nt.h)),this._pm}get sidebarController(){return this._sbc||(this._sbc=i.ModuleContainer.resolve(kt.SidebarController)),this._sbc}get currUser(){return Object(Zt.c)()}onTypeFilterChange(e,t){if(e===kt.FilterType.UNREAD){const e=this.labelFilters.length>0?1453215:1453214;Ze.e.logAction(e),setTimeout((()=>{this.scrollToTop(!1)}))}else e!==kt.FilterType.ARCHIVED&&e!==kt.FilterType.FOCUSED||this.typeFilter===e||setTimeout((()=>{this.scrollToTop(!1)}));e==kt.FilterType.ARCHIVED&&this.hasUnreadArchivedChat&&(this.hasUnreadArchivedChat=!1),this.applyTypeFilter(e,t)}onLabelFilterChange(e){this.typeFilter===kt.FilterType.UNREAD&&setTimeout((()=>{this.scrollToTop(!1)})),this.applyLabelFilter(e)}rerenderList(){this.signalRenderList()}async onPreviewChange(e,t){if(!e||!t)return;const s=e.convId;if(this.listRawAll.add(s),Vt.a.isThreadHidden(s))return void this.listHiddens.push(s);let i=s,n=!1,r=!1,a=!1;if(await xt.a.isOATypeAsync(s)){const e=this.convDataManager.getConvByIdSync(s);if(!e||!xt.a.popoutOA(e))return}else if(xt.a.isStrangerV2(s)&&(n=!0,this.listStrangers.includes(s)||(this.logger.zsymb(0,10577,30001,`first new stranger msg ${s}`),this.listStrangers.push(s)),!this.isMeBAAccount())){const t="0"==e.fromUid||this.convDataManager.isRespondedByMeSync(s),n=this.listVisible.includes(s);t||(n&&(a=!0,this.listVisible=this.listVisible.filter((e=>e!==s))),this.updateNewestStrangerId(this.listStrangers),i=L.CONV_FILTER.STRANGER),t&&!n&&(r=!0,this.listVisible.unshift(s),this.newestStrangerId===s&&this.updateNewestStrangerId(this.listStrangers))}const[o,d]=xt.a.insertToProperPosition(this.listVisible,i,this.getAlterId());this.listVisible=o;const l=Wt.b.getLabelObjByConversaionId(s),c=l&&l.id&&this.labelFilters.includes(""+l.id),h=n&&this.labelFilters.includes(Pt.h),u=c||h,g=d||r||a;if(this.typeFilter===kt.FilterType.ALL)this.addTabAllFiltered(s,u,g);else if(this.typeFilter===kt.FilterType.UNREAD)this.addTabUnreadFiltered(s,u,n);else if(this.typeFilter===kt.FilterType.STRANGER){const e=c||!this.labelFilters.length,t=n&&e;this.addTabStrangerFiltered(s,t)}else this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===kt.FilterType.ARCHIVED,this.labelFilters),this.signalRenderList())}addTabAllFiltered(e,t,s){if(t){const[t,s]=xt.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());s&&(this.listFiltered=t,this.signalRenderList())}else s&&this.signalRenderList()}addTabUnreadFiltered(e,t,s){if(this.listFiltered.includes(e)||!ss.b.isMyMessage(this.previewManager.getPreviewByIDSync(e)))if(t)this.addConvToUnreadFilterV2(e);else{if(this.labelFilters.length)return;this.isMeBAAccount()||!s?this.addConvToUnreadFilterV2(e):this.addConvToUnreadFilterV2(L.CONV_FILTER.STRANGER)}}addTabStrangerFiltered(e,t){if(!t)return;const[s,i]=xt.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());i&&(this.listFiltered=s,this.signalRenderList())}addConvToUnreadFilterV2(e){if(this.muteDataManager.isMuted(e)&&!xt.a.getPinFromConvId(e))this.listFiltered=this.safeSortConvList(this.listFiltered,!0),this.signalRenderList();else{const[t,s]=xt.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());s&&(this.listFiltered=t,this.signalRenderList())}}onPinChange(e){let t=!1;for(let s=0;s<e.length;s++){const i=e[s].priority,n=e[s].id;i?(this.onPreviewChange({convId:n},[]),t=!1):(t=!0,(!this.previewManager.getPreviewByIDSync(n)||!this.convDataManager.isRespondedByMeSync(n)&&xt.a.isStrangerV2(n))&&(this.listVisible=this.listVisible.filter((e=>e!==n))))}t&&(this.listVisible=this.safeSortConvList(this.listVisible,!1),(this.typeFilter!==kt.FilterType.ALL||this.labelFilters.length)&&(this.listFiltered=xt.a.sortConvId(this.listFiltered,this.typeFilter===kt.FilterType.UNREAD,!0))),this.signalRenderList()}onHiddenChat(e,t){const s=this.convDataManager.getConvByIdSync(e);if(this.logger.zsymb(0,10577,30003,"onHiddenChat ",e,t,!!s),t)this.listHiddens.push(e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.signalRenderList();else{if(!s&&!Dt.a.PinDataManager.isPinned(e))return;if(this.listHiddens=this.listHiddens.filter((t=>t!==e)),this.isMeBAAccount()||!xt.a.isStrangerV2(e)||this.listStrangers.includes(e)){const[t,s]=xt.a.insertToProperPosition(this.listVisible,e,this.getAlterId());this.listVisible=t}else this.listStrangers.push(e);if(this.listFiltered){const[t,s]=xt.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());this.listFiltered=t,this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===kt.FilterType.ARCHIVED,this.labelFilters))}}this.signalRenderList()}getCurrentFilter(){return{type:this.typeFilter,labels:this.labelFilters}}getRecentContacts(){const e=[];return this.listRawAll.forEach((t=>{const s=this.convDataManager.getConvByIdSync(t);s&&e.push(s)})),e}getRecentContactWithId(e){if(this.listRawAll.has(e)){return this.convDataManager.getConvByIdSync(e)||null}return null}addConvToLabel(e,t){let s=Wt.b.getItem(t);He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.MANAGE_LABEL,params:{view:qt.b.ADD_CONVERSATION,info:s}}),e&&(e.preventDefault(),e.stopPropagation()),Ze.e.logAction(14521)}selectConversation(e){if(Kt.b.startPerf(Kt.a),e.userId===L.CONV_FILTER.MEDIA)return void this.logger.zsymb(18,10577,30004,"No handler for mediabox. This feat disable!!!");if(e.userId===L.CONV_FILTER.STRANGER)return void(2==Number(Me.default.getConvUXVersion())?this.applyTypeFilter(kt.FilterType.STRANGER):this.labelDataManager.onSelectLabel(Pt.h));const t=this.sidebarController.getState($t.c).selectedId;e.userId===t&&e.userId!==L.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object(Be.f)({type:_t.ConversationListActions.SELECT_CONV_MINOR,payload:e}):(this.convUIListContainer&&this.convUIListContainer.focus(),e.userId===pt.default.sendToMeId&&(Ht.g.getFlagForCurrentUser(this.currUser.userId,as)||(Qt.p.getHasShownSendToMeTip()?Ht.g.setFlagForCurrentUser(this.currUser.userId,as,1):setTimeout((()=>{It.default.send(_t.ConversationListActions.SHOW_BUBBLE_DOT),Qt.p.setHasShownSendToMeTip(!0)}),144e5)),Jt.b.getCurrentStepKey()!==Jt.a.UPLOAD_IMAGES||this.showedOnboarding||(Jt.b.show(),this.showedOnboarding=!0),Ze.e.logAction(13901)),e.userId===L.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object(Be.f)({type:_t.SideBarActions.SELECT_FRIEND_CENTER,payload:Object(f.a)({},e)}):i.ModuleContainer.resolve(es.b).openConversation(e.userId,es.c.fromConvItem(e))),this.logActionSelectConv(e.userId)}showBroadCastMsgModal(){var e;if(!Me.default.checkBroadcastTime())return void Xe.a.createError(Ye.default.str("STR_BROADCAST_OVER_LIMIT_TIP"));let t=!0;1===this.labelFilters.length&&(t=Wt.b.getItem(this.labelFilters[0])||!0),null!==(e=pt.default.broadcast_resend_config)&&void 0!==e&&e.enable?He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.BROADCAST_RESEND,params:t}):He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.BROADCAST_COMPSE,params:{label:t}}),Ze.e.logAction(1453102)}markAsRead(e,t){void 0===t&&(t=null),e&&(e.preventDefault(),e.stopPropagation()),Ze.e.logAction(164),Me.default.isShowMarkAsReadAgain()?Xt.a.openConfirm({windowId:$t.c,name:L.MODAL_CONFIRM.confirmIdentities,params:{message:Ye.default.str("STR_MARK_READ_CONFIRM_TEXT"),okText:Ye.default.str("STR_CONFIRM"),okType:"primary",cancelText:Ye.default.str("STR_LOGOUT_NO"),onOk:e=>{Me.default.setShowMarkAsReadAgain(!(e&&e.dont_show_mark_as_read)),this.markConvsAsRead(t)},options:[{default_val:!1,key:"dont_show_mark_as_read",title:"STR_DONT_SHOW_AGAIN"}]}}):this.markConvsAsRead(t)}scrollToTop(e){const t=Yt.b.instance().getConvList();t&&t.scrollToTop(e)}scrollToConv(e){const t=Yt.b.instance().getConvList();t&&t.scrollToConversation(e)}openInNewWindow(e,t){if(!e||!e.userId)return;const s=this.menuRef[Pt.b];s&&s.openInNewWindow&&(s.updateTargetInfo(e),s.openInNewWindow(t))}getStrangerInfo(){let e="";if(this.newestStrangerId){const t=this.previewManager.getPreviewByIDSync(this.newestStrangerId);e=t?t.messageTime:""}return this.logger.zsymb(0,10577,30005,"getStrangerInfo ",this.newestStrangerId,e),{messageTime:e}}getTopMostConv(){return this.typeFilter!==kt.FilterType.ALL||this.labelFilters.length?this.listFiltered[0]:this.listVisible[0]}addListener(){setTimeout((()=>{this.labelDataManager.addEventListener(Gt.d.SelectedLabelChange,(e=>{this.onLabelFilterChange(e.payload)})),this.labelDataManager.addEventListener(Gt.d.LabelAddConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"add")})),this.labelDataManager.addEventListener(Gt.d.LabelRemoveConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"remove")}));const e=i.ModuleContainer.resolve(Nt.h);e.addEventListener(zt.b.DoneLoadPreview,(e=>{this.onLoadPreview(e.payload)})),e.addEventListener(zt.b.DoneMigratePreview,(()=>{this.onMigratedPreview()})),e.addEventListener(zt.b.PreviewChanged,(e=>{const{changedItem:t,all:s}=e.payload;this.onPreviewChange(t,s)})),e.addEventListener(zt.b.DraftChanged,(e=>{})),this.convDataManager.addEventListener(zt.b.DeleteConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(zt.b.EmptyConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(zt.b.LeaveGroup,(e=>{this.moveConvOutConvList(e.convId)})),this.pinDataManager.addEventListener(zt.b.ChangePinConv,(e=>{this.onPinChange(e.payload)})),this.archivedChatManager.addEventListener(zt.b.UpdateListArchivedChat,(e=>{this.updateListArchivedChat()})),this.archivedChatManager.addEventListener(zt.b.OnOffArchivedChat,(e=>{this.onOffArchivedChat(e.payload.status)})),this.unreadDataManager.addEventListener(zt.b.ChangeUnreadArchiveChat,(e=>{this.updateUnreadArchivedChat(e.payload.hasUnreadArchivedChat)})),this.muteDataManager.addEventListener(zt.b.MuteChanged,this.handleMuteChange),Je.default.subscribeEventFriend(L.EventFriend.ADD_FRIEND,(e=>{let{userId:t}=e,s=0;this.listStrangers.includes(t)&&(s++,this.listStrangers=this.listStrangers.filter((e=>e!==t)),t==this.newestStrangerId&&(s++,this.updateNewestStrangerId(this.listStrangers))),this.logger.zsymb(0,10577,30008,`on add friend ${t} ${s}`)})),Je.default.subscribeEventFriend(L.EventFriend.REMOVE_FRIEND,(e=>{let{userId:t}=e,s=0;!this.listStrangers.includes(t)&&this.listVisible.some((e=>e===t))&&(s++,this.listStrangers.push(t)),this.logger.zsymb(0,10577,30009,`on remove friend ${t} ${s}`)})),Je.default.subscribeEventFriend(L.EventFriend.DOWNGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()})),Je.default.subscribeEventFriend(L.EventFriend.UPGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()}))}),0)}addToListFiltered(e,t){void 0===t&&(t=!1),e.forEach((e=>{if(t){const t=this.unreadDataManager.getUnreadByConvIdSync(e);if(!t||!t.smsUnreadCount&&!t.unreadMark)return}const[s]=xt.a.insertToProperPosition(this.listFiltered,e);this.listFiltered=s}))}applyTypeFilter(e,t){if(void 0===t&&(t=!1),this.typeFilter===e&&!t)return;this.logger.zsymb(0,10577,30010,"applyTypeFilter ",e,t);const s=this.typeFilter;switch(this.typeFilter=e,e){case kt.FilterType.ALL:if(0!==this.labelFilters.length){if(this.listFiltered=xt.a.filterByLabel(this.listVisible,this.labelFilters),this.labelFilters.includes(Pt.h)){let e=this.listStrangers;this.showStrangerNROnly()&&(e=xt.a.filterByResponsed(e,!1)),this.addToListFiltered(e)}else this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters);this.addLikeConvToFilterListV2(this.listFiltered,this.labelFilters)}break;case kt.FilterType.UNREAD:if(0!==this.labelFilters.length){const e=s==kt.FilterType.ALL?this.listFiltered:this.listVisible;this.listFiltered=xt.a.filterByLabel(e,this.labelFilters),this.labelFilters.includes(Pt.h)?this.addToListFiltered(this.listStrangers):this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.listFiltered=xt.a.filterByUnread(this.listFiltered),this.listFiltered=xt.a.sortConvId(this.listFiltered,!0,!0)}else this.listFiltered=xt.a.filterByUnread(this.listVisible),this.listFiltered=this.safeSortConvList(this.listFiltered);break;case kt.FilterType.STRANGER:this.listFiltered=xt.a.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=xt.a.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=xt.a.filterByResponsed(this.listFiltered,!1));break;case kt.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,this.labelFilters);break;case kt.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,this.labelFilters)}this.signalRenderState(),this.signalRenderList()}applyLabelFilter(e){if(this.labelFilters!==e){switch(this.logger.zsymb(0,10577,30011,"applyLabelFilter ",e.join("-")),this.labelFilters=e.map((e=>""+e)),this.typeFilter){case kt.FilterType.ALL:if(this.listFiltered=xt.a.filterByLabel(this.listVisible,this.labelFilters),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.addLikeConvToFilterListV2(this.listFiltered,e),this.labelFilters.some((e=>e==Pt.h))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=xt.a.filterByResponsed(e,!1)),this.addToListFiltered(e)}break;case kt.FilterType.UNREAD:if(this.listFiltered=xt.a.filterByLabel(this.listVisible,e),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.labelFilters.some((e=>e==Pt.h))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=xt.a.filterByResponsed(e,!1)),this.addToListFiltered(e)}this.listFiltered=xt.a.filterByUnread(this.listFiltered),this.listFiltered=this.safeSortConvList(this.listFiltered);break;case kt.FilterType.STRANGER:this.listFiltered=xt.a.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=xt.a.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=xt.a.filterByResponsed(this.listFiltered,!1));break;case kt.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,e);break;case kt.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,e)}this.signalRenderState(),this.signalRenderList()}}showStrangerNROnly(){return!this.isMeBAAccount()}isMeBAAccount(){const e=Je.default.isMeBAAccount();return this.logger.zsymb(0,10577,30012,"isMeBAAccount ",e),e}doAddStrangerHasLabel(e,t){if(t.length){const s=xt.a.filterByLabel(this.listStrangers,t);if(s.length){const t=new Set(s);for(let s=0;s<e.length;s++)t.has(e[s])&&t.delete(e[s]);this.addToListFiltered(t)}}return e}isConvExists(e){const t=this.convDataManager.getConvByIdSync(e);return!!(null!=t&&t.firstSmsLocalId||null!=t&&t.lastSmsLocalId)}safeSortConvList(e,t){void 0===t&&(t=!0);const s=e.indexOf(L.CONV_FILTER.STRANGER);if(-1!==s){e[s]=this.newestStrangerId;const i=(e=xt.a.sortConvId(e,t,!0)).indexOf(this.newestStrangerId);e[i]=L.CONV_FILTER.STRANGER}else e=xt.a.sortConvId(e,t,!0);return e}isValidFakeConv(e,t,s){if(e.some((e=>e==s))||Vt.a.isThreadHidden(s))return!1;const i=Wt.b.getLabelObjByConversaionId(s);return!(!i||!t.some((e=>e==i.id)))}isValidFakeConvV2(e,t){if(!t||e.some((e=>e==t))||Vt.a.isThreadHidden(t))return!1;return!(t&&t.startsWith(L.GROUPID_PREFIX))||!!ts.default.getGroupByIdSync(t)}addLikeConvToFilterListV2(e,t){if(t.length&&this.typeFilter!==kt.FilterType.UNREAD){this.logger.zsymb(0,10577,30013,"addLikeConvToFilterListV2 ",t);for(const s of t){const t=this.labelDataManager.getLabelById(s);if(t&&t.conversations)for(const s of t.conversations)this.isValidFakeConvV2(e,s)&&e.push(s)}}}markConvsAsRead(e){const t=[],s=0===this.labelFilters.length;this.logger.zsymb(0,10577,30014,`markConvsAsRead #1  ${null==e?void 0:e.join("-")}`),this.listRawAll.forEach((i=>{const n=this.unreadDataManager.getUnreadByConvIdSync(i);if(n&&(n.smsUnreadCount>0||n.unreadMark)){if(this.logger.zsymb(0,10577,30015,`markConvsAsRead #2, ${i}, ${n.smsUnreadCount}`),e&&!e.hasOwnProperty(i)||i===L.FAKE_CONVERSATION_ID.FRIEND_CENTER)return;const r=Wt.b.getLabelObjByConversaionId(i)||{},a=this.convDataManager.getConvByIdSync(i)||{userId:i};(s||this.labelFilters.some((e=>e==r.id))||xt.a.isInStrangerBoxV2(i)&&this.typeFilter===kt.FilterType.STRANGER)&&t.push(a)}})),this.logger.zsymb(0,10577,30016,`markConvsAsRead #3 ${t.length} ${t.map((e=>e.userId)).join("-")}`),t.length>0&&(It.default.send(_t.SideBarActions.MARK_AS_READ,{conversations:t}),Ze.e.logAction(1453304))}onLoadPreview(e){this.logger.zsymb(0,10577,30017,`onload Preview 1: ${this.listRawAll.size}`);let t=e.map((e=>e.convId));const s=Me.default.getConvUXVersion();this.isEnableArchivedChat=!!is.a.isEnableArchivedChat()&&"3"==s,this.typeFilter=this.isEnableArchivedChat?kt.FilterType.FOCUSED:kt.FilterType.ALL,this.listRawAll.size&&this.listRawAll.forEach((e=>{t.some((t=>t===e))||t.push(e)})),this.listRawAll=new Set(t);const i=pt.default.sendToMeId;this.listRawAll.has(i)||(t.push(i),this.listRawAll.add(i)),this.logger.zsymb(0,10577,30018,`onload Preview 2: ${t.length}`),xt.a.groupConversaion(t).then((e=>{if(this.logger.zsymb(0,10577,30019,`grouped list #1: \n\t\t\t\t${e.hidden.length}\n\t\t\t\t- ${e.stranger.length}\n\t\t\t\t- ${e.outdate.length}\n\t\t\t\t- ${e.visible.length}\n\t\t\t`),pt.default.stagingAccount)for(const i in e)this.logger.zsymb(0,10577,30020,`${i}: ${e[i]}`);this.listStrangers=e.stranger,this.listHiddens=e.hidden;const t=this.addStrangersToVisible(e.visible,this.listStrangers);let s=t;if(this.listVisible.length){this.logger.zsymb(0,10577,30021,`preview changed while group csc #1: ${this.listVisible}`),s=this.listVisible;const e=new Set(this.listVisible);t.forEach((t=>{e.has(t)||s.push(t)}))}this.listVisible=this.safeSortConvList(s,!1),this.initMyCloud(),this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===kt.FilterType.ARCHIVED,this.labelFilters)),this.logger.zsymb(0,10577,30022,`visible sorted #1: ${this.listVisible}`),this.loaded=!0,this.signalRenderList(),this.signalRenderState(),this.dispatchEvent(new zt.a(zt.c.LoadPreviewDone,"",this.listVisible.slice()))}))}onMigratedPreview(){this.logger.zsymb(0,10577,30023,`onMigratedPreview #1: ${this.listVisible}`);const e=Me.default.getConvUXVersion();this.isEnableArchivedChat=!!is.a.isEnableArchivedChat()&&"3"==e,this.typeFilter=this.isEnableArchivedChat?kt.FilterType.FOCUSED:kt.FilterType.ALL;const t=pt.default.sendToMeId;this.listRawAll.has(t)||this.initMyCloud(),this.convDataManager.getConvByIdSync(t)&&!this.listVisible.includes(t)&&(this.logger.zsymb(0,10577,30024,"onMigratedPreview #2"),this.onPreviewChange({convId:t},[])),this.loaded=!0,this.signalRenderList(),this.signalRenderState()}initMyCloud(){const e=Ht.g.getFlagForCurrentUser(null,"z_sendtome"),t=pt.default.sendToMeId,s=!(pt.default.isOffSendToMe||e&&1!==e);if(this.logger.zsymb(0,10577,30025,"initMyCloud",e,pt.default.isOffSendToMe),this.listVisible.some((e=>e===t))){const e=this.convDataManager.getConvByIdSync(t);e&&e.pinned?Ze.e.logAction(1390703):(Ht.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),Ze.e.logAction(1390702))}else if(s){const e=Dt.a.PinDataManager.getTotalPinnedConversation()>=pt.default.limit_pin_messages,s=pt.default.auto_pin_send2me&&!Ht.g.getFlagForCurrentUser(null,"z_sendtome_pinned")&&!e;this.convDataManager.createEmptyConvForUser(t,s?1:0,L.CONV_OT_STATE.none,{}),s&&(Dt.a.PinDataManager.pin([t]),Ht.g.setFlagForCurrentUser(null,"z_sendtome_pinned",1)),Ht.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),this.onPreviewChange({convId:t},[])}}addStrangersToVisible(e,t){if(!t||!t.length)return e;if(this.isMeBAAccount())return e.concat(t);{const s=xt.a.filterByResponsed(t,!1);if(s.length){this.newestStrangerId=xt.a.getNewestConvFromIds(s);e.includes(L.CONV_FILTER.STRANGER)||e.push(L.CONV_FILTER.STRANGER)}return t.forEach((t=>{this.convDataManager.isRespondedByMeSync(t)&&e.push(t)})),e}}onLabelChangeConvs(e,t,s){if(this.logger.zsymb(0,10577,30026,"onLabelChangeConvs",t.length,e),t.length&&this.labelFilters.includes(e))if("add"==s){const e=t.filter((e=>!this.listFiltered.includes(e)&&!this.listHiddens.includes(e)));if(!e.length)return;this.listFiltered=[...this.listFiltered,...e],this.listFiltered=xt.a.sortConvId(this.listFiltered,this.typeFilter===kt.FilterType.UNREAD,!1),this.signalRenderList()}else{let e=!1;t.forEach((t=>{const s=Wt.b.getLabelObjByConversaionId(t),i=s?s.id:null;this.labelFilters.includes(""+i)||(this.listFiltered=this.listFiltered.filter((e=>e!==t)),e=!0)})),e&&this.signalRenderList()}}moveConvOutConvList(e){this.logger.zsymb(0,10577,30027,"moveConvOutConvList",e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.listStrangers=this.listStrangers.filter((t=>t!==e)),e!==this.newestStrangerId||this.isMeBAAccount()||this.updateNewestStrangerId(this.listStrangers),this.signalRenderList()}getAlterId(){return new Map([[L.CONV_FILTER.STRANGER,this.newestStrangerId]])}updateNewestStrangerId(e){if(this.isMeBAAccount())return;const t=xt.a.filterByResponsed(e,!1),s=this.newestStrangerId;if(this.newestStrangerId=xt.a.getNewestConvFromIds(t),this.newestStrangerId||(this.listVisible=this.listVisible.filter((e=>e!==L.CONV_FILTER.STRANGER)),this.signalRenderList()),this.previewManager.updateStrangerBox(this.newestStrangerId),s!==this.newestStrangerId&&this.newestStrangerId){const[e,t]=xt.a.insertToProperPosition(this.listVisible,L.CONV_FILTER.STRANGER,this.getAlterId());this.listVisible=e,this.signalRenderList()}}rebuildList(){this.logger.zsymb(0,10577,30028,`rebuildList 1: ${this.listRawAll.size} ${this.listVisible.length} ${this.listStrangers.length}`),this.listStrangers=[],this.listVisible=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="";const e=Array.from(this.listRawAll),t=xt.a.groupConversaionSync(e);if(this.logger.zsymb(0,10577,30029,`grouped list #2: \n\t\t\t${t.hidden.length}\n\t\t\t- ${t.stranger.length}\n\t\t\t- ${t.outdate.length}\n\t\t\t- ${t.visible.length}\n\t\t`),pt.default.stagingAccount)for(const n in t)this.logger.zsymb(0,10577,30030,`${n}:, ${t[n]}`);this.listStrangers=t.stranger,this.listHiddens=t.hidden;const s=this.addStrangersToVisible(t.visible,this.listStrangers),i=this.safeSortConvList(s,!1);this.listVisible=i,this.logger.zsymb(0,10577,30031,`visible sorted #2: ${this.listVisible}`),this.labelFilters.length&&this.applyLabelFilter(this.labelFilters),this.typeFilter!==kt.FilterType.ALL&&this.applyTypeFilter(this.typeFilter,pt.default.should_force_genlist_conv),this.signalRenderList(),this.signalRenderState()}handleUserPackageChange(){this.logger.zsymb(0,10577,30032,`handleUserPackageChange: ${Je.default.isMeBAAccount()}}`),this.rebuildList()}signalRenderList(e){void 0===e&&(e="all"),Object(st.h)(this.name,e)}signalRenderState(){Object(st.g)(this.name,$t.c)}logActionSelectConv(e){const t=this.labelFilters.length>0;if(this.typeFilter===kt.FilterType.UNREAD?(Ze.e.logAction(1453103),t||Ze.e.logAction(1453107)):this.typeFilter===kt.FilterType.ALL?(Ze.e.logAction(1453104),t&&Ze.e.logAction(1453108)):this.typeFilter===kt.FilterType.FOCUSED?Ze.e.logAction(1453501):this.typeFilter===kt.FilterType.ARCHIVED&&Ze.e.logAction(1453502),t)Ze.e.logAction(1453105);else{Ze.e.logAction(1453106);for(let e=0;e<this.labelFilters.length;e++){if(parseInt(this.labelFilters[e])>0){Ze.e.logAction(1453109);break}}}this.typeFilter==kt.FilterType.ARCHIVED&&is.a.sendTrackSrc(e,4,!1)}init(){}getItem(e){return e.key===$t.c?{labelFilters:this.labelFilters,typeFilter:this.typeFilter,loaded:this.loaded,isEnableArchivedChat:this.isEnableArchivedChat,hasUnreadArchivedChat:this.hasUnreadArchivedChat,typeFilterSrc:this.typeFilterSrc}:rs}getList(e){return e.key===$t.c||this.typeFilter==kt.FilterType.ALL&&0===this.labelFilters.length?this.listVisible:this.listFiltered}onGetItemFailure(e){}onGetListFailure(e){}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===Pt.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]}showConvActionMenu(e,t){if(t&&t.friendItem)return;if(t.userId===L.CONV_FILTER.STRANGER||t.userId===L.CONV_FILTER.MEDIA)return;const s=Object(f.a)({},t),i=s.userId;if(s&&!bt.default.isFakeId(i)){const e=this.previewManager.getPreviewByIDSync(i),t=Je.default.getProfileFriendByIdSync(i)||{},n=this.unreadDataManager.getUnreadByConvIdSync(i);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.unreadMark=null==n?void 0:n.unreadMark,s.smsUnreadCount=null==n?void 0:n.smsUnreadCount}this.menuRef[Pt.b].updateTargetInfo(s),this.menuRef[Pt.b].showAction(Object(f.a)({},e))}bindUIContainer(e){this.convUIListContainer=e}cleanUpUIContainer(){this.convUIListContainer=null}getEnableArchivedChat(){return this.isEnableArchivedChat}getListFilterSrc(e){return this.typeFilterSrc===kt.FilterSrcType.UNREAD?xt.a.filterByUnread(e):e}setTypeFilterSrc(e){if(this.typeFilterSrc!==e&&(this.typeFilterSrc=e,this.applyTypeFilter(this.typeFilter,!0),e===kt.FilterSrcType.UNREAD)){const e=this.labelFilters.length>0?1453215:1453214;Ze.e.logAction(e)}}genListArchivedChat(e,t,s,i,n){void 0===i&&(i=!0),void 0===n&&(n=!0);let r=[];r=xt.a.filterByLabel(this.getListFilterSrc(e),s),s.length&&n&&this.typeFilterSrc!==kt.FilterSrcType.UNREAD&&this.addLikeConvToFilterListV2(r,s);let a=this.getListFilterSrc(this.listStrangers).filter((e=>(is.a.isArchivedChat(e)&&t||!is.a.isArchivedChat(e)&&!t)&&!Vt.a.isThreadHidden(e)));return s.includes(Pt.h)&&1==s.length?this.isMeBAAccount()||(a=xt.a.filterByResponsed(a,!1)):s.includes(Pt.h)||(a=xt.a.filterByLabel(a,s)),r=r.filter((e=>!(this.typeFilter===kt.FilterType.ARCHIVED||!a.length||e!=L.CONV_FILTER.STRANGER)||(is.a.isArchivedChat(e)&&t||!is.a.isArchivedChat(e)&&!t)&&e!==L.CONV_FILTER.STRANGER&&!xt.a.isStrangerV2(e)&&!Vt.a.isThreadHidden(e))),i&&(this.typeFilter===kt.FilterType.ARCHIVED?r=r.concat(a):this.isMeBAAccount()||s.length?(this.isMeBAAccount()&&(null==s||!s.length)||null!=s&&s.length)&&(r=r.concat(a)):r=this.addStrangersToVisible(r,a)),r=r.filter(((e,t)=>r.indexOf(e)==t)),this.safeSortConvList(r,this.typeFilterSrc===kt.FilterSrcType.UNREAD)}updateListArchivedChat(){this.typeFilter==kt.FilterType.FOCUSED?this.onTypeFilterChange(kt.FilterType.FOCUSED,!0):this.typeFilter==kt.FilterType.ARCHIVED&&this.onTypeFilterChange(kt.FilterType.ARCHIVED,!0)}onOffArchivedChat(e){if(!pt.default.enable_archived_chat)return;const t=Me.default.getConvUXVersion();this.isEnableArchivedChat&&e&&"2"==t&&(this.isEnableArchivedChat=!1,this.signalRenderState()),this.isEnableArchivedChat!=e&&(e||this.typeFilter!==kt.FilterType.ARCHIVED&&this.typeFilter!==kt.FilterType.FOCUSED?e&&this.onTypeFilterChange(kt.FilterType.FOCUSED,!0):this.onTypeFilterChange(kt.FilterType.ALL,!0),this.labelDataManager.onClearFilter(),this.setTypeFilterSrc(kt.FilterSrcType.ALL),this.isEnableArchivedChat=e&&"3"==t,this.signalRenderState())}isShowUnreadArchivedChat(){return this.hasUnreadArchivedChat}updateUnreadArchivedChat(e){this.typeFilter!=kt.FilterType.ARCHIVED&&(this.hasUnreadArchivedChat=e),this.signalRenderState()}})||Ut)||Ut)||Ut)||Ut)||Ut)||Ut)||Ut)||Ut);var os,ds=s("EYv5"),ls=s("AtyM"),cs=s("R5gT"),hs=s("Xzw3"),us=s("d+hT"),gs=s("uEOi"),ms=s("rQsU"),ps=s("kTC5"),fs=s("4wTQ"),vs=s("ES/k"),bs=s("WBqA");const ys={isFocusSearchBox:!1,isFocusOnRecentSearch:!1,searchText:"",searchResult:{},searching:!1,conversation:null,highlightId:"",filter:{timeFrom:0,timeTo:Date.now()}},Is=new bt.LocalId;var _s;!function(e){e[e.STEP_CONTACT=0]="STEP_CONTACT",e[e.STEP_MESSAGES=1]="STEP_MESSAGES",e[e.STEP_FILES=2]="STEP_FILES",e[e.STEP_DIRECTORY=3]="STEP_DIRECTORY"}(_s||(_s={}));Object(Bt.b)(kt.SearchController)(os=function(e,t){return i.ModuleContainer.inject(ms.b)(e,void 0,0)}(os=function(e,t){return i.ModuleContainer.inject(Nt.b)(e,void 0,1)}(os=function(e,t){return i.ModuleContainer.inject(Nt.h)(e,void 0,2)}(os=Reflect.metadata("design:type",Function)(os=Reflect.metadata("design:paramtypes",[void 0===ms.b?Object:ms.b,void 0===Nt.b?Object:Nt.b,void 0===Nt.h?Object:Nt.h])(os=class{constructor(e,t,s){this.convListController=e,this.convDataManager=t,this.previewDataManager=s,this.state=void 0,this.pageLoad=void 0,this.curQuery=void 0,this.cacheResSearch=void 0,this.countQuery=void 0,this.countTimeUseGlobalSearch=void 0,this.countSelectTopRes=void 0,this.cacheSearch=void 0,this.trackSearch=void 0,this.trackSearchVietnamese=void 0,this.lastTextSearch=void 0,this.lastTextSearchTs=void 0,this.isShowRecentSearch=void 0,this.isFirstLoadSuccess=void 0,this.searchDelay=void 0,this.closeBySendingMsg=void 0,this.clearAdminMode=void 0,this.timeouResetDataMsg=void 0,this.searchResultList=void 0,this.recentSearchList=void 0,this.searchInput=void 0,this.loadingMore=void 0,this.loadingMoreFiles=void 0,this.oldestTime=void 0,this.functionSearchByName=void 0,this.timeoutLog=void 0,this._sbc=null,this._removeSearchResult=(e,t)=>{const s=this.getSearchState();if(s&&!s.conversation&&s.searchResult)if(t){if(!s.searchResult.groups)return;const t=[...s.searchResult.groups];for(let i=0;i<t.length;i++)if(t[i].userId==e){t.splice(i,1),this.updateState(Object(f.a)(Object(f.a)({},s),{},{searchResult:Object(f.a)(Object(f.a)({},s.searchResult),{},{groups:t})}));break}}else{if(!s.searchResult.friends)return;const t=[...s.searchResult.friends];for(let i=0;i<t.length;i++)if(t[i].userId==e){t.splice(i,1),this.updateState(Object(f.a)(Object(f.a)({},s),{},{searchResult:Object(f.a)(Object(f.a)({},s.searchResult),{},{friends:t})}));break}}},this.name=kt.SEARCH_CONTROLLER,this.key="windowId",this.state=ys,this.pageLoad=0,this.curQuery="",this.countQuery=0,this.countTimeUseGlobalSearch=0,this.countSelectTopRes=0,this.cacheSearch={items:[],keywords:null},this.trackSearch=!1,this.trackSearchVietnamese=!1,this.lastTextSearch="",this.lastTextSearchTs=0,this.isShowRecentSearch=!1,this.searchDelay=this._getSearchDelaySetting(),this.closeBySendingMsg=!1,this.loadingMore=!1,this.loadingMoreFiles=!1,this.oldestTime=0,this.timeoutLog=null,this.isFirstLoadSuccess=!1,this._innerSearchFunc=this._innerSearchFunc.bind(this),this.functionSearchByName=bt.default.throttle(this._innerSearchFunc,this.searchDelay),this.onKeywordChange=this.onKeywordChange.bind(this),this.loadMessagesV2=this.loadMessagesV2.bind(this),this.loadMoreFiles=this.loadMoreFiles.bind(this),this.onKeyPressInput=this.onKeyPressInput.bind(this),this.onFocusInput=this.onFocusInput.bind(this),this.onBlurInput=this.onBlurInput.bind(this),this.onclickCloseSearchButton=this.onclickCloseSearchButton.bind(this),this.onClickClearSearch=this.onClickClearSearch.bind(this),this.onSearchKeyword=this.onSearchKeyword.bind(this),this.setRecentSearchFocusState=this.setRecentSearchFocusState.bind(this),this.focusSearchBox=this.focusSearchBox.bind(this),this.selectResult=this.selectResult.bind(this),this.onFileSelect=this.onFileSelect.bind(this),this.selectTopRes=this.selectTopRes.bind(this),this.listenEvents()}get sidebarController(){return this._sbc||(this._sbc=i.ModuleContainer.resolve(kt.SidebarController)),this._sbc}listenEvents(){It.default.subscribe(((e,t)=>{switch(e){case _t.SideBarActions.FOCUS_SEARCH_INPUT:this.focusSearchBox();break;case _t.FetchActions.FRIENDS_REMOVED:this._removeSearchResult(t,!1);break;case _t.FetchActions.GROUP_LEAVE:this._removeSearchResult(t,!0);break;case _t.SideBarActions.SEARCH_FILE_DONE:this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!1}));break;case _t.SideBarActions.CLEAR_SEARCH:this.clearSearch();break;case _t.ConversationListActions.SELECT_CONVERSATION:setTimeout((()=>{this.state.highlightId!==t.userId&&this.setRecentSearchFocusState(!1,!1,!0),t.callPoint!==es.a.JumpMessage&&this.updateStateOf("highlightId",null==t?void 0:t.userId)}),0)}}))}logSearch(e){Qt.p.getDebugSearch().showLogSearchFlow}updateState(e,t){void 0===t&&(t=!0),this.state=e,t&&Object(st.g)(this.name,$t.c)}isTextKey(e){return e.match(/^[a-zA-Z0-9!@#$%^&*)(+=._-|\\\[\]{}~`"\';:?/<>,-\s\n]$/)}isMultipleKeyPressed(e){return e.ctrlKey||e.metaKey||e.altKey}isKeywordStale(e){return vs.a.formatTextSearch(e)!==vs.a.formatTextSearch(this.state.searchText)}bindUIList(e,t){this._updateListRef(e,t)}cleanUpUIList(e){this._updateListRef(e,null)}bindUISearchInput(e){this.searchInput=e}cleanUpUISearchInput(){this.searchInput=null}_updateListRef(e,t){switch(e){case ps.c.SEARCH_RESULT:this.searchResultList=t;break;case ps.c.RECENT_SEARCH:this.recentSearchList=t}}resetState(){this.searchInput.value="",this.updateState(Object(f.a)({},ys))}updateStateOf(e,t){this.state.hasOwnProperty(e)&&this.state[e]!==t&&("searchText"===e&&(this.searchInput.value=t),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{[e]:t})))}onKeyPressInput(e){if(this._isSelectAllSearchText()&&this.searchResultList&&this.isTextKey(e.key)&&!this.isMultipleKeyPressed(e)&&(this.searchResultList.openTabAll(),this.searchResultList.resetContactList()),e.which==L.K_BACK_SPACE?this.state&&this.state.searchText&&""!==this.state.searchText&&Ze.e.logAction(12307):""===this.state.searchText&&!this.timeoutLog&&this.isTextKey(e.key)&&(this.timeoutLog=setTimeout((()=>{this.timeoutLog=null,Ze.e.logAction(1232002)}),3e3)),e.which==L.K_ESC)!0===this.isShowRecentSearch&&(this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{isFocusOnRecentSearch:!1,isFocusSearchBox:!1})),this.searchInput&&this.searchInput.blur(),this.onCloseSearch()),""!=this.searchInput.value?this.clearSearch(!1):this.clearSearch(!0);else if(e.which==L.K_ENTER){let e=this.searchResultList||this.recentSearchList;if(e&&this.state.searchText){let t=e.selectFocusedConversation(!0);setTimeout((()=>{this.state.conversation?this.focusSearchBox():Vt.a.isThreadHidden(t)||It.default.send(_t.ChatBoxActions.FOCUS_INPUT,{userId:t,windowId:$t.c})}),0)}}else if(e.which==L.K_UP||e.which==L.K_DOWN){this.searchResultList&&Ze.e.logAction(12317);let t=this.searchResultList||this.recentSearchList;t&&(e.stopPropagation(),e.preventDefault(),e.which==L.K_UP?t.moveUp():t.moveDown())}}onKeywordChange(e,t){let s="";if(s=!e&&t?t:e.target.value,s&&(s=bt.default.ZSafeFunction((()=>s.normalize()),s)),this.countTimeUseGlobalSearch||(this.countTimeUseGlobalSearch=ls.a.now(),this.countSelectTopRes=0),s){const e=vs.a.formatTextSearch(this.lastTextSearch),t=vs.a.formatTextSearch(s);bt.default.log("searching: true"),pt.default.stagingAccount&&this._checkOnAdminMode(s),this.trackSearch||(this.trackSearch=!0,Ze.e.logAction(12318)),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchText:s})),this.countQuery=Is.next(),this.functionSearchByName(s,this.countQuery,e!==t)}else this._resetCacheResultSearch(),cs.a.abortSearch(),this.clearSearch(!1)}onFocusInput(){bs.a.onNewSession($t.c),this.searchInput&&""!==this.searchInput.value&&this.searchInput.select(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{isFocusSearchBox:!0})),Ze.e.logAction(1232001)}onBlurInput(){setTimeout((()=>{this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{isFocusSearchBox:!1})),this.searchInput&&""==this.searchInput.value&&this.qosLogSearch()}),20)}onclickCloseSearchButton(e){this.setRecentSearchFocusState(!1),this.onCloseSearch(),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),Ze.e.logAction(1232003),e&&(e.stopPropagation(),e.preventDefault())}onClickClearSearch(){Qt.p.resetGlobalSearchMode(),this.state.conversation&&Ze.e.logAction(12314),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),this.focusSearchBox(),Ze.e.logAction(1232006)}onSearchKeyword(e){"string"==typeof e&&this.searchInput&&(this.searchInput.value=e,this.onKeywordChange(null,e),gs.a.addCacheKeyword(e))}onRemoveKeyword(e){"string"==typeof e&&gs.a.removeCacheKeyword(e)}onFileSelect(e){null!=e&&e.msgId&&(this.updateStateOf("highlightId",e.msgId),this.state.searchText&&gs.a.addCacheKeyword(this.state.searchText))}setRecentSearchFocusState(e,t,s){if(void 0===t&&(t=!1),void 0===s&&(s=!1),!s){const t=this.sidebarController.getSelectedId();if(this.state.isFocusOnRecentSearch===e||t&&this.state.highlightId===t&&!e)return}this.state.isFocusOnRecentSearch=e,e&&(this.closeBySendingMsg=!1),Object(st.g)(this.name,$t.c)}onCloseSearch(){var e,t;Ze.e.logAction(1232004),0==(null===(e=this.state.searchResult)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.length)&&Ze.e.logAction(1232202),this.qosLogSearch()}focusSearchBox(e){void 0===e&&(e=!1),this.searchInput&&(this.searchInput.focus(),e&&setTimeout((()=>{this.searchInput.select()}),0))}openRecentSearch(){this.searchInput?this.searchInput.focus():this.setRecentSearchFocusState(!0)}loadMessagesV2(e,t,s){var i=this;void 0===t&&(t=!1);let n=this.state.searchResult,r="",a=e;if(!this.state.searchText)return;r=this.state.searchText;let o=this.state,d=!1;t||(o=Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:null})}),d=!0);const l=()=>this.state.filter.timeFrom!=a.timeFrom||this.state.filter.timeTo!=a.timeTo||!(!this.state.searchText||!this.isKeywordStale(r)),c=!this.loadingMore&&this.isFirstLoadSuccess&&!!n&&!!n.messages;if(!t||c){this.logSearch(`[Search flow] load more msg: ${r}, ${this.pageLoad}`),this.updateState(Object(f.a)(Object(f.a)({},o),{},{filter:{timeFrom:e.timeFrom,timeTo:e.timeTo}}),d),this.loadingMore=!0;const n=[],a=function(e,a){var o;void 0===a&&(a=!1);let d=[];if(i.loadingMore=!1,i.logSearch(`[Search flow] load more msg res: ${r}, ${null===(o=e.arr)||void 0===o?void 0:o.length}`),l())return i.pageLoad++,void(s&&s(null,-1));if(e&&e.listConv&&e.arr){i.convListController.getRecentContacts().forEach((t=>{let s=e.listConv.indexOf(t.userId);if(s>=0&&!Vt.a.isThreadHidden(t.userId))for(let i=s;i<e.listConv.length;++i)e.listConv[i]==t.userId&&(e.arr[i].conversation=t)})),e.arr.forEach((e=>{Object.keys(e.conversation).length>1&&d.push(e)})),Array.prototype.push.apply(n,d),a&&t&&n.length&&i.pageLoad++,l()||!i.isFirstLoadSuccess&&t||(i.state.searchResult.messages&&(d=i.state.searchResult.messages.concat(d)),i.updateState(Object(f.a)(Object(f.a)({},i.state),{},{searchResult:Object(f.a)(Object(f.a)({},i.state.searchResult),{},{messages:d}),searching:!1})),s&&a&&s(n,i.pageLoad))}};cs.a.searchGlobalMessagesV3(r,l,void 0,a,pt.default.limit_result_msg_search+1,e).then((e=>a(e,!0))).catch((e=>{this.loadingMore=!1,this.logSearch(`[Search flow] load more msg err: ${r}, ${e}`),s&&s(null,-1),bt.default.logCoreError("searchGlobalMsg v2 "+e)}))}else s&&s(null,-1)}loadMoreMessages(){this.state.searchResult}loadMoreFiles(){let e=this.state.searchResult,t=this.state.searchText;var s;e&&e.rawFileResult&&e.files&&e.rawFileResult.length>e.lastFileOffset&&!this.loadingMoreFiles&&(this.loadingMoreFiles=!0,null===(s=i.ModuleContainer.resolve(ds.a))||void 0===s||s.getMultiMedias("file",e.rawFileResult.slice(e.lastFileOffset,e.lastFileOffset+20)).then((s=>{if(this.loadingMoreFiles=!1,this.isKeywordStale(t))return;e=this.state.searchResult;const i=s.filter(Boolean);let n=bt.default.ZSafeFunction((()=>Math.max(0,e.rawFileResult.length-e.lastFileOffset-20)+e.files.length+i.length),e.realFileLen),r=this.state.searchResult.files.concat(i);r.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm))),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{files:r,realFileLen:n,lastFileOffset:e.lastFileOffset+20})}))})).catch((e=>{this.loadingMoreFiles=!1,bt.default.logCoreError("_loadMoreFiles ",e)})))}qosLogSearch(){this.countTimeUseGlobalSearch&&(k.default.increaseSuccess(97111,0,ls.a.now()-this.countTimeUseGlobalSearch),this.countTimeUseGlobalSearch=0),this.countSelectTopRes>=0&&(k.default.increaseSuccess(97112,0,this.countSelectTopRes),this.countSelectTopRes=-1)}selectTopRes(){this.countSelectTopRes>=0&&this.countSelectTopRes++}selectResult(e,t,s,i){var n;void 0===t&&(t=!1),void 0===s&&(s=!1),void 0===i&&(i=!1);const r=this.state.searchText;let a=!!this.state.conversation;fs.a.jumpToMessage(e.message,null===(n=e.conversation)||void 0===n?void 0:n.userId,Be.f).then((t=>{const{groupMsgs:s=[]}=t;let i=null;bt.default.ZSafeFunction((()=>{if(s)for(let t=0;t<s.length;t++)if(s[t].msgId==e.message.msgId)return i=Object(f.a)({},s[t]),void(i.searchKeyWord=r)}),null),this.state.searchText&&gs.a.addCacheKeyword(this.state.searchText),It.default.send(_t.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:s,focusId:[""+e.message.msgId],conversation:e.conversation}),i&&Object(Be.f)({type:_t.ChatBoxActions.UPDATE_MESSAGE_ATTRIBUTES,payload:i})})).catch((t=>{bt.default.logCoreError(t),Xe.a.createWarning(Ye.default.str("STR_MESSAGE_NOT_FOUND")),i||It.default.send(_t.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:[],focusId:[],conversation:e.conversation})})),a?(s&&this.focusSearchBox(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{highlightId:e.message.msgId}))):t||this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{highlightId:e.message.msgId}))}getRecentSearchItems(){if(0===pt.default.recent_search.is_enable)return[];let e=gs.a.getLocalRecentSearchList();if(!e)return[];let t=ts.default.getGroupsListSync(),s=t||[];return e=e.filter((e=>{if(e&&e.userId&&!Vt.a.isThreadHidden(e.userId)){if(e.userId.startsWith(L.GROUPID_PREFIX)||1===e.type){let t=!1;1!==e.type||e.userId.startsWith(L.GROUPID_PREFIX)||(e.userId=L.GROUPID_PREFIX+e.userId);for(let i of s)if(i.userId&&e.userId==i.userId){t=!0;break}return!!t||(gs.a.removeLocalRecentSearchList(e.userId),!1)}return!0}return!1})),e}getCacheRecentSearch(){return this.cacheSearch.items=this.getRecentSearchItems(),pt.default.sync_recent_search.enable_kw&&(this.cacheSearch.keywords=gs.a.getLocalKeywordList()),this.cacheSearch}getPageLoad(){return this.pageLoad}getSearchInputRef(){return this.searchInput}getSearchState(){return this.state}clearSearch(e){if(void 0===e&&(e=!0),this._resetCacheResultSearch(),this.searchInput.value="",this.lastTextSearch="",e){if(hs.b.setMode(hs.a.NORMAL),this.updateState(Object(f.a)({},ys)),this.sidebarController.getState($t.c).currentTab==kt.SidebarTab.FILE_TAB)return void this.functionSearchByName(null,this.countQuery,!0)}else this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchText:"",searching:!0,highlightId:""})),this.functionSearchByName("",this.countQuery,!0)}_resetCacheResultSearch(){this.curQuery="",this.cacheResSearch=null,this.trackSearch=!1,this.trackSearchVietnamese=!1}_checkOnAdminMode(e){let t=this.__checkOnAdminMode(e);t&&(1===t?(this.clearAdminMode&&clearTimeout(this.clearAdminMode),pt.default.adminMode=!0,this.sidebarController.togglePerfTab(!0),this.clearAdminMode=setTimeout((()=>{this.clearAdminMode=void 0,pt.default.adminMode=void 0,this.sidebarController.togglePerfTab()}),216e5)):2===t&&(this.clearAdminMode&&(clearTimeout(this.clearAdminMode),this.clearAdminMode=void 0),pt.default.adminMode=!1,this.sidebarController.togglePerfTab(!1)))}__checkOnAdminMode(e){if(e&&"string"==typeof e&&e.startsWith("$##")){return e.substring(3)===pt.default.zAminKey?1:2}return 0}_innerSearchFunc(e,t,s){if(void 0===s&&(s=!0),!Is.valid(t))return;if(this.sidebarController.getState($t.c).currentTab===kt.SidebarTab.FILE_TAB)It.default.send(_t.SideBarActions.SEARCH_FILE,{term:e});else if(this.state.conversation)this.filterByConversation(e,this.state.conversation);else{const t=s&&this.isKeywordStale(this.lastTextSearch),n=vs.a.formatTextSearch(e);var i;if(this.logSearch(`[Search flow] start search-------: ${t}, ${n}`),!n)null===(i=this.searchResultList)||void 0===i||i.forceStopSearch(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:null,files:[],rawFileResult:[]})}));this._searchGlobal(e,t)}}_searchGlobal(e,t){var s,n,r,a,o,d,l=this;void 0===t&&(t=!0),this.lastTextSearchTs=Date.now(),this.lastTextSearch=e;let c=2,h=0,u={},g=this.convDataManager.getAllConvSync(),m=this.previewDataManager.getAllPreviewsSync(),p=bt.default.simpleStripVietnamese(e,!1);const v=(s,i)=>{s!==_s.STEP_DIRECTORY&&s!==_s.STEP_FILES&&c--;let n,r=1==c&&s===_s.STEP_CONTACT&&0==h;if(n=!!(c>1||r),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:i,searching:n})),s===_s.STEP_CONTACT&&t&&(I(),pt.default.tabbedGlobalSearchResult&&hs.b.setMode(hs.a.SEARCHING),pt.default.enableFileGlobalSearch&&y()),0==c&&!this.isKeywordStale(e)){let e=Date.now()-this.lastTextSearchTs;e>2e3?this._upSearchDelay():e<600&&this._downSearchDelay()}},b=()=>!!this.isKeywordStale(e),y=()=>{if(pt.default.adminConfig&&pt.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&v(_s.STEP_FILES,this.state.searchResult)}),100);const t=t=>{var s,n,r;if(this.isKeywordStale(e))return;let a=new Set,o=[];var d,l;if((t.forEach((e=>{e.msgId&&!a.has(e.msgId)&&(a.add(e.msgId),o.push(e.msgId))})),(null===(s=this.state.searchResult)||void 0===s||null===(n=s.rawFileResult)||void 0===n?void 0:n.length)>=20&&(null==o?void 0:o.length)>=20)&&((null===(d=this.state.searchResult)||void 0===d?void 0:d.rawFileResult[0])==o[0]&&(null===(l=this.state.searchResult)||void 0===l?void 0:l.rawFileResult[19])==o[19]))return void this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{rawFileResult:o,realFileLen:o.length})}),!1);const c=o.slice(0,20);null===(r=i.ModuleContainer.resolve(ds.a))||void 0===r||r.getMultiMedias("file",c).then((t=>{if(this.isKeywordStale(e))return;let s=[],i=0,n=0;for(const e of t)e?(s.push(e),i++):n++;s.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm)));let r=this.state.searchResult;bt.default.log("search files: cur = "+r.searchKey+" this query = "+e,s.length),r=r?Object(f.a)({},r):{},r.files=s,r.realFileLen=o.length-n,r.rawFileResult=o,r.lastFileOffset=c.length,r.searchKey=e,h+=i,v(_s.STEP_FILES,r)})).catch((t=>{bt.default.logCoreError("doSearchFiles "+t),this.state&&!this.isKeywordStale(e)&&v(_s.STEP_FILES,this.state.searchResult)}))};cs.a.search(e,null,{msgType:L.MSG_FILE},t,{enableReject:!0}).then(t).catch((e=>{this.state.searchResult.files&&this.state.searchResult.files.length||this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{files:[]})}),!0)}))},I=()=>{if(pt.default.adminConfig&&pt.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&v(_s.STEP_MESSAGES,this.state.searchResult)}),100);this.logSearch(`[Search flow] search msg: ${e}`);Date.now();const t=function(t,i){var n;if(void 0===i&&(i=!1),l.logSearch(`[Search flow] search msg res first load: ${e}, ${null===(n=t.arr)||void 0===n?void 0:n.length}`),l.pageLoad=0,l.timeouResetDataMsg&&(clearTimeout(l.timeouResetDataMsg),l.timeouResetDataMsg=!1,l.updateState(Object(f.a)(Object(f.a)({},l.state),{},{searchResult:Object(f.a)(Object(f.a)({},l.state.searchResult),{},{messages:null})}),!1)),!l.isKeywordStale(e)&&t){let n=[],a=0;t&&t.listConv&&t.arr&&g.forEach((e=>{let s=t.listConv.indexOf(e.userId);if(s>=0&&!Vt.a.isThreadHidden(e.userId))for(let i=s;i<t.listConv.length;++i)t.listConv[i]==e.userId&&(t.arr[i].conversation=e,a+=1,n.push(t.arr[i]))}));let o=l.state.searchResult,d=n;var r;if(o.messages&&(d=o.messages.slice(),Array.prototype.push.apply(d,n)),d.sort(((e,t)=>parseInt(t.message.sendDttm)-parseInt(e.message.sendDttm))),o=o?Object(f.a)({},o):{},o.messages=d,o.searchKey=e,h+=a,i)l.isFirstLoadSuccess=!0,l.searchResultList&&s&&l.searchResultList.updateFirstLoadPos(s.timeFrom),bt.default.logCoreError("[Global search] check First data",e,null===(r=l.state.searchResult.messages)||void 0===r?void 0:r.length);else if(!n.length)return;v(_s.STEP_MESSAGES,o)}};this.searchResultList&&(!this.timeouResetDataMsg&&this.state.searchResult.messages&&(this.timeouResetDataMsg=setTimeout((()=>{this.timeouResetDataMsg=!1,this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:null})})),this.searchResultList&&this.searchResultList.resetDataSearch()}),1e3)),this.searchResultList.resetDataSearch());const s=Object(f.a)({},null);this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!0,highlightId:"",searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:!this.lastTextSearch||e.length<this.lastTextSearch.length?null:this.state.searchResult.messages})})),this.loadingMore=!1,this.isFirstLoadSuccess=!1,cs.a.searchGlobalMessagesV3(e,(()=>b()),void 0,t,pt.default.limit_result_msg_search+1,null).then((e=>t(e,!0))).catch((t=>{if(this.logSearch(`[Search flow] search msg fail: ${t}`),bt.default.logCoreError("searchGlobalMsg "+t),this.state&&!this.isKeywordStale(e)){this.searchResultList&&this.searchResultList.forceStopSearch(),this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1);let e=this.state.searchResult;e.messages=[],v(_s.STEP_MESSAGES,e)}}))};if(this.curQuery&&0!==e.indexOf(this.curQuery)&&this._resetCacheResultSearch(),!this.cacheResSearch){const e=e=>{for(const t of e){const e=t.userId||t.convId;t&&!u[e]&&(t.userId||(t.userId=e),t.infoSearch&&delete t.infoSearch,t.isDirectory&&delete t.isDirectory,u[e]=t)}};m.length&&e(m),e(Je.default.getFriendsSync()),e(ts.default.getGroupsListSync())}us.a.search(e,this.cacheResSearch?this.cacheResSearch:u,{hasSection:!0,suggestGroupWithMember:!0,searchFriendInGroup:!0,isCalc:!0,updateLastChat:!this.cacheResSearch,searchPb:!0,searchZName:!0,searchNumPhone:!0,filterHidden:Vt.a.isKeyPIN(e)}).then((t=>{let s=this.state.searchResult;if(!this.isKeywordStale(e)){{var i;let n=[];if(Vt.a.isKeyPIN(e)){Ze.e.logAction(1970601);const e=Vt.a.getUidsHiddenChat();if(e.length)for(let t of e){let e=!1;for(let s of g)if(s&&s.userId==t){n.push(Object(f.a)(Object(f.a)({},s),{},{infoSearch:{}})),e=!0;break}if(!e){let e=null;e=t.startsWith(L.GROUPID_PREFIX)?ts.default.getGroupByIdSync(t):Je.default.getProfileFriendSync(t),e&&(e.lastMessageTime||(e.lastMessageTime=0),n.push(Object(f.a)(Object(f.a)({},e),{},{infoSearch:{}})))}}}this.curQuery||(this.curQuery=e),!this.cacheResSearch&&t.orderAll&&t.orderAll.constructor==Array&&t.orderAll.length>0&&(this.cacheResSearch=u),null!==(i=t.phone)&&void 0!==i&&i.length&&(t.phone=t.phone.filter((e=>e.userId))),s=s?Object(f.a)({},s):{},s.recentChat=t.recentChat,s.groups=t.groups,s.friends=t.friends,s.oa=t.oa,s.directory=t.directory,s.searchKey=e,s.phone=t.phone,s.hiddenChat=n,s.all=t.all,s.orderAll=t.orderAll,h+=(s.groups?s.groups.length:0)+(s.friends?s.friends.length:0)+(s.oa?s.oa.length:0),h+=(s.recentChat?s.recentChat.length:0)+s.hiddenChat.length}v(_s.STEP_CONTACT,s)}})).catch((e=>{bt.default.logCoreError(e)})),0==(null===(s=this.state.searchResult)||void 0===s||null===(n=s.messages)||void 0===n?void 0:n.length)&&0==(null===(r=this.state.searchResult)||void 0===r||null===(a=r.all)||void 0===a?void 0:a.length)&&0==(null===(o=this.state.searchResult)||void 0===o||null===(d=o.files)||void 0===d?void 0:d.length)&&Ze.e.logAction(1232201),p===e||this.trackSearchVietnamese||(this.trackSearchVietnamese=!0,Ze.e.logAction(1232010))}filterByConversation(e,t){var s=this;if(!e)return this.searchInput.value="",void this.updateState(Object(f.a)(Object(f.a)({},ys),{},{conversation:t,searching:!1,highlightId:""}));let i=function(i,n){void 0===n&&(n=!1),s.isKeywordStale(e)?bt.default.logCoreError("search: abort filtermode 1",s.state.searchText,e):(!n||i&&0!=i.length)&&cs.a.getMessageOfConversation(i,t.userId,20).then((r=>{if(s.isKeywordStale(e))return void bt.default.logCoreError("search: abort filtermode 2",s.state.searchText,e);let a=r.list;if(n&&(!a||0===a.length))return;let o=a.length<20&&i.length>20;a.length>0?(s.updateState(Object(f.a)(Object(f.a)({},s.state),{},{conversation:t,searchResult:{messageList:a.map((e=>({message:e,conversation:t}))),realLen:r.len,rawSearchResult:i,lastOffset:20,progress:n},searching:!1,highlightId:a[0].msgId})),n||(s.focusSearchBox(),o&&s.loadMoreMessages()),!n&&s.searchResultList&&s.searchResultList.scrollToTop&&s.searchResultList.scrollToTop()):(s.updateState(Object(f.a)(Object(f.a)({},s.state),{},{conversation:t,searchResult:{messageList:[],realLen:0,lastOffset:0,progress:!1},searching:!1,highlightId:""})),s.focusSearchBox(),!n&&o&&s.loadMoreMessages())}))};cs.a.search(e,null,{convId:t.userId+""},(e=>{i(e,!0)})).then((e=>{i(e)}))}_getSearchDelaySetting(){return 70}_upSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.min(400,Math.round(1.1*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_downSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.max(70,Math.round(.9*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_resetSearchFunction(){bt.default.logCoreError("__rssf__",this.searchDelay),this.functionSearchByName=bt.default.throttle(this._innerSearchFunc,this.searchDelay)}_isSelectAllSearchText(){if(this.searchInput){const e=this.searchInput.selectionStart,t=this.searchInput.selectionEnd;return!(!this.searchInput.value.length||0!=e||t!=this.searchInput.value.length)}return!1}init(){}getItem(e){return this.state}getList(e){throw new Error("No imp!!!")}onGetItemFailure(e){}onGetListFailure(e){}loadOldestTime(){cs.a.getOldestTime().then((e=>{null!=e&&e.length&&e[0].ts?this.oldestTime=parseFloat(e[0].ts):this.oldestTime=0})).catch((e=>{this.oldestTime=0}))}getOldestTime(){return this.oldestTime}})||os)||os)||os)||os)||os);var Ms,Cs=s("OlUt"),Ts=s("jnrz"),Os=s("Anfm"),Es=s("BZLJ"),Ss=s("A9FD"),ws=s("BKm0"),Ls=s("iKSP");const Ds={windowId:$t.c,theme:Cs.a.default,currentTab:kt.SidebarTab.MESSAGE_TAB,previousTab:kt.SidebarTab.MESSAGE_TAB,selectedId:null,previousId:null,showExportImportEntry:!0},Fs="z_sendtome_bubbledot",Rs="SIDEBAR CONTROLLER";function As(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];bt.default.logCoreInfo(`[${Rs}] - `,t)}Object(V.h)()(Ms=Object(Bt.b)(kt.SidebarController)(Ms=function(e,t){return i.ModuleContainer.inject(kt.ConvListController)(e,void 0,0)}(Ms=function(e,t){return i.ModuleContainer.inject(ps.b)(e,void 0,1)}(Ms=Reflect.metadata("design:type",Function)(Ms=Reflect.metadata("design:paramtypes",[void 0===kt.ConvListController?Object:kt.ConvListController,void 0===ps.b?Object:ps.b])(Ms=class{constructor(e,t){var s=this;this.convListController=e,this.searchController=t,this.changeTabFromSearch=void 0,this._firstTimePageLoad=void 0,this._querySelect=void 0,this._convsLoaded=void 0,this._exportImportFinished=void 0,this._exportImportProgressError=void 0,this._allowAutoJumpFC=void 0,this._es=void 0,this._onSendMsg=e=>{var t,s;const i=(null==e||null===(t=e.messages)||void 0===t||null===(s=t[0])||void 0===s?void 0:s.upSrc)&L.FILE_UP_SRC.TextEditor,n=this.getState();if(n.currentTab==kt.SidebarTab.TODO_TAB||n.currentTab==kt.SidebarTab.CATALOG_TAB||i||e.isChild)return;const r=this.searchController.getSearchState();n.currentTab!==kt.SidebarTab.MESSAGE_TAB||r&&r.searchText?(n.currentTab=kt.SidebarTab.MESSAGE_TAB,Object(st.g)(this.name,$t.c),Object(Be.f)({type:_t.SideBarActions.SHOW_CHAT_VIEW}),r&&r.searchText&&Ze.e.logAction(1232007),this.searchController.clearSearch(!0)):n.currentTab==kt.SidebarTab.MESSAGE_TAB&&this.searchController.setRecentSearchFocusState(!1,!1,!0),this.searchController.closeBySendingMsg=!0,setTimeout((()=>{this.convListController.scrollToTop(!1)}),100)},this.changeTab=function(e,t){void 0===t&&(t=$t.c);const i=s._getStateByWindowId(t);i.currentTab!==e&&(i.currentTab=e,Object(st.g)(s.name,t)),s._onChangeTab(i.currentTab)},this.togglePerfTab=e=>{const t=this._getStateByWindowId($t.c);t.showPerfTab!==e&&(t.showPerfTab=e,Object(st.g)(this.name,$t.c))},this.changeTheme=async e=>{const t=this._getStateByWindowId($t.c);t.theme!==e&&(t.theme=e,Object(st.g)(this.name,$t.c))},this.selectMessageTab=()=>{this.changeTab(kt.SidebarTab.MESSAGE_TAB)},this.selectTodoTab=()=>{this.changeTab(kt.SidebarTab.TODO_TAB),Ze.e.logAction(171),Es.h.setViewPopupTodoSrc(Es.c.TAB_ICON)},this.selectContactFromSearch=async function(e,t){if(void 0===t&&(t=!1),!e)return As("Select friend null!"),Promise.resolve(!1);const n=await i.ModuleContainer.resolve(es.b).openConversation(e.userId,es.c.fromSearchList(e));return!0===t?(s.searchController.onCloseSearch(),s.searchController.resetState()):s.searchController.updateStateOf("highlightId",e.userId),n?(e&&e.userId===pt.default.sendToMeId&&(Ht.g.getFlagForCurrentUser(s.currUser.userId,Fs)||(Qt.p.getHasShownSendToMeTip()?Ht.g.setFlagForCurrentUser(s.currUser.userId,Fs,1):setTimeout((()=>{It.default.send(_t.ConversationListActions.SHOW_BUBBLE_DOT),Qt.p.setHasShownSendToMeTip(!0)}),144e5)),Ze.e.logAction(1390101)),Promise.resolve(!0)):(As("Open conv failure"),Promise.resolve(!1))},this.setupSelectConvOnPageLoad=()=>{if(!this._firstTimePageLoad)return;let e=this._getQueryParams();if(e.c){bt.default.logCoreInfo(`[${this.name}] - setup select conv c`);const t=e=>{const t={[e]:!0};this._querySelect=()=>{let s;s=e.startsWith(L.GROUPID_PREFIX)?vt.default.fetchGroupsIfNotExpire(t):vt.default.fetchFriendsIfNotExist(t),s.then((t=>{t&&t[e]?this.selectContactFromSearch(t[e]):bt.default.logCoreInfo(`[${this.name}] - auto open conv with id ${e} does not exist`)})).catch((e=>{bt.default.logCoreError(e)}))},this._autoSelectConv()},s=e.c;e.convert?vt.default.convertOAIds([s]).then((e=>{e&&e[s]&&t(e[s])})):t(s),this._firstTimePageLoad=!1}else if(e.g)bt.default.logCoreInfo(`[${this.name}] - setup select conv g`),Qe.a.autoSelectGroupByLink(`https://${pt.default.CONFIG_DOMAIN}/g/`+encodeURIComponent(e.g));else if(e.zs);else if(e.phone){let t=e.phone,s=e.openConv;!t||isNaN(t)||this._querySelect||(bt.default.logCoreInfo(`[${this.name}] - setup select conv p`),this._querySelect=()=>{s?Qe.a.autoOpenConversationByPhone(t,Be.e):Qe.a.autoSelectConversationByPhone(t,Be.e)},this._autoSelectConv())}else if(e.alias){bt.default.logCoreInfo(`[${this.name}] - setup select conv a`);let t=e.alias;this._querySelect||(this._querySelect=()=>{Qe.a.autoSelectConversationByAlias(t,Be.e)},this._autoSelectConv())}},this.name=kt.SIDEBAR_CONTROLLER,this.data=new Map,this.key="windowId",this.changeTabFromSearch=!1,this._firstTimePageLoad=!0,this._convsLoaded=!1,this._allowAutoJumpFC=!1,this.selectConversationForFriend=this.selectConversationForFriend.bind(this),this.listenEvents()}get currUser(){return Object(Zt.c)()}get autoJumFC(){return this._allowAutoJumpFC}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}onStart(e){i.ModuleContainer.resolve(es.b)}listenEvents(){It.default.subscribe(((e,t)=>{switch(e){case _t.ChatBoxActions.SEND_MSG:this._onSendMsg(t);break;case _t.ChatBoxActions.SELECT_FRIEND:this.selectConversationForFriend(t);break;case _t.SideBarActions.SHOW_FILE_MANAGER:this.getState().currentTab=kt.SidebarTab.FILE_TAB,Object(st.g)(this.name,$t.c);break;case _t.SideBarActions.SELECT_TAB_MSG:this.changeTab(kt.SidebarTab.MESSAGE_TAB);break;case _t.SideBarActions.SELECT_ZAVI_TAB:this.changeTab(kt.SidebarTab.ZAVI_TAB);break;case _t.FetchActions.DELETE_CONVERSATION:case _t.FetchActions.GROUP_LEAVE:{const e=this.getState();e.previousId&&t===e.previousId&&(e.previousId=null);break}case _t.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:case _t.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH:this.getState().currentTab==kt.SidebarTab.FILE_TAB&&this.changeTab(kt.SidebarTab.MESSAGE_TAB);break;case _t.TodoActions.OPEN_TODO_LIST:{const e=Yt.b.instance().getTodoView();e?e.onCheckOpenTab():this.changeTab(kt.SidebarTab.TODO_TAB);break}case _t.ActionList.ACT_OPEN_TAB_CHAT:this.selectMessageTab();break;case _t.ActionList.ACT_OPEN_TAB_CONTACT:this.changeTab(kt.SidebarTab.CONTACT_TAB);break;case _t.ActionList.ACT_OPEN_GROUPLIST:if(this.getState().currentTab===kt.SidebarTab.CONTACT_TAB){const e=Yt.b.instance().getContactList();e&&e.onJumpGroupCenter()}else this.changeTab(kt.SidebarTab.CONTACT_TAB);break;case ws.b.EXPORT_IMPORT_START:this._exportImportFinished=!1,this._exportImportProgressError=!1;break;case ws.b.EXPORT_IMPORT_FINISHED:this._exportImportFinished=!0,this._exportImportProgressError=!1;break;case ws.b.IMPORT_DB_PROGRESS:case ws.b.IMPORT_PROGRESS:case ws.b.EXPORT_PROGRESS:case ws.b.EXPORT_DB_PROGRESS:t&&t.error&&(this._exportImportProgressError=!0);break;case _t.ConversationListActions.SELECT_CONVERSATION:{const e=this.getState();e.currentTab!==kt.SidebarTab.FILE_TAB&&e.currentTab!==kt.SidebarTab.ZAVI_TAB&&e.currentTab!==kt.SidebarTab.CATALOG_TAB||this.changeTab(kt.SidebarTab.MESSAGE_TAB);break}}})),Dt.a.ConvInfoDataManager.addEventListener(zt.b.DoneLoadDB,(e=>{this._convsLoaded=!0,this._autoSelectConv()})),Dt.a.UnreadDataManager.addEventListener(zt.b.DoneLoadDB,(e=>{Ts.b.onDoneLoadUnreadDB(null==e?void 0:e.payload)}))}getState(e){return void 0===e&&(e=$t.c),this._getStateByWindowId(e)}getSelectedId(e){return this.getState(e).selectedId||null}getCurrMainConvId(){const e=this.eventStore.getState();return e&&e.chatview.view===Ls.c.CHAT_VIEW?this.getSelectedId():null}updateSelectedId(e,t){void 0===t&&(t=$t.c);const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=e?null:s.selectedId,s.selectedId=e,Object(st.g)(this.name,t))}isInImportExportProcess(){const e=this._exportImportFinished||this._exportImportProgressError;return void 0!==e&&!e}openFriendCenter(){}selectConversationForFriend(e,t){if(void 0===t&&(t=!1),!e)return void bt.default.logCoreError("friend null");if(Be.f&&(Object(Be.f)({type:_t.ConversationListActions.SELECT_CONV_MINOR,payload:e}),Object(Be.f)({type:_t.ChatBoxActions.READ_CONVERSATION,payload:{conversationId:e.userId}})),e.userId==this.currUser.userId)return void this._showMyProfile();let s=this.convListController.getRecentContactWithId(e.userId),i=!1;if(s)i=!0;else{let t=t=>{t&&t.includes(e.userId)&&(s=Object(f.a)({},t[e.userId]))};s||t(ts.default.getGroupsListSync()),s||t(Je.default.getFriendsSync()),s||(s={}),Object.assign(s,e),s.isFr=s.isFr||0,s.type=s.type||L.FRIEND_TYPE_NORMAL}e.byPassPIN?s.byPassPIN=1:s.byPassPIN&&delete s.byPassPIN,setTimeout((()=>{Object(Be.f)({type:_t.ConversationListActions.SELECT_CONVERSATION,payload:s})}),0);const n=this.data.get($t.c);let r=null==n?void 0:n.currentTab;!0===t?(r=i?kt.SidebarTab.MESSAGE_TAB:kt.SidebarTab.CONTACT_TAB,r===kt.SidebarTab.CONTACT_TAB&&(bt.default.log("sidebar: select from search, should highlight thread"),this.changeTabFromSearch=!0),this.searchController.onCloseSearch(),this.searchController.resetState(),!e.userId||!e.byPassPIN&&Vt.a.isThreadHidden(e.userId)||setTimeout((()=>{It.default.send(_t.ChatBoxActions.FOCUS_INPUT,{userId:e.userId,windowId:$t.c})}),0)):this.searchController.updateStateOf("highlightId",e.userId),this.updateState(Object(f.a)(Object(f.a)({},n),{},{currentTab:r,selectedId:e.userId})),e&&e.userId===pt.default.sendToMeId&&(Ht.g.getFlagForCurrentUser(this.currUser.userId,Fs)||(Qt.p.getHasShownSendToMeTip()?Ht.g.setFlagForCurrentUser(this.currUser.userId,Fs,1):setTimeout((()=>{It.default.send(_t.ConversationListActions.SHOW_BUBBLE_DOT),Qt.p.setHasShownSendToMeTip(!0)}),144e5)))}showAddFriendModal(){Ze.e.logAction(1020203),Ze.e.logAction(12316),He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.FIND_FRIEND})}showGroupCompose(){Ze.e.logAction(1020202),Os.c.markStart(Os.a.CREATE_GROUP,Os.b.Group.CREATE_GR_HEADER_ICON);const e=Qt.p.getSessionUserId(),t=function(e){void 0===e&&(e=!0),He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.CREATE_GROUP_COMPOSE,params:{needInitE2ee:e},forceCloseAll:!1})};!Ht.g.getTimeEntryPointE2eGroup(e,Os.b.Group.CREATE_GR_HEADER_ICON)&&pt.default.e2ee.enable_group&&pt.default.e2ee.group.can_enable_right_in_creation_step?He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.E2EE_ONBOARDING,params:{entry:Ss.e.CREATE_GROUP,entrySrc:Os.b.Group.CREATE_GR_HEADER_ICON,isGroup:!0,userId:"",callback:t,callbackCancel:t},forceCloseAll:!1}):t(!1)}enableAutoJupmFC(){this._allowAutoJumpFC=!0}disableAutoJupmFC(){this._allowAutoJumpFC=!1}init(){}getItem(e){const t=e.key;return this._getStateByWindowId(t)}getList(e){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}updateState(e,t,s){void 0===t&&(t=$t.c),void 0===s&&(s=!0),this.data.set(t,e),s&&Object(st.g)(this.name,t)}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(f.a)({},Ds),this.data.set(e,t)),t}_onChangeTab(e){switch(function(){switch(e){case kt.SidebarTab.MESSAGE_TAB:Ze.e.logAction(12801);break;case kt.SidebarTab.CONTACT_TAB:Ze.e.logAction(12802),3===pt.default.noti_center_config.entry_position&&Ze.e.logAction(1281205);break;case kt.SidebarTab.MENTION_TAB:Ze.e.logAction(12805);break;case kt.SidebarTab.STAR_TAB:Ze.e.logAction(12806);break;case kt.SidebarTab.FILE_TAB:Ze.e.logAction(133);break;case kt.SidebarTab.TODO_TAB:3===pt.default.noti_center_config.entry_position&&Ze.e.logAction(1281206);break;case kt.SidebarTab.ZAVI_TAB:Ze.e.logAction(20701)}}(),Qt.p.resetGlobalSearchMode(),this.searchController.clearSearch(!0),e){case kt.SidebarTab.MESSAGE_TAB:{this._resetConversationList();const e=this.getState();!e.selectedId&&e.previousId&&this.updateSelectedId(e.previousId),Object(Be.f)({type:_t.SideBarActions.SHOW_CHAT_VIEW});break}case kt.SidebarTab.ZAVI_TAB:Object(Be.f)({type:_t.SideBarActions.SELECT_ZAVI});case kt.SidebarTab.TODO_TAB:}}_showMyProfile(){He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.FRIEND_PROFILE,params:this.currUser.userId})}_resetConversationList(){}_getQueryParams(){let e={},t=window.location.search;if(t=t?t.substr(1).split("&"):null,t)for(let s=0;s<t.length;s++){let i=t[s].indexOf("=");if(i>=0){let n=t[s].slice(0,i),r=t[s].slice(i+1,t[s].length);n&&n.length>0&&r&&r.length>0&&(e[n]=decodeURIComponent(r))}}return e}_autoSelectConv(){this._querySelect&&this._convsLoaded&&(bt.default.logCoreInfo(`[${this.name}] - auto select conv start`),this._querySelect(),this._querySelect=null)}})||Ms)||Ms)||Ms)||Ms)||Ms);var Ps;const Ns={id:Pt.g,color:"#EA87FF",conversations:[],createTime:1634956772046,emoij:"",offset:100,text:"default"};var js;!function(e){e.ALL="all",e.SELECTED="selected"}(js||(js={}));Object(Bt.b)(kt.LabelDataManager)(Ps=Reflect.metadata("design:type",Function)(Ps=Reflect.metadata("design:paramtypes",[])(Ps=class extends Y.b{constructor(){super(),this.allLabels=void 0,this.selectedLabel=void 0,this.name=kt.LABEL_DATA_MANAGER,this.data=new Map,this.key="labelId",this.allLabels=[],this.selectedLabel=[]}onLabelChange(e){const{color:t,conversations:s,createTime:i,emoij:n,offset:r,text:a}=e,o=""+e.id,d=this.data.get(o);if(!o||d&&s===d.conversations&&i==(null==d?void 0:d.createTime)&&n==d.emoij&&r==d.offset&&a===d.text&&t==d.color||(this.data.set(o,e),Object(st.g)(this.name,o),Object(st.h)(this.name,"all")),d&&d.conversations&&d.conversations.length!==s.length){let e=[];s.length>d.conversations.length?(e=s.filter((e=>!d.conversations.includes(e))),this.dispatchEvent(new Gt.c(Gt.d.LabelAddConvs,{labelId:o,convIds:e}))):(e=d.conversations.filter((e=>!s.includes(e))),this.dispatchEvent(new Gt.c(Gt.d.LabelRemoveConvs,{labelId:o,convIds:e})))}}onFetchLabels(e){if(Array.isArray(e)&&!(e.length<0)){for(let t=0;t<e.length;t++)this.onLabelChange(e[t]);this.data.forEach((t=>{const s=""+t.id;e.some((e=>e.id==s))||this.data.delete(s)})),this._updateAllLabels(e.map((e=>e.id)))}}onLabelDeleted(e){if("string"!=typeof e&&(bt.default.logCoreError(`[${this.name}] - delete label invalid lid type ${e}`),e=""+e),!this.data.has(e))return void bt.default.logCoreError(this.name+"Deleted not exists item!!!");const t=this.data.get(e);let s=[];t&&t.conversations&&(s=[...t.conversations]),this.data.delete(e),this._updateAllLabels(this.allLabels.filter((t=>t!==e))),this.selectedLabel.includes(e)&&this.onDeSelectLabel(e),this.dispatchEvent(new Gt.c(Gt.d.RemoveLabel,{labelId:e,convs:s})),Object(st.e)(this.name,e)}_updateAllLabels(e){return!bt.default.shallowEqual(this.allLabels,e)&&(this.allLabels=e,Object(st.h)(this.name,js.ALL),!0)}onSelectLabel(e){this.selectedLabel=[""+e],Object(st.h)(this.name,js.SELECTED),this.selectedLabelChanged()}onDeSelectLabel(e){this.selectedLabel=this.selectedLabel.filter((t=>t!==e)),Object(st.h)(this.name,js.SELECTED),this.selectedLabelChanged()}onClearFilter(){this.selectedLabel=[],Object(st.h)(this.name,js.SELECTED),this.selectedLabelChanged()}getLabelById(e){return e?("string"!=typeof e&&(e=e.toString()),e==Pt.g?Ns:e==Pt.h?{id:Pt.h}:this.data.get(e)||null):null}getAllLabels(){return Array.from(this.data.values())}getAllLabelIds(){return this.allLabels}applyNewFilter(e){this.selectedLabel=e,Object(st.h)(this.name,js.SELECTED),this.selectedLabelChanged()}selectedLabelChanged(){this.dispatchEvent(new Gt.c(Gt.d.SelectedLabelChange,this.selectedLabel))}init(){Wt.b.getAll().then((e=>{this.onFetchLabels(e)}))}getItem(e){const t=e.key;return this.getLabelById(t)}getList(e){const t=e.key;return t===js.ALL?this.allLabels:t===js.SELECTED?this.selectedLabel:[]}onGetItemFailure(e){}onGetListFailure(e){}})||Ps)||Ps);i.ModuleContainer.register(Rt.b,jt);var Us=s("k+R1"),Bs=s("Py3H");let ks;!function(e){e[e.FULL=0]="FULL",e[e.WINDOWED=1]="WINDOWED"}(ks||(ks={}));var Gs,xs=s("tQbm"),zs=s("qzuk"),Vs=s("NMlV"),$s=s("4HQc"),Ws=s("8RMw"),qs=s("lPX+"),Ks=s("OU7N"),Hs=s("UYGI"),Qs=s("X4fA"),Js=s("V8Oy"),Zs=s("7WX+");let Xs;bt.default.isWeb()||(Xs=s("Dprd").default);const Ys={conversationId:null,mode:ks.FULL,windowId:$t.c};Object(Bt.b)(xs.b)(Gs=function(e,t){return i.ModuleContainer.inject(kt.SidebarController)(e,void 0,0)}(Gs=Reflect.metadata("design:type",Function)(Gs=Reflect.metadata("design:paramtypes",[void 0===kt.SidebarController?Object:kt.SidebarController])(Gs=class extends Y.b{constructor(e){super(),this.sidebar=e,this.data=new Map,this.onLogOut=()=>{if(Ks.c.isCalling())return void Xe.a.createWarning(Ye.default.str("STR_SIGNOUT_WITH_CALL"));let e=Qt.p.getSessionUserId(),t="STR_LOGOUT_CONFIRM",s=+Hs.a.isUploading();if(!s&&Xs&&Xs.isDownloading()&&(s=2),s>0){const e=1===s?Ye.default.str("STR_TITLE_BAR_SEND"):Ye.default.str("STR_TITLE_BAR_RECEIVE");t=Ye.default.str("STR_LOGOUT_CANCEL_FILE")+` ${e} `+Ye.default.str("STR_TITLE_BAR_EXIT_ZALO_P2")}Qs.a.getLogoutToken(),Xt.a.openConfirm({windowId:$t.c,name:L.MODAL_CONFIRM.confirmIdentities,params:{message:Ye.default.str(t),okText:Ye.default.str("STR_LOGOUT_YES"),cancelText:Ye.default.str("STR_LOGOUT_NO"),onOk:this.doLogout,options:[{default_val:Ht.g.isSetClearData(e),key:"del_history",title:"STR_LOGOUT_DEL_HISTORY"}],"data-id":{confirmBtn:"btn_Logout_Logout",cancelBtn:"btn_Logout_No"}}})},this.openConversationInNewWindow=async e=>{throw new Error("Method not implemented.")},this.openScreenCapture=async()=>{Ze.e.logAction(12808),It.default.send(_t.ChatBoxActions.SIDEBAR_CAPTURE)},this.openZaloSupport=async()=>{const e=pt.default.supportPage;return e?i.ModuleContainer.resolve(es.b).openConversation(e,es.c.fromSupport()):Promise.resolve(!1)},this.openUpdateMyProfile=async()=>{He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.UPDATE_PROFILE,params:{showCloseButton:!0}})},this.openUserInfo=async e=>{Bs.a.setFriendRequestSource(e,L.FRIEND_REQUEST_SRC_CONTACT_LIST_SUGGESTION),Qt.p.setSelectConversationSource(178012),He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})},this.openEditAlias=async e=>{const t={windowId:$t.c,name:L.ModalIdentitiesDefine.EDIT_ALIAS,params:Object(f.a)({},e)};He.ModalManagerV2.openModal(t)},this.sendFile=async(e,t)=>{const s=this._getStateByWindowId($t.c),i=Us.default.getChatBoxControllerByConvId(t||s.conversationId);null==i||i._uploadDragFile(e,null,t)},this.getConvId=()=>this._getStateByWindowId($t.c).conversationId,this.sendDirectMsgToSendToMe=(e,t)=>{!pt.default.isOffSendToMe&&this.chatboxController&&Me.default.getConversation(pt.default.sendToMeId).then((s=>{if(e===L.MSG_GIF&&t.url){var i;let e={hd:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},original:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},normal:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url}};null===(i=this.chatboxController)||void 0===i||i._sendMessage(s,L.MSG_GIF,e,null,null,null,null,null)}Object(Be.e)({type:_t.ConversationListActions.SELECT_CONVERSATION,payload:s}),this.sidebar.updateSelectedId(pt.default.sendToMeId)}))},this.handleSendMessageError=(e,t,s)=>{var i,n;if(Me.default.deleteMessageById(t.msgId),null===(i=this.chatboxController)||void 0===i||i._cleanUpLocalTTLItem(t),Qt.p.isDelSendingMsg(t.clientId))return;const r=t.convertToUIMessageObject();return null===(n=this.chatboxController)||void 0===n||n._handleMessageFailure(e,t,r,s,!0),e},this.broadCastMessage=(e,t,s,i)=>{if(e&&t)for(let l=0;l<e.length;l++){const c=e[l];if(c){let e=c.userId,l=e.startsWith(L.GROUPID_PREFIX);if(t.msgType===L.MSG_STICKER){var n,r;const d=Vs.a.next();t&&t.sendSrc&&Os.c.track(d,t.sendSrc);const h=bt.default.getMsgIdSendingFromCliMsgId(d),u=new $s.b(Qt.p.getSessionUserId(),e,h,d,L.MSG_STICKER,l),g=null===Ws.default||void 0===Ws.default||null===(n=Ws.default.signalProtocolManager)||void 0===n?void 0:n.isOnE2ee(c.userId);if(u.updateMessageContentProp($s.a.STICKER,t.message),g){var a;const e={id:u.content.sticker.id,catId:u.content.sticker.cateId,type:u.content.sticker.type};var o;if(null!==(a=t.message)&&void 0!==a&&a.fssInfo)e.extInfo=null===(o=t.message)||void 0===o?void 0:o.fssInfo;u.updateMessageContentProp($s.a.STICKER,e),u.e2eeStatus=L.MSG_E2EE}vt.default.sendMsgObject(u,null,null,L.RETRY_MSG_TIMEOUT_DEFAULT).then((t=>{if(s){var n;const t=Vs.a.next(),i=bt.default.getMsgIdSendingFromCliMsgId(t);let r=new $s.b(Qt.p.getSessionUserId(),e,i,t,L.MSG_TEXT,l);r.updateMessageContentProp($s.a.TEXT,s),g&&(r.e2eeStatus=L.MSG_E2EE),vt.default.sendMsgObject(r,null,null,L.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{g&&(e=bt.default.parseE2eeResp(e),this.chatboxController._sentMessage(r,e))})).catch((e=>{this.handleSendMessageError(e,r,c)})),null===(n=this.chatboxController)||void 0===n||n._showLocalMessage(r,c)}g&&(t=bt.default.parseE2eeResp(t),this.chatboxController._sentMessage(u,t)),i&&i(t)})).catch((e=>{bt.default.logCoreError("BroadcastErr: ",e),this.handleSendMessageError(e,u,c),i&&i(e)})),null===(r=this.chatboxController)||void 0===r||r._showLocalMessage(u,c)}else if(t.msgType===L.MSG_TEXT&&s){var d;const t=Vs.a.next(),n=bt.default.getMsgIdSendingFromCliMsgId(t);let r=new $s.b(Qt.p.getSessionUserId(),e,n,t,L.MSG_TEXT,l);r.updateMessageContentProp($s.a.TEXT,s);(null===Ws.default||void 0===Ws.default||null===(d=Ws.default.signalProtocolManager)||void 0===d?void 0:d.isOnE2ee(c.userId))&&(r.e2eeStatus=L.MSG_E2EE),vt.default.sendMsgObject(r,null,null,L.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{i&&i(e)})).catch((e=>{this.handleSendMessageError(e,r,c),i&&i(e)}))}}}},this.handleEvent=(e,t)=>{if(e===_t.ConversationListActions.SELECT_CONVERSATION){const e=this._getStateByWindowId($t.c);if(t.userId!==e.conversationId)return this._updateStateByWindowId($t.c,(e=>Object(f.a)(Object(f.a)({},e),{},{conversationId:t.userId}))),Object(st.g)(this.name,$t.c),void this.dispatchEvent(new zs.a(t.userId,$t.c))}},this.name=xs.a,this.key="windowId",this.init()}get chatboxController(){const e=this.sidebar.getState().selectedId;return Us.default.getChatBoxControllerByConvId(e||$t.b)}onInviteFriend(){const e=[qs.a];He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.SHARE_MSG_COMPOSE,params:{messages:e,title:Ye.default.str("STR_INVITE_FRIEND_1"),disableGroup:!0,disablePcUser:!0,callback:(e,t)=>{It.default.send(_t.SideBarActions.SEND_INVITATION,{target:e,message:(null==t?void 0:t.length)>0?t[0]:"",link:`https://${pt.default.CONFIG_DOMAIN}/may-tinh`})}}})}onWhatNew(){He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.APP_UPDATE_INFO,params:{data:Me.default.getCacheRecentUpdate(),isManual:!0}})}showMyProfile(){let e=Qt.p.getSessionUserId();He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})}get mainWindowConversationId(){return this._getStateByWindowId($t.c).conversationId}doLogout(e){let t=Qt.p.getSessionUserId();e&&e.del_history?Ht.g.setClearData(t,1):Ht.g.setClearData(t,0),Js.a.logout(),Zs.a.logout(),Qs.a.logout().catch((e=>{e.error_code&&18032===e.error_code&&He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.CHANGE_PW})}))}init(){It.default.subscribe(this.handleEvent)}getItem(e,t){return this._getStateByWindowId(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(f.a)({},Ys),this.data.set(e,t)),t}_updateStateByWindowId(e,t){const s=t(this._getStateByWindowId(e));this.data.set(e,s)}})||Gs)||Gs)||Gs);var ei,ti=s("OI//");let si=i.ModuleContainer.injectable()(ei=class{async get(e){return ts.default.getGroupByIdSync(e)}async getAll(){return await ts.default.getGroupsListSync()}})||ei;var ii;let ni=i.ModuleContainer.injectable()(ii=function(e,t){return i.ModuleContainer.inject(ti.c)(e,void 0,0)}(ii=function(e,t){return i.ModuleContainer.inject(H.ZLoggerFactory)(e,void 0,1)}(ii=Reflect.metadata("design:type",Function)(ii=Reflect.metadata("design:paramtypes",[void 0===ti.c?Object:ti.c,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(ii=class{constructor(e,t){this.groupRepository=e,this.logger=void 0,this.logger=t.createZLogger("groups",["group-manager"])}getAll(){return this.groupRepository.getAll().then((e=>e.map((e=>new ti.a(e))))).catch((e=>(this.logger.zsymb(18,8176,3e4,(()=>["getAll error. return [].",{reason:e}])),[])))}get(e){return this.groupRepository.get(e).then((e=>e?new ti.a(e):void 0)).catch((e=>{this.logger.zsymb(18,8176,30001,(()=>["get error. return undefined.",{reason:e}]))}))}})||ii)||ii)||ii)||ii)||ii;i.ModuleContainer.registerSingleton(ti.c,si),i.ModuleContainer.registerSingleton(ti.b,ni);var ri,ai=s("MqnV"),oi=s("yEZN");let di=i.ModuleContainer.injectable()(ri=function(e,t){return i.ModuleContainer.inject(Nt.d)(e,void 0,0)}(ri=function(e,t){return i.ModuleContainer.inject(oi.b)(e,void 0,1)}(ri=function(e,t){return i.ModuleContainer.inject(Nt.f)(e,void 0,2)}(ri=Reflect.metadata("design:type",Function)(ri=Reflect.metadata("design:paramtypes",[void 0===Nt.d?Object:Nt.d,void 0===oi.b?Object:oi.b,void 0===Nt.f?Object:Nt.f])(ri=class{constructor(e,t,s){this.conversationRepository=e,this.messageManager=t,this.muteManager=s}async get(e){const t=await this.conversationRepository.get(e).catch((()=>{}));if(t)return new Nt.c(t,this,this.messageManager)}isPinned(e){return this.conversationRepository.get(e).then((e=>!(null==e||!e.pinned))).catch((()=>!1))}isMuted(e){return!!this.muteManager.isMuted(e)}})||ri)||ri)||ri)||ri)||ri)||ri;var li;let ci=i.ModuleContainer.injectable()(li=function(e,t){return i.ModuleContainer.inject(Nt.b)(e,void 0,0)}(li=Reflect.metadata("design:type",Function)(li=Reflect.metadata("design:paramtypes",[void 0===Nt.b?Object:Nt.b])(li=class{constructor(e){this.convManager=e}get(e){return this.convManager.getConvById(e)}})||li)||li)||li)||li;var hi=s("SVh1");var ui,gi=new class{constructor(){}showMyProfile(){He.ModalManagerV2.openModal({windowId:$t.c,name:L.ModalIdentitiesDefine.FRIEND_PROFILE,params:Qt.p.getSessionUserId()})}},mi=s("idnp"),pi=s("SWHF"),fi=s("rkiK");function vi(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];bt.default.logCoreInfo("[Conversation controller] - ",t)}let bi=Object(i.singleton)()(ui=Object(i.injectable)()(ui=function(e,t){return Object(i.inject)(Nt.h)(e,void 0,0)}(ui=function(e,t){return Object(i.inject)(pi.b)(e,void 0,1)}(ui=function(e,t){return Object(i.inject)(kt.SidebarController)(e,void 0,2)}(ui=function(e,t){return Object(i.inject)(Nt.b)(e,void 0,3)}(ui=Reflect.metadata("design:type",Function)(ui=Reflect.metadata("design:paramtypes",[void 0===Nt.h?Object:Nt.h,void 0===pi.b?Object:pi.b,void 0===kt.SidebarController?Object:kt.SidebarController,void 0===Nt.b?Object:Nt.b])(ui=class{constructor(e,t,s,i){this.previewManager=e,this.adminSettingController=t,this.sidebar=s,this.convDataManager=i,this.lastOpenConv=new Map,this._es=void 0,this.onRequestJumtoMsg=(e,t)=>{const s=t.conversation,i=e===_t.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT||Vt.a.getListChatBoxViewCurrent().includes(null==s?void 0:s.userId)||s.byPassPIN;if(!s)return;if(s&&!i&&Vt.a.isThreadHidden(s.userId))return Object(Zt.b)({type:e,payload:t},!0),void vi("req jum to msg rejected because hidden chat");fi.e.Fps.record(fi.b.fps_jump_to_msg),vi("req jum to msg open on main"),Object(Zt.b)({type:e,payload:t},!0);const n=mi.b.fromJumpMessage();this.openConversationForJump(s.userId,n)},this.tryToFocusChild=(e,t)=>!!Us.default.isOpenChildWindowByConvId(e)&&(vi("Open conv forward because already open in child => call focus"),Us.default.focusOnChildWindow(e,null==t?void 0:t.callPoint),!0),this.handleOutConversation=e=>{this.closeConversation(e.convId)},this.listenEvent()}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}listenEvent(){It.default.subscribe(((e,t)=>{switch(e){case _t.ConversationListActions.SELECT_CONVERSATION_HIDDEN:this.sidebar.updateSelectedId(t.userId);break;case _t.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH:this.onRequestJumtoMsg(_t.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH,t);break;case _t.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:this.onRequestJumtoMsg(_t.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT,t)}})),this.convDataManager.addEventListener(zt.b.DeleteConv,this.handleOutConversation),this.convDataManager.addEventListener(zt.b.EmptyConv,this.handleOutConversation),this.convDataManager.addEventListener(zt.b.LeaveGroup,this.handleOutConversation)}isConvOpeningInMain(e){const t=this.eventStore.getState(),s=this.sidebar.getState().selectedId;return t&&t.chatview.view===Ls.c.CHAT_VIEW&&s===e}openConversationForJump(e,t){return void 0===t&&(t=mi.a),new Promise((async s=>{if(vi(`Request open conv for jum: ${e}`),!e||this.isConvOpeningInMain(e)){if(vi(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||Us.default.focusOnMainWindow()}return s(!1)}if(!(await this.conversationWillOpen(e)))return s(!1);let i=!1;if(t.window===hi.b.Child)return i=this.tryToFocusChild(e,t),s(i);if(t.window===hi.b.PreferChild){if(i=this.tryToFocusChild(e,t),i)return s(!0)}else t.window===hi.b.MainAndChild&&(i=this.tryToFocusChild(e,t));i||Us.default.focusOnMainWindow(),It.default.send(_t.ConversationListActions.SELECT_CONV_MINOR,{userId:e}),Object(Zt.b)({type:_t.ConversationListActions.OPEN_CONV_FOR_JUMP,payload:{userId:e}}),this.sidebar.updateSelectedId(e),s(!0),this.conversationDidOpen(e)}))}openConversation(e,t){return void 0===t&&(t=mi.a),new Promise((async(s,i)=>{if(vi(`Request open conv from: ${e} - ${t.callPoint}`),!e||this.isConvOpeningInMain(e)&&!t.force){if(vi(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||Us.default.focusOnMainWindow()}return s(!1)}const n=Qt.p.getSessionUserId();if(e==n)return gi.showMyProfile(),s(!1);fi.e.Fps.record(fi.b.fps_switch_conv);if(!(await this.conversationWillOpen(e)))return s(!1);let r=!1;if(t.window===hi.b.Child)return r=this.tryToFocusChild(e,t),s(r);if(t.window===hi.b.PreferChild){if(r=this.tryToFocusChild(e,t),r)return s(!0)}else t.window===hi.b.MainAndChild&&(r=this.tryToFocusChild(e,t));let a=t.credentConv;if(a||(a=await Me.default.getLikeConversation(e).catch((e=>{vi(`Failure to load conv from store ${e}`)})),vi(`Try to use storage conv: ${!!a}`)),a||(a=t.defaultConv,vi(`Try to use default conv: ${!!a}`)),!a)return vi(`Open conv not exists: ${e}`),s(!1);r||Us.default.focusOnMainWindow(),It.default.send(_t.ConversationListActions.SELECT_CONV_MINOR,a);const o=Vt.a.isThreadHidden(e);o&&Vt.a.checkShowUnreadHiddenChat(e),t.byPassPIN?(a=Object(f.a)({},a),a.byPassPIN=1):delete a.byPassPIN,this.eventStore.dispatch({type:_t.ConversationListActions.SELECT_CONVERSATION,payload:a}),It.default.send(_t.ConversationListActions.SELECT_CONVERSATION,{userId:a.userId,needScroll:t.callPoint!==hi.a.ConvItem,callPoint:t.callPoint});(!o||t.byPassPIN||Vt.a.getListChatBoxViewCurrent().includes(a.userId))&&this.sidebar.updateSelectedId(e),s(!0),this.conversationDidOpen(e)}))}closeConversation(e,t){return void 0===t&&(t=$t.c),new Promise((s=>{if(e&&this.sidebar.getState().selectedId!==e)return s(!1);if(t===$t.c){const e={conversation:null,convId:null};this.eventStore.dispatch({type:_t.ConversationListActions.SELECT_CONVERSATION,payload:e}),It.default.send(_t.ConversationListActions.SELECT_CONVERSATION,e),this.sidebar.updateSelectedId(null)}s(!0)}))}closeAllConversations(){return Promise.resolve(!0)}deleteConversation(e,t){return void 0===t&&(t=$t.c),new Promise((async s=>{if(this.conversationWillDelete(e),await At.a.deleteConversation(e,!0,t),t===$t.c){const t={userId:null};this.eventStore.dispatch({type:_t.ConversationListActions.SELECT_CONVERSATION,payload:t}),It.default.send(_t.ConversationListActions.SELECT_CONVERSATION,t),this.sidebar.updateSelectedId(null),s(!0),this.conversationDidDelete(e)}else s(!1)}))}pinConversation(e){return Promise.resolve(!0)}renameConversation(e){return Promise.resolve(!0)}getLastOpenConv(e){return this.lastOpenConv.get(e)}conversationWillOpen(e){return vi(`Will open conv ${e}`),this.lastOpenConv.set(e,Date.now()),Promise.resolve(!0)}conversationDidOpen(e){fi.e.start(fi.b.open_conversation,e),vi(`Did open conv ${e}`),this.adminSettingController.onLoadSetting(e),setTimeout((()=>{this.previewManager.revalidate(e)}),0)}conversationWillDelete(e){return vi(`Will delete conv ${e}`),Promise.resolve()}conversationDidDelete(e){vi(`Did delete conv ${e}`),this.lastOpenConv.delete(e)}})||ui)||ui)||ui)||ui)||ui)||ui)||ui)||ui;var yi,Ii=s("s9sK"),_i=s("TeMN"),Mi=s("bUXd"),Ci=(s("EHdh"),s("Ln14")),Ti=s("bdot"),Oi=s("cfFl"),Ei=s.n(Oi);const Si={userId:L.CONV_FILTER.STRANGER,label:null,isGroup:!1,respondedByMe:!1,numMsg:0,pinned:0,outside:0,topOut:!1,infoCheckSearch:null},wi=["userId","label","firstSmsLocalId","lastSmsLocalId","isGroup","respondedByMe","numMsg","pinned","outside","lastActionId","topOutImprTimeOut","topOutTimeOut","syncFromMobile","topOut","localType","infoCheckSearch","preLastSmsLocalId"];Object(Bt.b)(Ci.c)(yi=function(e,t){return i.ModuleContainer.inject(_i.b)(e,void 0,0)}(yi=Reflect.metadata("design:type",Function)(yi=Reflect.metadata("design:paramtypes",[void 0===zt.IReactiveDB?Object:zt.IReactiveDB])(yi=class extends Y.b{constructor(e){super(),this.DBConvInfo=e,this.name=void 0,this.key=void 0,this.data=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.fetchAllHolder=void 0,this.preloadCached=void 0,this._pm=void 0,this.pinEventQueue=void 0,this.labelEventQueue=void 0,this.doneEventQueue=void 0,this.name=Ci.a,this.key="convId",this.data=new Map,this.didInit=!1,this.doneLoadDB=!1,this.fetchAllHolder=null,this.preloadCached=null,this._pm=null,this.pinEventQueue=[],this.labelEventQueue=[],this.doneEventQueue=!1}get previewManager(){return this._pm||(this._pm=i.ModuleContainer.resolve(Nt.h)),this._pm}get unreadManager(){return Dt.a.UnreadDataManager}init(){return this.didInit?Promise.resolve():(this.didInit=!0,this.loadData())}async loadData(){this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll());const e=await this.fetchAllHolder.catch((e=>{bt.default.logCoreInfo(`[${this.name}] - load conv from DB got error ${e}`)}))||[],t=await this.onLoadDataFromDB(e);bt.default.logCoreInfo(`[${this.name}] - done load db ${e.length}`),this.doneLoadDB=!0,this.doIdleTask(),this.broadcastEvent(zt.b.DoneLoadDB,"",e),this.previewManager.migrate(t.map((e=>e.userId))),this.setCacheData(L.CONV_FILTER.STRANGER,Si,!0)}async doIdleTask(){const e=this.pinEventQueue.slice(),t=this.labelEventQueue.slice();this.pinEventQueue=[],this.labelEventQueue=[];const s=Ei.a.series(e),i=Ei.a.series(t);return Promise.all([s,i]).then((e=>this.pinEventQueue.length||this.labelEventQueue.length?this.doIdleTask():(this.doneEventQueue=!0,e)))}getItem(e,t){return this.data.get(e.key)}getList(e,t){return e.key===Ci.b.ALL?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}async onLoadDataFromDB(e){const t=await xt.a.filterOutdatedConv(e);bt.default.logCoreInfo(`[${this.name}] - done filter outdate ${e.length} ${t.length}`);const s=(new Date).getTime().toString(),i=[];Object(st.i)(s);for(let n=0;n<t.length;n++){if(!t[n].userId)continue;const e=Object(f.a)({},t[n]),r=this.data.get(e.userId);if(e.verified=!0,void 0===e.isGroup&&(e.isGroup=e.userId.startsWith(L.GROUPID_PREFIX)),r){if(!r.verified){const t=this.mergeConv(e,r);t.verified=!0,this.setCacheData(e.userId,t),Object(st.f)(s,this.name,e.userId),this.updateInDB(t)}}else this.setCacheData(e.userId,e),Object(st.f)(s,this.name,e.userId);e.infoCheckSearch&&(e.infoCheckSearch&&bt.default.msgTypeValid(e.infoCheckSearch.lastType)?us.a.pushCacheLastChat(e.userId,e.infoCheckSearch.lastMessageTime):e.numMsg&&e.numMsg>1&&i.push(e.userId))}return i.length>0&&us.a.cacheCheckLastChatInDb(i),Object(st.c)(s),t}onReceiveNewMessages(e,t,s){return void 0===s&&(s={outside:void 0,isGroup:!1}),new Promise(((i,n)=>{var r;if(!t||t.length<0)return n("Empty msgs");const a=t[t.length-1],o=t[0],d=this.data.get(e),l=xt.a.getLastValidMsg(t);let c;l&&(c={lastMessageTime:Number(l.sendDttm),lastType:l.msgType},us.a.pushCacheLastChat(e,c.lastMessageTime));const h={userId:e,firstSmsLocalId:o.msgId,isGroup:s.isGroup||e.startsWith(L.GROUPID_PREFIX),numMsg:t.length,respondedByMe:ss.b.includeMyMessage(t),pinned:0,label:null,topOut:a.topOut,verified:!1,lastSmsLocalId:a.msgId,outside:s.outside,cloudMore:!1,infoCheckSearch:c};if(this.preloadCached&&this.preloadCached.onNewMsg(e,a),d){const t=this.mergeConv(Object(f.a)({},d),h);this.setCacheData(e,t),this.shouldSignalUpdate(d,t)&&Object(st.g)(this.name,e),d.verified&&this.updateInDB(t),i(t)}else{const t=Wt.b.getLabelObjByConversaionId(e);if(h.label=t?t.id:null,this.setCacheData(e,h,!0),this.doneLoadDB)return h.verified=!0,this.updateInDB(h),i(h);this.DBConvInfo.getById(e).then((t=>{const s=this.data.get(e);if(!s)return n("Internal logic handle wrong");let r=Object(f.a)({},s);r.verified=!0,t?s.verified||(r=this.mergeConv(r,t),this.setCacheData(e,r),this.shouldSignalUpdate(r,s)&&Object(st.g)(this.name,e),this.updateInDB(r)):this.updateInDB(r),i(r)}))}d&&d.respondedByMe||null===(r=this.data.get(e))||void 0===r||!r.respondedByMe||(bt.default.logCoreInfo(`[${this.name}] - Detect first my msg ${e} ${a.msgId}`),this.previewManager.forceChangeItem(e))}))}async onDeleteMessages(e,t){const s=this.data.get(e);if(bt.default.logCoreInfo(`[${this.name}] - onDeleteMessages #1 ${e} ${t.length}`),s&&s.verified){let i=!1;if(t.find((e=>{let{msgId:t}=e;return s.firstSmsLocalId===t}))){const t=await(await Ti.b.getFirstMessage(e)).firstMsg;if(!t)return bt.default.logCoreInfo(`[${this.name}] - onDeleteMessages #4 ${e} `),this.forkDeleteCacheAndDB(e),{deletedId:e};s.firstSmsLocalId=null==t?void 0:t.msgId,i=!0}if(t.find((e=>{let{msgId:t}=e;return s.lastSmsLocalId===t}))){const t=await Ti.b.getLastMessage(e,s.lastSmsLocalId);if(!t||t.length<1)return bt.default.logCoreInfo(`[${this.name}] - onDeleteMessages #5 ${e} ${!!t}`),this.forkDeleteCacheAndDB(e),{deletedId:e};s.lastSmsLocalId=t[0].msgId,i=!0}return bt.default.logCoreInfo(`[${this.name}] - onDeleteMessages #6 ${e} ${i}`),i&&(this.setCacheData(e,Object(f.a)({},s)),this.updateInDB(s)),{conversation:s,updated:i}}{const t=await(await Ti.b.getFirstMessage(e)).firstMsg,s=await Ti.b.getLastMessage(e),i=s&&s[0];if(!t||!i)return bt.default.logCoreInfo(`[${this.name}] - onDeleteMessages #2 ${e} ${!!t} ${!!i}`),Dt.a.PinDataManager.isPinned(e)||this.onDeleteConversation(e),{deletedId:e};const n=await this.DBConvInfo.getById(e);let r=bt.default.msgTypeValid(i)?{lastMessageTime:i.sendDttm,lastType:i.msgType}:void 0;if(bt.default.logCoreInfo(`[${this.name}] - onDeleteMessages #3 ${e} ${!!n}`),n){let s=!1;n.firstSmsLocalId!==(null==t?void 0:t.msgId)&&(n.firstSmsLocalId=null==t?void 0:t.msgId,s=!0),n.lastSmsLocalId!==i.msgId&&(n.lastSmsLocalId=null==i?void 0:i.msgId,s=!0);const r=Object(f.a)(Object(f.a)({},n),{},{verified:!0});return this.setCacheData(e,r,!0),s&&this.updateInDB(r),{conversation:r,updated:!0}}{const s={userId:e,isGroup:e.startsWith(L.GROUPID_PREFIX),pinned:0,label:null,topOut:void 0,verified:!0,outside:null,cloudMore:!1,firstSmsLocalId:t.msgId,lastSmsLocalId:i.msgId,numMsg:2,respondedByMe:"0"==t.fromUid||"0"==i.fromUid,infoCheckSearch:r};return this.setCacheData(e,s,!0),this.updateInDB(s),{conversation:s,updated:!0}}}}mergeConv(e,t){return(!e.lastSmsLocalId||t.lastSmsLocalId&&t.lastSmsLocalId>e.lastSmsLocalId)&&(e.preLastSmsLocalId=e.lastSmsLocalId||t.lastSmsLocalId,e.lastSmsLocalId=t.lastSmsLocalId,e.outside=t.outside),e.numMsg=(e.numMsg||0)+t.numMsg,e.respondedByMe=e.respondedByMe||t.respondedByMe,(!e.firstSmsLocalId||t.firstSmsLocalId&&t.firstSmsLocalId<e.firstSmsLocalId)&&(e.firstSmsLocalId=t.firstSmsLocalId),(!e.infoCheckSearch||!e.infoCheckSearch.lastMessageTime||t.infoCheckSearch&&t.infoCheckSearch.lastMessageTime>e.infoCheckSearch.lastMessageTime)&&(e.infoCheckSearch=t.infoCheckSearch),e.preLastSmsLocalId||(e.preLastSmsLocalId=t.lastSmsLocalId),!t.respondedByMe&&t.topOut&&(e.topOut=t.topOut),"string"!=typeof e.firstSmsLocalId&&(e.firstSmsLocalId=""+e.firstSmsLocalId),e}async onEmptyConversation(e){const t=await this.getConvById(e);if(bt.default.logCoreInfo(`[${this.name}] - onEmptyConversation ${e} ${!!t}`),!t)return;const s=Object(f.a)({},t);return delete s.firstSmsLocalId,delete s.lastSmsLocalId,s.numMsg=0,s.respondedByMe=!1,this.setCacheData(e,s,!0),this.broadcastEvent(zt.b.EmptyConv,e),Object(st.g)(this.name,e),Dt.a.PinDataManager.isPinned(e)&&Dt.a.PinDataManager.unpin([e]),this.updateInDB(s)}onDeleteConversation(e){bt.default.logCoreInfo(`[${this.name}] - onDeleteConversation ${e}`);const t=this.data.get(e);return this.doDeleteConversation(e).then((s=>{this.broadcastEvent(zt.b.DeleteConv,e,t)}))}doDeleteConversation(e){const t=this.data.get(e);return bt.default.logCoreInfo(`[${this.name}] - doDeleteConversation ${e} ${!!t}`),t&&(this.data.delete(e),Object(st.e)(this.name,e)),Dt.a.PinDataManager.isPinned(e)&&Dt.a.PinDataManager.unpinLocal([e]),this.deleteInDB(e)}onPinConversation(e,t){return new Promise((s=>{this.doneEventQueue?this.doUpdatePin(e,t).then(s):this.pinEventQueue.push((async()=>{const i=await this.doUpdatePin(e,t);s(i)}))}))}doUpdatePin(e,t){if(t&&xt.a.isStrangerV2(e))return Promise.resolve(null);if(!this.data.get(e)){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const s=new Map;return s.set("pinned",t),this.updateFields(e,s).then((s=>(this.broadcastEvent(zt.b.ChangePinConv,e,t),s))).catch((t=>(bt.default.logCoreInfo(`[${this.name}] - doUpdatePin err`,t),this.data.get(e))))}onLeaveGroup(e){return bt.default.logCoreInfo(`[${this.name}] - onLeaveGroup ${e}`),this.doDeleteConversation(e).then((t=>{this.broadcastEvent(zt.b.LeaveGroup,e)}))}async onChangeConvLabel(e,t){return new Promise((s=>{const i=this.data.get(e);if(i&&i.label===t)return s(i);this.doneEventQueue?this.doUpdateConvLabel(e,t).then(s):this.labelEventQueue.push((async()=>{const i=await this.doUpdateConvLabel(e,t);s(i)}))}))}doUpdateConvLabel(e,t){if(!e)return bt.default.logCoreInfo(`[${this.name}] - doUpdateConvLabel with undefined ${t}`),Promise.resolve(null);const s=this.data.get(e);if(s&&s.label===t)return Promise.resolve(s);if(!s){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const i=new Map;return i.set("label",t),this.updateFields(e,i).then((i=>(this.unreadManager.onChangeConvLabel(e,null==s?void 0:s.label,t),i)))}onFetchConvLabels(e){if(!e||!Array.isArray(e))return;bt.default.logCoreInfo(`[${this.name}] - onChangeConvLabel ${e.length}`);const t={};this.getAllConv().then((s=>{for(let e=0;e<s.length;e++)t[s[e].userId]=1;for(let i=0;i<e.length;i++){const s=e[i].id,n=e[i].conversations;if(n)for(let e=0;e<n.length;e++){const i=n[e];delete t[i],this.onChangeConvLabel(i,s)}}for(const e in t)Object.hasOwnProperty.call(t,e)&&this.onChangeConvLabel(e,null)}))}onDeleteConvLabels(e){bt.default.logCoreInfo(`[${this.name}] - onDeleteConvLabels ${e.length}`),e.forEach((e=>{const t=e.conversations;if(t&&t.length)for(let s=0;s<t.length;s++)this.data.has(t[s])&&this.onChangeConvLabel(t[s],null)}))}async onUpdateMsgId(e,t,s){if(!t||!s||t===s)return Promise.reject("[Conv-info-manager]- call update with invalid params!");const i=this.data.get(e);let n=i||{},r=!1;if(!i||!i.verified){const t=await this.DBConvInfo.getById(e);if(!i&&!t){const t=await this.createEmptyConvForUser(e,0,void 0,{firstSmsLocalId:s,lastSmsLocalId:s});return this.setCacheData(e,t),t}i&&t?(n=this.mergeConv(i,t),r=!0):(n=i||t,n.verified=!0,r=!0)}return n.firstSmsLocalId&&n.firstSmsLocalId!==t||(r=!0,n.firstSmsLocalId=s),n.lastSmsLocalId&&n.lastSmsLocalId!==t||(r=!0,n.lastSmsLocalId=s),r&&(this.setCacheData(e,n),this.updateInDB(n)),n}async addOrUpdateConv(e,t,s,i,n,r){"number"==typeof t&&(t=""+t),"number"==typeof s&&(s=""+s);const a=this.data.get(e);bt.default.logCoreInfo(`[${this.name}] - addOrUpdateConv ${e} ${!!a} ${s}`);const o=e=>((!e.firstSmsLocalId||t&&t<e.firstSmsLocalId)&&(e.firstSmsLocalId=t),(!e.lastSmsLocalId||s&&s>e.lastSmsLocalId)&&(e.lastSmsLocalId=s),e.cloudMore=i,e.respondedByMe=e.respondedByMe||n,e.numMsg=(e.numMsg||0)+r,e);if(a&&a.verified){const t=o(a);return this.setCacheData(e,Object(f.a)({},t)),this.updateInDB(t),t}{const a=await this.DBConvInfo.getById(e);if(bt.default.logCoreInfo(`[${this.name}] - addOrUpdateConv #2 ${e} ${!!a}`),a){const t=o(a);return this.setCacheData(e,Object(f.a)(Object(f.a)({},t),{},{verified:!0})),this.updateInDB(t),t}{const a={userId:e,firstSmsLocalId:t,lastSmsLocalId:s,isGroup:e.startsWith(L.GROUPID_PREFIX),respondedByMe:n,numMsg:r||2,label:null,pinned:0,verified:!0,cloudMore:i,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,a,!0),this.updateInDB(a),a}}}async addIfNotExistsConv(e,t,s,i,n,r){const a=this.data.get(e);if(bt.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #1 ${e} ${!!a} ${i}`),a)return!1;const o=await this.DBConvInfo.getById(e);if(bt.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #2 ${!!o}`),o)return!1;{const a={userId:e,firstSmsLocalId:s,lastSmsLocalId:i,isGroup:t||e.startsWith(L.GROUPID_PREFIX),respondedByMe:n,numMsg:r||1,label:null,pinned:0,verified:!0,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,a,!0),this.updateInDB(a),!0}}createEmptyConvForUser(e,t,s,i){return void 0===s&&(s=L.CONV_OT_STATE.none),new Promise(((n,r)=>{this.getConvById(e).then((n=>{let r;if(bt.default.logCoreInfo(`[${this.name}] - createEmptyConvForUser ${e} ${!!n}`),n){const i=new Map;return r=n,s!==L.CONV_OT_STATE.none&&void 0!==s&&(r.outside=s,i.set("outside",s)),t&&!Dt.a.PinDataManager.isPinned(r.userId)&&Dt.a.PinDataManager.pin([r.userId]),this.updateFields(e,i),r}return r=Object(f.a)({userId:e,lastMessageTime:t?0:Mi.a.getTimeNow(),isGroup:e.startsWith(L.GROUPID_PREFIX)},i),s!==L.CONV_OT_STATE.none&&void 0!==s&&(r.outside=s),t&&Dt.a.PinDataManager.pin([r.userId]),r.verified=!0,this.setCacheData(e,r,!0),this.updateInDB(r),r})).then((e=>{n(e)})).catch((e=>{bt.default.logCoreError(e),r(e)}))}))}updateLastMsgId(e,t){const s=this.data.get(e);if(s&&s.lastSmsLocalId===t)return Promise.resolve(s);const i=new Map;return i.set("lastSmsLocalId",t),this.updateFields(e,i)}updateInfoCheckSearch(e,t,s){const i=this.data.get(e);if(i&&i.infoCheckSearch&&i.infoCheckSearch.lastMessageTime===t)return Promise.resolve(i);const n=new Map;return n.set("infoCheckSearch",{lastMessageTime:t,lastType:s}),this.updateFields(e,n)}updateConvSetting(e,t){let s=this.data.get(e);if(!s){const i=!!this.doneLoadDB;s={userId:e,verified:i},i||bt.default.logCoreInfo(`[${this.name}] - update conv setting before done load db ${e}`,t)}bt.default.shallowEqual(s.setting,t)||(s.setting=t,this.setCacheData(e,s,!0),bt.default.logCoreInfo(`[${this.name}] - update conv setting for conv ${e}`,t))}async isRespondedByMe(e){const t=await this.getConvById(e);return!!t&&Boolean(t.respondedByMe)}isRespondedByMeSync(e){const t=this.data.get(e);return!!t&&Boolean(t.respondedByMe)}isDoneLoadDB(){return this.doneLoadDB}getConvByIdSync(e){return"string"!=typeof e&&bt.default.logCoreInfo(`[${this.name}] - getConvByIdSync with invalid id type`,e,!!this.data.get(e),!!this.data.get(""+e)),this.data.get(e)}getConvById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvInfo.getById(e).then((e=>{t(e)})).catch(s)}))}getAllConvSync(){return Array.from(this.data.values())||[]}getAllConv(){return new Promise(((e,t)=>{if(this.doneLoadDB){return e(this.getAllConvSync())}this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll()),this.fetchAllHolder.then(e).catch(t)}))}getAllConvIdsSync(){return Array.from(this.data.keys())}setPreloadCache(e){this.preloadCached=e}onDoneSyncMobile(){bt.default.logCoreInfo(`[${this.name}] - onDoneSyncMobile`),this.getAllConv().then((e=>{e&&this.previewManager.migrate(e.map((e=>e.userId)),!0)}))}setCacheData(e,t,s){void 0===s&&(s=!1),this.data.set(t.userId,t),s&&Object(st.g)(this.name,e)}updateFields(e,t){return new Promise(((s,i)=>{const n=this.data.get(e),r=n=>{bt.default.logCoreInfo(`[${this.name}] - updateFields #2`);const r=Object(f.a)({},n);t.forEach(((e,t)=>{r[t]=e})),this.setCacheData(e,r,!0),this.updateInDB(r).then((()=>{s(r)})).catch(i)};n?r(n):this.DBConvInfo.getById(e).then((e=>{e&&r(e)}))}))}forkDeleteCacheAndDB(e){if(bt.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e}`),!Dt.a.PinDataManager.isPinned(e)){const t=this.data.get(e);bt.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e} ${!!t}`),this.data.delete(e),Object(st.e)(this.name,e),this.deleteInDB(e).then((s=>{this.broadcastEvent(zt.b.DeleteConv,e,t)}))}}broadcastEvent(e,t,s){void 0===t&&(t=""),this.dispatchEvent(new zt.a(e,t,s))}shouldSignalUpdate(e,t){return Dt.a.PinDataManager.isPinned(e.userId)!==Dt.a.PinDataManager.isPinned(t.userId)||e.label!==t.label||e.respondedByMe!==t.respondedByMe}cleanConversation(e){return Object.keys(e).forEach((t=>{wi.includes(t)||delete e[t]})),e}getEmptyConv(e){return{userId:e,isGroup:e.startsWith(L.GROUPID_PREFIX),numMsg:0,respondedByMe:!1,pinned:0,label:null,outside:null,infoCheckSearch:null,topOut:null}}updateInDB(e){const t=this.cleanConversation(Object(f.a)({},e));return this.DBConvInfo.addOrUpdate(t).catch((e=>{bt.default.logCoreInfo(`[${this.name}] - updateInDB got error ${e}`)}))}deleteInDB(e){return this.DBConvInfo.remove(e).catch((e=>{bt.default.logCoreInfo(`[${this.name}] - deleteInDB got error ${e}`)}))}})||yi)||yi)||yi);var Li=s("NSWB"),Di=s("1Abx"),Fi=s("XEtq"),Ri=s("ZRfj"),Ai=s("EqtE"),Pi=s("oH3T"),Ni=s("13iL"),ji=s("mea/"),Ui=s("MPLC"),Bi=s("WK05");var ki,Gi=s("dwTj"),xi=s("RVT8"),zi=s("hkvp"),Vi=s("6tnf"),$i=s("sg3c"),Wi=s("4pY7"),qi=s("ofhN"),Ki=s("D8f9");const Hi="9999999999999999",Qi="zum_m",Ji="1.0.0",Zi=!1,Xi="total",Yi=e=>({convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"",lastSeenReactId:"",unreadMark:void 0}),en={CALL_INIT:!1},tn=1,sn=2;Object(Bt.b)(xi.b)(ki=function(e,t){return i.ModuleContainer.inject(zi.b)(e,void 0,0)}(ki=Reflect.metadata("design:type",Function)(ki=Reflect.metadata("design:paramtypes",[void 0===zt.IReactiveDB?Object:zt.IReactiveDB])(ki=class extends Y.b{constructor(e){super(),this.DBConvUnread=e,this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this.pendingMessage=void 0,this.previewMsgs=void 0,this.pendingClearUnread=void 0,this.fetchAllHolder=void 0,this.total=void 0,this.loadState=en,this.isLoadDBStarted=void 0,this.updateTotalQueue=void 0,this._logger=void 0,this.setupQueue=()=>Object(Oi.queue)((async e=>{this.doneLoadDB&&await this.calculateComputeUnreadCount(e)}),1),this._getDeletedMsgByTTLItem=(e,t)=>{if(t)return t.find((t=>e.msgId?e.msgId===t.msgId:e.cliMsgId===t.cliMsgId))},this.name=xi.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.isLoadDBStarted=!1,this.pendingMessage=new Map,this.previewMsgs=[],this.pendingClearUnread=new Map,this.fetchAllHolder=null,this.total=this.getEmptyTotal(),this.updateTotalQueue=this.setupQueue()}init(){this.didInit||(this.logger.zsymb(3,9683,3e4,"call init unread"),this.didInit=!0,this.addListener(),this.onState("CALL_INIT"))}onState(e){this.loadState[e]=!0;const t=Object.values(this.loadState).every((e=>!0===e));t&&!this.isLoadDBStarted&&(this.logger.zsymb(3,9683,30001,"done all state, ready to load db..."),this.loadData())}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.conversation,[ns.b.unread])),this._logger}getEmptyTotal(){return{convId:"total",smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:0,smsUnreadNomute:0}}loadData(){const e=T.a.getInstance().getItemForCurrentUser(Qi);if(e===Ji)this.isLoadDBStarted=!0,this.logger.zsymb(3,9683,30002,"start load unread {}",e),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((e=>{this.onLoadUnreadFromDBV2(sn,e),this.doDoneLoadDBTask()}));else{Dt.a.ConvInfoDataManager.isDoneLoadDB()&&(this.isLoadDBStarted=!0,this.migrateV2())}}async migrateV2(){const e=T.a.getInstance(),t=e.getItemForCurrentUser(Qi)===Ji;if(this.logger.zsymb(3,9683,30003,"call migrate unread {}",t),t)return;const s=Dt.a.ConvInfoDataManager.getAllConvSync(),i=[];s.forEach((e=>{const t=e.smsUnreadCount||0,s=e.smsUnreadNotCount||0,n=e.mentionUnreadCount||0,r=e.unreadMark||null;if(!(e&&e.userId&&(t||s||n||r)))return;const a={convId:e.userId,smsUnreadCount:t,smsUnreadNotCount:s,strangerUnreadCount:0,mentionUnreadCount:n,lastProcessMsgId:e.lastMessageIdFromServerv2||"0",lastSeenReactId:e.lastSeenReactId||"0",unreadMark:r};i.push(a)})),this.onLoadUnreadFromDBV2(tn,i),this.doDoneLoadDBTask(),this.logger.zsymb(3,9683,30004,"done migrate unread {}",i.length),e.setItemForCurrentUser(Qi,Ji)}doDoneLoadDBTask(){const e=Array.from(this.data.values());this.doneLoadDB=!0,this.broadcastEvent(zt.b.DoneLoadDB,"total",e),this.logger.zsymb(3,9683,30005,"done load unread {}",e.length),i.ModuleContainer.resolve(Wi.a).onLoadUnreads(e),setTimeout((()=>{this.unreadChanged("init")}),200)}addListener(){Dt.a.MuteDataManager.addEventListener(zt.b.MuteChanged,(e=>{this.onMuteConversation(e.convId,!!e.payload)})),Dt.a.ConvInfoDataManager.addEventListener(zt.b.LeaveGroup,(e=>{this.doDeleteUnread(e.convId)})),Dt.a.ConvInfoDataManager.addEventListener(zt.b.DeleteConv,(e=>{this.doDeleteUnread(e.convId)})),Dt.a.ConvInfoDataManager.addEventListener(zt.b.EmptyConv,(e=>{this.doDeleteUnread(e.convId)})),Dt.a.ConvInfoDataManager.addEventListener(zt.b.DoneLoadDB,(e=>{this.onState("CALL_INIT")})),Dt.a.ArchivedChatManager.addEventListener(zt.b.UpdateListArchivedChat,(e=>{this.onArchivedChat(e.convId)})),It.default.subscribe(((e,t)=>{if(null!=t&&t.length&&e===_t.ConversationListActions.CLEAR_MARK_AS_UNREAD)t.forEach((e=>{this.updateUnreadMark(e,null)}));else if(null!=t&&t.length&&e===_t.GeneralActions.UPDATE_HIDDEN_CHAT)for(let s=0;s<t.length;s++){const e=t[s];this.onHiddenConversation(e.uid,e.isHide)}}))}getItem(e,t){if(e.key===Xi)return this.total;return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){throw new Error("Method not implemented.")}onMuteConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||Vt.a.isThreadHidden(e)||xt.a.isOAType({userId:e})||(this.logger.zsymb(0,9683,30006,"onMuteConversation:",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onHiddenConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||Me.default.isMuted(e)||xt.a.isOAType({userId:e})||(this.logger.zsymb(0,9683,30007,"onHiddenConversation: ",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onArchivedChat(e){const t=this.data.get(e);!t||t.smsUnreadCount<1&&!t.unreadMark||Me.default.isMuted(e)||xt.a.isOAType({userId:e})||this.unreadChanged(e)}onChangeConvLabel(e,t,s){const i=this.data.get(e);t===s||!i||i.smsUnreadCount<1||Me.default.isMuted(e)||this.unreadChanged(e)}onReceivePreviewMessages(e){e.length>0&&(this.previewMsgs=[...this.previewMsgs,...e])}onReceiveNewMessagesOld(e,t,s){if(!s||!t)return;const i=this.data.get(e);if(i)this.logger.zsymb(0,9683,30008,"receive msg",e,i.lastProcessMsgId,s),(!i.lastProcessMsgId||i.lastProcessMsgId<t)&&(this.handleNewMessages(e,s,t),Object(st.g)(this.name,e));else{const t=this.pendingMessage.get(e),i=t?s.concat(t):s;this.pendingMessage.set(e,i),i.length===s.length&&this.DBConvUnread.getById(e).then((t=>{if(!t){const t=this.pendingMessage.get(e);if(t){const s=t.filter(((e,t,s)=>s.indexOf(e)===t)),i=ss.b.getLastMessageInList(s);if(!i)return;this.pendingMessage.delete(e),this.handleNewMessages(e,s,i.msgId),Object(st.g)(this.name,e)}}}))}}onReceiveNewMessages(e,t,s){if(!s||!s.length||!t)return;const i=this.data.get(e);if(this.doneLoadDB){if(!i||!i.lastProcessMsgId||i.lastProcessMsgId<t){const n=s.map((e=>e.msgId)).join("-");this.logger.zsymb(0,9683,30009,`onReceiveNewMessages: ${null==i?void 0:i.lastProcessMsgId} ${e} ${t} ${n}`),this.handleNewMessages(e,s,t),Object(st.g)(this.name,e)}}else{const t=this.pendingMessage.get(e),i=t?s.concat(t):s;this.pendingMessage.set(e,i)}}onDoneOffLineMessages(){this.logger.zsymb(0,9683,30010,"ph7 done offline"),Ts.b.onDoneEntry(Ts.a.FIRST_FETCH),this.previewMsgs.length>0&&setTimeout((()=>{this.handlePreviewMsgs()}),0)}doDeleteUnread(e){if(!e)return;const t=this.data.get(e);this.logger.zsymb(0,9683,30011,`doDeleteUnread ${!!t}`),this.data.delete(e)&&(Object(st.e)(this.name,e),this.unreadChanged(e)),this.deleteInDB(e)}onReceiveDeleteConvMsg(e,t){if(this.doneLoadDB){const s=this.safeGetUnreadCached(e);if(0===s.smsUnreadCount)return;if(t>=+s.lastProcessMsgId){const t=Object(f.a)(Object(f.a)({},s),{},{smsUnreadCount:0,smsUnreadNotCount:0});this.data.set(t.convId,t),Object(st.g)(this.name,e),this.unreadChanged(e)}}else this.pendingClearUnread.set(e,t)}onClearUnreadConversations(e){if(!e||e.length<0)return;let t=[];for(let s=0;s<e.length;s++){const i=e[s],n=this.data.get(i.userId)||Yi(i.userId);this.logger.zsymb(0,9683,30012,"onClearUnreadConversations",!!i,null==n?void 0:n.smsUnreadCount),i&&(t.push(i.userId),n.smsUnreadCount>0&&Me.default.getLastMessageFrom(i.userId,i.lastSmsLocalId,Hi,n.smsUnreadCount,!0).then((e=>{let t={};if(e&&e.length>0)for(let i=0;i<e.length;i++){let s=e[i];bt.default.validMessageFromOther(s)&&(t[s.msgId]=s)}const s={userId:i.userId,lastSmsLocalId:i.lastSmsLocalId,smsUnreadCount:n.smsUnreadCount};this.clearUnreadConversation(s,t),this.resetUnreadToZero(i.userId,n.lastProcessMsgId)})).catch((e=>{this.logger.zsymb(21,9683,30013,"clear unread conv failure {}",e)})),Bi.a.clearUnreadIfExist({userId:i.userId,lastSeenReactId:n.lastSeenReactId}))}Ai.a.clearUnreadMark(t,e.length)}onReadConversation(e,t){var s;if(pt.default.mark_unread.enable&&!Ai.a.canSendUnread(e))return this.logger.zsymb(0,9683,30014,`[read-message] dont clear ${e}`,pt.default.mark_unread.enable,Ai.a.canSendUnread(e)),!1;Ai.a.getUnreadMark(e)&&(e.startsWith(L.GROUPID_PREFIX)?Ze.e.logAction(2160024):Ze.e.logAction(2160023),Ze.e.logAction(2160022));const i=this.data.get(e)||Yi(e),n=i.smsUnreadCount;if(!t&&!n){this.logger.zsymb(0,9683,30015,`[read-message] dont clear ${e} unread `,n,t);const s=Bi.a.sendClearUnread(e,i.lastSeenReactId);return Ai.a.clearUnreadMark([e],0),s!=i.lastSeenReactId&&(i.lastSeenReactId=s,this.data.set(e,Object(f.a)({},i)),Object(st.g)(this.name,e),this.updateInDB(i)),!1}const r=this.acquireConvManager().getConvByIdSync(e);if(!r)return this.logger.zsymb(0,9683,30016,`[read-message] convinfo not exists ${e}`),!1;const a=[],o={},d=r.lastSmsLocalId?r.lastSmsLocalId.toString().split("_")[0]:"";let l=!1;const c=null===(s=Ui.b.messageCache)||void 0===s?void 0:s.getLast({userId:e},n);for(let g=c.length-1;g>-1;g--){let e=c[g];if(bt.default.validMessageFromOther(e)&&e.zglobalMsgId&&-1!=e.zglobalMsgId&&!a.includes(e.zglobalMsgId)&&(a.push(e.zglobalMsgId),o[e.zglobalMsgId]=e,e.zglobalMsgId==d&&(l=!0),a.length==n))break}const h={userId:e,lastSmsLocalId:r.lastSmsLocalId,smsUnreadCount:n};var u;!d||l||o[d]?this.clearUnreadConversation(h,o):(this.logger.zsymb(0,9683,30017,`[read-message] append lastMsgIdInConv ${d} ${Object.keys(o).length}`),null===(u=Ui.b.messageCache)||void 0===u||u.getMessageByMsgIdAsync(d).then((e=>{o[d]=Object(f.a)({},e),this.clearUnreadConversation(h,o)})).catch((e=>{this.clearUnreadConversation(h,o)})));return Ai.a.clearUnreadMark([e],0),i.lastSeenReactId=Bi.a.sendClearUnread(e,i.lastSeenReactId),this.resetUnreadToZero(e,i.lastProcessMsgId),!0}getUnreadByConvIdSync(e){return this.data.get(e)}getUnreadByConvId(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.getUnreadByConvIdSync(e));this.DBConvUnread.getById(e).then((e=>t(e))).catch(s)}))}getAllUnreadsSync(){return Array.from(this.data.values())}getAllUnreads(){return new Promise(((e,t)=>{if(this.doneLoadDB)return e(this.getAllUnreadsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((t=>e(t))).catch(t)}))}resetUnreadToZero(e,t){return this.getUnreadByConvId(e).then((s=>{if(Pi.b.onClearUnreadConv(e),!s||!s.smsUnreadCount&&!s.smsUnreadNotCount)return!1;this.logger.zsymb(3,9683,30018,"resetUnreadToZero {} {} {}",e,t,s.smsUnreadCount);const i={convId:e,smsUnreadCount:0,mentionUnreadCount:0,strangerUnreadCount:0,smsUnreadNotCount:0,lastProcessMsgId:t,lastSeenReactId:s.lastSeenReactId||"",unreadMark:s.unreadMark};return s.smsUnreadCount>0&&Ri.a.notiMainClearunread(e),this.forkUpdateCacheAndDB(i).then((t=>(this.broadcastEvent(zt.b.ReadConv,e),!0))).catch((t=>(this.logger.zsymb(21,9683,30019,"resetUnreadToZero failure {} {}",e,t),!1)))}))}isUnreadMessage(e){const{message:t,convId:s,lastProcessMsgId:i}=e,n=ss.b.isMyMessage(t),r=Di.b.isRead({userId:s,actionId:t.actionId,msgId:t.msgId,msgSendDttm:t.ts||t.serverTime||t.sendDttm,msgLocalId:void 0,e2eeStatus:Object($i.f)(t)}),a=!t.msgId||!i||t.msgId<=i;return!r&&a&&!n}_updateTTLUnreadCount(e,t,s){const i=this.data.get(e)||null;if(this.logger.zsymb(0,9683,30020,"_updateTTLUnreadCount",e,null==i?void 0:i.smsUnreadCount),i&&i.smsUnreadCount===t&&i.smsUnreadNotCount===s)return;let n=this.safeGetUnreadCached(e);n.smsUnreadCount=t,n.smsUnreadNotCount=s,this.forkUpdateCacheAndDB(n)}updateUnreadTTLConversation(e,t,s){const i=this.getUnreadByConvIdSync(e);if(i){let n=i.smsUnreadCount,r=i.smsUnreadNotCount;t.filter((t=>t.ttlType===Ki.a.Message&&this.isUnreadMessage({message:this._getDeletedMsgByTTLItem(t,s),convId:e,lastProcessMsgId:i.lastProcessMsgId}))).forEach((e=>{const t=this._getDeletedMsgByTTLItem(e,s),i=bt.default.getDataReminder(t),a=ss.b.isMyMessage(t);i&&a&&(t.idTo===pt.default.sendToMeId||a)?(r-=1,n-=1):n-=1})),this._updateTTLUnreadCount(e,Math.max(n,0),Math.max(r,0))}}updateUnreadCount(e,t){const s=this.data.get(e)||null;if(this.logger.zsymb(0,9683,30021,"updateUnreadCount",e,null==s?void 0:s.smsUnreadCount),s&&s.smsUnreadCount===t)return;let i=this.safeGetUnreadCached(e);i.smsUnreadCount=t,this.forkUpdateCacheAndDB(i)}updateMentionCount(e,t){this.logger.zsymb(0,9683,30022,"updateMentionCount",e,t);let s=this.safeGetUnreadCached(e);s.mentionUnreadCount=t,this.forkUpdateCacheAndDB(s,!1),Vi.a.updateUnreadMentions(this.getTotalMentionCount())}updateLastSeenReactId(e,t){let s=this.safeGetUnreadCached(e);s.lastSeenReactId=t,this.forkUpdateCacheAndDB(s,!1)}updateUnreadMark(e,t){let s=this.safeGetUnreadCached(e);s.unreadMark||(s.unreadMark=null),t||(t=null),t!==s.unreadMark&&(this.total.unreadMark+=t?1:-1,Object(st.g)(this.name,Xi),s.unreadMark=t,this.forkUpdateCacheAndDB(s))}shouldClearUnread(e,t){const s=this.data.get(e),i=null==s?void 0:s.smsUnreadCount,n=null==s?void 0:s.lastProcessMsgId;return!!i&&!!(n&&t&&+t>=+n)}async forkUpdateCacheAndDB(e,t){void 0===t&&(t=!0),this.data.set(e.convId,e),Object(st.g)(this.name,e.convId),t&&this.isValidConvKey(e.convId)&&this.unreadChanged(e.convId),await this.updateInDB(e)}safeGetUnreadCached(e){const t=this.data.get(e);let s;return s=t?Object(f.a)({},t):{convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:null},s}getTotalMentionCount(){let e=0;return this.data.forEach((t=>{e+=t.mentionUnreadCount})),e}isValidConvKey(e){return!(!e||e.length<3)&&("null"!=e&&(e!==L.CONV_FILTER.STRANGER&&e!==Xi))}unreadChanged(e){"null"!=e&&(this.updateTotalQueue.remove((e=>!0)),this.updateTotalQueue.push(e))}async calculateComputeUnreadCount(e){try{var t;const n=this.getEmptyTotal(),r=(null===(t=this.data.get(L.CONV_FILTER.STRANGER))||void 0===t?void 0:t.smsUnreadCount)||0;let a=0,o=0;const d=new Map,l=new Map,c=new Map;Dt.a.LabelDataManager.getAllLabelIds().map((e=>{const t=""+e;c.set(t,t)}));const h=new Map,u=[];for(let e of Array.from(this.data.keys())){if(!this.isValidConvKey(e))continue;const t=this.data.get(e);if(!t||Vt.a.isThreadHidden(e))continue;const s=Boolean(t.smsUnreadCount)||Boolean(t.smsUnreadNotCount)||Boolean(t.unreadMark);if(s)if(s&&is.a.isArchivedChat(e)&&!Me.default.isMuted(e)){let t=i.ModuleContainer.resolve(Nt.h).getPreviewByIDSync(e);t&&o<parseInt(t.messageTime)&&(o=parseInt(t.messageTime)||0)}else h.set(e,t),u.push(e)}Zi;if((await xt.a.verifyOATypeAsync(u)).forEach((e=>{let{cid:t,isOA:s}=e;const i=h.get(t),r=i.convId,o=this.acquireConvManager().getConvByIdSync(r),c=Me.default.isMuted(r);const u=i.smsUnreadCount||0,g=i.smsUnreadNotCount||0;if(n.smsUnreadCount+=u,o&&!c&&!s&&o.userId!==L.FAKE_CONVERSATION_ID.FRIEND_CENTER){const e=Math.max(u-g,0);n.smsUnreadNomute+=e;const t=o.label?""+o.label:"",s="0"==t||!!t;if(s&&(d.has(t)?d.set(t,d.get(t)+e):d.set(t,e)),i.unreadMark){const e=n.unreadMark||0;n.unreadMark=e+1,s&&(l.has(t)?l.set(t,l.get(t)+1):l.set(t,1))}e>0&&this.isInStrangerBox(r)&&(a+=e)}})),this.total.smsUnreadCount!==n.smsUnreadCount||this.total.smsUnreadNomute!==n.smsUnreadNomute||this.total.unreadMark!==n.unreadMark){var s;const t=null===(s=this.data.get(e))||void 0===s?void 0:s.smsUnreadCount,i=Me.default.isMuted(e);this.total=n,this.dispatchEvent(new zt.a(zt.b.ChangeUnreadCount,Xi,{unreadNoMute:n.smsUnreadNomute,totalUnread:n.smsUnreadCount,convId:e,currentUnread:t,curentUnreadNoMute:i?0:t})),this.data.set(Xi,n),Object(st.g)(this.name,Xi)}const g=i.ModuleContainer.resolve(ms.b).isShowUnreadArchivedChat(),m=T.a.getInstance().getItemForCurrentUser("last_time_clear_archive_chat")||"0",p=o>parseInt(m);if(p!==g&&this.dispatchEvent(new zt.a(zt.b.ChangeUnreadArchiveChat,Xi,{hasUnreadArchivedChat:p})),r!==a){const e=this.safeGetUnreadCached("");e.smsUnreadCount=a,e.convId=L.CONV_FILTER.STRANGER,this.data.set(L.CONV_FILTER.STRANGER,e),Object(st.g)(this.name,L.CONV_FILTER.STRANGER)}for(let e of Array.from(d.keys())){const t=this.safeGetUnreadCached("");t.smsUnreadCount=d.get(e),t.unreadMark=l.get(e),this.data.set(e,t),c.delete(e),Object(st.g)(this.name,e)}for(let e of Array.from(c.keys()))this.data.delete(e)&&Object(st.g)(this.name,e)}catch(n){this.logger.zsymb(21,9683,30027," unread err - contact phucnh7 please!!! {}",n)}}acquireConvManager(){return Dt.a.ConvInfoDataManager}onLoadUnreadFromDBV2(e,t){if(this.logger.zsymb(0,9683,30029,"onLoadUnreadFromDB",t.length),t.length<1)return;const s=(new Date).getTime().toString();Object(st.i)(s);for(let i=0;i<t.length;i++){const n=t[i];if(Di.b.isRead({userId:n.convId,msgId:+n.lastProcessMsgId,e2eeStatus:void 0,actionId:void 0,msgSendDttm:void 0,msgLocalId:void 0})&&(n.smsUnreadCount||n.smsUnreadNotCount)&&(this.logger.zsymb(0,9683,30030,"clear offline",n.convId,n.smsUnreadCount),n.smsUnreadCount=0,n.strangerUnreadCount=0,n.smsUnreadNotCount=0),this.pendingClearUnread.has(n.convId)){const e=this.pendingClearUnread.get(n.convId);e&&e>=+n.lastProcessMsgId&&(this.logger.zsymb(0,9683,30031,"clear pending",this.pendingClearUnread.size,n.convId),n.smsUnreadCount=0,n.strangerUnreadCount=0,n.smsUnreadNotCount=0)}"null"===n.lastProcessMsgId&&(n.lastProcessMsgId=""),this.data.set(n.convId,n),Object(st.f)(s,this.name,n.convId),e===tn&&this.updateInDB(n),n.unreadMark&&this.total.unreadMark++}this.pendingClearUnread.clear(),this.processPendingMessages(),Object(st.c)(s)}processPendingMessages(){this.logger.zsymb(0,9683,30032,"start processPendingMessages",this.pendingMessage.size),this.pendingMessage.forEach(((e,t)=>{const s=new Map,i=this.data.get(t);e.forEach((e=>{var t;(!i||i.lastProcessMsgId<e.msgId)&&s.set(`${(t=e).uidFrom||t.fromUid}_${t.idTo||t.toUid}_${t.cliMsgId}`,e)})),this.logger.zsymb(0,9683,30033,"check processPendingMessages #2",t,null==i?void 0:i.smsUnreadCount,e.map((e=>e.msgId)),s.keys());const n=Array.from(s.values()),r=ss.b.getLastMessageInList(n);this.handleNewMessages(t,n,null==r?void 0:r.msgId)})),this.pendingMessage.clear()}handleNewMessages(e,t,s){if(!t||!t.length)return;let i=!1;const n={convId:e,strangerUnreadCount:0,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,lastProcessMsgId:s,lastSeenReactId:"0"},r=Date.now(),a=new Set;if(t.forEach((t=>{const o=ss.b.isMyMessage(t);if(t.status!==L.MSG_READ&&!o){const s=t.ts||t.serverTime||t.sendDttm;Di.b.isRead({userId:e,actionId:t.actionId,msgId:t.msgId,msgSendDttm:s,msgLocalId:void 0,e2eeStatus:Object($i.f)(t)})&&(pt.default.stagingAccount&&this.logger.zsymb(0,9683,30034,`mark msg status as read ${e} ${t.actionId} ${t.msgId}`),t.status=L.MSG_READ)}let d=Fi.a.get(t.msgId,t.status);d!=t.status&&pt.default.stagingAccount&&this.logger.zsymb(0,9683,30035,`change msg status ${t.status} => ${d}`),t.status=d;let l=!1;if("chat.todo"===t.msgType){let e=t.content;if(e){"todo.remind"===e.action&&(l=!0)}}let c=bt.default.getDataReminder(t);var h,u;t.status!==L.MSG_READ&&!o||!0===l?(t.paramsExt&&bt.default.valueValid(t.paramsExt.countUnread)&&0==t.paramsExt.countUnread&&(n.smsUnreadNotCount+=1),this.isCallTimeMessage(t)||(n.smsUnreadCount+=1,n.strangerUnreadCount+=1),Li.b.isMessageMentionMe(t)&&n.mentionUnreadCount++):c&&o&&(t.idTo===pt.default.sendToMeId||o)?(n.smsUnreadCount+=1,n.smsUnreadNotCount+=1,this.logger.zsymb(0,9683,30036,`new unread #2: ${r} ${e} ${t.msgId} ${t.idTo} ${t.toUid} ${t.src} ${s}`)):!(h=t)||"0"==h.uidFrom&&(null===(u=h.paramsExt)||void 0===u?void 0:u.platformType)==Ss.i.DeviceIds.SYSTEM?(a.add(t.msgId),this.logger.zsymb(0,9683,30037,"_addMessages: skipped clear unread for",t.idTo)):t.isCallMessage||(n.smsUnreadCount=0,n.strangerUnreadCount=0,n.mentionUnreadCount=0,i=!0),n.smsUnreadCount>0&&Ts.b.markGotUnread(e,t.msgId),Ts.b.isLastMsgV2(t)&&this.onDoneOffLineMessages()})),a.has(s))for(let d=t.length-1;d>=0;d--){const s=t[d];if(bt.default.validMessageFromServer(s)&&!a.has(s.msgId)){this.logger.zsymb(0,9683,30038,"update last process id",e,n.lastProcessMsgId,s.msgId),n.lastProcessMsgId=s.msgId;break}var o;0==d&&(n.lastProcessMsgId=(null===(o=this.data.get(e))||void 0===o?void 0:o.lastProcessMsgId)||"0")}return this.updateUnread(e,i,n)}handlePreviewMsgs(){if(!this.previewMsgs.length)return;const e=[...this.previewMsgs];this.previewMsgs=[],this.logger.zsymb(0,9683,30039,"handle preview",e.map((e=>e.msgId))),e.forEach((e=>{const t=e.toUid,s=Gi.default.checkDuplicate(t,{uidFrom:e.fromUid,cliMsgId:e.cliMsgId});s&&s.src&&s.msgId!==e.msgId&&(this.logger.zsymb(0,9683,30040,"detect dup msg",e.msgId,s.msgId),e.msgId=s.msgId),this.onReceiveNewMessages(t,e.msgId,[e])}))}updateUnread(e,t,s){let i=this.data.get(e);if(i){const e=i.lastSeenReactId||"0";t?i=s:(i.smsUnreadNotCount+=s.smsUnreadNotCount,i.smsUnreadCount+=s.smsUnreadCount,i.strangerUnreadCount+=s.strangerUnreadCount,i.mentionUnreadCount+=s.mentionUnreadCount,i.lastProcessMsgId=s.lastProcessMsgId),i.lastSeenReactId=e}else{if(i=s,!i)return void this.logger.zsymb(18,9683,30041,`updateUnread undefined item ${e}`);i.lastSeenReactId=qi.a.getLastSeen(e)||"0"}this.data.set(e,Object.assign({},i)),this.updateInDB(i),0!=s.mentionUnreadCount&&Vi.a.updateUnreadMentions(this.getTotalMentionCount()),this.unreadChanged(e)}isInStrangerBox(e){const t=Dt.a.ConvInfoDataManager.getConvByIdSync(e);return Ri.a.isInStrangerBox(t)}isCallTimeMessage(e){if("chat.recommended"===e.msgType&&e.content){if(e.content.action===L.CallMessageAction.CallTime)return!0;if(e.content.action===L.CallMessageAction.MissCall){let s=e.content.params;if("string"==typeof s)try{s=JSON.parse(e.content.params)}catch(t){}if(s&&3===s.reason)return!0}}return!1}clearUnreadConversation(e,t){if(void 0===t&&(t={}),e&&e.smsUnreadCount)try{let s=!0,i=Object.keys(t);i&&0!=i.length||(s=!1,this.logger.zsymb(0,9683,30043,`[read-message] actually, no need send seen in that case 2: ${i.length}`)),!s&&pt.default.chat_aggressive_send_seen&&(s=!0),s?i&&0!==i.length?this.sendClearUnreadToServer(t,e.userId):Me.default.getLastMessageFrom(e.userId,e.lastSmsLocalId,Hi,e.smsUnreadCount,!0).then((t=>{let s=[],i={};if(t&&t.length)for(let e=0;e<t.length;e++){let n=t[e];bt.default.validMessageFromOther(n)&&n.zglobalMsgId&&-1!=n.zglobalMsgId&&(s.push(n.zglobalMsgId),i[n.zglobalMsgId]=n)}0===s.length?this.logger.zsymb(3,9683,30044,"- [read-message] get ids.length == 0 {}",e.userId):this.sendClearUnreadToServer(i,e.userId)})).catch((e=>{this.logger.zsymb(21,9683,30045," [read-message] get msgs err {}",e)})):this.logger.zsymb(3,9683,30046,"[read-message] no send {}",e.userId)}catch(s){this.logger.zsymb(21,9683,30047,"[read-message] err {}",s)}else this.logger.zsymb(0,9683,30042,`[read-message] actually, no need send seen in that case 1: ${null==e?void 0:e.userId}`)}async sendClearUnreadToServer(e,t){void 0===e&&(e={});const s=Object.keys(e),i=Ri.a.isGroup(t),n=ji.a.newReq();try{await vt.default.sendSeen(e,t,i,n),pt.default.stagingAccount&&this.logger.zsymb(0,9683,30048,`[read-message] done ${t} msgId:\n\t\t\t\t\t${s&&s.length?s[s.length-1]:0}`)}catch(r){if(this.logger.zsymb(21,9683,30049,"[read-message] err {}",r),!(s&&s.length>0))throw this.logger.zsymb(21,9683,30051,"[read-message] send seen fail!!! convId:{} msgId len = 0",t),r;if(this.logger.zsymb(21,9683,30050,"[read-message] send seen fail!! convId:{} msgId:{}",t,s[s.length-1]),r&&(114===r.error_code||-69===r.error_code))throw this.logger.zsymb(21,9683,30052,"[read-message] send seen fail!!! no need retry {}",r.error_code),r;throw pt.default.retrySendSeen?(this.logger.zsymb(21,9683,30053,"[read-message] send seen fail!!! retry"),Ni.b.retryAction(Ni.a.SEND_SEEN_V2,[e,t,i,n],{startedTime:Date.now(),duration:pt.default.retrySendSeen.timeout})):this.logger.zsymb(21,9683,30054,"[read-message] send seen fail!!! not retry"),r}}broadcastEvent(e,t,s){this.dispatchEvent(new zt.a(e,t,s))}updateInDB(e){null==e.lastSeenReactId&&(e.lastSeenReactId=qi.a.getLastSeen(e.convId)||"0",this.logger.zsymb(18,9683,30055,`update invalid lastSeen ${e.convId}`)),this.DBConvUnread.addOrUpdate(e)}deleteInDB(e){this.DBConvUnread.remove(e)}})||ki)||ki)||ki);var nn=s("8Nax"),rn=s("GSHL"),an=s("w5bt");let on;var dn,ln;(dn=on||(on={})).modelToEntity=function(e){if(!e)throw new Error("[PreviewHelper] Convert undefined model to entity");return{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties?{type:e.properties.type}:null,mentions:e.mentions?e.mentions:null,ttl:e.ttl,cliMsgId:e.cliMsgId,actionId:e.actionId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon}},dn.entityToModel=function(e){return e?{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties,mentions:e.mentions,ttl:e.ttl,cliMsgId:e.cliMsgId,actionId:e.actionId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon,src:"db.preview",verified:!1}:null};const cn="zpm_m",hn="1.0.0";Object(Bt.b)(an.b)(ln=function(e,t){return i.ModuleContainer.inject(rn.b)(e,void 0,0)}(ln=Reflect.metadata("design:type",Function)(ln=Reflect.metadata("design:paramtypes",[void 0===zt.IReactiveDB?Object:zt.IReactiveDB])(ln=class extends Y.b{constructor(e){super(),this.DBConvPreview=e,this.name=void 0,this.key=void 0,this.didInit=void 0,this.data=void 0,this.list=void 0,this.deleteQueue=void 0,this.doneLoadDB=void 0,this.migrating=void 0,this._Logger=void 0,this.name=an.a,this.key="convId",this.didInit=!1,this.data=new Map,this.list=new Map,this.deleteQueue=[],this.doneLoadDB=!1,this.migrating=!1}init(){return this.didInit?Promise.resolve():(this.didInit=!0,this.loadData())}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}signalRenderItem(e,t){Object(st.g)(e,t),this.broadcastEvent(zt.b.PreviewChanged,t,{changedItem:this.data.get(t),all:Array.from(this.data.values())})}loadData(){return new Promise(((e,t)=>{T.a.getInstance().getItemForCurrentUser(cn)!==hn||this.migrating?e():(this.Logger.zsymb(3,11263,3e4,"start load preview"),this.DBConvPreview.getAll().then((t=>{this.onLoadPreviewsFromDB(t).then(e).catch((t=>{this.Logger.zsymb(21,11263,30001,"load previews from db failure #1! {}",t),e()}))})).catch((t=>{this.Logger.zsymb(21,11263,30002,"load preview from db failure #2! {}",t),e()})))}))}async revalidate(e){const t=!!this.getPreviewByIDSync(e),s=await Ti.b.getPreviewMessage(e).catch((s=>(this.Logger.zsymb(21,11263,30003,"revalidate failure #1 {} {} {}",e,t,s),{previewMsg:void 0})));return!!s.previewMsg&&this.onReceiveNewMessage("db.message",s.previewMsg).then((s=>(this.Logger.zsymb(3,11263,30004,"revalidate success {} {} {}",e,t,s),!0))).catch((s=>(this.Logger.zsymb(21,11263,30005,"revalidate failure #2 {} {} {}",e,t,s),!1)))}migrate(e,t){return void 0===t&&(t=!1),new Promise((s=>{const i=T.a.getInstance().getItemForCurrentUser(cn);if(i===hn&&!t)return;if(this.Logger.zsymb(3,11263,30006,"start migrate {} {}",i,t),this.migrating=!0,0===e.length)return this.doneMigratePreivew(0),s(0);let n=0,r=0;const a=()=>{if(n++,n===e.length)return this.doneMigratePreivew(r),s(r)},o=()=>{r++,a()},d=()=>{for(let t=0;t<e.length;t++)Ti.b.getPreviewMessage(e[t]).then((s=>{s&&s.previewMsg?this.onReceiveNewMessage("db.message",s.previewMsg).then(o).catch(a):(this.Logger.zsymb(3,11263,30007,"migrate not exists msg {}",e[t]),a())})).catch((s=>{a(),this.Logger.zsymb(21,11263,30008,"migrate failure for conv {} {}",e[t],s)}))};let l=e.filter((e=>e!==L.FAKE_CONVERSATION_ID.FRIEND_CENTER&&e!==L.FAKE_CONVERSATION_ID.GROUP_CENTER&&!e.startsWith(L.GROUPID_PREFIX)));if(l.length>0)return Je.default.getProfileFriendByIds(l,L.SRC_GET_PROFILE.FETCH_MINI_INFO).then((()=>{d()})).catch((()=>{d()}));d()}))}doneMigratePreivew(e){this.Logger.zsymb(3,11263,30009,"done migrate preview {}",e);T.a.getInstance().setItemForCurrentUser(cn,hn),this.broadcastEvent(zt.b.DoneMigratePreview,"")}upgradeItemsVersion(e){void 0===e&&(e=[]),this.Logger.zsymb(3,11263,30010,"upgradeItemsVersion");const t=(new Date).getTime().toString();Object(st.i)(t),0!==e.length?e.forEach((e=>{Object(st.f)(t,this.name,e)})):this.data.forEach((e=>{Object(st.f)(t,this.name,e.convId)})),Object(st.c)(t)}updateStrangerBox(e){const t=this.data.get(e);t&&(this.data.set(L.CONV_FILTER.STRANGER,Object(f.a)({},t)),Object(st.g)(this.name,L.CONV_FILTER.STRANGER))}forceChangeItem(e){this.signalRenderItem(this.name,e)}getItem(e,t){const s=this.data.get(e.key);return s||this.Logger.zsymb(5,11263,30011,"try to get item not exist in cache {}",e.key),s}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){this.Logger.zsymb(11,11263,30012,"onGetItemFailure {}",e)}onGetListFailure(e,t){this.Logger.zsymb(11,11263,30013,"onGetListFailure {} {}",e,t)}onLoadPreviewsFromDB(e){return new Promise(((t,s)=>{if(this.Logger.zsymb(3,11263,30014,"onLoadPreviewsFromDB {}",null==e?void 0:e.length),!e||0===e.length)return this.doneLoadPreview(0),t();let i=0;const n=()=>{i++,i===e.length&&(this.doneLoadPreview(i),t())};for(let r=0;r<e.length;r++){const t=on.entityToModel(e[r]);t&&!nn.a.instance.filterExpiredPreview(t)&&(t.messageType=L.MSG_VANISH,t.message="",this.updateInDB(t)),this.addPreviewToManager(t).then((()=>{n()})).catch((e=>{n(),this.Logger.zsymb(21,11263,30015,"onload preview failure for item {} {}",null==t?void 0:t.convId,e)}))}}))}doneLoadPreview(e){this.Logger.zsymb(3,11263,30016,"doneLoadPreview {}",e),this.doneLoadDB=!0,this.broadcastEvent(zt.b.DoneLoadPreview,"",Array.from(this.data.values())),Object(st.h)(this.name,"all")}onReceiveNewMessage(e,t){return new Promise(((s,i)=>{if(!t)return s(!1);const n=this.convertDBMessageToPreviewItem(e,t);this.addPreviewToManager(n).then((e=>e?(this.signalRenderItem(this.name,t.toUid),s(!0)):s(!1))).catch(i)}))}onReceiveNewMessages(e,t){return new Promise((s=>{if(!t)return s(!1);const i=this.groupMessageByConvId(t),n=[];for(const e in i){if(!Object.prototype.hasOwnProperty.call(i,e))continue;const t=i[e];for(let e=t.length-1;e>=0;e--){if(ss.b.isValidPreviewMessage(t[e])){n.push(t[e]);break}this.Logger.zsymb(3,11263,30017,"receive msg but not preview {}",t[e].msgId)}}return n.length?Promise.all(n.map((async t=>this.onReceiveNewMessage(e,t)))).then((e=>{const t=e.some((e=>1==e));s(t)})).catch((e=>{this.Logger.zsymb(21,11263,30018,"add messages to preview got error {}",e),s(!1)})):s(!1)}))}onUndoMessage(e,t){if(!t)return;this.Logger.zsymb(3,11263,30019,"onUndoMessage {}",t.msgId);const s=this.convertDBMessageToPreviewItem(e,t);s.messageType=L.MSG_UNDO,s.message="",this.addPreviewToManager(s).then((e=>{e&&this.signalRenderItem(this.name,t.toUid)}))}onUpdateE2EEMessage(e,t){if(!t)return;const s=t.toUid,i=this.data.get(s);if(this.Logger.zsymb(3,11263,30020,"onUpdateE2EEMessage {} {} {}",s,null==i?void 0:i.msgId,t.msgId),i&&(i.msgId!==t.msgId||!Li.b.isSameMsg(i,t)))return;const n=this.convertDBMessageToPreviewItem(e,t),r=bt.default.normalizeMessageTypeFromSubState(null==t?void 0:t.e2eeStatus)||t.msgType;n.message=n.message||ss.b.getPlainText({msgType:r}),n.verified=!0,n.messageType=r,this.data.set(t.toUid,n),this.updateInDB(n),this.signalRenderItem(this.name,t.toUid)}onDeleteMessage(e,t){return new Promise(((e,s)=>{if(!t)return e(!1);this.Logger.zsymb(3,11263,30021,"onDeleteMessage {}",t.msgId);const i=this.convertDBMessageToPreviewItem("db.message",t);this.deleteMessageInManager(i).then((s=>{s?(this.Logger.zsymb(3,11263,30022,"onDeleteMessage success {}",t.msgId),this.signalRenderItem(this.name,t.toUid),e(!0)):e(!1)}))}))}onDeleteMessages(e,t){if(!t||t.length<1)return;const s=this.groupMessageByConvId(t);for(const i in s)if(Object.prototype.hasOwnProperty.call(s,i)){const t=s[i];let n=this.convertDBMessageToPreviewItem(e,t[0]),r=0;for(let s=1;s<t.length;s++){const i=this.convertDBMessageToPreviewItem(e,t[s]);this.isSecondItemNewer(n,i)&&(r=s,n=i)}this.onDeleteMessage(e,t[r])}}onDeleteConversation(e){e&&(this.Logger.zsymb(3,11263,30023,"onDeleteConversation {}",e),this.data.delete(e)&&Object(st.e)(this.name,e),this.deleteInDB(e))}onChangeDraft(e,t){let s=this.getPreviewByIDSync(e);!e||!s||s.draft===t||s.draft&&t&&s.draft.draftTime===t.draftTime?this.Logger.zsymb(3,11263,30024,"onChangeDraft - reject {}",!!s):(this.Logger.zsymb(3,11263,30025,"onChangeDraft - call update {}",!!s),s=Object(f.a)(Object(f.a)({},s),{},{draft:t}),this.data.set(e,s),this.signalRenderItem(this.name,e),this.broadcastEvent(zt.b.DraftChanged))}getPreviewById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvPreview.getById(e).then((s=>{s||this.Logger.zsymb(3,11263,30026,"get item not exist with id {}",e);const i=on.entityToModel(s);t(i||void 0)})).catch(s)}))}getPreviewByIDSync(e){return this.data.get(e)}getAllPreviews(){return new Promise(((e,t)=>{if(this.doneLoadDB)return e(this.getAllPreviewsSync());this.DBConvPreview.getAll().then((t=>{const s=t.map((e=>on.entityToModel(e)));e(s)})).catch(t)}))}getAllPreviewsSync(){return Array.from(this.data.values())||[]}setPreview(e,t,s,i,n,r,a){void 0===r&&(r=1),void 0===a&&(a={});const o=this.data.get(e);this.Logger.zsymb(3,11263,30027,"call set preview {} {}",e,!!o);const d={convId:e,msgId:a.msgId||"unset",src:"ui",dName:a.dName||"",message:t,messageType:"",isGroup:e.startsWith(L.GROUPID_PREFIX),messageTime:s,fromUid:i,toUid:n,urgencyLevel:a.urgencyLevel,properties:null,verified:!0,status:r,computedMessage:t,computedIcon:a.icon};this.data.set(e,d),this.signalRenderItem(this.name,e),this.updateInDB(d)}async addPreviewToManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);let i=!1;return s?this.isSecondItemNewer(s,e)&&(this.data.set(t,e),i=!0,s.verified?(e.verified=!0,this.updateInDB(e)):i=await this.compareCacheWithDBAndUpdate(t,e)):(this.data.set(t,e),i=!0,"db.preview"!==e.src&&(i=await this.compareCacheWithDBAndUpdate(t,e))),i}async deleteMessageInManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);if(!s||!Li.b.isSameMsg(e,s)&&this.isSecondItemNewer(e,s))return 0!==this.deleteQueue.length&&this.deleteQueue.push(e),!1;const i=async()=>{const e=await Ti.b.getPreviewMessage(t),i=this.deleteQueue.find((t=>{var s;return t.msgId===(null===(s=e.previewMsg)||void 0===s?void 0:s.msgId)}));if(i)return this.data.set(t,i),await this.deleteMessageInManager(i);this.deleteQueue=[];const n=this.data.get(t);if(n&&this.isSecondItemNewer(s,n))return!1;if(e.previewMsg){const s=this.convertDBMessageToPreviewItem("db.message",e.previewMsg);return s.verified=!0,this.data.set(t,s),this.updateInDB(s),!0}return this.data.delete(t),this.deleteInDB(t),Object(st.e)(this.name,t),!1};if(s.verified)return await i();{const s=await this.DBConvPreview.getById(t),n=s&&on.entityToModel(s);return n&&this.isSecondItemNewer(e,n)?(this.data.set(t,n),!0):await i()}}convertDBMessageToPreviewItem(e,t){let s=t.sendDttm||t.serverTime;s=s?s.toString():"";const i=t.fromUid||t.uidFrom,n=t.toUid||t.idTo,r=n&&n.startsWith(L.GROUPID_PREFIX);return{convId:t.toUid,msgId:t.msgId,src:e,dName:t.dName||"",message:t.message,messageType:t.msgType,mentions:t.mentions,isGroup:r,messageTime:s,fromUid:i,properties:t.properties,urgencyLevel:t.urgency,verified:!1,ttl:t.ttl,status:t.status||1,substate:t.e2eeStatus,cliMsgId:t.cliMsgId,toUid:t.toUid}}isSecondItemNewer(e,t){return!e||(t.msgId===e.msgId&&t.messageTime===e.messageTime||Li.b.isSameMsg(e,t)?t.messageType===L.MSG_UNDO&&e.messageType!==L.MSG_UNDO||xt.a.comparePreviewStt(t.status,e.status)>0:e.messageTime!==t.messageTime?t.messageTime>e.messageTime:t.msgId>e.msgId)}compareCacheWithDBAndUpdate(e,t){return new Promise(((s,i)=>{this.DBConvPreview.getById(e).then((i=>{this.Logger.zsymb(3,11263,30028,"compareCacheWithDBAndUpdate {} {}",e,!!i);const n=on.entityToModel(i),r=this.data.get(e);if(JSON.stringify(r)!==JSON.stringify(t))return s(!1);!n&&r||n&&r&&this.isSecondItemNewer(n,r)?(r.verified=!0,this.updateInDB(r)):n&&this.data.set(e,n),s(!0)})).catch(i)}))}groupMessageByConvId(e){const t={};for(let s=0;s<e.length;s++)t[e[s].toUid]?t[e[s].toUid].push(e[s]):t[e[s].toUid]=[e[s]];return t}broadcastEvent(e,t,s){void 0===t&&(t=""),this.dispatchEvent(new zt.a(e,t,s))}updateInDB(e){this.Logger.zsymb(3,11263,30029,"update in db {}",e.msgId);try{const t=on.modelToEntity(e);this.DBConvPreview.addOrUpdate(t)}catch(t){this.Logger.zsymb(21,11263,30030,"update in db got err{}",t)}}deleteInDB(e){this.DBConvPreview.remove(e).catch((e=>{this.Logger.zsymb(18,11263,30031,`[${this.name}] - deleteInDB got error ${e}`)}))}})||ln)||ln)||ln);var un=s("rKwX"),gn=s("SWKE");class mn{constructor(){this.cache=void 0,this.cache={}}localKey(e){return"z_ml_"+e}muteConversation(e,t){const s=T.a.getInstance(),i="z_ml_"+e;t?t.constructor===Object?s.setItemForCurrentUser(this.localKey(e),JSON.stringify(t)):s.setItemForCurrentUser(this.localKey(e),`${t}`):s.removeItemForCurrentUser(i),this.cache[e]=t||!1}isMuted(e){if(this.cache.hasOwnProperty(e))return this.cache[e];let t,s=T.a.getInstance().getItemForCurrentUser(this.localKey(e));if(!s)return null;try{return t=JSON.parse(s),this.cache[e]=t,t}catch(i){bt.default.logCoreError(i)}return this.cache[e]=!1,!1}setMutedConversations(e){let t=[];e.chatEntries&&e.chatEntries.length>0&&e.chatEntries.reduce(((e,t)=>(e.push(t),e)),t),e.groupChatEntries&&e.groupChatEntries.length>0&&e.groupChatEntries.reduce(((e,t)=>(t.id=L.GROUPID_PREFIX+t.id,e.push(t),e)),t);gn.a.getInstance().cleanupLocalStorageMatchConditions((e=>{const t=T.a.getInstance().getKeyNameForCurrentUser(this.localKey(""));return e.startsWith(t)})),this.cache={};for(let s=0;s<t.length;s++)this.muteConversation(t[s].id,t[s]);return t}}var pn;Object(Bt.b)(Nt.f)(pn=Reflect.metadata("design:type",Function)(pn=Reflect.metadata("design:paramtypes",[])(pn=class extends Y.b{constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this._muteManager=void 0,this.userId=void 0,this.mapTimeout=void 0,this.name=Nt.e,this.key="id",this.didInit=!1,this.userId="",this.mapTimeout={}}init(e){this.didInit||(this.didInit=!0,this.userId=e)}get muteManager(){return this._muteManager&&""!==this.userId||(this.userId,this._muteManager=new mn),this._muteManager}getItem(e,t){return this.muteManager.isMuted(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e){}onGetListFailure(e,t){}onMute(e,t){return new Promise(((s,i)=>{this._clearTimeout(e);let n=-1;switch(t){case 1:n=3600;break;case 2:n=14400;break;case 3:n=Math.round(this._getNowTo8Am()/1e3)}bt.default.logCoreInfo(`[${this.name}] - onMute ${e} ${n}`),un.a.lock(e,n,!0).then((t=>{this.muteManager.muteConversation(e,{id:e,startTime:t.startTime,duration:t.duration,systemTime:t.systemTime,currentTime:t.currentTime,muteMode:t.muteMode}),s(!0)})).catch(i)}))}onUnMute(e,t,s){return void 0===t&&(t=!0),void 0===s&&(s=!1),new Promise(((i,n)=>{this._clearTimeout(e),bt.default.logCoreInfo(`[${this.name}] - onUnMute ${e} ${t} ${s}`),un.a.unlock(e,t,s).then((t=>{this.muteManager.muteConversation(e,0),i(!!t)})).catch(n)}))}onFetchMute(e){bt.default.logCoreInfo(`[${this.name}] - onFetchMute`);let t=this.muteManager.setMutedConversations(e);return this.processFetchData(e),t}onCtrMute(e,t){t?(this.doLock(t,!1),this.muteManager.muteConversation(e,t),this.muteChanged(e,!!t)):this.onUnMute(e,!1).then((s=>{this.muteChanged(e,!!t)}))}isMuted(e){return this.muteManager.isMuted(e)}processFetchData(e){try{e.chatEntries&&(e.chatEntries.forEach((e=>{this.doLock(e,!0)})),e.groupChatEntries.forEach((e=>{this.doLock(e,!0)})))}catch(t){bt.default.logCoreError(t)}}doLock(e,t){if(void 0===t&&(t=!0),this.mapTimeout.hasOwnProperty(e.id)&&(t=!0),this._clearTimeout(e.id),-1!=e.duration){bt.default.log("setTimer",e);let s=e.duration-(e.currentTime-e.systemTime);s>=0?(bt.default.log("setTimer: lock1",e.id),bt.default.logCoreInfo("[Unmute timeout] setTimer: lock1",e.id,s),this.mapTimeout[e.id]=setTimeout((()=>{this.onUnMute(e.id,t,!0),bt.default.logCoreInfo("[Unmute timeout] setTimer: unlock1",e.id)}),1e3*s)):(bt.default.log("setTimer: unlock",s),bt.default.logCoreInfo("[Unmute timeout] setTimer: unlock",e.id),this.onUnMute(e.id,t))}}_clearTimeout(e){this.mapTimeout.hasOwnProperty(e)&&(clearTimeout(this.mapTimeout[e]),delete this.mapTimeout[e])}_getNowTo8Am(){let e=(new Date).getTime(),t=new Date(e);return t.setHours(8,0,0,0),t.getTime()<=e?t.getTime()+864e5-e:t.getTime()-e}muteChanged(e,t){Object(st.g)(this.name,e),this.broadcastEvent(zt.b.MuteChanged,e,t)}broadcastEvent(e,t,s){void 0===t&&(t=""),this.dispatchEvent(new zt.a(e,t,s))}})||pn)||pn);var fn,vn=s("kCOK"),bn=s("qvRd"),yn=s("fBUP"),In=s("gwig");const _n="zpinc",Mn="ver_pin",Cn=0,Tn=1,On=2;Object(Bt.b)(bn.b)(fn=Reflect.metadata("design:type",Function)(fn=Reflect.metadata("design:paramtypes",[])(fn=class extends Y.b{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this._Logger=void 0,this.reFetchCount=void 0,this.retryTimeout=void 0,this.refetchInterval=void 0,this.lastFetchTime=void 0,this.isDataLastest=void 0,this.requestingIds=void 0,this.name=bn.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.reFetchCount=0,this.isDataLastest=!1,this.lastFetchTime=0,this.requestingIds=new Map}init(){this.didInit||(this.didInit=!0,this._loadData(),this._fetchPinnedConversations(),this._addListener())}_loadData(){const e=T.a.getInstance().getItemForCurrentUser(_n);if(e&&e.length)try{const s=JSON.parse(e);Object.keys(s).map((e=>{this._verifyPin(s[e].id)&&this.data.set(s[e].id,{id:s[e].id,priority:+s[e].priority||Mi.a.getTimeNow()})}));try{this.Logger.zsymb(0,9682,3e4,"pin conversations loaded from local",JSON.stringify(Object.fromEntries(this.data)))}catch(t){this.Logger.zsymb(18,9682,30001,"stringify fail")}this.doneLoadDB=!0;const i=this.getAllPinnedConversations();i.length&&this._broadcastEvent(zt.b.ChangePinConv,i)}catch(s){0}}_addListener(){Je.default.subscribeEventFriend(L.EventFriend.REMOVE_FRIEND,(e=>{this.Logger.zsymb(0,9682,30002,"remove friend - unpin",e.userId),this.updateListPin([e.userId],On)})),this._setFetchInterval()}_setFetchInterval(){this.refetchInterval&&clearTimeout(this.refetchInterval),this.refetchInterval=setInterval((()=>{this._fetchPinnedConversations()}),864e5)}_broadcastEvent(e,t){this.dispatchEvent(new zt.e(e,t))}_newPinItem(e,t){return{id:e,priority:t}}_syncServer(e,t){return this._updatePinnedConversationsV2(e,t)}getLastFetchTime(){return this.lastFetchTime}isPinned(e){return this.data.has(e)}getPinTime(e){const t=this.data.get(e);return t?t.priority:0}async _checkAndSyncDataBeforeAction(){if(!this.isDataLastest)try{return await this._fetchPinnedConversations(),!0}catch(e){return!1}return!0}pin(e){return this.Logger.zsymb(0,9682,30003,"client pin",e),new Promise((async(t,s)=>{const i=await this._checkAndSyncDataBeforeAction();if(!e||!e.length)return s(null);if(i){if(this.data.size+e.length>pt.default.limit_pin_messages)return s(null);let i=[];for(let t=0;t<e.length;++t)this.isPinned(e[t])||i.push(e[t]);if(i.length>0)try{const s=await this._syncServer(i,Tn);return this.updateListPin(e,Tn),t(s)}catch(n){return s(n)}}return s(null)}))}pinLocal(e){this.updateListPin(e,Tn)}unpin(e,t){return void 0===t&&(t=!1),this.Logger.zsymb(0,9682,30004,"client unpin",e,"force sync",t),new Promise((async(s,i)=>{if(!e||!e.length)return i(null);if(await this._checkAndSyncDataBeforeAction()){let r=[];for(let s=0;s<e.length;++s)(this.isPinned(e[s])||t)&&r.push(e[s]);if(r.length>0)try{await this._syncServer(r,On),this.updateListPin(e,On),s(1)}catch(n){i(n)}}return i(null)}))}unpinLocal(e){this.Logger.zsymb(0,9682,30005,"unpin local",e),this.updateListPin(e,On)}getAllPinnedConversations(){return Array.from(this.data.values())}getAllPinnedConversationsSync(){return Array.from(this.data.values())}getTotalPinnedConversation(){return this.data.size+Array.from(this.requestingIds.values()).filter((e=>e===Tn)).length}_verifyPin(e){return this.Logger.zsymb(0,9682,30006,"verify conversation",e,Je.default.isFriend(e),!!ts.default.getGroupByIdSync(e),e===pt.default.sendToMeId),Je.default.isFriend(e)||!!ts.default.getGroupByIdSync(e)||e===pt.default.sendToMeId}updateListPin(e,t){if(this.Logger.zsymb(0,9682,30007,"updateListPin",e,t),!e||!e.length)return;const s=[];switch(t){case Tn:let t=Mi.a.getTimeNow();for(let i=0;i<e.length;i++)if(this._verifyPin(e[i])&&!this.data.has(e[i])){++t,this.requestingIds.get(e[i])&&this.requestingIds.set(e[i],Cn);const n=this._newPinItem(e[i],t);this.data.set(e[i],n),s.push(n),Object(st.g)(this.name,e[i])}break;case On:for(let i=0;i<e.length;i++)if(this.data.has(e[i])){this.requestingIds.get(e[i])&&this.requestingIds.set(e[i],Cn),this.data.delete(e[i]);const t=this._newPinItem(e[i],0);s.push(t),Object(st.g)(this.name,e[i])}break;default:return}s.length&&this._broadcastEvent(zt.b.ChangePinConv,s),this._updateInDB()}_retryFetch(e){if(this.reFetchCount>5)return;let t=0;switch(e){case"ERR_NO_NETWORK":case-69:break;case 212:this.Logger.zsymb(20,9682,30008,"hasn't pinned conversation from server");T.a.getInstance().setItemForCurrentUser(Mn,"0"),this._sendToServer();break;case"ERR_CONNECTION_TIMED_OUT":case 112:t=5e3*this.reFetchCount;break;default:t=36e5}this.Logger.zsymb(21,9682,30009,"Handle request error fail with error: {}, retry after time= {}",e,t),this.retryTimeout||t>0&&(this.retryTimeout=setTimeout((()=>{this._fetchPinnedConversations(),this.retryTimeout=void 0}),t))}_parseData(e){let t=[];for(let s=0;s<e.length;++s)"m1"===e[s]||(e[s].startsWith("g")?t.push(e[s]):t.push(e[s].slice(1)));return t}_fetchPinnedConversations(){return this.reFetchCount++,this.Logger.zsymb(0,9682,30010,"_fetchPinnedConversations",this.reFetchCount),new Promise(((e,t)=>{yn.default.getPinnedConversations().then(vn.a).then((t=>{if(t&&t.conversations){const e=T.a.getInstance();void 0===t.version&&null===t.version||e.setItemForCurrentUser(Mn,t.version),this._onFetchPin(this._parseData(t.conversations))}e(t)})).catch((e=>{this.isDataLastest=!1,e&&(e.error_code?this._retryFetch(e.error_code):e.code?this._retryFetch(e.code):this._retryFetch("UNKNOWN_ERROR")),t(e)}))}))}_updatePinnedConversationsV2(e,t){return new Promise(((s,i)=>{if(!pt.default.enable_sync_pinned)return;if(!In.b.getStateNetwork())return void i(t===Tn?Ye.default.str("STR_ERR_NETWORK_PIN_CONVERSATION"):Ye.default.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));let n=[];for(let r=0;r<e.length;++r)e[r].startsWith("g")||e[r].startsWith("u")||(e[r]="u"+e[r]),n.includes(e[r])||this.requestingIds.has(e[r])&&this.requestingIds.get(e[r])!==Cn||(n.push(e[r]),this.requestingIds.set(e[r],t));n.length&&yn.default.updatePinnedConversationsV2(n,t).then(vn.a).then((()=>{n.forEach((e=>{this.requestingIds.set(e,Cn)})),s(!0)})).catch((e=>{n.forEach((e=>{this.requestingIds.set(e,Cn)})),this.Logger.zsymb(20,9682,30011,"Update sync pin conv v2 FAIL: "+e);let s="";if(e)if(e.error_code)if(160===e.error_code)this._fetchPinnedConversations();else s=Ye.default.str("STR_ERR_PIN_CONVERSATION")+" ("+e.error_code+")";else"ERR_NO_NETWORK"===e.code&&In.b.getStateNetwork()==In.a.DISCONNECT&&(s=t===Tn?Ye.default.str("STR_ERR_NETWORK_PIN_CONVERSATION"):Ye.default.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));i(s)}))}))}_isRemoteDataChanged(e){const t=Array.from(this.data.values()).sort(((e,t)=>t.priority-e.priority)).map((e=>e.id));if(e.length!==t.length)return!0;let s=!1;return e.forEach(((e,i)=>{e!==t[i]&&(s=!0)})),s}_onFetchPin(e){this.Logger.zsymb(0,9682,30012,"onFetchPin",e),this.isDataLastest=!0,this.lastFetchTime=Mi.a.getTimeNow(),this.reFetchCount=0;let t=Mi.a.getTimeNow();this._setFetchInterval();const s=[],i=[];for(let n=0;n<e.length;n++)this._verifyPin(e[n])?i.push(e[n]):this.unpin([e[n]],!0);if(this._isRemoteDataChanged(i)){for(const e of Array.from(this.data.values()))i.find((t=>t===e.id))||(this.data.delete(e.id),Object(st.g)(this.name,e.id),s.push({id:e.id,priority:0}));for(let e=0;e<i.length;e++){const n=this._newPinItem(i[e],t),r=this.isPinned(i[e]);this.data.set(i[e],n),r||Object(st.g)(this.name,i[e]),t--,s.push(n)}this.Logger.zsymb(0,9682,30013,"[After Fetch]",Array.from(this.data.values())),s.length&&this._broadcastEvent(zt.b.ChangePinConv,s),this._updateInDB()}}_sendToServer(){this._syncServer(Array.from(this.data.keys()),Tn)}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){this.Logger.zsymb(18,9682,30014,"onGetItemFailure - key:",e," - error",t)}onGetListFailure(e,t){this.Logger.zsymb(18,9682,30015,"onGetItemFailure - key:",e," - error",t)}_updateInDB(){if(!this.data)return;const e=T.a.getInstance();this.data.size?e.setItemForCurrentUser(_n,JSON.stringify(Array.from(this.data.values()))):e.removeItemForCurrentUser(_n)}})||fn)||fn);var En,Sn=s("MnJw");Object(Bt.b)(Sn.a)(En=Reflect.metadata("design:type",Function)(En=Reflect.metadata("design:paramtypes",[])(En=class extends Y.b{constructor(){super()}onUpdateListArchivedChat(e){this.dispatchEvent(new zt.a(zt.b.UpdateListArchivedChat,e))}onOffArchivedChat(e){this.dispatchEvent(new zt.a(zt.b.OnOffArchivedChat,"",{status:e}))}})||En)||En);i.ModuleContainer.registerSingleton(ai.b,ci),i.ModuleContainer.registerSingleton(Ii.a,bi),i.ModuleContainer.registerSingleton(ai.a,di);var wn,Ln=s("Xvw2"),Dn=s("5uwv"),Fn=s("lCn6"),Rn=s("kg13"),An=s("dJFb");const Pn=2,Nn={userId:"",friendRequestType:Pn,friendRequestSource:85};var jn;!function(e){e.SUGGEST="suggest",e.REQUEST="request",e.UNREADREQ="unread-req"}(jn||(jn={}));Object(Bt.b)(Ln.b)(wn=Reflect.metadata("design:type",Function)(wn=Reflect.metadata("design:paramtypes",[])(wn=class extends Y.b{constructor(){super(),this.sugguestList=void 0,this.requestList=void 0,this.unreadFRList=void 0,this._ebFriendRequestSend=e=>{const t=this.unreadFRList.filter((t=>t!==e));t.length!==this.unreadFRList.length&&(Me.default.removeFriend(e),bt.default.logCoreError("[reddot-check] SEND_FRIEND_REQUEST: "+JSON.stringify(e)),this.unreadFRList=t,Object(st.h)(this.name,jn.UNREADREQ))},this._ebFriendFetch=e=>{for(let t in e)if(e.hasOwnProperty(t)){const e=this.requestList.slice();for(let s=0;s<e.length;s++)if(e[s]===t){e.splice(s,1);break}e.length!==this.requestList.length&&(this.requestList=e,Object(st.h)(this.name,jn.REQUEST))}},this._ebFrReqFetch=e=>{bt.default.log("friendNotificationAction: friend requests fetched",e);const t=this.requestList.reduce(((e,t)=>(e[t]||(e[t]=!0),e)),{}),s=this.requestList.slice();for(let i of e)t[i.userId]||s.unshift(i);this.requestList=s,Object(st.h)(this.name,jn.REQUEST)},this._ebFrReqRemove=e=>{bt.default.log("friendNotificationAction: friend requests removed",e);const t=this.requestList.filter((t=>-1===e.indexOf(t)));t.length!==this.requestList.length&&(this.requestList=t,Object(st.h)(this.name,jn.REQUEST)),this.onFriendListNotificationsChange({action:"remove",ids:e})},this.name=Ln.a,this.data=new Map,this.key="userId",this.sugguestList=[],this.requestList=[],this.unreadFRList=[],this.listenEvents()}listenEvents(){It.default.subscribe(((e,t)=>{switch(e){case _t.ChatBoxActions.SEND_FRIEND_REQUEST:this._ebFriendRequestSend(t);break;case _t.FetchActions.FRIENDS_FETCHED:this._ebFriendFetch(t);break;case _t.FetchActions.FRIEND_REQUESTS_FETCHED:this._ebFrReqFetch(t);break;case _t.FetchActions.FRIEND_REQUESTS_REMOVED:this._ebFrReqRemove(t)}}))}onAddFriend(e){Rn.a.removeSuggest(e.userId),this.onFriendListNotificationsChange({action:"remove",ids:[e.userId]})}onReceiveFriendRequests(e){if(!e||e.length<1)return;for(let s=0;s<e.length;s++){let t=e[s];t&&Rn.a.removeSuggest(t.userId)}An.d.setUnreadRequest(1);for(let s=0;s<e.length;s++)e[s]&&Qt.p.addNewFriendItem(e[s].userId);Dt.a.UnreadDataManager.updateUnreadCount(L.FAKE_CONVERSATION_ID.FRIEND_CENTER,An.d.getUnreadRequest());let t=e.map((e=>({dataInfo:Object(f.a)(Object(f.a)({},e),{},{recommInfo:{message:e.friendRequestMsg,source:e.friendRequestSource},recommType:Pn}),recommItemType:e.friendRequestType})));Rn.a.addRequest(t),this.broadcastEvent(Dn.b.ReceiveRequest,"",{uids:e.map((e=>e.userId))})}onRemoveSuggest(e,t,s){return Rn.a.removeSuggestFriend(e,t,s).then((t=>{this.broadcastEvent(Dn.b.RemoveSuggest,e)}))}onPromoteFriends(){Dt.a.UnreadDataManager.updateUnreadCount(L.FAKE_CONVERSATION_ID.FRIEND_CENTER,1)}onFriendRequestFetched(){}onFriendListNotificationsChange(e){if(!e.ids||!e.ids.length)return void("clear"===e.action&&(this.unreadFRList=[],Object(st.h)(this.name,jn.UNREADREQ)));let t=this.unreadFRList;if("remove"===e.action)t=t.filter((t=>-1===e.ids.indexOf(t)));else if("add"===e.action){const s=[];for(let i of e.ids)-1===t.indexOf(i)&&s.push(i);s.length&&(t=t.concat(s))}t.length!==this.unreadFRList.length&&(this.unreadFRList=t,Object(st.h)(this.name,jn.UNREADREQ))}acceptFriendRequest(e,t){return void 0===t&&(t=$t.c),new Promise(((s,i)=>{const n=this.data.get(e);if(!n)return Bs.a.acceptAddFriend(e).then((i=>{He.ModalManagerV2.openModal({windowId:t,name:L.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch(i);let r;if(n.friendRequestType===L.FRIEND_REQUEST_TYPE_SUGGEST){if(n.requested)return r=104097,Ze.e.logAction(r),s(!1);const a=Ye.default.trans("STR_MSG_DEFAULT_REQ_ADD_FR",Je.default.getMiniProfileMe().zaloName);Bs.a.requestAddFriend(e,a,n.friendRequestSource).then((()=>{He.ModalManagerV2.openModal({windowId:t,name:L.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),Me.default.removeFriend(e),Rn.a.removeSuggest(e);const i=Object(f.a)(Object(f.a)({},n),{},{requested:!0});this.broadcastEvent(Dn.b.SentFriendReq,e),this.data.set(e,i),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),i(e)})),r=104096}else Bs.a.acceptAddFriend(e).then((()=>{this.data.delete(e),Object(st.e)(this.name,e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),this.broadcastEvent(Dn.b.AcceptRequest,e),Fn.a.getUser(e).then((t=>{It.default.send(_t.FetchActions.FRIENDS_FETCHED,{[e]:Object(f.a)(Object(f.a)({},bt.default.reformatConversationFromFriend(t)),{},{isFr:1})})})),Me.default.getAcceptNewFriend(n),He.ModalManagerV2.openModal({windowId:t,name:L.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),i(e)})),r=104095;r&&Ze.e.logAction(r)}))}async rejectFriendRequest(e){const t=this.data.get(e),s=()=>{Xe.a.createSuccess(Ye.default.str("STR_TOAST_REJECT_REQUEST")),Me.default.removeFriend(e),Rn.a.removeSuggest(e),this.broadcastEvent(Dn.b.RejectRequest,e)},i=e=>{bt.default.logCoreError(e),e&&e.error_message&&Xe.a.createError(e.error_message)};t&&t.friendRequestSource?vt.default.removeRecommendedFriend(e,t.friendRequestSource).then(s).catch(i):Bs.a.rejectRequestAddFriend(e).then(s).catch(i),this.data.delete(e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),Ze.e.logAction(104094)}undoRequestFriend(e){e&&Bs.a.undoRequestAddFriend(e).catch((e=>{e.error_message&&Xe.a.createError(e.error_message)}))}clearUnreadFriendRequest(){Dt.a.UnreadDataManager.updateUnreadCount(L.FAKE_CONVERSATION_ID.FRIEND_CENTER,0),this.unreadFRList=[],Object(st.h)(this.name,jn.UNREADREQ)}getAllFriendRequests(){return new Promise(((e,t)=>{const s=Rn.a.getRecommendedFriendsV2(!1,!1);if(!s)return e({});e(this.filterFriendRequest(s))}))}getAllFriendRequestsSync(){const e=Rn.a.getRecommendedFriendsSync();return e?this.filterFriendRequest(e):{}}init(){Me.default.getFriends(null,!0).then((e=>{if(e){const t=Me.default.getLastContactListOpenTime(),s=e.filter((e=>e&&e.friendRequestFetchTime>t)).map((e=>e.userId));s.length&&this.onFriendListNotificationsChange({action:"add",ids:s})}}))}getItem(e){return Nn}getList(e){return e.key===jn.UNREADREQ?this.unreadFRList:[]}onGetItemFailure(e){}onGetListFailure(e){}handleFailureFriendRq(e){if(bt.default.logCoreError(e),e&&e.error_message){let t=e.error_message;[224,251].includes(e.error_code)&&(t=Ye.default.trans(`STR_FRIEND_REQUEST_FAIL_${e.error_code}`,[""+pt.default.limitFriends])),Xe.a.createMessage(t,3e3)}}filterFriendRequest(e){const t={};for(let s in e)if(e.hasOwnProperty(s)){let i=e[s];i&&i.dataInfo.recommType===Pn&&(t[s]=i,t[s].friendRequestType=i.dataInfo.recommType)}return t}broadcastEvent(e,t,s){this.dispatchEvent(new Dn.a(e,t,s)),this.dispatchEvent(new Dn.a(Dn.b.FriendCenterChange,t,Object(f.a)(Object(f.a)({},s),{},{act:e})))}})||wn)||wn);var Un=s("5cla"),Bn=s("WV6O");class kn{static resetNewFriendList(){delete this.newListFriend,this.newListFriend=void 0}static addNewFriendUid(e){void 0===this.newListFriend&&this.getNewFriendList(),this.newListFriend.push(e)}static getNewFriendList(){Me.default.removeNewFriend("",!0);let e=[];try{const t=T.a.getInstance().getItemForCurrentUser("f_nf");t&&(e=JSON.parse(t))}catch(t){}this.newListFriend=e.map((e=>e.userId))}static getFriendList(e){const{userId:t}=e,s=[];return new Promise(((e,i)=>{Je.default.getFriends().then((i=>{if(i){const n=Boolean(Ht.g.getConfigShowAllUser(t));for(let e=0;e<i.length;e++)(1===i[e].isFr||i[e].isFr||i[e].userId===pt.default.supportPage)&&i[e].userId!=t&&i[e].isValid&&i[e].userId!=pt.default.sendToMeId&&(n||i[e].isActive||i[e].isActivePC||i[e].isActiveWeb)&&s.push(i[e].userId);e(s)}else e([])})).catch((e=>i(e)))}))}static getFriendInfo(e){var t;const{userId:s}=e,i=Je.default.getProfileFriendSync(s);return i?(void 0===this.newListFriend&&this.getNewFriendList(),{userId:i.userId,avatar:i.avatar,displayName:i.displayName,isFr:i.isFr,zaloName:i.zaloName,bizPkg:i.bizPkg,bizInfo:i.bizInfo,isNewFriend:(null===(t=this.newListFriend)||void 0===t?void 0:t.includes(s))||!1,isBlocked:i.isBlocked}):null}}kn.newListFriend=void 0;class Gn{static getGroupList(e){return new Promise(((e,t)=>{ts.default.getGroupsList().then((t=>{const s=t.map((e=>e.userId));e(s)})).catch(t)}))}static getGroupInfo(e){const{userId:t}=e;return new Promise(((e,s)=>{ts.default.getGroupById(t).then((t=>{e({userId:t.userId,avatar:t.avatar,displayName:t.displayName,topMember:t.topMember,totalMember:t.totalMember,creatorId:t.creatorId})})).catch(s)}))}static getGroupInfoSync(e){const{userId:t}=e,s=ts.default.getGroupByIdSync(t);return s?{userId:s.userId,avatar:s.avatar,displayName:s.displayName,topMember:s.topMember,totalMember:s.totalMember,creatorId:s.creatorId}:null}}class xn{static getRecommendFriendList(){return new Promise(((e,t)=>{vt.default.getRecommendedFriends().then((t=>e(t.recommItems))).catch(t)}))}static getRelatedGroup(e){return new Promise(((t,s)=>{vt.default.getRelatedGroup(e).then(t).catch(s)}))}static getRequestedFriendList(){return new Promise(((e,t)=>{vt.default.getRequestedFriends().then(e).catch(t)}))}static acceptAddFriend(e){return Bs.a.acceptAddFriend(e)}static rejectAddFriend(e){return Bs.a.rejectRequestAddFriend(e)}static makeUndoSentRequestFriend(e){return Bs.a.undoRequestAddFriend(e.userId)}static removeSuggestFriend(e){return new Promise(((t,s)=>{vt.default.removeRecommendedFriendV2(e.uid,e.src,e.type).then(t).catch(s)}))}}var zn;const Vn={currentView:Bn.c.FRIEND_LIST,unread:{newFriendRequests:[],newGroupRequests:[]}},$n="1",Wn="ctt_l_a",qn="ctt_l_r";Object(Bt.b)(Un.b)(zn=Reflect.metadata("design:type",Function)(zn=Reflect.metadata("design:paramtypes",[])(zn=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.currentTab=void 0,this.data=new Map,this._Logger=void 0,this.name=Un.a,this.key=Un.a,this.data.set($n,Vn),this.currentTab=""}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.contactTabV2,[this.name])),this._Logger}_updateState(e,t,s){void 0===t&&(t=$n),void 0===s&&(s=!0),this.data.set(t,e),s&&Object(st.g)(this.name,t)}_getState(e){void 0===e&&(e=$n);return this.data.get(e)}_getAccessTime(){try{return JSON.parse(T.a.getInstance().getItemForCurrentUser(Wn))}catch(e){return this.Logger.zsymb(18,9649,3e4,"[_getAccessTime], error: "+JSON.stringify(e)),null}}_setAccessTime(e){T.a.getInstance().setItemForCurrentUser(Wn,JSON.stringify(e))}_setLastRequestFriendTime(e,t,s){let i=[];try{i=JSON.parse(T.a.getInstance().getItemForCurrentUser(qn))||[]}catch(r){this.Logger.zsymb(18,9649,30001,"[_setLastRequestFriendTime], error: "+JSON.stringify(r))}let n=[];switch(e){case"NEW":i.find((e=>(null==e?void 0:e.userId)===s))?(n=i.filter((e=>e.userId!==s)),n=[{ts:t,userId:s},...i]):n=[{ts:t,userId:s},...i];break;case"REMOVE":n=i.filter((e=>e.userId!==s))}T.a.getInstance().setItemForCurrentUser(qn,JSON.stringify(n))}_getLastRequestAddFriendTime(){let e;try{e=JSON.parse(T.a.getInstance().getItemForCurrentUser(qn))}catch(t){this.Logger.zsymb(18,9649,30002,"[_getLastRequestAddFriendTime], error: "+JSON.stringify(t))}return e?e[0]:null}_onChangeView(e){switch(i.ModuleContainer.resolve(kt.SidebarController).updateSelectedId(null),e){case Bn.c.FRIEND_LIST:Object(Be.f)({type:_t.SideBarActions.SELECT_FRIEND_LIST,payload:{userId:"999"}});break;case Bn.c.GROUP_LIST:Object(Be.f)({type:_t.SideBarActions.SELECT_GROUP_CENTER,payload:{userId:"999"}});break;case Bn.c.FRIEND_REQUEST:Object(Be.f)({type:_t.SideBarActions.SELECT_FRIEND_CENTER,payload:{userId:"999"}})}}_onUpdateUnreadRequest(e,t){const s=this._getState();if(!s)return;let i=s.unread;switch(t){case"FRIEND":i.newFriendRequests.push(e);break;case"GROUP":i.newGroupRequests.push(e)}this._updateState(Object(f.a)(Object(f.a)({},s),{},{unread:i}),$n,!0)}_clearUnreadRequest(){const e=this._getState();if(!e)return;let t=e.unread;t.newFriendRequests=[],t.newGroupRequests=[],this._updateState(Object(f.a)(Object(f.a)({},e),{},{unread:t}),$n,!0)}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetTabData(){this.currentTab="",kn.resetNewFriendList(),i.ModuleContainer.resolve(Un.b).resetData(),i.ModuleContainer.resolve(Un.f).resetData(),i.ModuleContainer.resolve(Un.e).resetData(),i.ModuleContainer.resolve(Un.j).resetData(),i.ModuleContainer.resolve(Un.i).resetData(),i.ModuleContainer.resolve(Un.m).resetData()}resetData(){const e=this._getState();e&&this._updateState(Object(f.a)(Object(f.a)({},e),{},{currentView:Bn.c.FRIEND_LIST}))}changeView(e){const t=this._getState();t&&this._updateState(Object(f.a)(Object(f.a)({},t),{},{currentView:e}),$n,!0),this.currentTab=e,this._onChangeView(e)}onClickContabTabEntry(){if(document.getElementById("ContactTabV2")){const e=this._getState(),t=(null==e?void 0:e.currentView)||Vn.currentView;this._onChangeView(t)}}onContactTab(e){this._setAccessTime(e),this._clearUnreadRequest()}getDefaultView(){if(this.currentTab)return this.currentTab;const e=this._getAccessTime(),t=this._getLastRequestAddFriendTime();if(!t)return this.currentTab=Bn.c.FRIEND_LIST,this.currentTab;const s=!pt.default.contactTabV2.enable_rule_last_view_friend_req||e&&t.ts<e,i=t.ts<Date.now()-864e5;return this.currentTab=i&&s?Bn.c.FRIEND_LIST:Bn.c.FRIEND_REQUEST,this.currentTab}onUpdateRequestTracking(e,t,s,i){if("NEW"===t?this._onUpdateUnreadRequest(i,e):"REMOVE"===t&&this._clearUnreadRequest(),"FRIEND"===e)this._setLastRequestFriendTime(t,s||0,i)}onInitUnreadRequest(){const e=this._getState();let t=(null==e?void 0:e.unread)||Vn.unread;const s=(null==e?void 0:e.currentView)||Vn.currentView,i=this._getAccessTime(),n=this._getLastRequestAddFriendTime();n&&i&&(i<n.ts&&t.newFriendRequests.push(n.userId),this._updateState({currentView:s,unread:t},$n,!0))}})||zn)||zn);var Kn=s("iq5K");const Hn=(e,t)=>{const s=bt.default.simpleStripVietnamese(t).split(" "),i=bt.default.simpleStripVietnamese(e).split(" ");return(()=>{const e=[];for(const t of s){let s=!1;for(let n=0;n<i.length;++n)if(i[n].startsWith(t)&&!e.includes(n)){e.push(n),s=!0;break}if(!s)return!1}return!0})()},Qn=e=>new Promise(((t,s)=>{if(!e)return t(e);setTimeout((()=>{t(e)}),e)}));var Jn;Object(Bt.b)(Un.f)(Jn=Object(i.injectable)()(Jn=function(e,t){return i.ModuleContainer.inject(Un.e)(e,void 0,0)}(Jn=function(e,t){return i.ModuleContainer.inject(kt.LabelDataManager)(e,void 0,1)}(Jn=Reflect.metadata("design:type",Function)(Jn=Reflect.metadata("design:paramtypes",[void 0===Un.e?Object:Un.e,void 0===kt.LabelDataManager?Object:kt.LabelDataManager])(Jn=class{constructor(e,t){this.friendInfoManager=e,this.labelDataManager=t,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listFriend=void 0,this.initListFriend=void 0,this.currentPage=void 0,this.didSort=void 0,this.eventBusInstance=void 0,this._Logger=void 0,this.name=Un.d,this.key=Un.d,this.listState=Kn.d,this.listFriend=[],this.initListFriend=[],this.currentPage=1,this.didSort=!1,this.eventBusInstance=null,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(st.h)(this.name,"all")}_signalRenderItem(){Object(st.g)(this.name,"all")}_signalRenderBoth(){Object(st.g)(this.name,"all"),Object(st.h)(this.name,"all")}_onRemoveFriend(e){this.listFriend.includes(e.userId)&&(this.listFriend.splice(this.listFriend.indexOf(e.userId),1),this.initListFriend.splice(this.initListFriend.indexOf(e.userId),1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth())}_onAddFriend(e){this.listFriend.includes(e.userId)||(this.listFriend.unshift(e.userId),this.initListFriend.unshift(e.userId),kn.addNewFriendUid(e.userId),this._signalRenderList())}_getItemInfo(e){return this.friendInfoManager.getItem({key:e,version:1,extraData:null},null)||this.friendInfoManager.loadInfoNotRender({userId:e})}_onBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onUnBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onEditAlias(e){this.friendInfoManager.onLoadInfo({userId:e.userId}),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!this.isDidSort(),!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth()}_onUpdateTagConv(e,t){void 0===t&&(t="add");let s=!1;e.convIds.forEach((i=>{if(this.friendInfoManager.onLoadInfo({userId:i}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listFriend.findIndex((e=>e===i));"remove"===t&&-1!==e?(this.listFriend.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listFriend.push(i),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1,!1),this.listState.totalRecord=this.listFriend.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.friendInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}addComponentListeners(){Je.default.subscribeEventFriend(L.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),Je.default.subscribeEventFriend(L.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),Je.default.subscribeEventFriend(L.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),Je.default.subscribeEventFriend(L.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance=It.default.on(_t.FetchActions.UPDATE_NAME,this._onEditAlias.bind(this)),this.labelDataManager.addEventListener(kt.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener(kt.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener(kt.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){Je.default.unsubscribeEventFriend(L.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),Je.default.unsubscribeEventFriend(L.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),Je.default.unsubscribeEventFriend(L.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),Je.default.unsubscribeEventFriend(L.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance&&this.eventBusInstance.remove(),this.labelDataManager.removeEventListener(kt.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener(kt.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener(kt.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}async onLoadList(e){try{const t=await kn.getFriendList(e);this.listFriend=t,this.initListFriend=t,this.listState.totalRecord=t.length,this.listFriend=this._handleFilter(Kn.g.searching.searchText,Kn.g.searching.sorter,Kn.g.searching.filter,!0,!1),this.initListFriend=this._handleFilter(Kn.g.searching.searchText,Kn.g.searching.sorter,Kn.g.searching.filter,!0,!0),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}catch(t){this.Logger.zsymb(18,11663,3e4,"[FriendListController] -> [onLoadList], error: "+JSON.stringify(t))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListFriend];return[...this.initListFriend].filter((t=>{const s=this._getItemInfo(t);return Hn((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterAll(e){return e}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!Vt.a.isThreadHidden(e)))}onSortAlpha(e,t){if(e===Kn.o.DEFAULT)return t;return t.sort(((t,s)=>{const i=this._getItemInfo(t),n=this._getItemInfo(s);return((t,s)=>{const i=/^[a-zA-Z]/,n=i.test(bt.default.simpleStripVietnamese(t)),r=i.test(bt.default.simpleStripVietnamese(s));switch(e){case Kn.o.ALPHA_INCREASE:return!n&&r?1:n&&!r?-1:t.localeCompare(s);case Kn.o.ALPHA_DECREASE:return!n&&r?-1:n&&!r?1:s.localeCompare(t);default:return 0}})((null==i?void 0:i.displayName.toLowerCase())||(null==i?void 0:i.zaloName.toLowerCase())||"",(null==n?void 0:n.displayName.toLowerCase())||(null==n?void 0:n.zaloName.toLowerCase())||"")}))}onMovingNewFriend(e){let t=[],s=[];for(let i=e.length-1;i>=0;i--){const n=this._getItemInfo(e[i]);null!=n&&n.isNewFriend?t.unshift(null==n?void 0:n.userId):s.unshift(null==n?void 0:n.userId)}return[...t,...s]}_handleFilter(e,t,s,i,n){var r;let a=[];return a=this.onFilterByName(e),a=this.onFilterByLabel(null==s||null===(r=s.label)||void 0===r?void 0:r.convs,a),a=this.onFilterAll(a),a=this.onSortAlpha(t,a),a=this.onFilterHidden(n,e,a),i&&(a=this.onMovingNewFriend(a)),a}_checkDidSort(e){return e!==Kn.o.ALPHA_INCREASE?this.didSort=!0:this.didSort=!1,this.didSort}isDidSort(){return this.didSort}_updateInitListFriendWithoutDockNewFriends(){this.initListFriend=this._handleFilter(Kn.g.searching.searchText,Kn.g.searching.sorter,Kn.g.searching.filter,!1,!0),this.listState.totalRecord=this.listFriend.length}onFilter(e,t,s){const i=this._checkDidSort(t);i&&this._updateInitListFriendWithoutDockNewFriends(),this.listFriend=this._handleFilter(e,t,s,!i,!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}getList(e,t){return this.listFriend}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listFriend=[],this.initListFriend=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:Kn.o.ALPHA_INCREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1,this.didSort=!1}})||Jn)||Jn)||Jn)||Jn)||Jn);var Zn;Object(Bt.b)(Un.e)(Zn=Reflect.metadata("design:type",Function)(Zn=Reflect.metadata("design:paramtypes",[])(Zn=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=Un.c,this.key=Un.c}init(e){throw new Error("Method not implemented.")}onLoadInfo(e){const t=kn.getFriendInfo(e);t&&(this.data.set(e.userId,t),Object(st.g)(this.name,e.userId))}loadInfoNotRender(e){const t=kn.getFriendInfo(e);return t?(this.data.set(e.userId,t),t):null}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||Zn)||Zn);var Xn;Object(Bt.b)(Un.j)(Xn=Object(i.injectable)()(Xn=function(e,t){return i.ModuleContainer.inject(Un.i)(e,void 0,0)}(Xn=function(e,t){return i.ModuleContainer.inject(Nt.h)(e,void 0,1)}(Xn=function(e,t){return i.ModuleContainer.inject(kt.LabelDataManager)(e,void 0,2)}(Xn=Reflect.metadata("design:type",Function)(Xn=Reflect.metadata("design:paramtypes",[void 0===Un.i?Object:Un.i,void 0===Nt.h?Object:Nt.h,void 0===kt.LabelDataManager?Object:kt.LabelDataManager])(Xn=class{constructor(e,t,s){this.groupInfoManager=e,this.previewDataManager=t,this.labelDataManager=s,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listGroup=void 0,this.initListGroup=void 0,this.currentPage=void 0,this._Logger=void 0,this.name=Un.h,this.key=Un.h,this.listState=Kn.e,this.listGroup=[],this.initListGroup=[],this.currentPage=1,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(st.h)(this.name,"all")}_signalRenderItem(){Object(st.g)(this.name,"all")}_signalRenderBoth(){Object(st.g)(this.name,"all"),Object(st.h)(this.name,"all")}_getItemInfo(e){return this.groupInfoManager.getItem({key:e,version:1,extraData:null},null)||this.groupInfoManager.loadInfoNotRender({userId:e})}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}async onLoadList(){try{const e=await Gn.getGroupList({});this.listGroup=e,this.initListGroup=e,this.listState.totalRecord=e.length,this.groupInfoManager.loadMultiGroupInfo(this.initListGroup),this.listGroup=this._handleFilter(Kn.h.searching.searchText,Kn.h.searching.sorter,Kn.h.searching.filter,!1),this.initListGroup=this._handleFilter(Kn.h.searching.searchText,Kn.h.searching.sorter,Kn.h.searching.filter,!0),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}catch(e){this.Logger.zsymb(18,11662,3e4,"[GroupListController] -> [onLoadList], error: "+JSON.stringify(e))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListGroup];return this.initListGroup.filter((t=>{const s=this._getItemInfo(t);return Hn((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterMyAdminGroup(e,t){if(!e)return t;return t.filter((t=>{const s=this._getItemInfo(t);return(null==s?void 0:s.creatorId)===e}))}onFilterAll(e){return e}onSortAlpha(e,t){return e===Kn.o.DEFAULT||e===Kn.o.ACTION_INCREASE||e===Kn.o.ACTION_DECREASE?t:t.sort(((t,s)=>{const i=this._getItemInfo(t),n=this._getItemInfo(s),r=(null==i?void 0:i.displayName.toLowerCase())||"",a=(null==n?void 0:n.displayName.toLowerCase())||"";switch(e){case Kn.o.ALPHA_INCREASE:return r.localeCompare(a);case Kn.o.ALPHA_DECREASE:return a.localeCompare(r);default:return 0}}))}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!Vt.a.isThreadHidden(e)))}onSortActionTime(e,t){return e===Kn.o.DEFAULT||e===Kn.o.ALPHA_INCREASE||e===Kn.o.ALPHA_DECREASE?t:t.sort(((t,s)=>{var i,n;const r=(null===(i=this.previewDataManager.getPreviewByIDSync(t))||void 0===i?void 0:i.messageTime)||0,a=(null===(n=this.previewDataManager.getPreviewByIDSync(s))||void 0===n?void 0:n.messageTime)||0;switch(e){case Kn.o.ACTION_DECREASE:if(a&&r){if(a>r)return 1;if(a<r)return-1}return a&&!r?1:!a&&r?-1:0;case Kn.o.ACTION_INCREASE:if(a&&r){if(a<r)return 1;if(a>r)return-1}return!a&&r?1:a&&!r?-1:0;default:return 0}}))}_handleFilter(e,t,s,i){var n;let r=[];return r=this.onFilterByName(e),r=this.onFilterByLabel(null==s||null===(n=s.label)||void 0===n?void 0:n.convs,r),r=this.onFilterMyAdminGroup((null==s?void 0:s.admin)||"",r),r=this.onFilterAll(r),r=this.onSortAlpha(t,r),r=this.onSortActionTime(t,r),r=this.onFilterHidden(i,e,r),r}onFilter(e,t,s){this.listGroup=this._handleFilter(e,t,s,!1),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}_onUpdateTagConv(e,t){void 0===t&&(t="add");let s=!1;e.convIds.forEach((i=>{if(this.groupInfoManager.onLoadInfo({userId:i}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listGroup.findIndex((e=>e===i));"remove"===t&&-1!==e?(this.listGroup.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listGroup.push(i),this.listGroup=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1),this.listState.totalRecord=this.listGroup.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.groupInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}_onLeaveGroup(e){for(let t=0;t<e.length;t++){if(!this.listGroup.includes(e[t]))return;this.listGroup.splice(this.listGroup.indexOf(e[t]),1),this.initListGroup.splice(this.listGroup.indexOf(e[t]),1),this.listState.totalRecord=this.listGroup.length}this._signalRenderBoth()}addComponentListeners(){ts.default.subscribeEventGroup(L.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.addEventListener(kt.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener(kt.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener(kt.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){ts.default.unsubscribeEventGroup(L.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.removeEventListener(kt.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener(kt.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener(kt.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}getList(e,t){return this.listGroup}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listGroup=[],this.initListGroup=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:Kn.o.ACTION_DECREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1}})||Xn)||Xn)||Xn)||Xn)||Xn)||Xn);var Yn;let er;Object(Bt.b)(Un.i)(Yn=Reflect.metadata("design:type",Function)(Yn=Reflect.metadata("design:paramtypes",[])(Yn=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=Un.g,this.key=Un.g}init(e){throw new Error("Method not implemented.")}async onLoadInfo(e){const t=Gn.getGroupInfoSync(e);t&&(this.data.set(e.userId,t),Object(st.g)(this.name,e.userId))}loadInfoNotRender(e){const t=Gn.getGroupInfoSync(e);return t?(this.data.set(e.userId,t),t):null}loadMultiGroupInfo(e){for(const t of e)this.loadInfoNotRender({userId:t})}openGroupMemberPopup(e){const t=this.data.get(e);He.ModalManagerV2.openModal({windowId:"1",name:L.ModalIdentitiesDefine.GROUP_PROFILE,params:{group_member:t}})}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||Yn)||Yn);!function(e){e[e.RECOMMEND=1]="RECOMMEND",e[e.RECEIVE=2]="RECEIVE"}(er||(er={}));const tr=500,sr=500;var ir;Object(Bt.b)(Un.m)(ir=function(e,t){return i.ModuleContainer.inject(Un.b)(e,void 0,0)}(ir=Reflect.metadata("design:type",Function)(ir=Reflect.metadata("design:paramtypes",[void 0===Un.b?Object:Un.b])(ir=class extends Y.b{constructor(e){super(),this.contactTabController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this._Logger=void 0,this.name=Un.k,this.key=Un.k,this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}}),this.addPublicListeners()}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.contactTabV2,[this.name])),this._Logger}_signalRenderItem(){Object(st.g)(this.name,"all")}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.data.get(e.key)}_updateLoadingState(e,t){const{listFriendReceived:s=[],listFriendSuggest:i=[],listFriendSent:n=[]}=this.data.get("all")||{};let{isLoadingRecommendFriendList:r,isLoadingRequestedFriendList:a}=this.data.get("all")||{};if("RecommendFriendList"===e)switch(t){case"ON":r||0!==s.length||0!==i.length||(r=!0);break;case"OFF":r&&(r=!1)}if("RequestedFriendList"===e)switch(t){case"ON":a||0!==n.length||(a=!0);break;case"OFF":a&&(a=!1)}this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{isLoadingRecommendFriendList:r,isLoadingRequestedFriendList:a})),this._signalRenderItem()}async onLoadRequestedFriendList(){const e=Date.now();try{this._updateLoadingState("RequestedFriendList","ON");const t=await xn.getRequestedFriendList();Date.now()-e<tr&&await Qn(sr),this._updateLoadingState("RequestedFriendList","OFF");const s=Object.keys(t).map((e=>t[e])).sort(((e,t)=>{var s,i;const n=null===(s=e.fReqInfo)||void 0===s?void 0:s.time,r=null===(i=t.fReqInfo)||void 0===i?void 0:i.time;return r>n?1:r<n?-1:0})),{listFriendReceived:i=[],listFriendSuggest:n=[],mapRelatedGroup:r={}}=this.data.get("all")||{};this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:i,listFriendSent:s,listFriendSuggest:n,mapRelatedGroup:r})),this._signalRenderItem()}catch(t){Date.now()-e<tr&&await Qn(sr),this._updateLoadingState("RequestedFriendList","OFF"),this.Logger.zsymb(18,10294,3e4,"[InvitationController] -> [onLoadRequestedFriendList], error: "+JSON.stringify(t))}}async onLoadRecommendFriendList(){const e=Date.now();try{this._updateLoadingState("RecommendFriendList","ON");const t=await xn.getRecommendFriendList();if(Date.now()-e<tr&&await Qn(sr),this._updateLoadingState("RecommendFriendList","OFF"),Array.isArray(t)&&t.length>0){const e=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===er.RECEIVE})),s=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===er.RECOMMEND})),{listFriendSent:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{};this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:i,listFriendSuggest:s,mapRelatedGroup:n})),s.length>0&&this.dispatchEvent(new Bn.b(Bn.a.LoadRelatedGroups,"",{})),this._signalRenderItem()}}catch(t){Date.now()-e<tr&&await Qn(sr),this._updateLoadingState("RecommendFriendList","OFF"),this.Logger.zsymb(18,10294,30001,"[InvitationController] -> [onLoadRecommendFriendList], error: "+JSON.stringify(t))}}_handleSortFriendSuggestList(e,t){return 0===e.length?e:e.sort(((e,s)=>{var i,n,r,a,o,d;const l=t[null===(i=e.dataInfo)||void 0===i?void 0:i.userId]&&t[null===(n=e.dataInfo)||void 0===n?void 0:n.userId].length,c=(null===(r=e.dataInfo)||void 0===r?void 0:r.displayName)||"",h=t[null===(a=s.dataInfo)||void 0===a?void 0:a.userId]&&t[null===(o=s.dataInfo)||void 0===o?void 0:o.userId].length,u=(null===(d=s.dataInfo)||void 0===d?void 0:d.displayName)||"";return l&&h?l===h?c.localeCompare(u):h>l?1:-1:l&&!h?-1:!l&&h?1:l||h?0:c.localeCompare(u)}))}async onLoadRelatedGroupList(){try{const{listFriendSuggest:e=[]}=this.data.get("all")||{},t=e.map((e=>{var t;return null==e||null===(t=e.dataInfo)||void 0===t?void 0:t.userId})),s=await xn.getRelatedGroup(t),{listFriendReceived:i=[],listFriendSent:n=[]}=this.data.get("all")||{},r=this._handleSortFriendSuggestList(e,s.groupRelateds);this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:i,listFriendSent:n,listFriendSuggest:r,mapRelatedGroup:s.groupRelateds||{}})),this._signalRenderItem()}catch(e){this.Logger.zsymb(18,10294,30002,"[InvitationController] -> [onLoadRelatedGroupList], error: "+JSON.stringify(e))}}handleFriendProfileChange(e){const{listFriendReceived:t=[],listFriendSuggest:s=[],listFriendSent:i=[]}=this.data.get("all")||{};Object.keys(e).forEach((e=>{const n=Je.default.getDName(e),r=t.findIndex((t=>t.dataInfo.userId===e));-1!==r&&(t[r].displayName=n);const a=s.findIndex((t=>t.dataInfo.userId===e));-1!==a&&(s[a].displayName=n);const o=i.findIndex((t=>t.userId===e));-1!==o&&(i[o].displayName=n)})),this._signalRenderItem()}handlePublicFriendEvents(e){const t=e.payload;if(t)for(let i=0;i<t.length;i++){var s;const n=t[i].ts,r="add"===t[i].act&&t[i].data||(null===(s=t[i].data)||void 0===s?void 0:s.fromUid),a=r===e.userId;if(n&&r&&!a&&"fr"===t[i].act_type)switch(t[i].act){case"req_v2":this.contactTabController.onUpdateRequestTracking("FRIEND","NEW",n,r);break;case"undo_req":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",n,r),this.dispatchEvent(new Bn.b(Bn.a.UndoAddFriendEvent,"",r));break;case"add":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",n,r),this.dispatchEvent(new Bn.b(Bn.a.AcceptAddFriendEvent,"",r));break;case"reject":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",n,r),this.dispatchEvent(new Bn.b(Bn.a.RejectAddFriendEvent,"",r))}}}handlePublicAddFriendEvent(e){let t=[];const s=e.payload;if(s){for(let e=0;e<s.length;e++){let i={};i.userId=s[e].userId,i.zaloName=s[e].zaloName,i.avatar=s[e].avatar,i.displayName=s[e].displayName,i.recommInfo={message:s[e].friendRequestMsg,source:s[e].friendRequestSource},i.recommTime=s[e].friendRequestFetchTime,i.recommType=s[e].friendRequestType,t.push({dataInfo:i,recommItemType:1})}this.dispatchEvent(new Bn.b(Bn.a.ReceiveAddFriendEvent,"",t))}}addPublicListeners(){this.addEventListener(Bn.a.PublicInvitationEvents,this.handlePublicFriendEvents.bind(this)),this.addEventListener(Bn.a.PublicReceiveAddFriendEvent,this.handlePublicAddFriendEvent.bind(this)),Je.default.connectSignalChangeDNameAndAvatar(this.handleFriendProfileChange.bind(this))}addComponentListeners(){}removeComponentListeners(){}_addFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{},r=e.concat(t);this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:r,listFriendSent:s,listFriendSuggest:i,mapRelatedGroup:n})),this._signalRenderItem()}_removeFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{},r=t.filter((t=>{var s;return(null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:r,listFriendSent:s,listFriendSuggest:i,mapRelatedGroup:n})),this._signalRenderItem()}onUpdateFriendRequests(e,t){switch(t){case"ADD":this._addFriendReceived(e);break;case"REMOVE":this._removeFriendReceived(e),this._removeFriendSent(e)}}async onRejectFriend(e){return new Promise(((t,s)=>{xn.rejectAddFriend(e).then((()=>{this._removeFriendReceived(e),t(e)})).catch((e=>{this.Logger.zsymb(18,10294,30003,"[InvitationController] -> [onRejectFriend], error: "+JSON.stringify(e)),s(e)}))}))}async onAddFriend(e){return new Promise(((t,s)=>{xn.acceptAddFriend(e).then(t).catch((e=>{this.Logger.zsymb(18,10294,30004,"[InvitationController] -> [onAddFriend], error: "+JSON.stringify(e)),s(e)}))}))}removeFriendSent(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{},r=s.filter((t=>(null==t?void 0:t.userId)!==e));this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:r,listFriendSuggest:i,mapRelatedGroup:n})),this._signalRenderItem()}onRemoveFriendSent(e){xn.makeUndoSentRequestFriend(e).then((()=>{this.removeFriendSent(e.userId)})).catch((e=>{this.Logger.zsymb(18,10294,30005,"[InvitationController] -> [onRemoveFriendSent], error: "+JSON.stringify(e)),e&&301==e.error_code?Xe.a.createError(Ye.default.str("STR_UNDO_REQUEST_ERROR_301")):e&&"ERR_NO_NETWORK"===e.code?Xe.a.createError(Ye.default.str("STR_CHECK_NET")):Xe.a.createError(Ye.default.str("STR_UNDO_REQUEST_ERROR_UNKNOWN"))}))}_removeFriendSuggest(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{},r=i.filter((t=>{var s;return(null==t||null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:s,listFriendSuggest:r,mapRelatedGroup:n})),this._signalRenderItem()}onAddFriendSuggest(e){Fn.a.doAddFriend(e.uid,e.src,null,e.windowId).then((()=>{this._removeFriendSuggest(e.uid),this.onLoadRequestedFriendList()})).catch((e=>{this.Logger.zsymb(18,10294,30006,"[InvitationController] -> [onAddFriendSuggest], error: "+JSON.stringify(e))}))}onRemoveFriendSuggest(e){xn.removeSuggestFriend(e).then((()=>{this._removeFriendSuggest(e.uid)})).catch((e=>{this.Logger.zsymb(18,10294,30007,"[InvitationController] -> [onRemoveFriendSuggest], error: "+JSON.stringify(e))}))}openMutualGroupPopup(e){He.ModalManagerV2.openModal({windowId:"1",name:L.ModalIdentitiesDefine.FRIEND_PROFILE,params:{userId:e,showMutualGroups:!0}})}resetData(){this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}})}makeExpiredReceivedFriendRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:i={}}=this.data.get("all")||{};if(0!==e.length){for(let t=0;t<e.length;t++)e[t].dataInfo.recommTime=-1,e[t].dataInfo.recommInfo.source=-1,e[t].dataInfo.recommInfo.message="";this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:i})),this._signalRenderItem()}}makeExpiredSentFriendSentRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:i={}}=this.data.get("all")||{};if(0!==t.length){for(let e=0;e<t.length;e++)t[e].fReqInfo.time=-1,t[e].fReqInfo.src=-1,t[e].fReqInfo.message="";this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:i})),this._signalRenderItem()}}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||ir)||ir)||ir);var nr=s("hd49");let rr;!function(e){e.MessageDelivered="MessageDelivered"}(rr||(rr={}));class ar extends Event{constructor(e,t,s){super(e),this.msgId=void 0,this.payload=void 0,this.msgId=t,this.payload=s}}var or,dr=s("Y/Cm");Object(V.h)()(or=Object(V.g)()(or=Object(i.singleton)(nr.a)(or=Object(i.injectable)()(or=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,0)}(or=Reflect.metadata("design:type",Function)(or=Reflect.metadata("design:paramtypes",[void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(or=class extends Y.b{constructor(e){super(),this.logger=void 0,this.logger=e.createZLogger("feat",["message-service"])}onStart(){}onDispose(){}onPollingMessages(e,t){return new Promise(((s,i)=>{if(!e||0===e.length)return s(!1);const n=t?{userId:t}:{userId:e[0].toUid},r=[...e],a=()=>{this.messagesDelivered(r)};dr.a.preparse(r,n,a,a)}))}loadMessage(e){return Promise.resolve({})}loadMessagesBefore(e,t,s){}loadMessagesAfter(e,t,s){}loadLastMessage(e,t){}messagesDelivered(e){this.broadcastEvent(rr.MessageDelivered,"",e)}broadcastEvent(e,t,s){void 0===t&&(t=""),bt.default.log([e,"- id: ",t," - payload: ",null==s?void 0:s.length]),this.dispatchEvent(new ar(e,t,s))}})||or)||or)||or)||or)||or)||or);const lr=Object(i.define)("cloud-segment-repository"),cr=Object(i.define)("cloud-segment-manager"),hr=Object(i.define)("cloud-message-manager");class ur{constructor(e){this.entity=e}get conversationId(){return this.entity.conversationId}get cloudFirstSmsLocalId(){return this.entity.cloudFirstSmsLocalId}get cloudSegmentCheck(){return this.entity.cloudSegmentCheck}get hasMore(){return this.entity.hasMore}get lastCloudVerifiedDttm(){return this.entity.lastCloudVerifiedDttm}get lastDeletedMsgID(){return this.entity.lastDeletedMsgID}get lastGetMaxRecentTs(){return this.entity.lastGetMaxRecentTs}get maxCloudMsgId(){return this.entity.maxCloudMsgId}}var gr,mr=s("t3h5");let pr=i.ModuleContainer.injectable()(gr=Reflect.metadata("design:type",Function)(gr=Reflect.metadata("design:paramtypes",[])(gr=class{constructor(){}get(e){return mr.a.getSegmentByConvId(e)}})||gr)||gr)||gr;var fr,vr=s("npvr"),br=s("D8Ji");let yr,Ir=i.ModuleContainer.injectable()(fr=function(e,t){return i.ModuleContainer.inject(lr)(e,void 0,0)}(fr=Reflect.metadata("design:type",Function)(fr=Reflect.metadata("design:paramtypes",[void 0===lr?Object:lr])(fr=class{constructor(e){this.segmentRepository=e}get(e){return this.segmentRepository.get(e).then((e=>e&&new ur(e))).catch((e=>{}))}async createOrExtendSegment(e,t){const s=await this.segmentRepository.get(e);s.cloudSegmentCheck=br.a.mergeNewSegment(t.verifiedRange,null==s?void 0:s.cloudSegmentCheck),s.maxCloudMsgId=Math.max(s.maxCloudMsgId||0,t.verifiedRange[1]),mr.a.setSegmentCacheByConvId(e,s),await vr.b.updateSegmentDB(e,s)}})||fr)||fr)||fr)||fr;!function(e){e[e.STOP_RETRY=-69]="STOP_RETRY",e[e.RETRY_LATER=-71]="RETRY_LATER",e[e.FORCE_UPDATE_CONFIG=-72]="FORCE_UPDATE_CONFIG",e[e.UNKNOWN_EXCEPTION=112]="UNKNOWN_EXCEPTION",e[e.PARAMS_INVALID=114]="PARAMS_INVALID",e[e.CLIENT_NOT_SUPPORT=211]="CLIENT_NOT_SUPPORT",e[e.LIMIT_GROUPS_PER_REQUEST=300]="LIMIT_GROUPS_PER_REQUEST",e[e.LIMIT_MSG_PER_GROUP=301]="LIMIT_MSG_PER_GROUP",e[e.LIMIT_TOTAL_SYNC_MSG_PER_GROUP=303]="LIMIT_TOTAL_SYNC_MSG_PER_GROUP",e[e.MISSING_PARAM=111]="MISSING_PARAM",e[e.GROUP_NOT_EXIST=161]="GROUP_NOT_EXIST",e[e.NOT_BELONG_TO_GROUP=164]="NOT_BELONG_TO_GROUP",e[e.IS_DIRTY_GROUP=302]="IS_DIRTY_GROUP"}(yr||(yr={}));class _r extends Error{constructor(e,t,s){super(s),this.code=e,this.data=t}}var Mr;let Cr=i.ModuleContainer.injectable()(Mr=function(e,t){return i.ModuleContainer.inject(_.a)(e,void 0,0)}(Mr=Reflect.metadata("design:type",Function)(Mr=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a])(Mr=class{constructor(e){this.config=e}get settings(){return this.config.get("cloud.auto_download")}async crawlMissingMessage(e,t){void 0===t&&(t={nRetry:0,count:50});let s=e.conversationId;s.startsWith("g")&&(s=s.slice(1));const i=`${s}_${e.requestMsgId}`;let n=this.settings.limit.minMsgDttm,r=this.settings.limit.maxMsgFirstSegment;const a={groupId:s,fromMsgId:e.requestMsgId,globalMsgIds:e.globalMsgIds,curTotalMsgs:e.curTotalMsgs,tsJoinGroup:e.tsJoinGroup,minMsgTs:n,maxTotalSyncMsg:r};return await yn.default.crawlMissingMessage(i,a,{requestTimeout:this.settings.fetching.timeout,count:t.count,nRetry:t.nRetry,usePostApi:!0}).then((e=>Object(vn.a)(e))).then((e=>{try{return JSON.parse(e)}catch(t){throw{error_code:-1,error_message:"invalid response"}}})).then((e=>{const t=e[s];if(t.error>0)throw{error_code:t.error,error_message:"inner error"};return t})).catch((e=>{if("number"==typeof e.error_code){let s=e.data;try{s=JSON.parse(s)}catch(t){}throw new _r(e.error_code,s,e.error_message)}throw e}))}})||Mr)||Mr)||Mr)||Mr;var Tr,Or=s("EO3V"),Er=s("enz2");const Sr={totalMsgCount:0,fetchedMsgCount:0,serverMsgCount:0,newMsgCount:0,phaseDone:!1,isFilteredByTimeJoin:!1,done:!0,tsJoinGroup:"0"};let wr=i.ModuleContainer.injectable()(Tr=function(e,t){return i.ModuleContainer.injectToken(Cr)(e,void 0,0)}(Tr=function(e,t){return i.ModuleContainer.inject(cr)(e,void 0,1)}(Tr=function(e,t){return i.ModuleContainer.inject(oi.c)(e,void 0,2)}(Tr=function(e,t){return i.ModuleContainer.inject(oi.b)(e,void 0,3)}(Tr=function(e,t){return i.ModuleContainer.inject(H.ZLoggerFactory)(e,void 0,4)}(Tr=Reflect.metadata("design:type",Function)(Tr=Reflect.metadata("design:paramtypes",[void 0===Cr?Object:Cr,void 0===cr?Object:cr,void 0===oi.c?Object:oi.c,void 0===oi.b?Object:oi.b,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(Tr=class{constructor(e,t,s,i,n){this.api=e,this.segmentManager=t,this.messageRepository=s,this.messageManager=i,this.logger=void 0,this.logger=n.createZLogger("cld-msg",["manager"])}async crawlMissingMessage(e,t,s){const i=await this.segmentManager.get(e),n=(()=>{var e;let t=s.minMsgId&&Number.parseInt(s.minMsgId);return i&&i.lastDeletedMsgID&&(t=t?Math.max(i.lastDeletedMsgID,t):i.lastDeletedMsgID),null===(e=t)||void 0===e?void 0:e.toString()})(),r="0"!==t,a=r?s.count+1:s.count;if(r&&t<=n)return Sr;const o=await this.messageManager.findPrevMessagesFromMsgId(e,{maxMsgId:"0"!==t?t:void 0,minMsgId:n,limit:a}).then((e=>e.map((e=>e.entity)))),d=new Set;o.forEach((e=>{try{const t=Number.parseInt(e.msgId);Number.isInteger(t)&&d.add(t.toString())}catch(t){}}));const l=Array.from(d.values()),c=await this.api.crawlMissingMessage({conversationId:e,requestMsgId:t,globalMsgIds:l,curTotalMsgs:s.curTotalMsgs,tsJoinGroup:s.tsJoinGroup},{nRetry:s.nRetry,count:s.count});if(0===c.groupMsgs.length&&"0"===c.maxMsgId)return Sr;let h=Or.a.checkDupMessageFromCloud(e,c.groupMsgs);n&&n>"0"&&(h=h.filter((e=>e.msgId>n)));const u=[...o,...h];if(0===u.length)return Sr;const g=Number.parseInt(c.lastMsgId,10);let m=Number.parseInt(t);const p=Or.a.findMinMaxGroupMsg(u,m,g,null==i?void 0:i.lastDeletedMsgID),{groupMsgsToView:v,groupMsgsAddDb:b,groupMsgsSearch:y}=Er.a.findMsgsAddDb(t,h,[],o,Object(f.a)({apiType:2,conversationId:e},p));b.forEach((e=>{e.src=L.MSG_SRC.AUTO_LOADER})),await this.messageRepository.saveMessages(b),await Er.a.updateSearchV3(y,e);const I=!!c.isFilteredByPhase,_=c.maxMsgId;p.minMsgId&&p.maxMsgId&&await this.segmentManager.createOrExtendSegment(e,{verifiedRange:[p.minMsgId,p.maxMsgId]});let M="0";Number.isInteger(Number.parseInt(c.tsJoinGroup))?M=c.tsJoinGroup:this.logger.zsymb(18,8177,3e4,(()=>["api res invalid ts join group",{tsJoinGroup:c.tsJoinGroup}]));const C=!!c.isFilteredByTimeJoin,T={totalMsgCount:v.length,fetchedMsgCount:b.length,serverMsgCount:h.length,newMsgCount:b.length,phaseDone:I,isFilteredByTimeJoin:C,done:!(I||!C&&c.hasMore),minMsgId:n,maxMsgId:_.toString(),tsJoinGroup:M};return this.logger.zsymb(3,8177,30001,"[auto-dl-msg] crawl result",T),T}})||Tr)||Tr)||Tr)||Tr)||Tr)||Tr)||Tr)||Tr;i.ModuleContainer.registerSingleton(lr,pr),i.ModuleContainer.registerSingleton(cr,Ir),i.ModuleContainer.registerSingleton(hr,wr);var Lr,Dr=s("rfrl"),Fr=s("KP/S"),Rr=s("wiGx");const Ar={screen:Rr.a.Hidden,error:Fr.b.NO_ERROR,progress:0,numOfSyncedConv:0,popupVisible:!1,startSyncTime:0,closing:!1,syncingConversation:null};Object(Bt.b)(Rr.b)(Lr=class{constructor(){this.state=Object(f.a)({},Ar),this.name="sync-message-ui",this.key="window_id"}showPopup(){this.setState((e=>{e.popupVisible=!0}))}setSyncingConversation(e){this.setState((t=>{t.syncingConversation=e}))}hidePopup(){this.setState((e=>{e.popupVisible=!1}))}hideAllUI(){this.setState((e=>{e.screen=Rr.a.Hidden,e.closing=!1}))}showError(e){this.setState((t=>{t.error=e,t.screen=Rr.a.Error,t.syncingConversation=null}))}showSuggestNewSync(e){this.setState((t=>{t.screen=Rr.a.SuggestNewSync,t.popupVisible=e}))}showSuggestResume(){this.setState((e=>{e.screen=Rr.a.SuggestResume,e.popupVisible=!1}))}showSyncGuide(){this.setState((e=>{e.screen=Rr.a.SyncGuide,e.popupVisible=!0}))}showWaitForBackup(){this.setState((e=>{e.screen=Rr.a.WaitForBackup}))}showDownloadingBackup(){this.setState((e=>{e.screen=Rr.a.DownloadingBackup,e.progress=0}))}showDecryptingBackup(){this.setState((e=>{e.screen=Rr.a.DecryptingBackup,e.progress=0}))}showInProgress(){this.setState((e=>{e.screen=Rr.a.SyncInProgress,e.progress=0}))}showCloseNotice(){this.setState((e=>{e.closing=!0}))}showSuccessMessage(){this.setState((e=>{e.screen=Rr.a.SyncSuccess,e.syncingConversation=null}))}showWaitForNetwork(){this.setState((e=>{e.screen=Rr.a.WaitForNetwork}))}setProgress(e){this.setState((t=>{t.progress=e}))}setNumOfSyncedConv(e){this.setState((t=>{t.numOfSyncedConv=e}))}resetStartSyncTime(){this.setState((e=>{e.startSyncTime=Date.now()}))}clearError(){this.setState((e=>{e.error=Fr.b.NO_ERROR}))}getStartSyncTime(){return this.state.startSyncTime}getCurrentError(){return this.state.error}getCurrentScreen(){return this.state.screen}getPopupVisible(){return this.state.popupVisible}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(Dr.a)(this.state,e);this.state!==t&&(this.state=t,Object(st.g)(this.name,"current"))}});var Pr,Nr=s("cPHW");let jr=i.ModuleContainer.injectable()(Pr=class{start(){}isEnable(){return!1}canSync(){return Fr.a.DISABLED}suggestSync(){throw new Error("Method not implemented.")}suggestResume(){throw new Error("Method not implemented.")}sync(){throw new Error("Method not implemented.")}resume(){throw new Error("Method not implemented.")}cancel(){throw new Error("Method not implemented.")}confirmCancelSyncInSuggestingPopup(){throw new Error("Method not implemented.")}closeCancelSyncInSuggestingPopup(){throw new Error("Method not implemented.")}pause(){throw new Error("Method not implemented.")}retry(){throw new Error("Method not implemented.")}rejectSuggest(){throw new Error("Method not implemented.")}showSuggestPopup(){throw new Error("Method not implemented.")}closeSuggestPopup(){throw new Error("Method not implemented.")}setRequestBackupTimeout(){throw new Error("Method not implemented.")}clearRequestBackupTimeout(){throw new Error("Method not implemented.")}setAutoCloseSuccessTimeout(){throw new Error("Method not implemented.")}clearAutoCloseSuccessTimeout(){throw new Error("Method not implemented.")}resendRequest(){throw new Error("Method not implemented.")}reset(){throw new Error("Method not implemented.")}hideProgress(){throw new Error("Method not implemented.")}handleCtrlEvents(){}})||Pr;i.ModuleContainer.registerSingleton(Nr.a,jr);var Ur=s("Erqw");const Br=e=>{var t;const s=e.step,i=e.registry;let n=null!==(t=e.timeout)&&void 0!==t?t:0;const r=e.callback,a=e.args,o=performance.now()+n;let d;function l(){let e=Math.min(o-performance.now(),s);return performance.now()>o?i[d]=setTimeout(r,0,a):i[d]=setTimeout(l,e),i[d]}return function(){let e=Math.min(o-performance.now(),s);return d=setTimeout(l,e),i[d]=d,d}()};const{setTimeoutUnlimited:kr,clearTimeoutUnlimited:Gr}=function(e){var t,s;void 0===e&&(e={});const i=null!==(t=e.step)&&void 0!==t&&t?1e4:36e5,n=null!==(s=e.registry)&&void 0!==s?s:{};return{setTimeoutUnlimited:function(e,t){for(var s=arguments.length,r=new Array(s>2?s-2:0),a=2;a<s;a++)r[a-2]=arguments[a];const o=Br({step:i,registry:n,callback:e,timeout:t,args:r});return o},clearTimeoutUnlimited:e=>{(e=>{const t=e.id,s=e.registry;clearTimeout(s[t]),delete s[t]})({id:e,registry:n})}}}({registry:{}});var xr,zr=s("1p+n"),Vr=s("UYft"),$r=s("AULX");Object(i.injectable)()(xr=Object(i.singleton)($r.a)(xr=Object(V.g)()(xr=Object(V.e)()(xr=function(e,t){return Object(i.inject)(A)(e,void 0,0)}(xr=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,1)}(xr=Reflect.metadata("design:type",Function)(xr=Reflect.metadata("design:paramtypes",[void 0===R?Object:R,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(xr=class{constructor(e,t){this.kvCacheFactory=e,this.loggerFactory=t,this._logger=void 0,this._authEvent=void 0,this.__cache=void 0,this._renewRegistry={},this.updateEmitter=new zr.a,this._logger=this.loggerFactory.createZLogger("feat",["group-link"])}onAuthenticated(e){this._authEvent=e}_makeCache(){if(!this._authEvent)throw new Error("Not authenticated");return this.kvCacheFactory.createCache(`group-link-v3-${this._authEvent.getSession().userId}`,{maxSize:50})}get _cache(){return this.__cache||(this.__cache=this._makeCache()),this.__cache}_scheduleRenew(e,t){if(this._clearRenewSchedule(e),!t.enabled)return this;if(!pt.default.groupLink.enableScheduleRenew)return this._logger.debug(["_scheduleRenew skipped, enableScheduleRenew:",pt.default.groupLink.enableScheduleRenew]),this;let s=t.expirationDate-Mi.a.getTimeNow(),i=kr((()=>{this._clearRenewSchedule(e),this._emitGroupLinkUpdated(e,!0)}),s);return this._renewRegistry[e]=()=>{Gr(i),delete this._renewRegistry[e]},this}_clearRenewSchedule(e){var t,s;return null===(t=(s=this._renewRegistry)[e])||void 0===t||t.call(s),this}onDispose(){this._authEvent=void 0,this.__cache=void 0}async _getFromCache(e){if(!pt.default.groupLink.enableCache)return void this._logger.debug(["cache skipped, enableCache:",pt.default.groupLink.enableCache]);e=Wr(e);let t=await this._cache.getItem(e);if(t){if(function(e){if(!e)return!1;let{data:t,meta:s}=e;if(!t)return!1;if(!s)return!1;if(Ur.a.isOverflowAtTime(s.ts))return!1;const i=Mi.a.getTimeNow();if(s.ts+pt.default.groupLink.maxCacheDuration<i)return!1;if(t.enabled&&t.expirationDate<i)return!1;return!0}(t))return t.data;await this._cache.removeItem(e)}}async _fetchAndPutToCache(e,t){const s=Mi.a.getTimeNow(),i=await t(),n={enabled:i.enabled,expirationDate:i.expiration_date,link:i.link};let r={ts:s};return await this._cache.setItem(e,{data:n,meta:r}),n}async _deleteCache(e){await this._cache.removeItem(e)}async getGroupLinkDetail(e,t){void 0===t&&(t=!1),this._logger.zsymb(12,9640,3e4,["getting",e]);let s=Wr(e),i=await this._getFromCache(s);if(i&&!t)return this._logger.zsymb(12,9640,30001,["cache hit",s]),this._scheduleRenew(s,i),i;this._logger.zsymb(12,9640,30002,["fetching",s]);let n=bt.default.getRawGroupId(s);let r=await this._fetchAndPutToCache(s,(()=>vt.default.getGroupLinkDetail(n))).catch(Vr.a.catch((e=>this._logger.zsymb(18,9640,30003,["get failed",s,e]))));return this._scheduleRenew(s,r),t&&await this._emitGroupLinkUpdated(e),this._logger.zsymb(12,9640,30004,["done",s]),r}async renewGroupLink(e){this._logger.zsymb(12,9640,30005,["renewing",e]);let t=Wr(e),s=bt.default.getRawGroupId(t);let i=await this._fetchAndPutToCache(t,(()=>vt.default.renewGroupLink(s))).catch(Vr.a.catch((e=>this._logger.zsymb(18,9640,30006,["renew failed",t,e]))));return this._scheduleRenew(t,i),await this._emitGroupLinkUpdated(t),this._logger.zsymb(12,9640,30007,["renew done",e]),i}async disableGroupLink(e){this._logger.zsymb(12,9640,30008,["disabling",e]);let t=Wr(e),s=bt.default.getRawGroupId(t);await vt.default.disableGroupLink(s).catch(Vr.a.catch((e=>this._logger.zsymb(18,9640,30009,["disable failed",t,e])))),await this._emitGroupLinkUpdated(t,!0),this._logger.zsymb(12,9640,30010,["disable done",e])}async _emitGroupLinkUpdated(e,t){void 0===t&&(t=!1);const s=Wr(e);t&&await this._deleteCache(s),this.updateEmitter.emit(s,s),this.updateEmitter.emit("*",s)}async emitGroupLinkUpdated(e){return await this._emitGroupLinkUpdated(e,!0)}})||xr)||xr)||xr)||xr)||xr)||xr)||xr);function Wr(e){return L.GROUPID_PREFIX+bt.default.getRawGroupId(e)}var qr,Kr=s("TO4U");const Hr={loading:!0};Object(Bt.b)(Kr.a)(qr=function(e,t){return Object(i.inject)($r.a)(e,void 0,0)}(qr=Reflect.metadata("design:type",Function)(qr=Reflect.metadata("design:paramtypes",[void 0===$r.a?Object:$r.a])(qr=class e{constructor(e){this._groupLink=e,this.type=void 0,this.name="group-link-ui",this.key="group-link-ui",this._cache=new U.default({maxSize:50}),this._handleUpdate=e=>{const t=Qr(e);this._cache.delete(t),this._startFetchAndSetToSession(t)},this._groupLink.updateEmitter.on("*",this._handleUpdate)}init(){}getItem(e,t){if(!e.key.startsWith(L.GROUPID_PREFIX))return;const s=Qr(e.key);this._startFetchAndSetToSession(s);let i=this._cache.get(s);return i||Hr}static shouldSignal(e,t){var s,i,n,r,a,o;return!e||(null==e||e.error,null==t||t.error,null==t||null===(s=t.data)||void 0===s||s.enabled,null==t||null===(i=t.data)||void 0===i||i.enabled,null!=e&&null!==(n=e.data)&&void 0!==n&&n.enabled&&null!=t&&null!==(r=t.data)&&void 0!==r&&r.enabled&&(null==e||null===(a=e.data)||void 0===a||a.link,null==t||null===(o=t.data)||void 0===o||o.link),!1)}signalIfNeeded(t,s,i){e.shouldSignal(s,i)&&Object(st.g)(this.name,t)}_startFetchAndSetToSession(e){const t=this._cache.get(e);setTimeout((()=>{this._groupLink.getGroupLinkDetail(e).then((s=>{const i={loading:!1,data:s};this._cache.set(e,i),this.signalIfNeeded(e,t,i)})).catch((s=>{const i={loading:!1,error:s};this._cache.set(e,i),this.signalIfNeeded(e,t,i)}))}),0)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||qr)||qr)||qr);function Qr(e){return L.GROUPID_PREFIX+bt.default.getRawGroupId(e)}var Jr=s("akSd"),Zr=s("xQyS"),Xr=s("fqRP"),Yr=s("L904"),ea=s("EiAw"),ta=s("IoRb");let sa;class ia{static get instance(){return sa||(sa=new ia),sa}get _eventStore(){return this.__eventStore||(this.__eventStore=s("emRR").default),this.__eventStore}constructor(){this.__eventStore=void 0,this._emitConversationDeleted=e=>{let t,s,i=[];if(e.ok?({conversation:t,toUid:s,allItems:i}=e.value):({conversation:t,toUid:s,allItems:i}=e.error),t)return;if(i.length&&i.every((e=>e.ttlType===Ki.a.Quote)))return;const n={type:_t.FetchActions.DELETE_CONVERSATION,payload:s};this._eventStore.dispatch(n),Ke.a.dispatch(n),It.default.send(n.type,n.payload)},this._emitDeletedMsgs=e=>{let t,s;e.ok?({allItems:s,conversation:t}=e.value):({allItems:s,conversation:t}=e.error);const i=s.filter((e=>e.ttlType===Ki.a.Message)).map((e=>e.msgId));Object(ea.a)({msgId:i,conversation:t})},this._emitUpdateUnread=(e,t)=>{let s,i=[];e.ok?({toUid:s,allItems:i}=e.value):({toUid:s,allItems:i}=e.error),Dt.a.UnreadDataManager.updateUnreadTTLConversation(s,i,null==t?void 0:t.get(s))},this.emitPerConversation=async(e,t)=>{let s=await Object(Zr.a)(this._emitConversationDeleted,e);s.ok||Object(ta.a)("_emitConversationDeleted failed",s.error),s=await Object(Zr.a)(this._emitDeletedMsgs,e),s.ok||Object(ta.a)("_emitDeletedMsgs failed",s.error),s=await Object(Zr.a)(this._emitUpdateUnread,e,t),s.ok||Object(ta.a)("_emitUpdateUnread failed",s.error)}}}var na,ra=s("LA52"),aa=s("GSaP");const oa=e=>null==e?void 0:e.toUid,da=e=>null!=e&&e.ok?"success":"error";Object(i.singleton)(ra.a)(na=Reflect.metadata("design:type",Function)(na=Reflect.metadata("design:paramtypes",[])(na=class{constructor(){var e=this;this._pruning=!1,this._task=void 0,this._ttl=i.ModuleContainer.resolve(Xr.a),this._logger=void 0,this.dispose=()=>{},this.prune=async()=>this._pruning?await this._task:(this._pruning=!0,this._task=this._pruneFromDB(),this._pruning=!1,this._task),this._pruneFromDB=async()=>{const e=Mi.a.getTimeNow();this._logger.zsymb(0,8948,3e4,"Pruner execute task",e);const t=await Object(Zr.b)(this._ttl.getExpireItemsBefore,e);if(!t.ok)return this._logger.zsymb(18,8948,30001,"Pruner getExpireItemsBefore failed",t.error),{ok:!1,error:null};const s=t.ok?t.value:[];return await this._pruneTTLItems(s)},this._pruneByMsgsBatch=[],this.pruneByMsgs=async e=>{const t=Object(Mt.a)(e);this._pruneByMsgsBatch.push(...t),setTimeout((()=>{const e=this._pruneByMsgsBatch;this._pruneByMsgsBatch=[],e.length&&(this._logger.zsymb(15,8948,30002,"running a batch {}",e.length),this._pruneByMsgs(e))}),2e3)},this._pruneByMsgs=async e=>{const t=Mi.a.getTimeNow();this._logger.zsymb(15,8948,30003,"deriving {}",e.length);let s=aa.a.createFromCurrentSession().deriveTTLItems(e);this._logger.zsymb(15,8948,30004,"ttlItems count: {}",s.length),s=s.filter((e=>{const s=+e.expireOn+pt.default.ttl.enable_delete_on_filter_minimum_overtime;return!isNaN(s)&&s<t})),this._logger.zsymb(15,8948,30005,"expired count: {}",s.length),s=s.filter((e=>!this._hasPruneMsgCache(e))),s.forEach((e=>{this._setPruneMsgCache(e)})),this._logger.zsymb(15,8948,30006,"no cache count: {}",s.length),s.length?(this._logger.zsymb(3,8948,30007,"pruning {}, {}",s.length,s),await this._deleteMsgsAndEmit(s)):this._logger.zsymb(15,8948,30008,"no items to prune")},this._pruneMsgCache=new U.default({maxSize:1e4}),this._pruneTTLItems=async e=>{const t=e.map((e=>[e.msgId,e.ttlType]));this._logger.zsymb(3,8948,30009,"pruning {} items: {}",t.length,t),await this._deleteMsgsAndEmit(e);const s=await Object(Zr.b)(this._ttl.deletes,t);return s.ok||this._logger.zsymb(18,8948,30010,"Pruner deletes ttl failed",s.error),s},this._retryErrorMsgsIfNeeded=e=>{for(const s of e){var t;if(s.ok)continue;const{errorItems:e,toUid:i}=s.error;this._logger.zsymb(0,8948,30011,"_retryErrorDelete "+i,null==e||null===(t=e[0])||void 0===t?void 0:t.msgId),setTimeout((()=>{Object(Zr.b)(this._deleteMsgsBelongToTTLItems,e)}),5e3)}},this._retryErrorDelete=e=>setTimeout((async()=>{const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(Zr.b)(this._deleteMsgsBelongToTTLItems,e);!s.ok&&this._logger.zsymb(18,8948,30012,"Pruner _retryErrorDelete",s.error),s.ok&&this._emitPruneResult(s.value,t)}),5e3),this._emitPruneResult=async(e,t)=>{for(const s of e)await Object(Zr.b)(ia.instance.emitPerConversation,s,t)},this._deletePerConversation=async function(e,t){var s,i,n,r,a,o,d,l,c;void 0===t&&(t=[]);const h=await Object(Zr.b)(Ti.b.vanishMessages,e,t);if(!h.ok)return{ok:!1,error:{toUid:e,allItems:[],errorItems:t,successItems:[]}};const u=null===(s=h.value.vanish)||void 0===s?void 0:s[0],g=null===(i=h.value.quote)||void 0===i?void 0:i[0];if(!u&&!g)return{ok:!1,error:{toUid:e,conversation:{},allItems:[],errorItems:t,successItems:[]}};const m=null===(n=h.value.vanish)||void 0===n||null===(r=n[0])||void 0===r||null===(a=r.conv)||void 0===a?void 0:a.conversation;let p=[...null!==(o=null===(d=h.value.vanish)||void 0===d?void 0:d.map((e=>e.res)).flat())&&void 0!==o?o:[],...null!==(l=null===(c=h.value.quote)||void 0===c?void 0:c.flat())&&void 0!==l?l:[]];p=p.filter((e=>e));const{success:f=[],error:v=[]}=Object(Yr.a)(p,da),b=f.map((e=>e.info)),y=v.map((e=>e.info)),I=[...b,...y];return y.length?{ok:!1,error:{toUid:e,conversation:m,allItems:I,successItems:b,errorItems:y}}:{ok:!0,value:{toUid:e,conversation:m,allItems:I,successItems:b}}},this._deleteMsgsBelongToTTLItems=async e=>{const t=Object(Yr.a)(e,oa),s=Object.keys(t).map((async e=>(Object(Zr.b)(this._sideEffect,e,t[e]),this._deletePerConversation(e,t[e]))));return await Promise.all(s)},this._sideEffect=async function(t,s){return void 0===s&&(s=[]),setTimeout((async()=>{const i=await Object(Zr.b)(e._cancelSendingPerConversation,t,s);i.ok||e._logger.zsymb(18,8948,30013,"cancelSendingPerConversation failed",i.error);const n=await Object(Zr.b)(e._syncDeletePerConversation,t,s);n.ok||e._logger.zsymb(18,8948,30014,"syncDeletePerConversation failed",n.error)}),0)},this._cancelSendingPerConversation=async function(e,t){void 0===t&&(t=[]),t.forEach((t=>Object(Zr.b)((()=>{}),e,null==t?void 0:t.cliMsgId)))},this._syncDeletePerConversation=async function(e,t){if(void 0===t&&(t=[]),!pt.default.ttl.enable_sync_delete)return;const s=t=>{+t.msgId&&Object(Jr.e)(e,{cliMsgId:t.cliMsgId,msgId:t.msgId,sendDttm:t.sendDttm,toUid:e,fromUid:t.fromUid})};t.forEach((e=>Object(Zr.b)(s,e)))},this._pruning=!1,this._logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger("utils",["ttl","destructor","pruner"])}_getPruneMsgKey(e){return e?`${e.msgId}|${e.ttlType}`:""}_hasPruneMsgCache(e){return this._pruneMsgCache.has(this._getPruneMsgKey(e))}_setPruneMsgCache(e){this._pruneMsgCache.set(this._getPruneMsgKey(e),void 0)}async _deleteMsgsAndEmit(e){const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(Zr.b)(this._deleteMsgsBelongToTTLItems,e);s.ok||(this._logger.zsymb(18,8948,30015,"Pruner","deleteMessages failed"),this._retryErrorDelete(e)),s.ok&&this._retryErrorMsgsIfNeeded(s.value),s.ok&&this._emitPruneResult(s.value,t)}})||na)||na);function la(e,t){return e.reduce(((e,s,i,n)=>(e[t(s,i,n)?0:1].push(s),e)),[[],[]])}var ca;const ha=L.MessageConstants.MAX_MSG_ID;Object(i.singleton)(Xr.a)(ca=Reflect.metadata("design:type",Function)(ca=Reflect.metadata("design:paramtypes",[])(ca=class{constructor(){this._logger=void 0,this.dispose=()=>{},this._safePut=async e=>{const t=[],s=[],i=K.a.getInstance();for(const r of e)try{await i.MsgInfo.TTLItem.insert(r,{replace:!0}),t.push(r)}catch(n){s.push([r,n])}return[t,s]},this.putMsgs=async e=>{let t=e.map((e=>ma(e)));const[s,i]=la(t,(e=>e.ok)),n=s.map((e=>e.value));let r=[],a=[];[a,r]=await this._safePut(n);const o=i.map((e=>e.error));return r.lastItem||o.length?{ok:!1,error:{invalidItems:o,errorItems:r}}:{ok:!0,value:a}},this.deletes=e=>K.a.getInstance().MsgInfo.TTLItem.deleteMulti(e),this.getExpireItemsBefore=async(e,t)=>{const s=t?{from:[t.expireOn,t.toUid,t.msgId,t.ttlType],to:[e,ha,ha,Number.MAX_VALUE],excludeFrom:!1,excludeTo:!0}:{to:[e,ha,Number.MAX_VALUE],excludeTo:!1},i={limit:50,index:"expireOn_toUid_pk"},n=K.a.getInstance();return await n.MsgInfo.TTLItem.getAll(s,i)},this.getYoungestExpiredItem=async()=>{const e={to:[Number.MAX_VALUE,ha,ha,Number.MAX_VALUE],excludeTo:!0},t=K.a.getInstance();return(await t.MsgInfo.TTLItem.getAll(e,{limit:1,index:"expireOn_toUid_pk"}))[0]},this.getMappedMsgsByConvIdFromTTLItems=async e=>{const t=Ui.b.messageCache;let s;return t&&(s=await t.getMappedMessagesByConvIdAsync(e)),s},this._logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger("utils",["ttl","destructor","ttl"])}})||ca)||ca);const ua=e=>"number"==typeof e?String(e):e,ga=[Ki.a.Message,Ki.a.Quote],ma=function(e){void 0===e&&(e={});const t=Object(f.a)({},e);return t.cliMsgId=ua(t.cliMsgId),t.cliMsgId?(t.fromUid=ua(t.fromUid),t.fromUid?(t.toUid=ua(t.toUid),t.toUid?(t.msgId=ua(t.msgId),s=t.ttlType,ga.includes(s)?(t.expireOn=+t.expireOn,"number"!=typeof t.expireOn?{ok:!1,error:e}:{ok:!0,value:t}):{ok:!1,error:e}):{ok:!1,error:e}):{ok:!1,error:e}):{ok:!1,error:e};var s};var pa=s("oOjv"),fa=s("bB26"),va=s("lteq");const ba={[$t.c]:{}};i.ModuleContainer.registerSingleton(pa.b,class{constructor(){this.state=ba,this.animationControllers=new Map,this._manuallyOff=!1,this.name=pa.a,this.key="convId",this.isFeatEnabled=()=>!this._manuallyOff&&pt.default.preview_msg_time.enable,this.state=ba}offFeature(){this._manuallyOff=!0}enableFeature(){this._manuallyOff=!1}getAnimController(e){if(!this.isFeatEnabled())return null;if(!this.animationControllers.has(e)){const t=new fa.a(e);this.animationControllers.set(e,t)}return this.animationControllers.get(e)||null}setScrollDirection(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.setScrollDirection(t)}hasNewMsgInView(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasNewMsgInView(t)}hasViewOverflowMsg(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasViewOverflowMsg(t)}hitBottom(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hitBottom(t)}triggerActiveScroll(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.triggerActiveScroll(t)}onChangeConversation(e){var t;const s=this.getAnimController(e);null==s||s.resetAnimation(),null===(t=va.a.getInViewController(e))||void 0===t||t.resetPreviewTimestamp(),bs.a.onNewSession(e)}clearAnimations(e){const t=this.getAnimController(e);null==t||t.clearAnimations()}onMouseEnterPreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.pause())}onMouseLeavePreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.resume())}setTopMost(e,t,s){if(!this.isFeatEnabled())return;const i=this.getAnimController(e);null==i||i.setTopMost(t,s)}setSecondTopMost(e,t,s){if(!this.isFeatEnabled())return;const i=this.getAnimController(e);null==i||i.setSecondTopMost(t,s)}init(){}getItem(e){return this.state[e.key]}getList(e){return Object.keys(this.state)}onGetItemFailure(e){}onGetListFailure(e){}});const ya=Object(i.define)("chat-box-list-controller");var Ia,_a=s("Ti+8");Object(V.h)()(Ia=Object(V.g)()(Ia=Object(i.singleton)(ya)(Ia=Object(i.injectable)()(Ia=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,0)}(Ia=Reflect.metadata("design:type",Function)(Ia=Reflect.metadata("design:paramtypes",[void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(Ia=class{constructor(e){this.logger=void 0,this.handleMessageDelivered=e=>{var t;bt.default.log(["message delivered",null===(t=e.payload)||void 0===t?void 0:t.length])},this.logger=e.createZLogger("feat",["chat-box-list-controller"])}onStart(){i.ModuleContainer.resolve(_a.a).addEventListener(rr.MessageDelivered,this.handleMessageDelivered)}onDispose(){i.ModuleContainer.resolve(_a.a).removeEventListener(rr.MessageDelivered,this.handleMessageDelivered)}openConversation(e){return Promise.resolve(!0)}})||Ia)||Ia)||Ia)||Ia)||Ia)||Ia);var Ma,Ca=s("7nHs");const Ta={isShown:!1,modalTitle:"",guideTitle:"",errorCode:"",guideItems:[],showReloadBtn:!0,reloadBtnName:"STR_BU_CONFIRM_TEXT_4",showDeleteDataBtn:!0,deleteDataBtnName:"STR_BU_CANCEL_TEXT_4"};Object(Bt.b)(Ca.a)(Ma=class{constructor(){this.name=Ca.b,this.key="",this.state=Ta}setState(e){const t=Object(Dr.a)(this.state,e);this.state!==t&&(this.state=t,Object(st.g)(this.name,""))}showModal(e){this.state.isShown||this.setState((t=>Object(f.a)(Object(f.a)(Object(f.a)({},t),e),{},{isShown:!0})))}closeModal(){this.state.isShown&&this.setState((e=>Object(f.a)(Object(f.a)(Object(f.a)({},e),Ta),{},{isShown:!1})))}init(e){}getItem(e,t){return this.state}getList(e,t){return[]}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}});var Oa,Ea=s("Mf7h"),Sa=s("8c0e");const wa=new bt.LocalId;Object(i.injectable)()(Oa=Object(i.singleton)(Sa.a)(Oa=class{constructor(){this._linkPreviewDatas=new Map,this._lastCheckLinks=new Map,this._listeners=new Map}addListenerAtConv(e,t){if(e&&"function"==typeof t){const s=this._listeners.get(e);this._listeners.set(e,[...s||[],t])}}removeListenerAtConv(e,t){let s=this._listeners.get(e);s&&s.length>0&&(s=s.filter((e=>e!==t)),this._listeners.set(e,s))}removeAllListenerAtConv(e){this._listeners.delete(e)}setLastCheckLinkByConvId(e,t){this._lastCheckLinks.set(e,t)}isLastCheckLinkOfConv(e,t){const s=this._lastCheckLinks.get(e);return!!s&&s===t}getLinkPreviewDataByConvId(e){return this._linkPreviewDatas.get(e)||null}addLinkDataToConv(e,t){const s=this._prepareLinkPreviewData(e,t);this._linkPreviewDatas.set(e,Object(f.a)({},s));const i={action:_t.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(f.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,i),Ea.a.emit(_t.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(f.a)({},s)})}createLoadingLinkPreview(e,t){const s={id:wa.next(),convId:e,content:{title:Ye.default.str("STR_GETTING_LINK_INFO"),src:t,desc:"",thumb:"",loading:!0},link:t,shouldParseLinkOrContact:!0};e&&this._linkPreviewDatas.set(e,Object(f.a)({},s));const i={action:_t.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(f.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,i),Ea.a.emit(_t.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(f.a)({},s)})}removeLinkPreviewData(e){if(!e)return;this._linkPreviewDatas.delete(e);const t={action:_t.LinkPreviewActions.HIDE_LINK_PREVIEW,payload:null};this._notifyLinkPreviewDataChangeToConv(e,t),Ea.a.emit(_t.LinkPreviewActions.HIDE_LINK_PREVIEW,null)}_notifyLinkPreviewDataChangeToConv(e,t){const s=this._listeners.get(e);null==s||s.forEach((e=>{"function"==typeof e&&e({action:t.action,payload:t.payload})}))}_prepareLinkPreviewData(e,t){return{id:wa.next(),convId:e,link:t.link,content:t.content,shouldParseLinkOrContact:!1}}})||Oa);var La,Da=s("iy3m"),Fa=s("twqL");Object(V.h)()(La=Object(i.singleton)(Fa.a)(La=Reflect.metadata("design:type",Function)(La=Reflect.metadata("design:paramtypes",[])(La=class{constructor(){this.changeTimeFlushNotiReactWhenResumeApp=this.changeTimeFlushNotiReactWhenResumeApp.bind(this),this.changeTimeFlushNotiReactWhenDisNetwork=this.changeTimeFlushNotiReactWhenDisNetwork.bind(this),this.changeTimeFlushNotiReactWhenStartApp=this.changeTimeFlushNotiReactWhenStartApp.bind(this)}onStart(e){this.changeTimeFlushNotiReactWhenStartApp()}changeTimeFlushNotiReactWhenResumeApp(){this.changeTimeFlushNotiReact(Object(Da.d)())}setupTimer(e){qi.a.TimeFlushNotiReact=e,qi.a.TimeMaxWaiting=Object(Da.a)(),qi.a.setupIntervalToFlushNotiReact(),qi.a.setupTimeoutToGoBackNormalCondition()}changeTimeFlushNotiReactWhenDisNetwork(e){if(e===In.a.CONNECTED){const e=In.b.getPreStateNetwork();e!==In.a.CONNECTED&&e!==In.a.NOT_SET&&this.changeTimeFlushNotiReact(Object(Da.b)())}}changeTimeFlushNotiReactWhenStartApp(){this.changeTimeFlushNotiReact(Object(Da.e)())}changeTimeFlushNotiReact(e){qi.a.notiReactTimeoutId?(qi.a.TimeFlushNotiReact!==e&&(qi.a.TimeFlushNotiReact=e,qi.a.setupIntervalToFlushNotiReact()),qi.a.TimeMaxWaiting!==Object(Da.a)()&&(qi.a.TimeMaxWaiting=Object(Da.a)(),qi.a.setupTimeoutToGoBackNormalCondition())):this.setupTimer(e)}})||La)||La)||La);var Ra,Aa=s("K0f4"),Pa=s("buT3"),Na=s("wudS");Object(V.h)()(Ra=Object(V.e)()(Ra=class{onAuthenticated(e){const{userId:t}=e.getSession();if(t){const e=Object(Na.b)(t),s=`${e}_${Aa.m}`,i=Pa.a.getItem(s);if(!(null!==i))return;const n=97124,r="1"===i,a=`${e}_${Aa.g}`,o=+(Pa.a.getItem(a)||"-1"),d=isNaN(o)?-1:o,l=`${e}_${Aa.i}`,c=+(Pa.a.getItem(l)||"-1"),h=isNaN(c)?-1:c;if(r)k.default.increaseSuccess(n,0,d,[h]);else{const t=`${e}_${Aa.c}`,s=Pa.a.getItem(t),i=Number(s);k.default.increaseFailed(n,0,d,i,Date.now(),[h])}Pa.a.removeItem(s),Pa.a.removeItem(a),Pa.a.removeItem(l)}}onStart(){const e=Aa.l,t=Pa.a.getItem(e);if(!(null!==t))return;const s="1"===t,i=Aa.f,n=+(Pa.a.getItem(i)||"-1"),r=isNaN(n)?-1:n,a=Aa.h,o=+(Pa.a.getItem(a)||"-1"),d=isNaN(o)?-1:o;if(s)k.default.increaseSuccess(97123,0,r,[d]);else{const e=Pa.a.getItem(Aa.b),t=Number(e);k.default.increaseFailed(97123,0,r,t,Date.now(),[d])}Pa.a.removeItem(e),Pa.a.removeItem(i),Pa.a.removeItem(a)}})||Ra);var ja,Ua=s("l9L4"),Ba=s("CDcE");Object(V.d)()(ja=Object(i.injectable)()(ja=Object(i.singleton)(Ua.a)(ja=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,0)}(ja=Reflect.metadata("design:type",Function)(ja=Reflect.metadata("design:paramtypes",[void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(ja=class{constructor(e){this._isFirstLoginMap=new Map,this._firstLoginTimeMap=new Map,this._logger=void 0,this._logger=e.createZLogger("utils",["first-login-checker"])}getFirstLoginTime(e){if(this.firstLoginTimeMap.has(e))return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime();try{const t=T.a.getInstance().getItemForCurrentUser(L.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME);null!=t&&this.firstLoginTimeMap.set(e,parseInt(t))}catch(t){this.logger.zsymb(21,8183,3e4,"getFirstLoginTime error {} - {}",e,Object(Ba.f)(t,2))}return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime()}isFirstLogin(e){return!!this._isFirstLoginMap.get(e)}onApplicationReady(e){this.removeFirstLoginFlag()}setFirstLogin(e,t){this._isFirstLoginMap.set(e,t)}setFirstLoginTime(e,t){this.firstLoginTimeMap.set(e,t);try{T.a.getInstance().setItemForCurrentUser(L.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME,t&&t.toString()||"")}catch(s){this.logger.zsymb(21,8183,30001,"setFirstLoginTime error {} - {} - {}",e,t,Object(Ba.f)(s,2))}}removeFirstLoginFlag(){const e=Je.default.getUidMe(),t=T.a.getInstance();t.getItem(L.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)===e&&t.removeItem(L.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)}getDefaultFirstLoginTime(){return Mi.a.getTimeNow()}get firstLoginTimeMap(){return this._firstLoginTimeMap}get logger(){return this._logger}})||ja)||ja)||ja)||ja)||ja);const ka=Object(i.define)("transfer-data-suggestion-loader");var Ga=s("cgeJ"),xa=s("XVri"),za=s("bAqL");var Va=class{constructor(e){this._logger=void 0,this._moduleName=void 0,this._moduleName=e}log(){this.Logger.zsymb(0,8218,3e4,this.moduleTagName,...arguments)}logError(e,t){const s=null==t?"":this.stringifyDepthLevel(t);this.Logger.zsymb(18,8218,30001,this.moduleTagName,e,s)}stringifyDepthLevel(e){return Object(za.g)(e,Object(za.c)())}get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger("msg-sync",[xa.a])),this._logger}get moduleTagName(){return this._moduleName+" - "}};var $a,Wa=class{constructor(e){this.moduleName=e,this._logger=void 0,this._logger=new Va(this.moduleName)}get Logger(){return this._logger}};function qa(e){try{return JSON.stringify(e)}catch(t){return""}}function Ka(e){return JSON.parse(e)}Object(i.injectable)()($a=Object(i.singleton)(ka)($a=Reflect.metadata("design:type",Function)($a=Reflect.metadata("design:paramtypes",[])($a=class extends Wa{constructor(){super(Ga.d.LOADER),this._friendManager=void 0,this._groupManager=void 0}async loadLastCloseBannerDownloadPC(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load last close banner download pc failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(Ga.b);return null!=t?Ka(t):(this.Logger.logError("Load last close banner download pc failed null"),null)}catch(t){return this.Logger.logError("Load last close banner download pc failed",t),t}}async loadListConversationsFromDB(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load list conversations from DB failed cause invalid storage"),Promise.reject([]);try{const t=await e.getItemForCurrentUserAsync(Ga.c);return null!=t?Ka(t):(this.Logger.logError("Load list conversations from DB failed null"),[])}catch(t){return this.Logger.logError("Load list conversations from DB failed",t),[]}}async loadListFriends(){const e=this.getFriendManagerModule();if(e)try{return await e.getFriends()}catch(t){return this.Logger.logError("Load list friends failed",t),[]}return this.Logger.log("Load list friends empty"),[]}async loadListGroups(){const e=this.getGroupManagerModule();if(e)try{return await e.getGroupsList()}catch(t){return this.Logger.logError("Load list groups failed",t),[]}return this.Logger.log("Load list groups empty"),[]}async loadRegisteredData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load registered data failed cause invalid storage"),Promise.reject();try{let t=e.getItemForCurrentUser(L.RegisterLocalStorageKeys.IS_REGISTERED_ON_THIS_DEVICE);return null!=t?{isRegisteredOnThisDevice:Ka(t)}:(this.Logger.log("Load registered data null"),null)}catch(t){return this.Logger.logError("Load registered data failed",t),t}}async loadSyncMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load sync messages data failed cause invalid storage"),Promise.reject();try{const t=e.getItemForCurrentUser("sync_cross_settings");return t?Ka(t):(this.Logger.log("Load sync messages data null"),null)}catch(t){return this.Logger.logError("Load sync messages data failed",t),t}}async loadTransferMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load transfer messages data failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(Ga.k);return t?Ka(t):(this.Logger.logError("Load transfer messages data failed null"),null)}catch(t){return this.Logger.logError("Load transfer messages data failed",t),t}}async setLastCloseBannerDownloadPC(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Ga.b,qa(e)):Promise.reject("Invalid storage")}async setListConversationsFirstLoginToDB(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Ga.c,qa(e)):Promise.reject("Invalid storage")}async updateTransferMessagesData(e){const t={lastTransferSuccessTime:e.lastTransferSuccessTime||Date.now()};try{return await this.getSecureLocalStorageDB().setItemForCurrentUserAsync(Ga.k,qa(t))}catch(s){return s}}getFriendManagerModule(){var e;this._friendManager||(this._friendManager=null===(e=s("UiPd"))||void 0===e?void 0:e.default);return this._friendManager}getGroupManagerModule(){var e;this._groupManager||(this._groupManager=null===(e=s("Gm1y"))||void 0===e?void 0:e.default);return this._groupManager}getSecureLocalStorageDB(){return T.a.getInstance()}})||$a)||$a)||$a);var Ha=s("n09q"),Qa=s("31cx"),Ja=s("a1r1"),Za=s("BO4k");var Xa,Ya=class extends Wa{constructor(e,t){super(xa.c.MANAGER),this._eventMap=new Map,this._fistLoginTime=void 0,this._listConversationsBeforeLogin=[],this._moduleLoader=void 0,this._moduleUIManager=void 0,this._moduleLoader=e,this._moduleUIManager=t,this.handleUpdateConfigs=this.handleUpdateConfigs.bind(this),this.isDisplayedBannerDownloadPCSuggestion=this.isDisplayedBannerDownloadPCSuggestion.bind(this),this.isDisplayedBubbleInfoEcard=this.isDisplayedBubbleInfoEcard.bind(this),this.isDisplayedCloseButtonBannerDownloadPC=this.isDisplayedCloseButtonBannerDownloadPC.bind(this),this.isDisplayedConversationFooter=this.isDisplayedConversationFooter.bind(this),this.isDisplayedGlobalSearchFooter=this.isDisplayedGlobalSearchFooter.bind(this),this.isDisplayedSearchInConversationFooter=this.isDisplayedSearchInConversationFooter.bind(this),this.isDisplayedMilestoneInPreviewMedia=this.isDisplayedMilestoneInPreviewMedia.bind(this),this.isDisplayedSuggestionInMediaList=this.isDisplayedSuggestionInMediaList.bind(this),this.isDisplayedTransferModal=this.isDisplayedTransferModal.bind(this),this.isValidForTransferMessages=this.isValidForTransferMessages.bind(this)}addEventListeners(e,t){this.eventMap.set(e,[...this.eventMap.get(e)||[],t])}callTransferMessages(e){}closeBannerDownloadPCSuggestion(){}getConversationFooterRendererHeight(){return this.isDisplayedConversationFooter()?xa.b.CONVERSATION:0}getFirstLoginTime(){return this.firstLoginTime}getGlobalSearchFooterRendererHeight(){return this.isDisplayedConversationFooter()?xa.b.GLOBAL_SEARCH:0}getLogger(){return this.Logger}getUrlDownloadPC(){return""}hasConversationBeforeFirstLogin(e){return this._listConversationsBeforeLogin.includes(e)}hideTransferMessagesModal(){}async initialize(){this.firstLoginTime=i.ModuleContainer.resolve(Ja.a).getFirstLoginTime(this.getUserId()),this.handleUpdateConfigs(Za.a()),this.registerSubscriptions(),await this.initializeListConversationsBeforeFirstLogin()}isDisplayedBannerDownloadPCSuggestion(){return!!this.isEnabledFeature()&&Za.g()}isDisplayedBubbleInfoEcard(e){return!!this.isEnabledFeature()&&(!!Za.h()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedCloseButtonBannerDownloadPC(){return!!this.isEnabledFeature()&&Za.k()}isDisplayedConversationFooter(){return!!this.isEnabledFeature()&&Za.l()}isDisplayedCTADownloadPC(){return!!this.isEnabledFeature()&&Za.i()}isDisplayedCTATransferMessages(){return!!this.isEnabledFeature()&&Za.j()}isDisplayedGlobalSearchFooter(){return!!this.isEnabledFeature()&&Za.m()}isDisplayedSearchInConversationFooter(e){return!!this.isEnabledFeature()&&(!!Za.p()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedMilestoneInPreviewMedia(e){return!!this.isEnabledFeature()&&(!!Za.o()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedSuggestionInMediaList(e){return!!this.isEnabledFeature()&&(!!Za.n()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedTransferModal(){return!!this.isEnabledFeature()&&Za.q()}isEnabledFeature(){return Za.r()}isValidSupportDownloadPC(){return!1}isValidForTransferMessages(){return this.isEnabledFeature()}needTransferMessages(){}removeEventListeners(e,t){const s=this.eventMap.get(e);if(Array.isArray(s)){const e=s.findIndex((e=>e===t));-1!==e&&s.splice(e,1)}}setFirstLoginTime(e){this.firstLoginTime=e}shouldTransferMessages(){return!1}showTransferMessagesModal(){}registerSubscriptions(){pt.$AppConfig.subscribe(this.handleUpdateConfigs)}isFirstLogin(){return i.ModuleContainer.resolve(Ja.a).isFirstLogin(this.getUserId())}async initializeListConversationsBeforeFirstLogin(){this._listConversationsBeforeLogin=await this.loadListConversationsBeforeFirstLogin()}handleUpdateConfigs(e){void 0===e&&(e={});const{data_content:t}=Za.b(e),{first_time_login_device:s}=e;t&&this.UIManager.updateDataContent(Object(Qa.a)(t)),null!=s&&(this.firstLoginTime=s)}async loadListConversations(){const e=[],t=await this.loaderModule.loadListFriends();Array.isArray(t)&&t.forEach((t=>{e.push(t.userId)}));const s=await this.loaderModule.loadListGroups();return Array.isArray(s)&&s.forEach((t=>{e.push(t.userId)})),e}async loadListConversationsBeforeFirstLogin(){let e;if(this.isFirstLogin())e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e);else{const t=await this.loaderModule.loadListConversationsFromDB();e=t,(t||[]).length||(e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e))}return e}notifyEvent(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];const n=this.eventMap.get(e);Array.isArray(n)&&n.forEach((e=>Promise.resolve((()=>e(...s)))))}get firstLoginTime(){return this._fistLoginTime}set firstLoginTime(e){this._fistLoginTime=e}get eventMap(){return this._eventMap}get loaderModule(){return this._moduleLoader}get UIManager(){return this._moduleUIManager}getUserId(){const e=i.ModuleContainer.resolve(V.a),{userId:t}=e.getSession()||{};return t||""}},eo=s("mgoj"),to=s("JCvM");Object(i.injectable)()(Xa=Object(V.d)()(Xa=Object(i.singleton)(Ha.a)(Xa=function(e,t){return Object(i.inject)(ka)(e,void 0,0)}(Xa=function(e,t){return Object(i.inject)(eo.a)(e,void 0,1)}(Xa=Reflect.metadata("design:type",Function)(Xa=Reflect.metadata("design:paramtypes",[Object,void 0===to.ITransferDataSuggestionUIManager?Object:to.ITransferDataSuggestionUIManager])(Xa=class extends Ya{constructor(e,t){super(e,t),this._lastCloseBannerTimestamp=0,this.handleBeforeUnload=this.handleBeforeUnload.bind(this)}closeBannerDownloadPCSuggestion(){const e=Mi.a.getTimeNow();this.lastCloseBannerTimestamp=e,this.UIManager.closeBannerDownloadPCSuggestion(),this.loaderModule.setLastCloseBannerDownloadPC(e)}getUrlDownloadPC(){return Object(Za.f)()}async initialize(){await super.initialize(),await this.loadLastCloseBannerTimestamp()}isDisplayedBannerDownloadPCSuggestion(){if(!super.isDisplayedBannerDownloadPCSuggestion())return!1;if(!this.isValidSupportDownloadPC())return!1;const e=Object(Za.e)();return this.lastCloseBannerTimestamp+e<=Mi.a.getTimeNow()}isValidSupportDownloadPC(){const e=Object(za.d)().toLowerCase();return null!=Object(Za.d)().find((t=>e.indexOf(t)>-1))}isValidForTransferMessages(){return!1}onApplicationReady(e){this.isDisplayedBannerDownloadPCSuggestion()&&za.a.logAction(za.a.BannerDownloadPC.DISPLAYED),this.isEnabledFeature()&&za.a.logAction(za.a.Common.DISPLAYED_NOT_ENOUGH_DATA_MESSAGE)}handleBeforeUnload(){this.logActionBeforeUnload()}async loadLastCloseBannerTimestamp(){try{const e=await this.loaderModule.loadLastCloseBannerDownloadPC();e&&(this.lastCloseBannerTimestamp=e)}catch(e){}}logActionBeforeUnload(){const e=Object(za.b)();za.a.logActionInfo(e,!0)}registerSubscriptions(){super.registerSubscriptions(),i.ModuleContainer.resolve(V.a).addEventListenerOnce(V.b.BeforeUnload,this.handleBeforeUnload)}get lastCloseBannerTimestamp(){return this._lastCloseBannerTimestamp}set lastCloseBannerTimestamp(e){this._lastCloseBannerTimestamp=e}})||Xa)||Xa)||Xa)||Xa)||Xa)||Xa);var so,io=class extends Wa{constructor(){super(xa.c.UI),this.key=to.c,this.name=to.c,this.dataState=Object(f.a)({},xa.f),this.UIState=Object(f.a)({},xa.g)}closeBannerDownloadPCSuggestion(){}hideTransferMessagesModal(){}init(e){}initialize(){const{data_content:e}=Object(Za.b)(Object(Za.a)());this.handleUpdateContent(e)}getItem(e,t){return e.key===xa.e?this.dataState:e.key===xa.h?this.UIState:{}}getList(e,t){return[]}turnOffDisplayingEntryPoints(){this.handleUpdateRenderer({isDisplayedEntryPoints:!1})}onGetItemFailure(e,t){}onGetListFailure(e,t){}showTransferMessagesModal(){}updateDataContent(e){this.handleUpdateContent(e)}setDataState(e){const t=Object(Dr.a)(this.dataState,e);this.dataState!==t&&(this.dataState=t,Object(st.g)(this.name,xa.e))}setUIState(e){const t=Object(Dr.a)(this.UIState,e);this.UIState!==t&&(this.UIState=t,Object(st.g)(this.name,xa.h))}handleUpdateContent(e){this.setDataState((t=>{t.version=e.version,t.content=e.content}))}handleUpdateRenderer(e){this.setUIState((t=>{for(const s in e)t[s]=e[s]}))}};Object(Bt.b)(to.b)(so=class extends io{closeBannerDownloadPCSuggestion(){this.setUIState((e=>{e[Ga.j.BANNER_DOWNLOAD].isDisplayed=!1}))}getItem(e,t){const s=super.getItem(e,t);if(!s)return;let i={};if(e.key===Ga.f){const{content:e={}}=s;for(const t in e){const s=e[t];if(s)for(const e in s){var n;i[t]||(i[t]={}),i[t][e]=null===(n=s[e])||void 0===n?void 0:n.web}}}else i=s;return i}});var no=Object(i.define)("forward-message"),ro=s("oAAg");ro.Pool;var ao,oo,lo,co,ho,uo=Object(i.define)("forward-message-pool");ao=Object(i.singleton)(no),oo=function(e,t){return Object(i.inject)(uo)(e,void 0,0)},lo=Reflect.metadata("design:type",Function),co=Reflect.metadata("design:paramtypes",[Object]),Object(i.injectable)(ho=ao(ho=oo(ho=lo(ho=co(ho=class{constructor(e){this._pool=void 0,this.pool=e}forward(e,t){const s=this.buildTask();this.pool.use(s)}buildTask(){return async()=>{}}get pool(){return this._pool}set pool(e){this._pool=e}})||ho)||ho)||ho)||ho);var go=Object(i.define)("pin-topic-message-loader");var mo=Object(i.define)("pin-topic-storage"),po=mo,fo=s("UIHX"),vo=s("0URt"),bo=s("DRpF");function yo(e){return!(-1===Object(vo.g)().indexOf(e.msgType))&&!Object(bo.a)(e)}var Io=s("3ZdV");var _o=s("YYsv");function Mo(e,t,s){return s===e?1:s<t?0:-1}function Co(e){const t={needFetch:!1,reason:""};if(null==e||null==e||!e.lastFetch)return t.needFetch=!0,t.reason="empty",t;const{lastFetch:s}=e,i=function(e){return Ur.a.isOverflowAtTime(e)}(s);if(i)return t.needFetch=!0,t.reason="overflow",t;const n=function(e){return Date.now()-e>Object(Io.e)()}(s);if(n)return t.needFetch=!0,t.reason="expired",t;const r=function(e){const t=T.a.getInstance().getItemForCurrentUser(_o.g.FORCE_FETCH_MILESTONE);return!(!t||isNaN(+t))&&e<+t}(s);return r?(t.needFetch=!0,t.reason="forcedByServer",t):t}function To(e){const t=[];return e.forEach((e=>{t.push({topicId:e.id,topicType:e.type})})),t}function Oo(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.client_msg_id)||""}function Eo(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.global_msg_id)||""}function So(e,t,s){let i=t;const{topics:n}=s;if(!Array.isArray(n))return i;switch(e){case fo.a.ADD:{const{index:e}=s;i=null==e?[...n,...t]:[...t.slice(0,e),...n,...t.slice(e)];break}case fo.a.REMOVE:{const e={};n.forEach((t=>{e[t.id]=t.type})),i=[],t.forEach((t=>{(!e.hasOwnProperty(t.id)||e.hasOwnProperty(t.id)&&e[t.id]!==t.type)&&i.push(t)}));break}}return i}function wo(e){const t=e=>{if(!Array.isArray(e))return e;const t=[];for(let s=0;s<e.length;s++){const i=e[s];i&&(null!=i.id&&(i.id=i.id.toString()),null!=i.topicId&&(i.topicId=i.topicId.toString()),null!=i.type&&(i.type=parseInt(i.type)),null!=i.topicType&&(i.topicType=parseInt(i.topicType)),t.push(i))}return t},s=Object(f.a)({},e);return null!=s.oldTopic&&(s.oldTopic=t([s.oldTopic])[0]),null!=s.topic&&(s.topic=t([s.topic])[0]),null!=s.topics&&(s.topics=t(s.topics)),s}function Lo(e){let t={};if(!e.params)return e;try{t=JSON.parse(e.params)}catch(s){return}if(t.extra&&t.extra.constructor===String)try{t.extra=JSON.parse(t.extra)}catch(s){return}return e.params=t,e}var Do,Fo=function(){const e={};return{clear:()=>{for(const t in e)delete e[t]},get:t=>e[t],getCache:()=>e,set:(t,s)=>{e[t]=s},has:t=>e.hasOwnProperty(t),remove:t=>{delete e[t]}}};var Ro=Object(i.injectable)()(Do=function(e,t){return Object(i.inject)(po)(e,void 0,0)}(Do=Reflect.metadata("design:type",Function)(Do=Reflect.metadata("design:paramtypes",[Object])(Do=class{constructor(e){this.storage=e,this.clientMsgCache=void 0,this.globalMsgCache=void 0,this.globalMsgCache=Fo(),this.clientMsgCache=Fo()}clear(e){switch(e){case fo.g.GLOBAL:return void this.globalMsgCache.clear();case fo.g.CLIENT:return void this.clientMsgCache.clear();default:return this.globalMsgCache.clear(),void this.clientMsgCache.clear()}}loadMessages(e){return new Promise(((t,s)=>{e&&0!==e.length||s("Invalid topics");const i=e.length;for(let n=0;n<i;n++){const t=e[n];if(!t)continue;let i=Eo(t);if(i&&"0"!==i)this.getMessage(fo.g.GLOBAL,i).then().catch((e=>{s(e)}));else{let e=Oo(t);if(e){let i=t.params&&t.params.senderUid;this.getMessage(fo.g.CLIENT,e,{userId:i}).then().catch((e=>{s(e)}))}}}t()}))}getMessageFromTopic(e){if(e.type!==fo.i.MESSAGE||!e.params)return{};let t=Eo(e);if(this.globalMsgCache&&this.globalMsgCache.has(t))return this.globalMsgCache.get(t)||{};let s=Oo(e);return this.clientMsgCache&&this.clientMsgCache.has(s)&&this.clientMsgCache.get(s)||{}}removeMessages(e){Array.isArray(e)&&e.forEach((e=>{const t=Eo(e),s=Oo(e);this.globalMsgCache.remove(t),this.clientMsgCache.remove(s)}))}getMessage(e,t,s){void 0===s&&(s={});return new Promise(((i,n)=>{switch(e){case fo.g.GLOBAL:{let s=this.globalMsgCache.get(t);s?i(s):this.storage.getMessagesByIds([t]).then((s=>{s?(this.setMessage(e,t,s),i(s)):n("Not found")})).catch((e=>{n(e)}));break}case fo.g.CLIENT:{const{userId:r}=s;let a=this.clientMsgCache.get(t);a?i(a):this.storage.getMessageByCliMsgId(t,{myUID:Je.default.getUidMe(),userId:r}).then((s=>{s?(this.setMessage(e,t,s),i(s)):n("Not found")})).catch((e=>{n(e)}));break}default:n("Unknown")}}))}setMessage(e,t,s){switch(e){case fo.g.GLOBAL:return void this.globalMsgCache.set(t,s);case fo.g.CLIENT:return void this.clientMsgCache.set(t,s);default:return}}})||Do)||Do)||Do)||Do;i.ModuleContainer.register(go,Ro);var Ao=Object(i.define)("pin-topic-data-repository"),Po=s("ZsEe");var No=function(){const e={},t=t=>e[t]||null;return{clear:()=>{for(const t in e)delete e[t]},get:t,getAll:()=>e,getLastFetch:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastFetch)||0},getLastModified:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastModified)||0},getTopics:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.topics)||[]},getVersion:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.version)||0},has:t=>!!e[t],remove:t=>{delete e[t]},set:(t,s)=>{e[t]=s}}};var jo=function(e){const t=[];let s=!1;const i=e||(()=>{}),n=()=>t.length,r=e=>{s=e},a=()=>{if(s)return;if(!n())return void i();const e=t.shift();e&&(r(!0),e().then((()=>{r(!1),a()})).catch((()=>{r(!1),a()})))};return{enqueue:e=>{t.push(e),a()},dequeue:a,getLength:n}};var Uo=function(){const e=[];let t;const s=()=>e.length,i=(n,r)=>{if(r&&(t=r),!s())return t&&t(n);const a=e.shift();a&&((e,t)=>{const{callback:s}=e;let n;"function"==typeof s&&(n=s(e.data,t)),i(n)})(a,n)};return{enqueue:t=>{e.push(t)},dequeue:i,getLength:s}},Bo=s("u+F0");var ko=Object(i.define)("pin-topic-request-handler");function Go(e){return new Promise((t=>{let s=0,i=0,n={};for(let r in e)s++,e[r].then((e=>{n[r]=e,i++,i===s&&t(n)})).catch((()=>{n[r]=null,i++,i===s&&t(n)}));0===s&&t({})}))}function xo(e,t){return Object(Ba.f)(e,Number.isInteger(+t)?t:1/0)}var zo,Vo=class{constructor(e,t){this.moduleName=e,this.instanceNames=t,this.instanceMap=new Map}error(e){const t=this.getLogger(e);if(void 0!==t){for(var s=arguments.length,i=new Array(s>1?s-1:0),n=1;n<s;n++)i[n-1]=arguments[n];t.zsymb(18,9938,3e4,...i)}}info(e){const t=this.getLogger(e);if(void 0!==t){for(var s=arguments.length,i=new Array(s>1?s-1:0),n=1;n<s;n++)i[n-1]=arguments[n];t.zsymb(0,9938,30001,...i)}}getLogger(e){if(this.instanceNames.includes(e)&&void 0===this.instanceMap.get(e)){const t=this.LoggerFactory.createZLogger(ns.b.pinTopic,[this.moduleName,e]);this.instanceMap.set(e,t)}return this.instanceMap.get(e)}get LoggerFactory(){return i.ModuleContainer.resolve(H.ZLoggerFactory)}},$o=Vo;!function(e){e.CONTROL="control",e.CREATE="create",e.FETCH="fetch",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin"}(zo||(zo={}));var Wo,qo=class extends $o{constructor(){super(fo.f.DataRepository,[zo.CONTROL,zo.CREATE,zo.FETCH,zo.LOAD,zo.REORDER,zo.UNPIN])}infoControl(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(zo.CONTROL,...t)}infoCreate(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(zo.CREATE,...t)}infoFetch(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(zo.FETCH,...t)}infoLoad(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(zo.LOAD,...t)}infoReorder(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(zo.REORDER,...t)}infoUnpin(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(zo.UNPIN,...t)}errorControl(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(zo.CONTROL,...t)}errorCreate(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(zo.CREATE,...t)}errorFetch(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(zo.FETCH,...t)}errorLoad(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(zo.LOAD,...t)}errorReorder(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(zo.REORDER,...t)}errorUnpin(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(zo.UNPIN,...t)}logInfo(e){if(this.isEnableLog()){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];super.info(e,...s)}}logError(e){if(this.isEnableLog()){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];super.error(e,...s)}}isEnableLog(){return Object(Io.h)()}};var Ko=Object(i.injectable)()(Wo=function(e,t){return Object(i.inject)(po)(e,void 0,0)}(Wo=function(e,t){return Object(i.inject)(ko)(e,void 0,1)}(Wo=Reflect.metadata("design:type",Function)(Wo=Reflect.metadata("design:paramtypes",[Object,Object])(Wo=class{constructor(e,t){this.storage=e,this.fetcher=t,this.cache=void 0,this.eventQueue=void 0,this.logger=void 0,this.pendingWhenLoadQueue=void 0,this.requestID=void 0,this.cache=No(),this.eventQueue={},this.pendingWhenLoadQueue={},this.logger=new qo,this.requestID=new Po.a}clear(){this.cache.clear();for(const e in this.pendingWhenLoadQueue)delete this.pendingWhenLoadQueue[e];for(const e in this.eventQueue)delete this.eventQueue[e]}clearPinTopicsForConversation(e,t){void 0===t&&(t=!1),this.cache.remove(e),delete this.pendingWhenLoadQueue[e],delete this.eventQueue[e],this.Storage.clearTopics(e,t)}createPinTopic(e,t,s){void 0===s&&(s={});return new Promise(((i,n)=>{const r=this.getRequestID();this.Logger.infoCreate(r,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((a=>{const{checkEnableToCreate:o}=s||{};let d=null;if(o){const{enable:s,oldTopic:i}=o(e,t,a);if(!s)return this.Logger.infoCreate(r,`cId:${e} react limit`),n({code:Bo.a.PINBOARD_OVER_MAXIMUM,message:"",data:{cache:a}});i&&(d=i)}const{version:l}=a;this.Logger.infoCreate(r,`cId:${e}`,l),this.Fetcher.createTopic(e,t,l).then((t=>{this.Logger.infoCreate(r,`cId:${e}, create topic success`);let s=t.response.data;s.oldVersion=l,d&&(s.oldTopic={topicId:d.id,topicType:d.type}),s=wo(s),this.enqueueEvent(e,this.addTopic.bind(this,e,s,(e=>i(e))))})).catch((t=>{const s=t.error;s.data=Object(f.a)(Object(f.a)({},null==s?void 0:s.data),{},{cache:a}),this.Logger.errorCreate(r,`cId:${e}, create topic fail`,xo(t,Object(Io.b)())),n(s)}))}))}))}getEntryPointPromotionalTooltipShowedStatus(){return this.Storage.getEntryPointPromotionalTooltipShowedStatus()}handleReceivingEvent(e,t){return new Promise(((s,i)=>{if(this.Logger.infoControl(`call ${e}`,xo(t,Object(Io.b)())),e===fo.c.FORCE_SYNC){const{conversationIds:e}=t;if(!Array.isArray(e))return i("Invalid conversationIds for force all");if(0===e.length)this.Storage.setForcedFetchMilestone(Date.now());else for(let t=0;t<e.length;t++){var n;const r=null===(n=e[t])||void 0===n?void 0:n.toString();r&&(this.clearPinTopicsForConversation(r),this.fetchTopics(r).then((e=>{s(e)})).catch(i))}}else{const{conversationId:n}=t;this.loadDataFromCacheOrDB(n).then((n=>{this.processEventControl(e,t,n,s,i)}))}}))}loadPinTopics(e,t){return new Promise(((s,i)=>{e||i({status:fo.h.ERROR,error:{code:Bo.a.INVALID_PARAMETERS,message:"ConversationId not valid"}});const n=this.getRequestID();if(this.Logger.infoLoad(n,`call cId:${e}`),t&&t!==fo.d.NONE)return this.Logger.infoLoad(n,`force fetch cId:${e}`,t),this.fetchTopics(e).then((e=>{s(e)}));this.loadDataFromCacheOrDB(e).then((r=>{if(this.Logger.infoLoad(n,`cId:${e}`),t===fo.d.NONE)return s(r);this.doCheckAndFetchData(r).then((e=>{s(e)})).catch(i)}))}))}reorderPinTopics(e,t){return new Promise(((s,i)=>{const n=this.getRequestID();this.Logger.infoReorder(n,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((r=>{const{version:a}=r,o=To(t);this.Logger.infoReorder(n,`cId:${e}`,a),this.Fetcher.reorderTopics(e,o,a).then((i=>{this.Logger.infoReorder(n,`cId:${e}, reorder topic success`);let r=i.response.data;r.oldVersion=a,r.topics=t,r=wo(r),this.enqueueEvent(e,this.setTopics.bind(this,e,r,(e=>s(e))))})).catch((t=>{this.Logger.errorReorder(n,`cId:${e}, reorder topic fail`,xo(t,Object(Io.b)())),i(t.error)}))}))}))}setEntryPointPromotionalTooltipShowedStatus(e){this.Storage.setEntryPointPromotionalTooltipShowedStatus(e)}unpinTopics(e,t){return new Promise(((s,i)=>{const n=this.getRequestID();this.Logger.infoUnpin(n,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((r=>{const{version:a}=r,o=To(t);this.Logger.infoUnpin(n,`cId:${e}`,a),this.Fetcher.unpinTopics(e,o,a).then((i=>{this.Logger.infoUnpin(n,`cId:${e} unpin topic success`);let r=i.response.data;r.oldVersion=a,r.topics=t,r=wo(r),this.enqueueEvent(e,this.removeTopics.bind(this,e,r,(e=>s(e))))})).catch((t=>{this.Logger.errorUnpin(n,`cId:${e}, unpin topic fail`,xo(t,Object(Io.b)())),i(t.error)}))}))}))}setPendingQueue(e,t){t&&!this.pendingWhenLoadQueue[e]?this.pendingWhenLoadQueue[e]=Uo():delete this.pendingWhenLoadQueue[e]}isInPending(e){return!!this.pendingWhenLoadQueue[e]}openPendingQueue(e){this.setPendingQueue(e,!0)}closePendingQueue(e){this.setPendingQueue(e,!1)}enqueuePending(e,t){this.pendingWhenLoadQueue[e]&&this.pendingWhenLoadQueue[e].enqueue(t)}loadTopicsFromDB(e){this.openPendingQueue(e);return new Promise((t=>{const s=this.getRequestID();this.Logger.infoLoad(s,`DB call cId:${e}`),this.Storage.loadTopics(e).then((i=>{const n=this.handleLoadDBFinish(e,i);this.Logger.infoLoad(s,`DB cId:${e} success`),t({status:fo.h.SUCCESS,response:{data:n}})})).catch((i=>{const n=this.handleLoadDBFinish(e,null);this.Logger.errorLoad(s,`DB cId:${e} fail`,xo(null==i?void 0:i.error,Object(Io.b)())),t({status:fo.h.ERROR,response:{data:n}})}))}))}getRequestID(){return this.requestID.next()}handleLoadDBFinish(e,t){var s;let i;var n;t&&(i={conversationId:(n=t).conversationId,topics:n.topics,version:n.boardVersion,lastFetch:n.lastFetch,lastModified:Date.now()}),t&&(null===(s=i)||void 0===s?void 0:s.conversationId)===e||(i=function(e){return{conversationId:e,topics:[],version:0,lastFetch:0,lastModified:0}}(e));let r=i;if(!Co(r).needFetch&&this.isInPending(e)){const t=e=>{e&&(r=e)};this.pendingWhenLoadQueue[e].dequeue(i,t)}return this.closePendingQueue(e),r}fetchTopics(e,t){void 0===t&&(t=0),this.openPendingQueue(e);return new Promise(((s,i)=>{const n=this.getRequestID();this.Logger.infoFetch(n,`call cId:${e}`,t),this.Fetcher.fetchTopics(e,t).then((t=>{this.Logger.infoFetch(n,`cId:${e} success`),this.closePendingQueue(e);const{response:i}=t,r=i.data.topics;for(let e=0;e<r.length;e++)r[e]=Lo(r[e]);this.loadExtraDataForTopics(r).then((t=>{const n={conversationId:e,topics:t,version:i.data.version,lastFetch:Date.now(),lastModified:Date.now()};this.setToCache(e,n),this.setTopicsToDB(n),s(n)}))})).catch((t=>{this.Logger.errorFetch(n,`cId:${e} fail`,xo(t,Object(Io.b)())),this.closePendingQueue(e)}))}))}doCheckAndFetchData(e){return new Promise(((t,s)=>{const i=Co(e);if(this.Logger.infoFetch(`cId:${e.conversationId} needFetch:${i.needFetch} reason:${i.reason}`),!i.needFetch)return t(e);this.fetchTopics(e.conversationId).then((s=>{t(s||e)})).catch(s)}))}getDataInPendingQueueAfterMutation(e,t){if(e.conversationId!==t.conversationId)return t;if(e.oldVersion!=t.version)return t;return{topics:So(e.type,t.topics,{index:e.index,topics:e.topics}),version:e.version,conversationId:e.conversationId,lastModified:Date.now(),lastFetch:t.lastFetch}}setToCache(e,t){return null==t.lastModified&&(t.lastModified=Date.now()),this.cache.set(e,t),t}addToCache(e,t,s){void 0===s&&(s=0);const i=this.getCache(e),{topic:n,version:r}=t;let a=Date.now(),o=[];i?(o=So(fo.a.ADD,i.topics,{topics:[n],index:s}),a=i.lastFetch):o.push(n),t.lastFetch&&(a=t.lastFetch);const d={conversationId:e,topics:o,version:r,lastModified:Date.now(),lastFetch:a};return this.setToCache(e,d)}removeInCache(e,t,s){if(void 0===s&&(s=0),!this.cache.has(e))return null;const i=this.getCache(e),{topics:n}=i;if(t.topic)for(let a=0;a<n.length;a++){const e=n[a];if(e.id===t.topic.id&&e.type===t.topic.type){n.splice(a,1);break}}else n.splice(s,1);const r={conversationId:e,topics:n,version:t.version,lastModified:Date.now(),lastFetch:i.lastFetch};return this.setToCache(e,r)}enqueueEvent(e,t){if(!this.eventQueue[e]){const t=()=>{delete this.eventQueue[e]};this.eventQueue[e]=jo(t)}this.eventQueue[e].enqueue(t)}addTopic(e,t,s){return new Promise(((i,n)=>{if(this.isInPending(e)){const s={data:{type:fo.a.ADD,conversationId:e,oldTopic:t.oldTopic,topics:[t.topic],version:t.version,oldVersion:t.oldVersion,index:t.index},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const r=n=>{const{oldVersion:r,version:a}=t,o=Mo(r,a,n.version);if(this.Logger.infoCreate(`add call cId:${e} actCode:${o}`,r,a,n.version),1===o){const{oldTopic:n,index:r,topic:o}=t;n&&n.topicId&&this.removeInCache(e,{topic:{id:n.topicId,type:n.topicType},version:a}),Lo(o),this.loadExtraDataForTopics([o]).then((n=>{const a={topic:n[0],version:t.version},o=this.addToCache(e,a,r);this.setTopicsToDB(o),i(),s&&s(this.getCache(e))})).catch((()=>{i()}))}else 0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{r(e)}))}))}removeTopics(e,t,s){return new Promise((i=>{if(this.isInPending(e)){const s={data:{type:fo.a.REMOVE,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const n=n=>{const{oldVersion:r,version:a}=t,o=Mo(r,a,n.version);if(this.Logger.infoUnpin(`remove call cId:${e} actCode:${o}`,r,a,n.version),1===o){const{topics:r}=t;let o=n;for(let t=0;t<r.length;t++)o=this.removeInCache(e,{topic:r[t],version:a});return this.setTopicsToDB(o),s&&s(this.getCache(e)),i()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{n(e)}))}))}setTopics(e,t,s){return new Promise((i=>{if(this.isInPending(e)){const s={data:{type:fo.a.REORDER,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const n=n=>{const{oldVersion:r,version:a}=t,o=Mo(r,a,n.version);if(this.Logger.infoReorder(`set call cId:${e} actCode:${o}`,r,a,n.version),1===o){const r=n.topics,a=[];for(let e=0;e<t.topics.length;e++){const s=t.topics[e],i=r.find((e=>e.id===s.id&&e.type===s.type));i&&a.push(i)}const o={conversationId:e,topics:a,version:t.version,lastModified:Date.now(),lastFetch:(null==n?void 0:n.lastFetch)||0};return this.setToCache(e,o),this.setTopicsToDB(o),s&&s(this.getCache(e)),i()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{n(e)}))}))}loadDataFromCacheOrDB(e){return new Promise((t=>{const s=this.getCache(e);s?t(s):this.loadTopicsFromDB(e).then((s=>{const i=s.response.data;this.setToCache(e,i),t(i)}))}))}setTopicsToDB(e){return new Promise(((t,s)=>{const i={conversationId:e.conversationId,boardVersion:e.version,topics:e.topics,lastFetch:e.lastFetch};this.Storage.setTopics(i).then(t).catch(s)}))}processEventControl(e,t,s,i,n){const{conversationId:r}=t;let a={oldVersion:t.oldVersion,version:t.version};const o=wo(t);switch(e){case fo.c.CREATE:a=Object(f.a)(Object(f.a)({},a),{},{oldTopic:o.oldTopic,topic:o.topic,index:0}),this.enqueueEvent(r,this.addTopic.bind(this,r,a,(e=>i(e))));break;case fo.c.UNPIN:{const e=o.topic,t=[];e&&null!=e.topicId&&null!=e.topicType&&t.push({id:e.topicId,type:e.topicType}),a=Object(f.a)(Object(f.a)({},a),{},{topics:t}),this.enqueueEvent(r,this.removeTopics.bind(this,r,a,(e=>i(e))));break}case fo.c.REORDER:{var d;const e=[],t=(null===(d=o.topics)||void 0===d?void 0:d.length)||0;for(let i=0;i<t;i++){var l;const t=null===(l=o.topics)||void 0===l?void 0:l[i];if(t&&null!=t.topicId&&null!=t.topicType){const i=s.topics.find((e=>e.id===t.topicId&&e.type===t.topicType));i&&e.push(i)}}a=Object(f.a)(Object(f.a)({},a),{},{topics:e}),this.enqueueEvent(r,this.setTopics.bind(this,r,a,(e=>i(e))));break}}}loadStickerThumb(e){const t=e=>`${e.id}_${e.type}`;return new Promise((s=>{const i={};for(let o=0;o<e.length;o++){var n,r;const s=e[o];if((null===(n=s.params)||void 0===n?void 0:n.msg_type)===L.MSG_STICKER||(null===(r=s.params)||void 0===r?void 0:r.msg_type)===L.CLI_MSG_TYPE_STICKER){var a;const e=null===(a=s.params)||void 0===a?void 0:a.extra;e&&null!=e.catId&&null!=e.id&&(i[t(s)]=this.StickerManager.getStickerIfNotExist(e.catId,e.id))}}Object.keys(i).length>0?Go(i).then((i=>{for(let s=0;s<e.length;s++){const n=e[s],r=i[t(n)];r&&r.id===parseInt(n.params.extra.id)&&r.cateId===parseInt(n.params.extra.catId)&&(n.params.thumb=r.stickerUrl||"",e[s]=n)}s(e)})):s(e)}))}loadExtraDataForTopics(e){return new Promise((t=>{this.loadStickerThumb(e).then((e=>{t(e)}))}))}getCache(e){return this.cache.get(e)}get Fetcher(){return this.fetcher}get Logger(){return this.logger}get StickerManager(){return yt.g}get Storage(){return this.storage}})||Wo)||Wo)||Wo)||Wo)||Wo;i.ModuleContainer.register(Ao,Ko);var Ho=class{createOneOnOneTopic(e,t,s,i){void 0===e&&(e=""),void 0===s&&(s=0),void 0===i&&(i="vi");let n={conversationId:e,topic:t,version:s,lang:i};bt.default.logCoreInfo("[PinTopic] - createOneOnOneTopic params: ",n);const r=ht.b.getFriendBoardDomain()+"/api/friendboard/create?"+this.getCommonParams()+"&params="+this.getEncodedParams(n);return this.getRequest(r,null,12067)}getListOneOnOnePinTopics(e,t){void 0===e&&(e=""),void 0===t&&(t=0);let s={conversationId:e,version:t};bt.default.logCoreInfo("[PinTopic] - getListOneOnOnePinTopics params: ",s);const i=ht.b.getFriendBoardDomain()+"/api/friendboard/list?"+yn.default._getCommonParams()+"&params="+this.getEncodedParams(s);return this.getRequest(i,null,12065)}reorderOneOnOnePinTopics(e,t,s,i){void 0===e&&(e=""),void 0===s&&(s=0),void 0===i&&(i="vi");let n={conversationId:e,topics:t,version:s,lang:i};bt.default.logCoreInfo("[PinTopic] - reorderOneOnOnePinTopics params: ",n);const r=ht.b.getFriendBoardDomain()+"/api/friendboard/reorder?"+this.getCommonParams()+"&params="+this.getEncodedParams(n);return this.getRequest(r,null,12068)}unpinOneOnOneTopics(e,t,s,i){void 0===e&&(e=""),void 0===s&&(s=0),void 0===i&&(i="vi");let n={conversationId:e,topics:t,version:s,lang:i};bt.default.logCoreInfo("[PinTopic] - unpinOneOnOneTopics params: ",n);const r=ht.b.getFriendBoardDomain()+"/api/friendboard/multi_unpin?"+this.getCommonParams()+"&params="+this.getEncodedParams(n);return this.getRequest(r,null,12069)}getCommonParams(){return yn.default._getCommonParams()}getEncodedParams(e){return yn.default.getEncodedParams(e)}getRequest(e,t,s,i,n,r,a,o,d){return yn.default._get(e,t,s,i,n,r,a,o,d)}};var Qo,Jo=function(){let e;function t(){return e||(e=new Ho),e}const s=e=>new Promise(((t,s)=>{e.then(vn.a).then(t).catch(s)}));return{createOneOnOneTopic:function(e,i,n){void 0===n&&(n=0);const r=Object(f.a)({},i),{params:a}=r;a&&a.extra&&a.extra.constructor===Object&&(a.extra=JSON.stringify(a.extra)),a&&(r.params=JSON.stringify(a)),null==r.src&&(r.src=-1),null==r.pinAct&&(r.pinAct=1);const o=Ye.default.getCurrentLanguageName();return s(t().createOneOnOneTopic(e,r,n,o))},getListOneOnOnePinTopics:function(e,i){return void 0===i&&(i=0),s(t().getListOneOnOnePinTopics(e,i))},reorderOneOnOnePinTopics:function(e,i,n){void 0===n&&(n=0);const r=Ye.default.getCurrentLanguageName();return s(t().reorderOneOnOnePinTopics(e,i,n,r))},unpinOneOnOneTopics:function(e,i,n){void 0===n&&(n=0);const r=Ye.default.getCurrentLanguageName();return s(t().unpinOneOnOneTopics(e,i,n,r))}}};!function(e){e.CREATE="create",e.FETCH="fetch",e.REORDER="reorder",e.UNPIN="unpin"}(Qo||(Qo={}));var Zo=class extends $o{constructor(){super(fo.f.Network,[Qo.CREATE,Qo.FETCH,Qo.REORDER,Qo.UNPIN])}infoCreate(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(Qo.CREATE,...t)}infoFetch(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(Qo.FETCH,...t)}infoReorder(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(Qo.REORDER,...t)}infoUnpin(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(Qo.UNPIN,...t)}errorCreate(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(Qo.CREATE,...t)}errorFetch(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(Qo.FETCH,...t)}errorReorder(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(Qo.REORDER,...t)}errorUnpin(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(Qo.UNPIN,...t)}logInfo(e){if(this.isEnableLog()){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];super.info(e,...s)}}logError(e){if(this.isEnableLog()){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];super.error(e,...s)}}isEnableLog(){return Object(Io.i)()}};var Xo,Yo=class{constructor(){this.apiClient=void 0,this.logger=void 0,this.requestID=void 0,this.apiClient=Jo(),this.logger=new Zo,this.requestID=new Po.a}async fetchTopics(e,t){void 0===t&&(t=0);const s=this.getRequestId();this.Logger.infoFetch(s,`call cId:${e}`,t);try{const i=await this.apiClient.getListOneOnOnePinTopics(e,t);return this.Logger.infoFetch(s,`cId:${e} success`,i.version),{status:fo.h.SUCCESS,response:{data:{topics:i.data,version:i.version}}}}catch(i){return this.Logger.errorFetch(s,`cId:${e} fail`,xo(i,Object(Io.d)())),Promise.reject({status:fo.h.ERROR,error:{code:i.code||i.error_code,message:i.error_message}})}}async createTopic(e,t,s){void 0===s&&(s=0);const i=this.getRequestId();this.Logger.infoCreate(i,`call cId:${e}`,s);try{const n=await this.apiClient.createOneOnOneTopic(e,t,s);return this.Logger.infoCreate(i,`cId:${e} success`,n.version),{status:fo.h.SUCCESS,response:{data:{topic:n.data,version:n.version}}}}catch(n){return this.Logger.errorCreate(i,`cId:${e} fail`,xo(n,Object(Io.d)())),Promise.reject({status:fo.h.ERROR,error:{code:n.code||n.error_code,message:n.error_message}})}}async unpinTopics(e,t,s){void 0===s&&(s=0);const i=this.getRequestId();this.Logger.infoUnpin(i,`call cId:${e}`,s);try{const n=await this.apiClient.unpinOneOnOneTopics(e,t,s);return this.Logger.infoUnpin(i,`cId:${e} success`,n.version),{status:fo.h.SUCCESS,response:{data:n}}}catch(n){return this.Logger.errorUnpin(i,`cId:${e} fail`,xo(n,Object(Io.d)())),Promise.reject({status:fo.h.ERROR,error:{code:n.code||n.error_code,message:n.error_message}})}}async reorderTopics(e,t,s){void 0===s&&(s=0);const i=this.getRequestId();this.Logger.infoReorder(i,`call cId:${e}`,s);try{const n=await this.apiClient.reorderOneOnOnePinTopics(e,t,s);return this.Logger.infoReorder(i,`cId:${e} success`,n.version),{status:fo.h.SUCCESS,response:{data:n}}}catch(n){return this.Logger.errorUnpin(i,`cId:${e} fail`,xo(n,Object(Io.d)())),Promise.reject({status:fo.h.ERROR,error:{code:n.code||n.error_code,message:n.error_message}})}}getRequestId(){return this.requestID.next()}get Logger(){return this.logger}};i.ModuleContainer.register(ko,Yo);var ed=Object(i.singleton)(mo)(Xo=class{constructor(){this._storage=void 0}async clearTopics(e,t){void 0===t&&(t=!1);try{let s;if(t)s=this.storage.removeConversationTopics(e);else{const t={conversationId:e,topics:[]},i=["topics"];s=this.storage.updateGroupTopic(t,i)}return await s,e}catch(s){return Promise.reject(s)}}async loadTopics(e){try{return(await this.loadTopicsFromDB(e)).response.data}catch(t){return Promise.reject(t)}}async setTopics(e){try{return await this.setTopicsToDB(e)}catch(t){return Promise.reject(t)}}getEntryPointPromotionalTooltipShowedStatus(){const e=T.a.getInstance().getItemForCurrentUser(fo.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED);if(null===e)return null;try{return JSON.parse(e)}catch(t){return!1}}async getMessagesByIds(e){try{const t=await this.storage.getMessagesByIds(e);let s;e&&e.length>0&&(s=e[0]);let i=null;return s&&(i=t[s]),i||Promise.reject("Not found")}catch(t){return Promise.reject(t)}}async getMessageByCliMsgId(e,t){void 0===t&&(t={});try{const{myUID:s,userId:i}=t;if(i){let t=i;s==i&&(t="0");const n=await this.storage.getMessageByCliMsgIdOwnerId(e,t);return n||Promise.reject("Not found")}const n=await this.storage.getMessageByCliMsgId(e);if(!n||!n.length)return Promise.reject("Not found");n.length;const r=n&&n[0];return r||Promise.reject("Not found")}catch(s){return Promise.reject(s)}}setEntryPointPromotionalTooltipShowedStatus(e){T.a.getInstance().setItemForCurrentUser(fo.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED,JSON.stringify(e))}setForcedFetchMilestone(e){T.a.getInstance().setItemForCurrentUser(fo.e.FORCE_FETCH_MILESTONE,e.toString())}async loadTopicsFromDB(e){try{const t=await this.storage.getGroupTopic(e);return{status:fo.h.SUCCESS,response:{data:t}}}catch(t){return Promise.reject({status:fo.h.ERROR,error:{code:null==t?void 0:t.code,message:(null==t?void 0:t.message)||(null==t?void 0:t.error_message),data:t}})}}async setTopicsToDB(e){return await this.storage.setGroupTopic(e)}get storage(){return this._storage||(this._storage=s("XS0u").default),this._storage}})||Xo;i.ModuleContainer.register(po,ed);var td=s("+3r3");var sd,id=Object(i.define)("pin-topic-one-on-one-controller");!function(e){e.CONTROL="control",e.CREATE="create",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin"}(sd||(sd={}));var nd,rd=class extends $o{constructor(){super(fo.f.OneOnOneController,[sd.CONTROL,sd.CREATE,sd.LOAD,sd.REORDER,sd.UNPIN])}infoControl(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(sd.CONTROL,...t)}infoCreate(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(sd.CREATE,...t)}infoLoad(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(sd.LOAD,...t)}infoReorder(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(sd.REORDER,...t)}infoUnpin(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logInfo(sd.UNPIN,...t)}errorControl(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(sd.CONTROL,...t)}errorCreate(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(sd.CREATE,...t)}errorLoad(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(sd.LOAD,...t)}errorReorder(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(sd.REORDER,...t)}errorUnpin(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.logError(sd.UNPIN,...t)}logInfo(e){if(this.isEnableLog()){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];super.info(e,...s)}}logError(e){if(this.isEnableLog()){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];super.error(e,...s)}}isEnableLog(){return Object(Io.g)()}};Object(i.injectable)()(nd=Object(i.singleton)(id)(nd=function(e,t){return Object(i.inject)(Ao)(e,void 0,0)}(nd=function(e,t){return Object(i.inject)(go)(e,void 0,1)}(nd=Reflect.metadata("design:type",Function)(nd=Reflect.metadata("design:paramtypes",[Object,Object])(nd=class{constructor(e,t){this.dataRepository=e,this.messageLoader=t,this.events={},this.logger=void 0,this.requestID=void 0,this.initialize(),this.logger=new rd,this.requestID=new Po.a}getPinTopic(e,t,s){return new Promise(((i,n)=>{this.loadPinTopics(e).then((e=>{const{topics:r}=e,a=r.find((e=>e.id===(null==t?void 0:t.toString())&&e.type===s));a?i(a):n(null)})).catch(n)}))}getMessageFromTopic(e){return this.MessageLoader.getMessageFromTopic(e)}displayEntryPointPromotionalTooltip(){this.DataRepository.setEntryPointPromotionalTooltipShowedStatus(!0)}isDisplayedEntryPointPromotionalTooltip(){if(!Object(Io.l)())return!0;const e=this.DataRepository.getEntryPointPromotionalTooltipShowedStatus();return null!==e&&Boolean(e)}async loadPinTopics(e,t){if(void 0===t&&(t=!1),!Object(Io.k)())return Promise.reject({code:_o.c.OFF_FEATURE,message:""});const s=this.getRequestID();try{var i;let n;t&&(n=_o.e.OPEN_DIALOG),this.Logger.infoLoad(s,`call cId:${e}`,t);const r=await this.DataRepository.loadPinTopics(e,n);return this.Logger.infoLoad(s,`res cId:${e}`,!!r,r.conversationId,null===(i=r.topics)||void 0===i?void 0:i.length),{conversationId:r.conversationId,topics:r.topics}}catch(n){return this.Logger.errorLoad(s,`err cId:${e}`,xo(n,Object(Io.a)())),Promise.reject(n)}}addEventListener(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}removeEventListener(e,t){const s=this.events[e],i=(this.events[e]||[]).length;for(let n=0;n<i;n++)if(s[n]===t){s.splice(n,1);break}0===s.length&&delete this.events[e]}removeEventListeners(e){delete this.events[e]}handleEventControl(e){if(!Object(Io.k)())return;const t=this.getRequestID();this.Logger.infoControl(t,"recv",e.act,xo(e.data,Object(Io.a)())),this.DataRepository.handleReceivingEvent(e.act,e.data).then((s=>{if(this.Logger.infoControl(t,"res",e.act,xo(s,Object(Io.a)())),e.act===_o.d.UNPIN){let t=[];if(Array.isArray(e.data.topics)&&e.data.topics.forEach((e=>{s.topics.find((t=>t.id===e.topicId&&t.type===e.topicType))||t.push({topicId:e.topicId,topicType:e.topicType})})),t.length>0){const s={};t.forEach((t=>{s[`${t.topicId}_${t.topicType}`]=this.getPinTopic(e.data.conversationId,t.topicId,t.topicType)})),Go(s).then((e=>{const t=Object.keys(e).map((t=>e[t]));this.MessageLoader.removeMessages(t)}))}}this.MessageLoader.loadMessages(s.topics),this.notifyChangeEvent(s.conversationId,s.topics)})).catch((s=>{this.Logger.errorControl(t,"err",e.act,xo(s,Object(Io.a)()))}))}async createPinTopic(e,t,s){if(void 0===s&&(s=2),!Object(Io.k)())return Promise.reject({code:_o.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var n;if(this.Logger.infoCreate(i,`call cId:${e}`,!!t,s),!this.isValidNetwork())return Promise.reject({code:_o.c.NO_NETWORK,message:"STR_CHECK_NET"});const r=await this.retryable(s,(()=>this.processCreatePinTopic(e,t,s)));return this.Logger.infoCreate(i,`res cId:${e}`,!!r,null==r?void 0:r.conversationId,null==r||null===(n=r.topics)||void 0===n?void 0:n.length),r}catch(r){return this.Logger.errorCreate(i,`err cId:${e}`,xo(r,Object(Io.a)())),Promise.reject(r)}}async reorderPinTopics(e,t,s){if(void 0===s&&(s=2),!Object(Io.k)())return Promise.reject({code:_o.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var n;if(this.Logger.infoReorder(i,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:_o.c.NO_NETWORK,message:"STR_CHECK_NET"});const r=await this.retryable(s,(()=>this.processReorderPinTopics(e,t,s)));return this.Logger.infoReorder(i,`res cId:${e}`,!!r,null==r?void 0:r.conversationId,null==r||null===(n=r.topics)||void 0===n?void 0:n.length),r}catch(r){return this.Logger.errorReorder(i,`err cId:${e}`,xo(r,Object(Io.a)())),Promise.reject(r)}}async unpinPinTopics(e,t,s){if(void 0===s&&(s=2),!Object(Io.k)())return Promise.reject({code:_o.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var n;if(this.Logger.infoUnpin(i,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:_o.c.NO_NETWORK,message:"STR_CHECK_NET"});const r=await this.retryable(s,(()=>this.processUnpinPinTopics(e,t,s)));return this.Logger.infoUnpin(i,`res cId:${e}`,!!r,null==r?void 0:r.conversationId,null==r||null===(n=r.topics)||void 0===n?void 0:n.length),r}catch(r){return this.Logger.errorUnpin(i,`err cId:${e}`,xo(r,Object(Io.a)())),Promise.reject(r)}}isMessagePinnable(e){return function(e){return yo(e)}(e)}initialize(){this.FriendManager.subscribeEventFriend(L.EventFriend.REMOVE_FRIEND,(e=>{const{userId:t}=e;t&&this.clearTopics(t)})),Object(td.b)(this.clear)}clear(){this.DataRepository.clear(),this.MessageLoader.clear()}checkEnableToCreate(e,t,s){const i=(()=>{if(t.type===_o.i.MESSAGE){const i=s.topics,n=t.params.global_msg_id,r=t.params.client_msg_id,a=t.params.senderUid;for(let t=0;t<i.length;t++){const s=i[t];if(s.type===_o.i.MESSAGE){const t=this.MessageLoader.getMessageFromTopic(s);if(null!=t&&null!=n&&t.msgId===n)return s;if(null!=t&&null!=r&&t.cliMsgId===r&&t.fromUid===a&&t.toUid===e)return s}}}return null})();return s.topics.length<Object(Io.c)()||i?{enable:!0,oldTopic:i}:{enable:!1,oldTopic:null}}clearTopics(e){this.DataRepository.loadPinTopics(e,_o.e.NONE).then((t=>{this.DataRepository.clearPinTopicsForConversation(e,!0),this.MessageLoader.removeMessages(t.topics),this.notifyChangeEvent(e,[])})).catch()}getRequestID(){return this.requestID.next()}async fetchTopicsForHandleTopLevelErrors(e,t){return await this.DataRepository.loadPinTopics(e,t)}async handleTopLevelErrorInvalidBoardVersion(e,t,s){const{conversationId:i}=t;try{const e=await this.fetchTopicsForHandleTopLevelErrors(i,_o.e.OUT_OF_DATE);return s?await s():e}catch(n){return Promise.reject(e)}}async handleTopLevelErrorRolledData(e,t){const{conversationId:s}=t;try{const t=await this.fetchTopicsForHandleTopLevelErrors(s,_o.e.ROLLED_DATA);return this.notifyChangeEvent(t.conversationId,t.topics),Promise.reject({code:_o.c.TOPIC_NOT_IN_PIN_LIST,message:e.message||"STR_PIN_GENERAL_ERROR"})}catch(i){return Promise.reject(e)}}async handleTopLevelErrorUserBlockFriend(e){return Promise.reject({code:_o.c.USER_BLOCK_FRIEND,message:e.message||"STR_TOAST_BLOCK"})}async handleTopLevelErrorUserNonFriend(e){return Promise.reject({code:_o.c.USER_NON_FRIEND,message:e.message||"STR_PIN_NOT_ZALO_FRIEND"})}async handleTopLevelErrors(e,t,s){return e.code===_o.c.INVALID_BOARD_VERSION?await this.handleTopLevelErrorInvalidBoardVersion(e,t,s):e.code===_o.c.TOPIC_NOT_IN_PIN_LIST?await this.handleTopLevelErrorRolledData(e,t):e.code===_o.c.USER_BLOCK_FRIEND?await this.handleTopLevelErrorUserBlockFriend(e):e.code===_o.c.USER_NON_FRIEND?await this.handleTopLevelErrorUserNonFriend(e):Promise.reject(e)}isValidNetwork(){return In.b.getStateNetwork()===In.a.CONNECTED}notifyEvent(e){const t=this.events[e],s=(this.events[e]||[]).length;for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(let a=0;a<s;a++)"function"==typeof t[a]&&t[a](...n)}notifyChangeEvent(e,t){this.notifyEvent("onchange",e,t)}notifyExceedEvent(e,t,s){this.notifyEvent("onexceed",e,t,s)}async processCreatePinTopic(e,t,s){void 0===s&&(s=2);if(!this.FriendManager.isFriend(e))return Promise.reject({code:_o.c.USER_NON_FRIEND,message:"STR_PIN_NOT_ZALO_FRIEND"});if(this.FriendManager.isBlocked(e))return Promise.reject({code:_o.c.USER_BLOCK_FRIEND,message:"STR_TOAST_BLOCK"});try{const s=await this.DataRepository.createPinTopic(e,t,{checkEnableToCreate:this.checkEnableToCreate.bind(this)});return this.MessageLoader.loadMessages(s.topics),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(n){try{const i=await this.handleTopLevelErrors(n,{conversationId:e},this.createPinTopic.bind(this,e,t,s-1));return{conversationId:i.conversationId,topics:i.topics}}catch(r){if(r.code===_o.c.PINBOARD_OVER_MAXIMUM){var i;const s=null==r||null===(i=r.data)||void 0===i?void 0:i.cache;this.notifyExceedEvent(e,(null==s?void 0:s.topics)||[],t)}return Promise.reject(r)}}}async processReorderPinTopics(e,t,s){void 0===s&&(s=2);try{const s=await this.DataRepository.reorderPinTopics(e,t);return this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(i){try{const n=await this.handleTopLevelErrors(i,{conversationId:e},this.reorderPinTopics.bind(this,e,t,s-1));return{conversationId:n.conversationId,topics:n.topics}}catch(n){return Promise.reject(n)}}}async processUnpinPinTopics(e,t,s){void 0===s&&(s=2);try{const s=await this.DataRepository.unpinTopics(e,t);return this.MessageLoader.removeMessages(t),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(i){try{const n=await this.handleTopLevelErrors(i,{conversationId:e},this.unpinPinTopics.bind(this,e,t,s-1));return{conversationId:n.conversationId,topics:n.topics}}catch(n){return Promise.reject(n)}}}async retryable(e,t){return null!=e&&e<0?Promise.reject({code:_o.c.STOP_RETRY_CLIENT,message:"STR_PIN_GENERAL_ERROR"}):await t()}get DataRepository(){return this.dataRepository}get FriendManager(){return Je.default}get Logger(){return this.logger}get MessageLoader(){return this.messageLoader}})||nd)||nd)||nd)||nd)||nd);var ad,od=s("74m0");Object(i.injectable)()(ad=Object(i.singleton)(od.a)(ad=function(e,t){return Object(i.inject)(id)(e,void 0,0)}(ad=Reflect.metadata("design:type",Function)(ad=Reflect.metadata("design:paramtypes",[Object])(ad=class{constructor(e){this.oneOnOneController=e}addEventListener(e,t){this.OneOnOneController.addEventListener(e,t)}createPinTopic(e,t){return Object(bo.d)(e)?Promise.resolve():this.OneOnOneController.createPinTopic(e,t)}displayOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.displayEntryPointPromotionalTooltip()}getPinTopic(e,t,s){return Object(bo.d)(e)?Promise.resolve():this.OneOnOneController.getPinTopic(e,t,s)}getMessageFromTopic(e,t){if(!Object(bo.d)(e))return this.OneOnOneController.getMessageFromTopic(t)}handleEventControl(e){}handleOneOnOneEventsControl(e){this.OneOnOneController.handleEventControl(e)}isDisplayedOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.isDisplayedEntryPointPromotionalTooltip()}isEnablePinTopicOneOnOneFeature(){return Io.k()}isEnablePinTopicOneOnOneEntryPoint(){return Io.j()}isMessagePinnable(e,t){return!!this.isMessagePinnableForAllConversations(e)&&(t!==L.CONVERSATION_TYPE.FRIEND||this.OneOnOneController.isMessagePinnable(e))}loadPinTopics(e,t){return Object(bo.d)(e)?Promise.resolve():this.OneOnOneController.loadPinTopics(e,t)}removeEventListener(e,t){this.OneOnOneController.removeEventListener(e,t)}removeEventListeners(e){this.OneOnOneController.removeEventListeners(e)}reorderPinTopics(e,t){return Object(bo.d)(e)?Promise.resolve():this.OneOnOneController.reorderPinTopics(e,t)}unpinPinTopics(e,t){return Object(bo.d)(e)?Promise.resolve():this.OneOnOneController.unpinPinTopics(e,t)}isMessagePinnableForAllConversations(e){return yo(e)}get OneOnOneController(){return this.oneOnOneController}})||ad)||ad)||ad)||ad);var dd=s("t5n0"),ld=s("aQZC");var cd,hd=new class{constructor(){this.focusManager=void 0,this.focusStatus=void 0,this.focusService=void 0}get FSV(){return this.focusService||(this.focusService=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.appStatus,[ns.b.focusDetectorManager])),this.focusService}get FM(){return this.focusManager||(this.focusManager=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.appStatus,[ns.b.focusDetectorManager])),this.focusManager}get FSTT(){return this.focusStatus||(this.focusStatus=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.appStatus,[ns.b.focusStatus])),this.focusStatus}};let ud=Object(i.injectable)()(cd=Object(V.e)()(cd=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(cd=Reflect.metadata("design:type",Function)(cd=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a])(cd=class extends Y.b{constructor(e){super(),this.config=e,this.detectors=void 0,this.lostFocusHandler=void 0,this.reFocusHandler=void 0,this.lastFirer=void 0,this.enableLog=void 0,this.listenDetector=(e,t)=>{t&&(this.detectors.set(e,t),this.lostFocusHandler.set(e,(()=>{this.onLostFocus(e)})),this.reFocusHandler.set(e,(()=>{this.onRefocus(e)})),t.idle(this.lostFocusHandler.get(e)),t.wakeup(this.reFocusHandler.get(e)))},this.disposeDetector=e=>{const t=this.detectors.get(e);this.enableLog&&hd.FM.zsymb(0,11677,30003,"disposeDetector",e,!!t),t&&(t.removeIdle(this.lostFocusHandler.get(e)),t.removeWakeup(this.reFocusHandler.get(e)),t.ifvisible=null,t._window=null,t.removeAllIpc(),this.lostFocusHandler.delete(e),this.reFocusHandler.delete(e),this.detectors.delete(e))},this.onLostFocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&hd.FM.zsymb(0,11677,30004,"onlostFocus",e);let t=!0,s=Number.MAX_SAFE_INTEGER,i="unknown";this.detectors.forEach((e=>{if(e.isActive())t=!1;else{const t=e.getIdleInfo();t.idleFor<s&&(s=t.idleFor,i=t.idleByTimeout?"no-action-timeout":"unknown")}})),t&&this.dispatchEvent(new dd.a(dd.b.LostFocus,{scope:"app",reason:i})),this.lastFirer=null}),200)},this.onRefocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&hd.FM.zsymb(0,11677,30005,"onRefocus",e),this.dispatchEvent(new dd.a(dd.b.Focus,e)),this.lastFirer=null}),200)},this.detectors=new Map,this.lostFocusHandler=new Map,this.reFocusHandler=new Map,this.enableLog=!0}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&hd.FM.zsymb(0,11677,3e4,"onAuthenticated",t),this.init()}acquire(e,t,s){if(!e||e==$t.c)return ld.b;if(this.detectors.has(e))return hd.FM.zsymb(0,11677,30001,"acquire exists",e),this.detectors.get(e);this.enableLog&&hd.FM.zsymb(0,11677,30002,"acquire new",e);const i=new ld.a(e,t,s);return this.listenDetector(e,i),i}release(e){this.disposeDetector(e)}getAppIdleTime(){let e=Number.MAX_SAFE_INTEGER;return this.detectors.forEach((t=>{const s=t.getIdleInfo();s.idleFor<e&&(e=s.idleFor)})),e}updateIdleTimeout(e){this.detectors.forEach((t=>{t.setIdleTimeout(e)}))}isAppFocus(){let e=!1;return this.detectors.forEach((t=>{t.isActive()&&(e=!0)})),e}init(){this.listenDetector($t.c,ld.b)}})||cd)||cd)||cd)||cd)||cd;const gd=Object(i.define)("lost-focus-service"),md=Object(i.define)("active-service");var pd,fd,vd=s("cHDa");!function(e){e[e.Focus=0]="Focus",e[e.LostFocus=1]="LostFocus"}(fd||(fd={}));let bd=Object(i.injectable)()(pd=Object(V.e)()(pd=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(pd=function(e,t){return Object(i.inject)(gd)(e,void 0,1)}(pd=Reflect.metadata("design:type",Function)(pd=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===gd?Object:gd])(pd=class{constructor(e,t){this.config=e,this.service=t,this.enableLog=void 0,this.currentState=void 0,this.enableLog=!0,this.currentState=fd.LostFocus}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&hd.FSTT.zsymb(0,9656,3e4,"onAuthenticated",t),this.init()}init(){const e=i.ModuleContainer.resolve(dd.c);e.addEventListener(dd.b.LostFocus,(e=>{const{scope:t,reason:s}=e.payload;this.currentState==fd.Focus&&"app"===t&&(this.service.notiLostFocus(),this.config.get("online_configs.enable_focus_manager")&&vd.b.setAppStatus(vd.a.BACKGROUND),this.currentState=fd.LostFocus)})),e.addEventListener(dd.b.Focus,(e=>{this.currentState==fd.LostFocus&&this.config.get("online_configs.enable_focus_manager")&&vd.b.setAppStatus(vd.a.FOREGROUND),this.currentState=fd.Focus}))}})||pd)||pd)||pd)||pd)||pd)||pd;var yd;let Id=Object(i.injectable)()(yd=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(yd=Reflect.metadata("design:type",Function)(yd=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a])(yd=class{constructor(e){this.config=e}notiLostFocus(){this.config.get("online_configs.enable_lost_focus")?yn.default.lostFocus().then(vn.a).then((()=>{hd.FSV.zsymb(0,8612,30001,"send noti lost success")})).catch((e=>{hd.FSV.zsymb(0,8612,30002,"send noti lost fail",JSON.stringify(e))})):hd.FSV.zsymb(0,8612,3e4,"call send noti lost but feat disable")}})||yd)||yd)||yd)||yd;var _d=s("a8HX"),Md=s("LLK0");var Cd,Td=s("G15u");let Od=Object(i.injectable)()(Cd=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,0)}(Cd=function(e,t){return Object(i.inject)(md)(e,void 0,1)}(Cd=Reflect.metadata("design:type",Function)(Cd=Reflect.metadata("design:paramtypes",[void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory,void 0===md?Object:md])(Cd=class extends class{constructor(){this.interpreter=void 0}create(e){this.interpreter=new Md.a(this.createMachine(e),e)}get status(){var e;return(null===(e=this.interpreter)||void 0===e?void 0:e.status)||Md.b.NotStarted}start(){var e;null===(e=this.interpreter)||void 0===e||e.start()}stop(){var e;null===(e=this.interpreter)||void 0===e||e.stop()}send(e){return this.interpreter.send(e)}onChange(e){this.interpreter.onChange(e)}onTransition(e){this.interpreter.onTransition(e)}onStop(e){this.interpreter.onStop(e)}onDone(e){this.interpreter.onDone(e)}}{constructor(e,t){super(),this.loggerFactory=e,this.service=t}createMachine(){return e=this.loggerFactory.createZLogger(ns.b.activeDeactive,[ns.b.stateMachine]),t=this.service,Object(Td.a)({strict:!0,id:"active-deactive",context:{},initial:"unset",states:{unset:{entry:()=>e.zsymb(3,9805,3e4,"unset"),on:{FOCUS:{actions:()=>{e.zsymb(3,9805,30001,"start life cycle normal case!")},target:"foreground_active"},APP_UNLOCK:{actions:()=>{e.zsymb(3,9805,30002,"start life cycle app auto lock case!")},target:"foreground_active"},LOST_FOCUS:{actions:()=>{e.zsymb(3,9805,30003,"start life cycle lost focus case!")},target:"background_active"}}},foreground_active:{entry:s=>{e.zsymb(3,9805,30004,"state: foreground_active"),t.startForegroundMode()},on:{IDLE:{actions:()=>{},target:"background_deactive"},LOST_FOCUS:{actions:()=>{},target:"background_active"},INAPP_INTERACT:{actions:()=>{t.keepForegroundMode()}},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},APP_LOCK:{target:"background_deactive"},APP_UNLOCK:{actions:()=>{t.startForegroundMode()}},LOG_OFF:{target:"background_deactive"},OUTAPP_IDLE:{target:"background_deactive"}}},background_active:{entry:s=>{e.zsymb(3,9805,30005,"state: background_active"),t.startBackgroundMode()},on:{FOCUS:{target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},OUTAPP_IDLE:{target:"background_deactive"},APP_LOCK:{target:"background_deactive"},LOG_OFF:{target:"background_deactive"}}},background_deactive:{entry:(s,i)=>{e.zsymb(3,9805,30006,"state: background_deactive",i.status),t.startDeactive(i.status)},on:{FOCUS:{actions:()=>{},target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)},target:"background_active"},APP_UNLOCK:{target:"foreground_active"}}}},on:{RESET:{target:"unset",actions:()=>{}}}});var e,t}isUnset(){var e;return"unset"===(null===(e=this.interpreter)||void 0===e?void 0:e.state.value)}onceDeactive(e){var t;if("background_deactive"===(null===(t=this.interpreter)||void 0===t?void 0:t.state.value))e();else{let t=()=>{var s,i;"background_deactive"===(null===(s=this.interpreter)||void 0===s?void 0:s.state.value)&&(null===(i=this.interpreter)||void 0===i||i.off(t),e())};this.onChange(t)}}})||Cd)||Cd)||Cd)||Cd)||Cd;var Ed,Sd=s("4zJP");const wd=new Map([["0","LOCK_SCREEN"],["1","UNLOCK_SCREEN"],["2","LOG_ON"],["3","LOG_OFF"],["4","SLEEP"],["5","RESUME"]]);let Ld=Object(i.injectable)()(Ed=Object(V.h)()(Ed=Object(V.g)()(Ed=Object(i.singleton)(_d.a)(Ed=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(Ed=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,1)}(Ed=function(e,t){return Object(i.inject)(md)(e,void 0,2)}(Ed=Reflect.metadata("design:type",Function)(Ed=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory,void 0===md?Object:md])(Ed=class{constructor(e,t,s){this.config=e,this.service=s,this.logger=void 0,this.machine=void 0,this.authenticated=void 0,this.appLocked=void 0,this.isRunning=void 0,this.lastConfig=void 0,this.onAppLock=()=>{this.logger.zsymb(0,11676,30003,"app locked",this.authenticated),this.appLocked=!0,this.authenticated&&this.machine.send({type:"APP_LOCK",status:2})},this.onAppUnLock=()=>{this.logger.zsymb(0,11676,30004,"app unlocked",this.authenticated),this.appLocked=!1,this.authenticated&&this.machine.send({type:"APP_UNLOCK",status:0})},this.onConfigChanged=e=>{pt.default.stagingAccount&&(window._activeController=this),e&&this.config.set("online_configs",e);const t=this.isConfigsReallyChanged();if(this.logger.zsymb(0,11676,30005,"onConfigChanged",t),!t)return;this.lastConfig=this.config.get("online_configs");const s=this.config.get("online_configs.idle_time");i.ModuleContainer.resolve(dd.c).updateIdleTimeout(s/1e3),this.service.onConfigUpdated(),this.isEnable()?this.setup():this.onDispose()},this.onLostFocus=async e=>{const{scope:t,reason:s}=e.payload;"app"===t&&(this.logger.zsymb(0,11676,30006,"lost focus",s),"no-action-timeout"!=s||await this.service.isUserHasAction(this.idleTime)?this.machine.send({type:"LOST_FOCUS"}):this.machine.send({type:"IDLE",status:0}))},this.onFocus=e=>{this.isUsingApp()&&(this.logger.zsymb(0,11676,30007,"active-deactive focus"),this.machine.send({type:"FOCUS"}))},this.onActiveFromBackground=(e,t)=>{this.logger.zsymb(0,11676,30008,"onActiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_INTERACT",isOsEvt:t})},this.onDeactiveFromBackground=(e,t)=>{this.logger.zsymb(0,11676,30009,"onDeactiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_IDLE",status:t})},this.machine=i.ModuleContainer.resolveToken(Od),this.logger=t.createZLogger(ns.b.activeDeactive,[ns.b.controller]),this.config=e,this.service=s,this.authenticated=!1,this.appLocked=!1,this.isRunning=!1,this.lastConfig={},Qt.p.listenEvent(Qt.m,this.onConfigChanged);try{this.machine.create()}catch(n){return void this.logger.zsymb(18,11676,3e4,(()=>["create error",{error:n}]))}}createMachine(){}onStart(){this.isEnable()||this.logger.zsymb(0,11676,30001,"feature is not enable")}setup(){if(this.logger.zsymb(0,11676,30002,"setup",this.isRunning),this.clearBackgroundTracking(),this.isEnableBackgroundTrack()&&this.setupBackgroundTracking(),this.isRunning)return;this.isRunning=!0,this.machine.start();const e=i.ModuleContainer.resolve(dd.c);this.machine.isUnset()&&(e.isAppFocus()?this.machine.send({type:"FOCUS"}):this.machine.send({type:"LOST_FOCUS"})),e.addEventListener(dd.b.LostFocus,this.onLostFocus),e.addEventListener(dd.b.Focus,this.onFocus),this.appLocked=Qt.p.getAppLock(),Sd.b.on(Sd.a.APP_LOCKED,this.onAppLock),Sd.b.on(Sd.a.APP_UNLOCKED,this.onAppUnLock)}onAuthenticated(){this.authenticated=!0,this.isEnable()&&this.service.onLogin()}onDispose(){if(!this.isRunning)return;this.isRunning=!1,this.machine.stop();const e=i.ModuleContainer.resolve(dd.c);e.removeEventListener(dd.b.LostFocus,this.onLostFocus),e.removeEventListener(dd.b.Focus,this.onFocus),Sd.b.off(Sd.a.APP_LOCKED,this.onAppLock),Sd.b.off(Sd.a.APP_UNLOCKED,this.onAppUnLock),this.clearBackgroundTracking()}isConfigsReallyChanged(){for(const e in this.config.get("online_configs"))if(e&&this.lastConfig[e]!==this.config.get(`online_configs.${e}`))return!0;return!1}setupBackgroundTracking(){}clearBackgroundTracking(){}onUserSendMessage(){this.isEnable()&&this.machine.send("INAPP_INTERACT")}onUserLogOff(){return new Promise((e=>{if(!this.isEnable()||!this.isUsingApp())return e(!1);this.machine.onceDeactive((()=>{e(!0)})),this.machine.send({type:"LOG_OFF",status:3}),this.onDispose(),setTimeout((()=>{e(!0)}),1e3)}))}onOSEvent(e){if(!this.isEnable())return;const t=wd.get(e);It.default.send(_t.GeneralActions.USER_ACTIVE_CHANGED,t),this.logger.zsymb(3,11676,30010,"handle event os ",t)}isUsingApp(){const e=this.appLocked||Qt.p.getWaitRestart();return this.authenticated&&!e}isEnable(){return this.config.get("online_configs.enable_active_deactive_v2")}isEnableBackgroundTrack(){return!1}isEnableFullBackgroundTrack(){return!1}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get idleTime(){return this.config.get("online_configs.idle_time")}})||Ed)||Ed)||Ed)||Ed)||Ed)||Ed)||Ed)||Ed)||Ed;var Dd,Fd,Rd,Ad,Pd=s("yK2b");!function(e){e[e.ActiveBackground=0]="ActiveBackground",e[e.KeepActiveForeground=1]="KeepActiveForeground",e[e.FirstActiveForeground=2]="FirstActiveForeground",e[e.ToBackground=3]="ToBackground",e[e.KeepActiveBackground=4]="KeepActiveBackground"}(Fd||(Fd={})),function(e){e[e.Idle=0]="Idle",e[e.ComputerLock=1]="ComputerLock",e[e.AppLock=2]="AppLock",e[e.LogOff=3]="LogOff"}(Rd||(Rd={})),function(e){e[e.Foreground=0]="Foreground",e[e.BackgroundActive=1]="BackgroundActive",e[e.BackgroundDeactive=2]="BackgroundDeactive"}(Ad||(Ad={}));const Nd={[Ad.Foreground]:Fd.KeepActiveForeground,[Ad.BackgroundActive]:Fd.KeepActiveBackground};let jd=Object(i.injectable)()(Dd=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(Dd=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,1)}(Dd=function(e,t){return Object(i.inject)(dd.c)(e,void 0,2)}(Dd=Reflect.metadata("design:type",Function)(Dd=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory,void 0===dd.c?Object:dd.c])(Dd=class{constructor(e,t,s){this.config=e,this.focusManager=s,this.logger=void 0,this.pingTimer=void 0,this.deactiveTimer=void 0,this.status=void 0,this.configChanged=void 0,this.logger=t.createZLogger(ns.b.activeDeactive,[ns.b.service]),this.status=Ad.Foreground,this.configChanged=!1}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get deactiveTimeout(){return this.config.get("online_configs.idleTime")}get enableSendDeactiveOnBgIdle(){return this.config.get("online_configs.enable_deact_on_bg_idle")}get enableSendDeactiveOnFgIdle(){return this.config.get("online_configs.enable_deact_on_fg_idle")}get enSendActiveToKeepAlive(){return this.config.get("online_configs.send_active_to_keep_live")}get enActiveUsingSocket(){return this.config.get("online_configs.send_active_using_socket")}get enableBackgroundTracking(){return this.config.get("online_configs.enable_background_tracking")}get enableFeature(){return this.config.get("online_configs.enable_active_deactive_v2")}get enableFullBackgroundTrack(){return!1}onLogin(){this.sendActiveToServer(Fd.ActiveBackground)}startTrackIdle(e){void 0===e&&(e=!0),this.enableBackgroundTracking?this.logger.zsymb(0,11675,30001,"startTrackIdle"):this.logger.zsymb(0,11675,3e4,"in startTrackIdle but flag off")}stopTrackIdle(){this.logger.zsymb(0,11675,30002,"stopTrackIdle")}startForegroundMode(){this.status=Ad.Foreground,this.sendActiveToServer(Fd.FirstActiveForeground),this.clearPingTimer(),this.createPingTimer(),this.enableFullBackgroundTrack||this.stopTrackIdle()}keepForegroundMode(){this.sendActiveToServer(Fd.KeepActiveForeground,{additionText:"[Send Msg] "})}startBackgroundMode(){this.status=Ad.BackgroundActive,this.clearPingTimer(),this.startTrackIdle()}activeInBackground(e){const t=e?Fd.ActiveBackground:Fd.KeepActiveBackground;this.pingTimer?this.logger.zsymb(0,11675,30003,"user action bg but dont need ping because in ping interval"):this.sendActiveToServer(t)}startDeactive(e){let t=-1;switch(e){case 0:t=Rd.Idle;break;case 1:t=Rd.ComputerLock;break;case 2:t=Rd.AppLock;break;case 3:t=Rd.LogOff}this.clearPingTimer(),-1!==t&&this.canSendDeactive(t)&&this.sendDeactiveToServer(t),this.status===Ad.Foreground&&t==Rd.Idle&&this.startTrackIdle(!1),t!=Rd.ComputerLock&&t!=Rd.AppLock||this.stopTrackIdle(),this.status=Ad.BackgroundDeactive}onConfigUpdated(){this.configChanged=!0,this.enableFeature||this.clearPingTimer()}getStatus(){return this.status}createPingTimer(){!this.pingTimer&&this.enableFeature&&(this.logger.zsymb(0,11675,30004,"createPingTimer"),this.configChanged=!1,this.pingTimer=setInterval((()=>{const e=Nd[this.status];e?this.sendPingActive(e):this.logger.zsymb(0,11675,30005,"call ping invalid state!"),this.configChanged&&(this.clearPingTimer(),this.createPingTimer())}),this.pingInterval))}clearPingTimer(){this.logger.zsymb(0,11675,30006,"clearPingTimer"),clearInterval(this.pingTimer),this.pingTimer=null}async isUserHasAction(e){return this.focusManager.getAppIdleTime()<e}canSendDeactive(e){return e!==Rd.Idle||(this.status===Ad.Foreground&&this.enableSendDeactiveOnFgIdle||this.status===Ad.BackgroundActive&&this.enableSendDeactiveOnBgIdle)}async sendPingActive(e){await this.isUserHasAction(this.pingInterval)?this.sendActiveToServer(e):this.logger.zsymb(3,11675,30007,"call ping but discard, because the user don't have action!")}sendActiveToServer(e,t){void 0===t&&(t={additionText:""});const{additionText:s}=t;if(!this.enActiveUsingSocket||Pd.default.getMsgSrcType()!==L.MsgSources.SOCKET)return this.sendActiveViaHttp(e,s);let i=null;return i=this.enSendActiveToKeepAlive?Ws.default.pingActiveViaKeepAlive(e):Ws.default.pingActive(e),i.then((()=>(this.logger.zsymb(3,11675,30008,"{}Call active app SUCCESS: socket - {}",s,e),!0))).catch((t=>(this.logger.zsymb(21,11675,30009,"{}Call active fail: socket - {} - {}",s,e,JSON.stringify(t)),this.sendActiveViaHttp(e))))}sendActiveViaHttp(e,t){return void 0===t&&(t=""),new Promise((s=>{yn.default.active(e).then(vn.a).then((()=>{this.logger.zsymb(3,11675,30010,"{}Call active app SUCCESS: http - {}",t,e),s(!0)})).catch((i=>{this.logger.zsymb(21,11675,30011,"{}Call active fail: http - {} - {}",t,e,JSON.stringify(i)),s(!1)}))}))}sendDeactiveToServer(e){return yn.default.deactiveV2().then(vn.a).then((()=>(this.logger.zsymb(3,11675,30012,"Call deactive app SUCCESS {}",e),!0))).catch((e=>(this.logger.zsymb(21,11675,30013,"Call deactive fail: ",JSON.stringify(e)),!1)))}})||Dd)||Dd)||Dd)||Dd)||Dd)||Dd;i.ModuleContainer.registerSingleton(gd,Id),i.ModuleContainer.registerSingleton(dd.c,ud),i.ModuleContainer.registerSingleton(md,jd),i.ModuleContainer.resolve(dd.c),i.ModuleContainer.resolveToken(bd),i.ModuleContainer.resolveToken(Ld);var Ud=s("Vp9m");let Bd;!function(e){e.lockSendMsg="lockSendMsg"}(Bd||(Bd={}));var kd,Gd=s("MnxE"),xd=s("NDwn");Object(Bt.b)(pi.b)(kd=Reflect.metadata("design:type",Function)(kd=Reflect.metadata("design:paramtypes",[])(kd=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.onlyAdminChatSettings,[this.name])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.settings=new Map,this.me="",this._Logger=void 0,this.name=pi.a,this.key=pi.a,1===pt.default.only_admin_chat_setting.enable_only_admin_chat_setting&&this._addPublicGroupSettingEventListener(),this._addPublicFriendEventListener(),xd.a||Gd.a.signalCallback(this.onSettingsUpdate.bind(this))}_filterSettingKeys(e,t,s){let i={lockSendMsg:!1};for(let n in e)Object.keys(Bd).includes(n)&&n===Bd.lockSendMsg&&(i[Bd.lockSendMsg]=!t&&!s&&Boolean(e[Bd.lockSendMsg]));return i}_onUpdateSettings(e,t,s,i){this.me||(this.me=Je.default.getUidMe());const n=this.me===t,r=this._filterSettingKeys(i,n,s);return this.settings.set(e,r),Object(st.g)(this.name,e),r}showNoti(e){if("TOAST"===e.type)Ud.ZToastManagerHolder.getZToastManagerByWindowId(e.windowId||$t.c).show(Object(f.a)({},e.config))}verifySetting(e){const{convId:t,field:s,showNoti:i}=e,n=this.settings.get(t);return n?(i&&i.triggerValue===n[s]&&this.showNoti(i),n&&n[s]):null}onSettingsUpdate(e,t){let s=this.settings.get(e)||{lockSendMsg:!1};for(let i in t)Object.keys(Bd).includes(i)&&(s[i]=t[i]);this.settings.set(e,s),Object(st.g)(this.name,e)}_addPublicGroupSettingEventListener(){ts.default.subscribeEventGroup(L.EventGroup.CHANGE_OWNER,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),ts.default.subscribeEventGroup(L.EventGroup.ADD_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),ts.default.subscribeEventGroup(L.EventGroup.REMOVE_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),ts.default.subscribeEventGroup(L.EventGroup.GROUP_INFO_CHANGED,(e=>{if(null!=e&&e.length)for(let t=0;t<e.length;t++)this.onLoadGroupSetting(e[t])})),Us.default.subscribe($t.a.CHILD_WINDOW_ALIVE,(e=>{null!=e&&e.windowId&&this.onLoadSetting(e.windowId)})),It.default.subscribe(((e,t)=>{switch(e){case _t.FetchActions.UPDATE_GROUP_SETTING:{var s,i;const e=null!=t&&null!==(s=t.data)&&void 0!==s&&null!==(i=s.groupId)&&void 0!==i&&i.startsWith("g")?t.data.groupId:"g"+t.data.groupId;e&&this.onLoadGroupSetting(e);break}}}))}updateFriendBLockSetting(e,t){const s=t||Je.default.isBlocked(e),i=1===pt.default.block_msg_call_setting.enable_block_msg_call_setting;this.onSettingsUpdate(e,{[Bd.lockSendMsg]:Boolean(s)&&i})}_addPublicFriendEventListener(){Je.default.subscribeEventFriend(L.EventFriend.BLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!0)})),Je.default.subscribeEventFriend(L.EventFriend.UNBLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!1)})),It.default.subscribe(((e,t)=>{if(e===_t.FriendsAction.FRIENDS_CHANGE_INFO)t&&Array.isArray(t)&&t.forEach((e=>{let{userId:t}=e;this.updateFriendBLockSetting(t)}))}))}_checkGroupAdmin(e){var t;return this.me||(this.me=Je.default.getUidMe()),(null==e||null===(t=e.topMember)||void 0===t?void 0:t.filter((e=>e.id===this.me&&e.isAdmin)).length)>0}onLoadGroupSetting(e){return new Promise(((t,s)=>{ts.default.getFullInfoGroupById(e).then((s=>{if(!s)return this.Logger.zsymb(18,11223,3e4,"[GroupSetting]: Load GroupInfo from manager faily "+s+", GroupId: "+e),t(null);const i=s.setting,n=s.creatorId,r=this._checkGroupAdmin(s),a=this._onUpdateSettings(e,n,r,i);i&&!i.hasOwnProperty("lockSendMsg")&&this.Logger.zsymb(18,11223,30001,"[GroupSetting]: Dont have field lockSendMsg in setting data"),t(a)})).catch((s=>{this.Logger.zsymb(18,11223,30002,"[GroupSetting]: Have error in loadiing GroupInfo from manager: "+JSON.stringify(s)+", GroupId: "+e),t(null)}))}))}async onLoadSetting(e){return e.startsWith("g")?1!==pt.default.only_admin_chat_setting.enable_only_admin_chat_setting?null:await this.onLoadGroupSetting(e):(this.updateFriendBLockSetting(e),xd.a?null:void Gd.a.signalIfUnlock(e))}init(e){throw new Error("Method not  .")}getCurrentItem(e){return this.settings.get(e)}getItem(e,t){return this.settings.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||kd)||kd);const zd=Object(i.define)("media-primary-key-convertor");var Vd;let $d=Object(i.injectable)()(Vd=class{async toMediaPKFromMessagePK(e){if(!e)return"";const t=await K.a.getInstance().Core.Message.get(e);return t&&(t.cliMsgId||t.fromUid||t.toUid)?`${t.cliMsgId}_${t.fromUid}_${t.toUid}`:""}async toMessagePKFromMediaPK(e){const[t,s,i]=this._getThreePartsFromMediaPK(e);if(!t||!s||!i)return"";const n=await this._getMessagesByCliMsgIdRange(t,i);let r="";return n.forEach((e=>{e.fromUid===s&&e.toUid===i&&(r=e.msgId)})),r}_getMessagesByCliMsgIdRange(e,t){const s={from:e,to:e,excludeFrom:!1,excludeTo:!1},i={index:"cliMsgIdIndex",partition:t};return K.a.getInstance().Core.Message.getAll(s,i)}_getThreePartsFromMediaPK(e){if("string"!=typeof e||!e)return[];const[t,s,i]=e.split("_");return[t,s,i]}})||Vd;i.ModuleContainer.register(zd,$d);const Wd=Object(i.define)("utils-media-mapper"),qd=Object(i.define)("file-media-mapper"),Kd=Object(i.define)("image-media-mapper"),Hd=Object(i.define)("link-media-mapper");var Qd;let Jd=Object(i.injectable)()(Qd=class{toUtilsMediaDTOFromDomain(e){return{id:e.id,convId:e.convId,mediaType:e.mediaType,senderIds:e.senderIds,fileTypes:e.fileTypes}}})||Qd;i.ModuleContainer.register(Wd,Jd);var Zd,Xd=s("v6qY"),Yd=s("IZCB");function el(e){try{const t=JSON.parse(e),{fileExt:s,fType:i}=t;return"zip"===s&&2===i}catch(t){return!1}}function tl(e){try{if(el(e))return"folder";const t=JSON.parse(e);if(!t)return"";const{fileExt:s}=t;return s.toLowerCase()}catch(t){return""}}function sl(e){try{const t=JSON.parse(e);if(!t)return{width:null,height:null};const{width:s,height:i}=t;return{width:s,height:i}}catch(t){return{width:null,height:null}}}let il=Object(i.injectable)()(Zd=class{toDomainFromOldDomain(e,t){if(void 0===t&&(t=`${Xd.c.UNKNOWN}${Xd.d.FROM_OLD_DB}`),!e||!e.message)throw Error("This oldImageEntity isn't valid!");if(!(e.cliMsgId&&e.fromUid&&e.userId))throw Error("This oldImageEntity doesn't have key_from_to valid!");const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm;return{mediaId:`${e.cliMsgId}_${e.fromUid}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:e.fromUid,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},type:"number"==typeof e.subType?e.subType:-1,src:t,sendDttm:s,ttl:e.ttl,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:e.updateTime||s,metadata:Object(f.a)(Object(f.a)({},sl(e.message.params)),{},{vOrient:Yd.a.None})}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This imageDTO isn't valid!");if(!(e.cliMsgId&&e.fromUid&&e.userId))throw Error("This imageDTO doesn't have key_from_to valid!");const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:e.fromUid,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},type:"number"==typeof e.subType?e.subType:-1,sendDttm:t,src:e.src,ttl:"number"==typeof e.ttl?e.ttl:0,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:"number"==typeof e.updateTime?e.updateTime:t,metadata:Object(f.a)(Object(f.a)({},sl(e.message.params)),{},{vOrient:e.vOrient||Yd.a.None})}}toDomainFromTMessage(e,t,s){if(void 0===s&&(s=`${Xd.c.UNKNOWN}${Xd.d.FROM_MSG}`),!e||!e.message)throw Error("This messageEntity isn't valid!");if(!(e.cliMsgId&&e.fromUid&&e.toUid))throw Error("This messageEntity doesn't have key_from_to valid!");const i="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm;return{mediaId:`${e.cliMsgId}_${e.fromUid}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:e.fromUid,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},src:s,type:t,sendDttm:i,ttl:e.ttl||0,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:i,metadata:Object(f.a)(Object(f.a)({},sl(e.message.params)),{},{vOrient:Yd.a.None})}}async toDTO(e){if(!e||!e.mediaId)throw Error("This imageEntity isn't valid!");const t=e.msgId?e.msgId:await i.ModuleContainer.resolve(zd).toMessagePKFromMediaPK(e.mediaId);return{mediaId:e.mediaId,msgId:t,cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,description:"",childnumber:0,action:"",params:e.content.params,type:"",thumbUrl:e.content.thumbUrl,oriUrl:e.content.oriUrl,hdUrl:e.content.hdUrl,normalUrl:e.content.normalUrl,duration:e.content.duration||null,thumb:"",href:""},sendDttm:e.sendDttm,src:e.src,ttl:e.ttl,type:"image",subType:e.type,id:0,localPath:e.localPath,previewThumb:e.previewThumb,updateTime:e.modifiedTime,width:e.metadata.width,height:e.metadata.height,vOrient:e.metadata.vOrient}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"image",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts is undefined or not valid!");const t={};var s,i;(e.hasOwnProperty("message")&&"object"==typeof e.content&&(t.message={title:e.content.title,description:"",childnumber:0,action:"",params:e.content.params,type:"",thumbUrl:e.content.thumbUrl,oriUrl:e.content.oriUrl,hdUrl:e.content.hdUrl,normalUrl:e.content.normalUrl,duration:e.content.duration||null,thumb:"",href:""}),e.hasOwnProperty("subType")&&(t.subType=e.type),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("previewThumb")&&(t.previewThumb=e.previewThumb||""),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),e.hasOwnProperty("metadata"))&&(t.width=null===(s=e.metadata)||void 0===s?void 0:s.width,t.height=null===(i=e.metadata)||void 0===i?void 0:i.height);return t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts is undefined or not valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null}),e.hasOwnProperty("subType")&&(t.type=e.subType),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("previewThumb")&&(t.previewThumb=e.previewThumb||""),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("width")&&e.hasOwnProperty("height")&&e.hasOwnProperty("vOrient")&&(t.metadata={width:e.width,height:e.height,vOrient:e.vOrient||0}),t}})||Zd;var nl;i.ModuleContainer.register(Kd,il);let rl=Object(i.injectable)()(nl=class{toDomainFromOldDomain(e,t){if(void 0===t&&(t=`${Xd.c.UNKNOWN}${Xd.d.FROM_OLD_DB}`),!e||!e.message)throw Error("This oldFileEntity isn't valid!");if(!(e.cliMsgId&&e.fromUid&&e.userId))throw Error("This oldFileEntity doesn't have key_from_to valid!");const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm;return{mediaId:`${e.cliMsgId}_${e.fromUid}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:e.fromUid,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:el(e.message.params)?Xd.a.FOLDER:Xd.a.FILE,src:t,extType:tl(e.message.params),sendDttm:s,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||s,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:Object(f.a)({},e.dimension.orientation),bigRes:e.dimension.bigRes}:null}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This fileDTO isn't valid!");if(!(e.cliMsgId&&e.fromUid&&e.userId))throw Error("This fileDTO doesn't have key_from_to valid!");const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:e.fromUid,msgId:e.msgId,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:e.fileType||el(e.message.params)?Xd.a.FOLDER:Xd.a.FILE,src:e.src,extType:e.extType||tl(e.message.params),sendDttm:t,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||t,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:Object(f.a)({},e.dimension.orientation),bigRes:e.dimension.bigRes}:null}}async toDTO(e){if(!e||!e.mediaId||!e.content)throw Error("This fileEntity isn't valid!");const t=e.msgId?e.msgId:await i.ModuleContainer.resolve(zd).toMessagePKFromMediaPK(e.mediaId);return{mediaId:e.mediaId,msgId:t,cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,href:e.content.href,params:e.content.params,thumb:e.content.thumb,childnumber:0,action:"",description:"",type:"",thumbUrl:"",oriUrl:""},sendDttm:e.sendDttm,ttl:e.ttl,src:e.src,type:"file",fileType:e.type,extType:e.extType,id:0,updateTime:e.modifiedTime,localPath:e.localPath||"",folderPath:e.folderPath||"",downloadError:!1,dimension:"object"==typeof e.thumbMetadata?e.thumbMetadata:null,previewThumb:""}}toDomainFromMessage(e,t){if(void 0===t&&(t=`${Xd.c.UNKNOWN}${Xd.d.FROM_MSG}`),!e||!e.msgId||!e.message)throw Error("This messageEntity isn't valid!");if(!(e.cliMsgId&&e.fromUid&&e.toUid))throw Error("This messageEntity doesn't have key_from_to valid!");const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm;return{mediaId:`${e.cliMsgId}_${e.fromUid}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:e.fromUid,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:el(e.message.params)?Xd.a.FOLDER:Xd.a.FILE,src:t,extType:tl(e.message.params),sendDttm:s,ttl:e.ttl||0,modifiedTime:s,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:null}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"file",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts isn't valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.content&&(t.message={title:e.content.title,href:e.content.href,params:e.content.params,thumb:e.content.thumb,childnumber:0,action:"",description:"",type:"",thumbUrl:"",oriUrl:""}),e.hasOwnProperty("sendDttm")&&(t.sendDttm=e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("folderPath")&&(t.folderPath=e.folderPath||""),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),e.hasOwnProperty("dimension")&&(t.dimension=e.thumbMetadata?{width:e.thumbMetadata.width,height:e.thumbMetadata.height,type:e.thumbMetadata.type,orientation:e.thumbMetadata.orientation,bigRes:e.thumbMetadata.bigRes}:null),t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts isn't valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""}),e.hasOwnProperty("fileType")&&(t.type=e.fileType),e.hasOwnProperty("extType")&&(t.extType=e.extType||""),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("folderPath")&&(t.folderPath=e.folderPath||""),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("dimension")&&(t.thumbMetadata=e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:e.dimension.orientation,bigRes:e.dimension.bigRes}:null),t}})||nl;var al;i.ModuleContainer.register(qd,rl);let ol=Object(i.injectable)()(al=class{toDomainFromOldDomain(e,t){if(void 0===t&&(t=`${Xd.c.UNKNOWN}${Xd.d.FROM_OLD_DB}`),!e||!e.message)throw Error("This oldLinkEntity isn't valid!");if(!(e.cliMsgId&&e.fromUid&&e.userId))throw Error("This oldLinkEntity doesn't have key_from_to valid!");const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm;return{mediaId:`${e.cliMsgId}_${e.fromUid}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:e.fromUid,content:{title:"object"==typeof e.message.title?e.message.title.title||"":e.message.title,params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type||""},type:-1,src:t,sendDttm:s,ttl:e.ttl,modifiedTime:e.updateTime||s,parsedInfo:null}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This linkDTO isn't valid!");if(!(e.cliMsgId&&e.fromUid&&e.userId))throw Error("This linkDTO doesn't have key_from_to valid!");const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:e.fromUid,content:{title:"object"==typeof e.message.title?e.message.title.title:e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type},src:e.src,type:"number"==typeof e.linkType?e.linkType:-1,sendDttm:t,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||t,parsedInfo:null}}async toDTO(e){if(!e||!e.mediaId)throw Error("This linkEntity isn't valid!");const t=e.msgId?e.msgId:await i.ModuleContainer.resolve(zd).toMessagePKFromMediaPK(e.mediaId);return{mediaId:e.mediaId,msgId:t,cliMsgId:parseInt(e.cliMsgId),fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,params:e.content.params,href:e.content.href,thumb:e.content.thumb,description:e.content.description,type:e.content.type,action:"",childnumber:0,oriUrl:"",thumbUrl:""},sendDttm:e.sendDttm,type:"link",ttl:e.ttl,src:e.src,linkType:e.type,id:0,updateTime:e.modifiedTime,previewThumb:"",parsedInfo:"object"==typeof e.parsedInfo?Object(f.a)({},e.parsedInfo):null}}toDomainFromMessage(e,t){if(void 0===t&&(t=`${Xd.c.UNKNOWN}${Xd.d.FROM_MSG}`),!e)throw Error("This messageEntity isn't valid!");if(!(e.cliMsgId&&e.fromUid&&e.toUid))throw Error("This messageEntity doesn't have key_from_to valid!");const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm;return{mediaId:`${e.cliMsgId}_${e.fromUid}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:e.fromUid,content:{title:"object"===e.message.title?e.message.title.title:e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type},type:-1,src:t,sendDttm:s,ttl:e.ttl||0,modifiedTime:s,parsedInfo:null}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"link",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts isn't valid!");const t={};return e.hasOwnProperty("content")&&"object"==typeof e.content&&(t.message={title:e.content.title,params:e.content.params,href:e.content.href,thumb:e.content.thumb,description:e.content.description,type:e.content.type,action:"",childnumber:0,oriUrl:"",thumbUrl:""}),e.hasOwnProperty("sendDttm")&&(t.sendDttm=e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts isn't valid!");const t={};var s;e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:"object"==typeof e.message.title?(null===(s=e.message.title)||void 0===s?void 0:s.title)||"":e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type||""});return e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("linkType")&&(t.type=e.linkType),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("parsedInfo")&&(t.parsedInfo=e.parsedInfo?{protocol:e.parsedInfo.protocol||"",host:e.parsedInfo.domain||""}:null),t}})||al;i.ModuleContainer.register(Hd,ol);var dl=s("GbHB");let ll,cl,hl;!function(e){e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN"}(ll||(ll={})),function(e){e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN"}(cl||(cl={})),function(e){e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN"}(hl||(hl={}));var ul=s("wH4e");const gl="DONE",ml="NOT_DONE",pl="UNKNOWN",fl="GET_FROM_OLD_DB",vl="ADD_TO_NEW_DB",bl="DELETE_FROM_OLD_DB",yl="DONE",Il="FAILED",_l="NEW",Ml="RUNNING",Cl="FAILED",Tl="persisted_job_desc_summaries",Ol="migration_state";class El{constructor(e,t,s,i,n,r){this._dbInstance=void 0,this._mediaMigrationManager=void 0,this._dalInstance=K.a.getInstance(),this.dbTable=void 0,this.logger=void 0,this.mediaType=void 0,this.dbTable=this._dalInstance[e][t],this._dbInstance=this._dalInstance[e],this.mediaType=s,this._mediaMigrationManager=n,this.logger=r.createZLogger(`${e}-${t}-repository`,[i])}async insert(e,t){if(!e)throw Error("[insert]: item is undefined!");if(!e.cliMsgId||!e.fromUid||!e.convId)throw Error(`[insert]: item doesn't have valid key_from_to: ${e.cliMsgId}_${e.fromUid}_${e.convId}`);return e.mediaId=`${e.cliMsgId}_${e.fromUid}_${e.convId}`,!!(await this.dbTable.insert(e,t))}insertMulti(e,t){if(!e||!e.length)throw Error("[insertMulti]: items is undefined or empty!");const s=[];return e.forEach((e=>{e.cliMsgId&&e.fromUid&&e.convId?(e.mediaId=`${e.cliMsgId}_${e.fromUid}_${e.convId}`,s.push(e)):this.logger.zsymb(21,11049,3e4,"[insertMulti]: media doesn't have valid key_from_to: {}_{}_{}",e.cliMsgId,e.fromUid,e.convId)})),this.dbTable.insertMulti(s,t)}async update(e,t){if(!El.isNewMediaIdFormat(e))throw Error("[update]: mediaId doesn't have new media id format!");return!!(await this.dbTable.update(e,t))}async updateMedia(e,t,s){if(void 0===s&&(s=ll.UNKNOWN),!e)throw Error("[updateMedia]: mediaIdObj is undefined!");const{newId:i,oldId:n}=e;if((s===ll.NEW||await this._isMigrationDone())&&i)return!!(await this.dbTable.update(i,t));if(s===ll.OLD&&n){let e;if(t){const s=this.getMediaMapper().toOldEAttsFromNewEAtts(t.value||{});return e=Object(f.a)(Object(f.a)({},t),{},{attributes:Object.keys(s),value:s}),!!(await this.getOldDBTable().update(n,e))}throw Error("options is undefined!")}try{if(i){if(await this.dbTable.get(i))return!!(await this.dbTable.update(i,t))}if(n){let e;if(t){const s=this.getMediaMapper().toOldEAttsFromNewEAtts(t.value||{});return e=Object(f.a)(Object(f.a)({},t),{},{attributes:Object.keys(s),value:s}),!!(await this.getOldDBTable().update(n,e))}throw Error("options is undefined!")}throw Error(`${i} or ${n} isn't valid!`)}catch(r){throw Error(`[updateMedia] - err: ${r.message}`)}}async updateMulti(e){const t=await this.dbTable.updateMulti(e);return{success:t.success.map((e=>e.mediaId)),fail:t.fail.map((e=>e.mediaId))}}async updateMultiMedias(e){throw Error("This updateMultiMedias isn't implemented!")}delete(e,t){if(!El.isNewMediaIdFormat(e))throw Error("[delete]: mediaId doesn't have new media id format!");return this.dbTable.delete(e,t)}deleteMulti(e,t){if(!e||!e.length)throw Error("[deleteMulti]: mediaIds is undefined or empty!");if(e.some((e=>!El.isNewMediaIdFormat(e))))throw Error("[deleteMulti]: mediaIds contains an id which doesn't have new media id format!");return this.dbTable.deleteMulti(e,t)}async deleteMedia(e,t,s){if(void 0===s&&(s=hl.UNKNOWN),!e)throw Error("[deleteMedia]: mediaObj is undefined!");const{newId:i,oldId:n}=e;if((s===hl.NEW||await this._isMigrationDone())&&i)return this.dbTable.delete(i);if(s===hl.OLD&&n)return this.getOldDBTable().delete(n,t);{const e=[];i&&e.push(this.dbTable.delete(i,t)),n&&e.push(this.getOldDBTable().delete(n,t));return(await Promise.allSettled(e)).every((e=>"fulfilled"===e.status&&e.value))}}async deleteMultiMedias(e,t){if(!e||!e.length)throw Error("[deleteMultiMedias]: mediaIdObjs is undefined or empty!");const s={success:[],fail:[]},i=[];for(const{newId:n,oldId:r,deleteTo:a}of e){const e=(a===hl.NEW?n:a===hl.OLD?r:n||r||"")||"",o=async()=>{try{await this.deleteMedia({newId:n,oldId:r},t,a)&&s.success.push(e)}catch(i){this.logger.zsymb(18,11049,30001,i),s.fail.push(e)}};i.push(o)}return await Promise.allSettled(i.map((e=>e()))),s}async get(e,t){if(!El.isNewMediaIdFormat(e))throw Error("[get]: mediaId doesn't have new media id format!");return this.dbTable.get(e,t)}async getMulti(e,t){const{newIdFormats:s,oldIdFormats:i}=e.reduce(((e,t)=>(El.isNewMediaIdFormat(t)&&e.newIdFormats.push(t),e)),{newIdFormats:[],oldIdFormats:[]});let n=[];if(s.length){const e=await this.dbTable.getMulti(s,t);e.length&&n.push(...e)}return n}async getMedia(e,t,s){if(void 0===s&&(s=cl.UNKNOWN),!e)throw Error("[getMedia]: mediaIdObj params is undefined!");const{newId:i,oldId:n}=e;if((s===cl.NEW||await this._isMigrationDone())&&i)return this.dbTable.get(i,t);if(s===cl.NEW&&n){const e=await this.getOldDBTable().get(n,t);if(e)return this.getMediaMapper().toDomainFromOldDomain(e)}else{if(i){const e=await this.dbTable.get(i,t);if(e)return e}if(n){const e=await this.getOldDBTable().get(n,t);if(e)return this.getMediaMapper().toDomainFromOldDomain(e)}}}async getMultiMedias(e,t){if(!e||!e.length)throw Error("[getMultiMedias]: mediaIdObjs is undefined or empty!");let s=[];const i=[];for(const{newId:n,oldId:r,getFrom:a}of e)i.push(this.getMedia({newId:n,oldId:r},t,"number"==typeof a?a:cl.UNKNOWN));return s=(await Promise.allSettled(i)).map((e=>"fulfilled"===e.status?e.value:void 0)),s}getAll(e,t){if(!e)throw Error("[getAll]: keyRange is undefined!");return this.dbTable.getAll(e,t)}async getAllInOldDB(e,t){if(await this._isMigrationDone())return[];if(!e)throw Error("[getAllInOldDB]: keyRange is undefined!");const s=await this.getOldDBTable().getAll(e,t);return null!=s&&s.length?s.map((e=>this.getMediaMapper().toDomainFromOldDomain(e))):[]}static isNewMediaIdFormat(e){if(!e)return!1;return 3===e.split("_").length}static filterMedia(e,t){if(!(t&&(t.member||t.date&&(t.date.start||t.date.end)||t.name||t.ext)))return!0;if(!t.member||e.fromUid&&e.fromUid===t.member){let i,n,r;if(t.name){if(e.message.params&&e.message.href)try{let t=JSON.parse(e.message.params);i=t.mediaTitle?bt.default.simpleStripVietnamese(t.mediaTitle):bt.default.simpleStripVietnamese(e.message.title),n=t.src}catch(s){return bt.default.logCoreError(s),!1}r=bt.default.simpleStripVietnamese(t.name)}if(!t.name||r.length<=i.length&&bt.default.searchContent(i,r)){let i=!1;if(t.ext&&(i=L.fileExt[t.ext].some((t=>{if(!e.message.title){const t=dl.a.decrypt(e.message,Me.default.UIN,!1);try{e.message=JSON.parse(t)}catch(s){e.message={title:""}}}return e.message.title.endsWith(t)}))),!t.ext||i)return null==t.date.start&&null==t.date.end||(e.sendDttm>=t.date.start?e.sendDttm<=t.date.end:0)}}return!1}async isExistedMedia(e){let t=!1;if(e){const{newId:s,oldId:i}=e;s&&(t=!!(await this.dbTable.get(s))),i&&!t&&(t=!!(await this.getOldDBTable().get(i)))}return t}async getLastMediasOfConv(e,t,s){if(void 0===s&&(s=100),!e||!t)throw Error(`[getLastMediasOfConv]: convId: ${e}, lastItemOptions:${JSON.stringify(t)} isn't valid!`);const{sendDttm:i,cliMsgId:n,msgId:r}=t,a=await this.getLastMediasOfConvInNewDB(e,{sendDttm:i,cliMsgId:n},s);return a.length<s&&!(await this._isMigrationDone())&&a.push(...await this.getLastMediasOfConvInOldDB(e,{msgId:r},s-a.length)),a}async countMediaOfConv(e,t){let s=0;if(!(e&&t&&t.from&&t.to))throw Error(`[countMediaOfConv]: convId: ${e}, options: ${JSON.stringify(t)} isn't valid!`);const{from:i,to:n}=t;return s=await this.countMediaOfConvInNewDB(e,{from:{sendDttm:i.sendDttm,cliMsgId:i.cliMsgId},to:{sendDttm:n.sendDttm,cliMsgId:n.cliMsgId}}),await this._isMigrationDone()||(s+=await this.countMediaOfConvInOldDB(e,{from:{msgId:i.msgId},to:{msgId:n.msgId}})),s}countMediaOfConvInNewDB(e,t){const{from:s,to:i}=t,n={from:[e,s.sendDttm,s.cliMsgId],to:[e,i.sendDttm,i.cliMsgId],excludeFrom:!1,excludeTo:!1};return this.dbTable.count(n,{index:"convId_sendDttm_cliMsgId"})}async countMediaOfConvInOldDB(e,t){if(await this._isMigrationDone())return 0;const{from:s,to:i}=t,n={from:[e,s.msgId.length,s.msgId],to:[e,i.msgId.length,i.msgId],excludeFrom:!1,excludeTo:!1};return this.getOldDBTable().count(n,{index:"userId_sendDttm_msgId"})}async getMediasOfConv(e,t,s,i){if(!e||!t||!s)return Promise.resolve([]);let n=[];if(pt.default.load_media.optimize_mode&&(n=await this._isMigrationDone()?await this.getMediasOfConvOptimizeMode(e,t,s,i):await this.getMediasOfConvOptimizeModeInMixedDB(e,t,s,i)),null!=i&&i.deletePointOfConv){const{lastId:e,lastSendDttm:t,lastCliMsgId:s}=i.deletePointOfConv;return n.filter((i=>!(e&&i.msgId&&i.msgId<=e)&&(!(t&&i.sendDttm<=t)&&!(s&&i.cliMsgId<=s))))}return n}async getMediasOfConvOptimizeModeInMixedDB(e,t,s,i){let n=!1,r=!1;i&&i.date&&(null!==i.date.start||null!==i.date.end)&&(n=!0);const a=[],{sendDttm:o,cliMsgId:d}=await this.getSendDttmOfLatestMediaInOldDB(e),{sendDttm:l,cliMsgId:c,msgId:h}=t,u={from:[e,0,""],to:[e,l,c],excludeFrom:!0,excludeTo:!0},g={index:"convId_sendDttm_cliMsgId",limit:s,direction:ul.CursorDirection.PREV,predicate:e=>{if(!e)return!1;if(!bt.default.mapHasItem(e.content))return!1;if(!nn.a.instance.filterDBMessage(e))return!1;let t=El.filterMedia({message:e.content,fromUid:e.fromUid,sendDttm:e.sendDttm},i);return 0===t&&(r=!0),!!t&&(e.sendDttm>o&&e.cliMsgId>d||(a.push(e),!1))},aborted:n?()=>r:void 0};try{let t=await this.dbTable.getAll(u,g);if(t.length<s){const n=await this.getMediasOfConvOptimizeModeInOldDB(e,{msgId:h},s-t.length,i),r=[];n.length>0?a.length>0?(n.forEach((e=>{const t=a[0];t&&e.sendDttm<=t.sendDttm&&e.cliMsgId<=t.cliMsgId?(r.push(t),a.shift()):r.push(e)})),a.length>0&&r.push(...a),t.push(...r.slice(0,s-t.length))):t.push(...n):a.length>0&&t.push(...a)}return t}catch(m){const t=[e,this.mediaType,s,l,c,!!i].join("_");throw this.logger.zsymb(18,11049,30002,t,m),m}}async getSendDttmOfLatestMediaInOldDB(e){const t={from:[e,0,""],to:[e,L.MessageConstants.MAX_SENDDTTM,L.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},s={index:"userId_sendDttm_msgId",limit:1,direction:ul.CursorDirection.PREV},i=await this.getOldDBTable().getAll(t,s);if(!i||!i[0])return{sendDttm:0,cliMsgId:"0"};return{sendDttm:"string"==typeof i[0].sendDttm?parseInt(i[0].sendDttm):i[0].sendDttm,cliMsgId:""+(i[0].cliMsgId||0)}}async getMediasOfConvOptimizeMode(e,t,s,i){if(!e||!t||!s)throw Error(`[getMediasOfConvOptimizeMode]: convId: ${e}, lastItemOptions: ${JSON.stringify(t)}, limit: ${s} isn't valid!`);const{sendDttm:n,cliMsgId:r,msgId:a}=t,o=await this.getMediasOfConvOptimizeModeInNewDB(e,{sendDttm:n,cliMsgId:r},s,i);return o.length<s&&!(await this._isMigrationDone())&&o.push(...await this.getMediasOfConvOptimizeModeInOldDB(e,{msgId:a},s-o.length,i)),o}getMediasOfConvOptimizeModeInNewDB(e,t,s,i){let n=!1,r=!1;i&&i.date&&(null!==i.date.start||null!==i.date.end)&&(n=!0);const{sendDttm:a,cliMsgId:o}=t,d={from:[e,0,""],to:[e,a,o],excludeFrom:!0,excludeTo:!0},l={index:"convId_sendDttm_cliMsgId",limit:s,direction:ul.CursorDirection.PREV,predicate:e=>{if(!e)return!1;if(!bt.default.mapHasItem(e.content))return!1;if(!nn.a.instance.filterDBMessage(e))return!1;let t=El.filterMedia({message:e.content,fromUid:e.fromUid,sendDttm:e.sendDttm},i);return 0===t&&(r=!0),!!t},aborted:n?()=>r:void 0};try{return this.dbTable.getAll(d,l)}catch(c){const t=[e,this.mediaType,s,a,o,!!i].join("_");throw this.logger.zsymb(18,11049,30003,t,c),c}}async getMediasOfConvOptimizeModeInOldDB(e,t,s,i){if(await this._isMigrationDone())return[];let n=!1,r=!1;i&&i.date&&(null!=i.date.start||null!=i.date.end)&&(n=!0);const{msgId:a}=t,o={from:[e,0,""],to:[e,a.length,a],excludeFrom:!0,excludeTo:!0},d={index:"userId_sendDttm_msgId",limit:s,direction:ul.CursorDirection.PREV,predicate:e=>{if(e){if(e.msgId&&e.msgId.includes("_"))return!1;if(!bt.default.mapHasItem(e.message))return!1}if(!nn.a.instance.filterDBMessage(e))return!1;let t=El.filterMedia(e,i);return 0===t&&(r=!0),!!t},aborted:n?()=>r:void 0};try{const e=await this.getOldDBTable().getAll(o,d);return(await this.correctMediasInOldDB(e)).map((e=>this.getMediaMapper().toDomainFromOldDomain(e)))}catch(l){const t=[e,this.mediaType,s,a,!!i].join("_");throw this.logger.zsymb(18,11049,30004,t,l),l}}getLastMediasOfConvInNewDB(e,t,s){const{sendDttm:i,cliMsgId:n}=t,r={from:[e,0,""],to:[e,i,n],excludeFrom:!1,excludeTo:!1},a={index:"convId_sendDttm_cliMsgId",limit:s,direction:ul.CursorDirection.PREV};return this.dbTable.getAll(r,a)}async getLastMediasOfConvInOldDB(e,t,s){if(await this._isMigrationDone())return[];const{msgId:i}=t,n={from:[e,0,""],to:[e,i.length,i],excludeFrom:!1,excludeTo:!1},r={index:"userId_sendDttm_msgId",limit:s,direction:ul.CursorDirection.PREV},a=await this.getOldDBTable().getAll(n,r);return a.length>0?a.map((e=>Object(f.a)(Object(f.a)({},this.getMediaMapper().toDomainFromOldDomain(e)),{},{msgId:e.msgId}))):[]}correctMediasInOldDB(e,t){return void 0===t&&(t={saveBack:!0}),e&&e.length?new Promise((s=>{let i=[],n={},r=[];if(e.forEach((e=>{e&&e.msgId&&e.sendDttm&&(e.type&&e.cliMsgId?r.push(e):(i.push(e.msgId),n[e.msgId]=e))})),!i.length)return s(r);{let e="";const a=(t,s)=>{switch(s.msgType){case L.MSG_PHOTO:case L.MSG_PHOTO_2:e="image",t.subType=L.MSG_SUBTYPE_PHOTO;break;case L.MSG_VIDEO:e="image",t.subType=L.MSG_SUBTYPE_MEDIA_VIDEO;break;case L.MSG_FILE:e="file";break;case L.MSG_CONTACT:"object"==typeof s.message&&"recommened.link"===s.message.action&&(e="link")}return t.cliMsgId=s.cliMsgId,t.type=e,t};Me.default.getMessagesByIdsInQueue(i).then((e=>{const i=[];if(e)for(let t in e)e[t]&&i.push(a(n[t],e[t]));let o=r.concat(i);return o.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm))),i.length&&t.saveBack&&this.deleteAndInsertInOldDB(i),s(o)})).catch((e=>s(r)))}})):Promise.resolve([])}async deleteAndInsertInOldDB(e){if(!e||!e.length)throw Error(`[deleteAndInsertInOldDB]: oldItems: ${JSON.stringify(e)} isn't valid!`);return this.getOldDBTable().insertMulti(e,{replace:!0})}async _isMigrationDone(){return(await this._mediaMigrationManager.getMediaMigrationState()).stateName===gl}}class Sl extends El{constructor(e,t,s,i,n,r){super(e,t,s,i,n,r)}async getImageMessagesForPhotoViewer(e,t,s,i,n,r){const a=await this.getMsgIdsOfImageMediaForPhotoViewer(e,s,t,i,n,r);if(null==a||!a.length)return[];const o=await Promise.all(a.map((e=>this.getMediaMapper().toDTO(e)))),d=[];let l=[];for(const c of o)d.push(K.a.getInstance().Core.Message.get(c.msgId,{partition:e}).then((e=>{e?l.push(Object(f.a)(Object(f.a)({},c),e)):c.message&&l.push(c)})));return await Promise.all(d),l.reverse(),Me.default._fillExifBeforeShow(l),l}async getMsgIdsOfImageMediaForPhotoViewer(e,t,s,i,n,r){const{cliMsgId:a,sendDttm:o,msgId:d}=t,l=!i&&!n;let c=!1;const h=()=>c,u=e=>{if(!(r&&(r.member||r.date&&(r.date.start||r.date.end)||r.name||r.ext)))return!0;if(!r.member||e.fromUid&&e.fromUid===r.member){let s,i,n;if(r.name){if(e.message.params&&e.message.href)try{let t=JSON.parse(e.message.params);s=t.mediaTitle?bt.default.simpleStripVietnamese(t.mediaTitle):bt.default.simpleStripVietnamese(e.message.title),i=t.src}catch(t){return this.logger.zsymb(18,11029,3e4,t),!1}n=bt.default.simpleStripVietnamese(r.name)}if(!r.name||bt.default.searchContent(s,n)||bt.default.searchContent(i,n)){let t=!1;if(r.ext&&(t=L.fileExt[r.ext].some((t=>e.message.title.endsWith(t)))),!r.ext||t)return!r.date.start||!r.date.end||(r.date.end<e.sendDttm?e.sendDttm<r.date.start+864e5:(c=!0,!1))}}return!1};let g=[];if(i){const t=async()=>{let t=[];if(!(await this._isMigrationDone())){const i={from:[e,d.length,d],to:[e,L.MessageConstants.MAX_MSG_ID.length,L.MessageConstants.MAX_MSG_ID],excludeFrom:!l,excludeTo:!l},n={limit:s,index:"userId_sendDttm_msgId",direction:ul.CursorDirection.NEXT,predicate:e=>u({fromUid:e.fromUid,message:e.message,sendDttm:"string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm}),aborted:h};t=await this.getAllInOldDB(i,n)}if(t.length<s){const i={from:[e,o,a],to:[e,parseInt(L.MessageConstants.MAX_SENDDTTM),L.MessageConstants.MAX_MSG_ID],excludeFrom:!l,excludeTo:!l},n={limit:s-t.length,index:"convId_sendDttm_cliMsgId",direction:ul.CursorDirection.NEXT,predicate:e=>u({fromUid:e.fromUid,message:e.content,sendDttm:e.sendDttm}),aborted:h};t.push(...await this.getAll(i,n))}return t};g.push(t())}if(n){const t=async()=>{let t=[];const i={from:[e,0,""],to:[e,o,a],excludeFrom:!l,excludeTo:!l},n={limit:s,index:"convId_sendDttm_cliMsgId",direction:ul.CursorDirection.PREV,predicate:e=>u({fromUid:e.fromUid,message:e.content,sendDttm:e.sendDttm}),aborted:h};if(t=await this.getAll(i,n),t.length<s&&!(await this._isMigrationDone())){const i={from:[e,0,""],to:[e,d.length,d],excludeFrom:!l,excludeTo:!l},n={limit:t?s-t.length:s,index:"userId_sendDttm_msgId",direction:ul.CursorDirection.PREV,predicate:e=>u({fromUid:e.fromUid,message:e.message,sendDttm:"string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm}),aborted:h};t.push(...await this.getAllInOldDB(i,n))}return t};g.push(t())}try{const e=await Promise.all(g);if(2===e.length){let t=e[0].reverse();return t.pop(),t=t.concat(e[1]),t}return n?e[0]:e[0].reverse()}catch(m){return this.logger.zsymb(18,11029,30001,m),[]}}}const wl=Object(i.define)("image-media-repository");var Ll,Dl=s("H8Z7");Object(i.injectable)()(Ll=Object(i.singleton)(wl)(Ll=function(e,t){return Object(i.inject)(Kd)(e,void 0,0)}(Ll=function(e,t){return Object(i.inject)(Dl.c)(e,void 0,1)}(Ll=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,2)}(Ll=Reflect.metadata("design:type",Function)(Ll=Reflect.metadata("design:paramtypes",[Object,void 0===Dl.IMediaMigrationManager?Object:Dl.IMediaMigrationManager,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(Ll=class extends Sl{constructor(e,t,s){super("Media","Image","image","crud-image-media",t,s),this.imageMediaMapper=void 0,this.oldDBTable=void 0,this.imageMediaMapper=e,this.oldDBTable=this._dalInstance.Core.Image}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=K.a.getInstance().Core.Image),this.oldDBTable}getMediaMapper(){return this.imageMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,s){throw Error("Currently, this method isn't supported!")}})||Ll)||Ll)||Ll)||Ll)||Ll)||Ll);class Fl extends El{constructor(e,t,s,i,n,r){super(e,t,s,i,n,r)}async getLastestAddedFiles(e,t){if(!e||"number"!=typeof t)throw Error(`[getLastestAddedFiles]: ${JSON.stringify(e)} or ${t} isn't valid!`);const s=await this.getLastestAddedFilesInNewDB(e,t);return s.length<t&&!(await this._isMigrationDone())&&s.push(...await this.getLastestAddedFilesInOldDB({sendDttm:e.sendDttm},t-s.length)),s}async getLastestAddedFilesInNewDB(e,t){const{convId:s,sendDttm:i,cliMsgId:n}=e;return this.dbTable.getAll({from:["",0,0],to:[s,i,n],excludeFrom:!0,excludeTo:!0},{index:"convId_sendDttm_cliMsgId",limit:t,direction:ul.CursorDirection.PREV})}async getLastestAddedFilesInOldDB(e,t){if(await this._isMigrationDone())return[];const s=await this.getOldDBTable().getAll({from:0,to:e.sendDttm,excludeFrom:!0,excludeTo:!0},{index:"sendDttm",limit:t,direction:ul.CursorDirection.PREV});return s.length>0?s.map((e=>this.getMediaMapper().toDomainFromOldDomain(e))):[]}}const Rl=Object(i.define)("file-media-repository");var Al;Object(i.injectable)()(Al=Object(i.singleton)(Rl)(Al=function(e,t){return Object(i.inject)(qd)(e,void 0,0)}(Al=function(e,t){return Object(i.inject)(Dl.c)(e,void 0,1)}(Al=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,2)}(Al=Reflect.metadata("design:type",Function)(Al=Reflect.metadata("design:paramtypes",[Object,void 0===Dl.IMediaMigrationManager?Object:Dl.IMediaMigrationManager,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(Al=class extends Fl{constructor(e,t,s){super("Media","File","file","crud-file-media",t,s),this.fileMediaMapper=void 0,this.oldDBTable=void 0,this.fileMediaMapper=e,this.oldDBTable=this._dalInstance.Core.File}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=K.a.getInstance().Core.File),this.oldDBTable}getMediaMapper(){return this.fileMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,s){throw Error("Currently, this method isn't supported!")}})||Al)||Al)||Al)||Al)||Al)||Al);class Pl extends El{constructor(e,t,s,i,n,r){super(e,t,s,i,n,r)}}const Nl=Object(i.define)("link-media-repository");var jl;Object(i.injectable)()(jl=Object(i.singleton)(Nl)(jl=function(e,t){return Object(i.inject)(Hd)(e,void 0,0)}(jl=function(e,t){return Object(i.inject)(Dl.c)(e,void 0,1)}(jl=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,2)}(jl=Reflect.metadata("design:type",Function)(jl=Reflect.metadata("design:paramtypes",[Object,void 0===Dl.IMediaMigrationManager?Object:Dl.IMediaMigrationManager,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(jl=class extends Pl{constructor(e,t,s){super("Media","Link","link","crud-link-media",t,s),this.linkMediaMapper=void 0,this.oldDBTable=void 0,this.linkMediaMapper=e,this.oldDBTable=this._dalInstance.Core.Link}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=K.a.getInstance().Core.Link),this.oldDBTable}getMediaMapper(){return this.linkMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,s){throw Error("Currently, this method isn't supported!")}})||jl)||jl)||jl)||jl)||jl)||jl);var Ul=s("hWjG");const Bl=Object(i.define)("utils-media-repository");class kl{constructor(e){this._lruCache=void 0,this._lruCache=new U.default(e)}get(e){return this._lruCache.get(e)}getAll(e){void 0===e&&(e="ASC");const t="ASC"===e?this._lruCache.entriesAscending():this._lruCache.entriesDescending();return Object.values(t)}getAllKey(e){void 0===e&&(e="ASC");const t="ASC"===e?this._lruCache.entriesAscending():this._lruCache.entriesDescending();return Object.keys(t)}set(e,t){this._lruCache.set(e,t)}delete(e){return this._lruCache.delete(e)}clear(){this._lruCache.clear()}}var Gl;Object(i.injectable)()(Gl=Object(i.singleton)(Bl)(Gl=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,0)}(Gl=Reflect.metadata("design:type",Function)(Gl=Reflect.metadata("design:paramtypes",[void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(Gl=class extends Ul.a{constructor(e){super("Media","UtilsMedia","utils-media-repo",e,"id",Xd.b),this._cache=new kl({maxSize:Xd.b})}async isExisted(e){if(!e)return!1;const t=this._cache.get(e);if(!t){const t=await this._dbCollection.get(e);return t&&this._cache.set(e,t),!!t}return!!t}async update(e,t){const s=await this._dbCollection.update(e,t);return s&&this._cache.set(e,s),s}async updateMulti(e){const t=await this._dbCollection.updateMulti(e);return t.success.forEach((e=>this._cache.set(e.id,e))),t}getAllSenderIds(e,t){if(void 0===t&&(t=!0),!e)throw Error(`[getAllSenderIds]: id: ${e} isn't valid!`);return this._getItemListByField(e,"senderIds",t)}getAllFileTypes(e,t){if(!e)throw Error(`[getAllFileTypes]: id: ${e} isn't valid!`);return this._getItemListByField(e,"fileTypes",t)}saveSender(e,t){if(!e)throw Error(`[saveSender]: id: ${e} isn't valid!`);return this._saveValueOnField(e,"senderIds",t)}saveFileType(e,t){if(!e)throw Error(`[saveFileType]: id: ${e} isn't valid!`);return this._saveValueOnField(e,"fileTypes",t)}saveSenders(e,t){if(!e)throw Error(`[saveSenders]: id: ${e} isn't valid!`);return this._saveValuesOnField(e,"senderIds",t)}saveFileTypes(e,t){if(!e)throw Error(`[saveSenders]: id: ${e} isn't valid!`);return this._saveValuesOnField(e,"fileTypes",t)}deleteSender(e,t){if(!e)throw Error(`[deleteSender]: id: ${e} isn't valid!`);return this._deleteValueOnField(e,"senderIds",t)}deleteFileType(e,t){if(!e)throw Error(`[deleteFileType]: id: ${e} isn't valid!`);return this._deleteValueOnField(e,"fileTypes",t)}deleteSenders(e,t){if(!e)throw Error(`[deleteSenders]: id: ${e} isn't valid!`);return this._deleteValuesByField(e,"senderIds",t)}deleteFileTypes(e,t){if(!e)throw Error(`[deleteFileTypes]: id: ${e} isn't valid!`);return this._deleteValuesByField(e,"fileTypes",t)}async _saveValueOnField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){i[t].some((e=>e===s))||(i[t].push(s),await this.update(e,{value:{[t]:i[t]},attributes:[t]}))}return!0}async _saveValuesOnField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){const n=s.filter((e=>!i[t].includes(e)));n.length&&(i[t].push(...n),await this.update(e,{value:{[t]:i[t]},attributes:[t]}))}return!0}async _deleteValueOnField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){const n=i[t].indexOf(s);-1!==n&&(i[t].splice(n,1),await this.update(e,{value:{[t]:i[t]},attributes:[t]}))}return!0}async _deleteValuesByField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){const n=i[t].filter((e=>!s.includes(e)));n.length<i[t].length&&(i[t]=n,await this.update(e,{value:{[t]:n},attributes:[t]}))}return!0}async _getItemListByField(e,t,s){var i;void 0===s&&(s=!0);const n=this._cache.get(e);var r;if(s)return n&&null!==(r=n[t])&&void 0!==r&&r.length?n[t].slice():[];const a=await this._dbCollection.get(e);return a&&!n&&this._cache.set(e,Object(f.a)({},a)),a&&null!==(i=a[t])&&void 0!==i&&i.length?a[t].slice():[]}})||Gl)||Gl)||Gl)||Gl);const xl=Object(i.define)("media-mapper-factory");var zl;Object(i.injectable)()(zl=Object(i.singleton)(xl)(zl=class{getMediaMapper(e){switch(e){case"image":return i.ModuleContainer.resolve(Kd);case"file":return i.ModuleContainer.resolve(qd);case"link":return i.ModuleContainer.resolve(Hd);default:return}}})||zl);const Vl=Object(i.define)("media-repository-factory");var $l;Object(i.injectable)()($l=Object(i.singleton)(Vl)($l=class{getMediaRepository(e){switch(e){case"image":return i.ModuleContainer.resolve(wl);case"link":return i.ModuleContainer.resolve(Nl);case"file":return i.ModuleContainer.resolve(Rl);default:return}}})||$l);const Wl="utils-media-domain-service",ql=Object(i.define)(Wl);function Kl(e){const t=e;return function(e,s,i){void 0===i&&(i="error");const n=`${e} ${i}: ${s}`;switch(i){case"error":t.zsymb(18,11026,3e4,n);break;case"debug":t.zsymb(12,11026,30001,n);break;case"info":t.zsymb(0,11026,30002,n)}}}var Hl;Object(i.injectable)()(Hl=Object(i.singleton)(ql)(Hl=function(e,t){return Object(i.inject)(Bl)(e,void 0,0)}(Hl=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,1)}(Hl=Reflect.metadata("design:type",Function)(Hl=Reflect.metadata("design:paramtypes",[Object,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(Hl=class{constructor(e,t){this._log=void 0,this._logger=void 0,this._utilsMediaRepository=void 0,this._utilsMediaRepository=e,this._logger=t.createZLogger("utils-media-domain-service",["mn-utils-media-de"]),this._log=Kl(this._logger)}async create(e){if(!e)throw Error(`utilsMedia(${e}) isn't existed!`);if(!e.convId||!e.mediaType)throw Error(`cannot create utilsMedia with convId(${e.convId}) and mediaType(${e.mediaType})`);if(await this._utilsMediaRepository.isExisted(`${e.convId}_${e.mediaType}`))throw this._log("[create]",`existed utilsMedia have convId(${e.convId}) and mediaType(${e.mediaType})`,"info"),Error(`existed utilsMedia have convId(${e.convId}) and mediaType(${e.mediaType})`);return{id:`${e.convId}_${e.mediaType}`,convId:e.convId,mediaType:e.mediaType,senderIds:e.senderIds||[],fileTypes:e.fileTypes||[]}}addSenders(e,t){if(!e)throw Error("[addFileTypes] utilsMediaEntity isn't existed!");if(!t||!t.length)return Object(f.a)({},e);return Object(f.a)(Object(f.a)({},e),{},{senderIds:t.reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[...e.senderIds]||!1)})}addFileTypes(e,t){if(!e)throw Error("[addFileTypes] utilsMediaEntity isn't existed!");if(!t||!t.length)return Object(f.a)({},e);const s=Object(f.a)(Object(f.a)({},e),{},{fileTypes:t.reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[...e.fileTypes]||!1)});return s}})||Hl)||Hl)||Hl)||Hl)||Hl);const Ql="utils-media-app-service",Jl=Object(i.define)(Ql);var Zl;Object(i.injectable)()(Zl=Object(i.singleton)(Jl)(Zl=function(e,t){return Object(i.inject)(ql)(e,void 0,0)}(Zl=function(e,t){return Object(i.inject)(Bl)(e,void 0,1)}(Zl=function(e,t){return Object(i.inject)(Wd)(e,void 0,2)}(Zl=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,3)}(Zl=Reflect.metadata("design:type",Function)(Zl=Reflect.metadata("design:paramtypes",[Object,Object,Object,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(Zl=class{constructor(e,t,s,i){this._utilsMediaDomainService=void 0,this._utilsMediaRepository=void 0,this._mapper=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaDomainService=e,this._utilsMediaRepository=t,this._mapper=s,this._logger=i.createZLogger(Ql,["manage-utils-media-in-app"]),this._log=Kl(this._logger)}async create(e){try{const t=await this._utilsMediaDomainService.create(e);return this._mapper.toUtilsMediaDTOFromDomain(await this._utilsMediaRepository.insert(t))}catch(t){return void this._log("[create]",t.message)}}async createOrUpdate(e){try{const t=`${e.convId}_${e.mediaType}`;let s=await this._utilsMediaRepository.get(t);if(s){const{senderIds:i,fileTypes:n}=e;let r=s.senderIds,a=s.fileTypes;if(i&&i.length&&(r=this._utilsMediaDomainService.addSenders(s,i).senderIds),n&&n.length&&(a=this._utilsMediaDomainService.addFileTypes(s,n).fileTypes),r.length!==s.senderIds.length||a.length!==s.fileTypes.length){const e=await this._utilsMediaRepository.update(t,{value:{senderIds:r,fileTypes:a},attributes:["senderIds","fileTypes"]});return this._mapper.toUtilsMediaDTOFromDomain(e)}return this._mapper.toUtilsMediaDTOFromDomain(s)}return this.create(e)}catch(t){return void this._log("[createOrUpdate]",t.message)}}async deleteUtilsMediasByConvId(e){try{if(!e)return[];const t=Object.values(Xd.e).map((t=>`${e}_${t}`));return(await this._utilsMediaRepository.deleteMulti(t)).success}catch(t){return this._log("[deleteUtilsMediasByConvId]",t.message),[]}}async createOrUpdateFromMedias(e){try{if(!e||!e.length)return[];const t=new Map;e.forEach((e=>{let s=t.get(e.convId);if("image"===e.mediaType||"link"===e.mediaType)if(s){-1===s.senderIds.indexOf(e.fromUid)&&(s.senderIds.push(e.fromUid),t.set(e.convId,s))}else s={convId:e.convId,mediaType:e.mediaType,senderIds:[e.fromUid],fileTypes:[]},t.set(e.convId,s);else if("file"===e.mediaType){const i=this._getFileType(e.content.params);if(s){-1===s.fileTypes.indexOf(i)&&(s.fileTypes.push(i),t.set(e.convId,s))}else s={convId:e.convId,mediaType:e.mediaType,senderIds:[e.fromUid],fileTypes:[i]},t.set(e.convId,s)}}));const s=Array.from(t.values());return(await Promise.all(s.map((e=>this.createOrUpdate(e))))).filter(Boolean)}catch(t){return this._log("[createOrUpdateFromMedias]",t.message),[]}}_getFileType(e){try{const t=JSON.parse(e);if(!t)throw Error(`paramsObj is ${t}!`);const{fileExt:s,fType:i}=t;return"zip"===s&&2===i?"folder":s.toLowerCase()}catch(t){return this._log("[_getFileType]",t.message),""}}})||Zl)||Zl)||Zl)||Zl)||Zl)||Zl)||Zl);const Xl=Object(i.define)("media-migration-state-persist");var Yl;Object(i.injectable)()(Yl=Object(i.singleton)(Xl)(Yl=class{constructor(){this._localStorage=T.a.getInstance()}async saveMigrationState(e){e&&await this._localStorage.setItemForCurrentUserAsync(Ol,JSON.stringify(e))}async getMigrationState(){try{const e=await this._localStorage.getItemForCurrentUserAsync(Ol);return e?JSON.parse(e):{stateName:pl,mediaTableNamesToMigrate:[]}}catch(e){return{stateName:pl,mediaTableNamesToMigrate:[]}}}async saveJobDescSummaries(e){Array.isArray(e)&&await this._localStorage.setItemForCurrentUserAsync(Tl,JSON.stringify(e))}async getSavedJobDescSummaries(){try{const e=await this._localStorage.getItemForCurrentUserAsync(Tl);if(!e)return[];return JSON.parse(e)}catch(e){return[]}}async clearPersistedJobDescSummaries(){await this._localStorage.removeItemForCurrentUserAsync(Tl)}})||Yl);var ec=s("mH7l"),tc=s.n(ec);const sc=e=>"GET_FROM_OLD_DB"===e.name,ic=e=>"ADD_TO_NEW_DB"===e.name,nc=e=>"DELETE_FROM_OLD_DB"===e.name;function rc(){return pt.default.media_migration_db.should_stop_migration}function ac(){return pt.default.media_migration_db.max_running_concurrency_job}function oc(){return pt.default.media_migration_db.delay_time_per_job}function dc(){return pt.default.media_migration_db.delay_time_each_k_jobs}function lc(){return pt.default.media_migration_db.media_limit_per_job}function cc(){return pt.default.media_migration_db.min_retry_after}function hc(){return pt.default.media_migration_db.max_retry_after}var uc=s("1erv");const gc=0,mc=1,pc=2,fc=4;class vc extends Error{constructor(e){super(`ExpBackoff error:${e}`),this.code=e}}function*bc(e){var t,s,i,n,r;const a=null!==(t=null==e?void 0:e.retries)&&void 0!==t?t:3,o=null!==(s=null==e?void 0:e.min)&&void 0!==s?s:100,d=null!==(i=null==e?void 0:e.max)&&void 0!==i?i:1e4,l=null!==(n=null==e?void 0:e.step)&&void 0!==n?n:2,c=null!==(r=null==e?void 0:e.jitter)&&void 0!==r?r:0;if(o<=0)throw new vc(pc);if(c<0||c>1)throw new vc(mc);let h=0;for(;h<=a;){const e=yc({nTry:h,step:l,jitter:c,min:o,max:d});yield{nTry:h,duration:e,sleep:()=>new Promise((t=>{setTimeout(t,e)}))},h++}}function yc(e){let{step:t,nTry:s,jitter:i,min:n,max:r}=e,a=n*Math.pow(t,s);if(i){const e=Math.random(),t=Math.floor(e*i*a);a=0==(1&Math.floor(10*e))?a-t:a+t}return 0|Math.min(a,r)}var Ic;const _c=new Po.a,Mc=999999;Object(V.d)()(Ic=Object(i.injectable)()(Ic=Object(i.singleton)(Dl.c)(Ic=function(e,t){return Object(i.inject)(Xl)(e,void 0,0)}(Ic=function(e,t){return Object(i.inject)(V.a)(e,void 0,1)}(Ic=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,2)}(Ic=Reflect.metadata("design:type",Function)(Ic=Reflect.metadata("design:paramtypes",[Object,void 0===V.a?Object:V.a,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(Ic=class{constructor(e,t,s){this._isLoadData=!1,this._forceStop=!1,this._mediaMigrationStatePersist=void 0,this._maxWorkerPoolNum=ac(),this._worker=new tc.a({concurrency:this._maxWorkerPoolNum,autoStart:!1}),this._delayTimePerJob=oc(),this._delayTimeEachKJobs=dc(),this._mediaNumLimitPerJob=lc(),this._minRetryAfter=cc(),this._maxRetryAfter=hc(),this._currentJobDescs=[],this._currentJobHolders=[],this._currentMsgIdCursor=L.MessageConstants.MAX_MSG_ID,this._mediaMigrationState=void 0,this._failedGetJob=!1,this._failedAddJob=!1,this._failedDeleteJob=!1,this._hasDBError=!1,this._logger=void 0,this._application=void 0,this._mediaMigrationStatePersist=e,this._onApplicationIdle=this._onApplicationIdle.bind(this),this._onApplicationActive=this._onApplicationActive.bind(this),this._onApplicationExit=this._onApplicationExit.bind(this),this._application=t,this._logger=s.createZLogger(Dl.b,["manage-media-migration"])}onApplicationReady(e){this._listenEvents(),this._isLoadData||this._loadData().then((()=>{this._runMigration()})),this.toggleDBError(this._getTestMediaMigrationFlag("[mm]:db_error")),this.toggleGetJobFailed(this._getTestMediaMigrationFlag("[mm]:get_failed")),this.toggleAddJobFailed(this._getTestMediaMigrationFlag("[mm]:add_failed")),this.toggleDeleteJobFailed(this._getTestMediaMigrationFlag("[mm]:delete_failed"))}async getMediaMigrationState(){if(!Object(uc.a)()||rc())return{stateName:pl,mediaTableNamesToMigrate:[]};if(!this._mediaMigrationState){const{stateName:e,remainingTableNames:t}=await this._statsMediaMigration();this._mediaMigrationState={stateName:e,mediaTableNamesToMigrate:t}}return this._mediaMigrationState}pauseMigration(e){this._logger.zsymb(3,10719,3e4,"[mm] pause migration - reason: {}",e),this.flushHoldingJobs(),this._forceStop=!0,this._worker.pause()}async resumeMigration(e){this._logger.zsymb(3,10719,30001,"[mm] resume migration - reason: {}",e),this._forceStop=!1,Object(uc.a)()&&!rc()&&(this._isLoadData||await this._loadData(),this._currentJobDescs.forEach((e=>{if(e.state===Cl){e.state=_l;const t=this._createJob(e);if(t){const s=this._scheduleJob(e.id,t);this._worker.add(s,{priority:Mc})}}})),this._worker.size>0?this._worker.isPaused&&this._worker.start():this._runMigration())}flushHoldingJobs(){this._currentJobHolders.forEach((e=>{clearTimeout(e.timeoutId),e.resolver()})),this._currentJobHolders=[]}toggleGetJobFailed(e){this._failedGetJob=e}toggleAddJobFailed(e){this._failedAddJob=e}toggleDeleteJobFailed(e){this._failedDeleteJob=e}toggleDBError(e){this._hasDBError=e}_createJob(e){const{id:t,currentStep:s}=e;return this._updateStateOfCurrentJobByJobId(t,Ml),sc(s)?this._createJobFromGetFromOldDBCurrentStep(t,s):ic(s)?this._createJobFromAddToNewDBCurrentStep(t,s):nc(s)?this._createJobFromDeleteFromOldDBCurrentStep(t,s):void 0}_createJobFromGetFromOldDBCurrentStep(e,t){const s=Object(f.a)({},t),{mediaTableName:i,amount:n,lastMsgId:r}=s.dataToRun;return async()=>{try{await this._withRetry((async()=>{const t=this._createStep(s);if(!t)return void this._logger.zsymb(21,10719,30002,"[mm] getFromOldDBStep is undefined!");let a=await t();if(a.state===Il)throw a.data.jobId=e,a.data.jobType="GET_FROM_OLD_DB",a.data;const{data:o}=a;if(this._logger.zsymb(3,10719,30003,"[mm] getFromOldDBStep - DONE - jobId: {}, {}",e,o.length),o.length>=n?this._currentMsgIdCursor=o[o.length-1].msgId:this._mediaMigrationState&&this._mediaMigrationState.mediaTableNamesToMigrate.length&&(this._mediaMigrationState.mediaTableNamesToMigrate.shift(),this._currentMsgIdCursor=L.MessageConstants.MAX_MSG_ID),this._runMigration(),o.length){const t={name:vl,dataToRun:{mediaTableName:i,amount:n,lastMsgId:r,data:o}};this._updateCurrentStepByJobId(e,t);const s=this._createJobFromAddToNewDBCurrentStep(e,t);await s()}}))()}catch(t){this._logger.zsymb(3,10719,30004,"[mm] throw error from get from old DB step - jobId: {}, {}",e,null==t?void 0:t.message)}}}_createJobFromAddToNewDBCurrentStep(e,t){const s=Object(f.a)({},t),{mediaTableName:i,amount:n,lastMsgId:r}=s.dataToRun;return async()=>{try{await this._withRetry((async()=>{await this._persistCurrentJobDescs();const s=this._createStep(t);if(!s)return void this._logger.zsymb(18,10719,30005,"[mm] addToNewDBStep is undefined!");const a=await s();if(a.state===Il)throw a.data.jobId=e,a.data.jobType="ADD_TO_NEW_DB",a.data;const{data:o}=a;if(this._logger.zsymb(3,10719,30006,"[mm] addToNewDBStep - jobId: {}, {}",e,o.length),o.length){const t={name:bl,dataToRun:{mediaTableName:i,amount:n,lastMsgId:r,data:o}};this._updateCurrentStepByJobId(e,t);const s=this._createJobFromDeleteFromOldDBCurrentStep(e,t);await s()}}))()}catch(s){this._logger.zsymb(3,10719,30007,"[mm] throw error from add to new DB step - jobId: {}, {}",e,null==s?void 0:s.message)}}}_createJobFromDeleteFromOldDBCurrentStep(e,t){const s=Object(f.a)({},t);return async()=>{try{await this._withRetry((async()=>{await this._persistCurrentJobDescs();const t=this._createStep(s);if(!t)return void this._logger.zsymb(21,10719,30008,"[mm] deleteFromOldDBStep is undefined!");const i=await t();if(i.state===Il)throw i.data.jobId=e,i.data.jobType="DELETE_FROM_OLD_DB",i.data;this._logger.zsymb(3,10719,30009,"[mm] deleteFromOldDBStep - DONE - jobId: {}",e),this._currentJobDescs=this._currentJobDescs.filter((t=>t.id!==e)),this._currentJobHolders=this._currentJobHolders.filter((t=>t.jobId!==e)),this._persistCurrentJobDescs()}))()}catch(t){this._logger.zsymb(3,10719,30010,"[mm] throw error from delete from old DB step - jobId: {} - err: {}",e,null==t?void 0:t.message)}}}_updateCurrentStepByJobId(e,t){const s=this._currentJobDescs.find((t=>t.id===e));s&&(s.currentStep=t)}_updateStateOfCurrentJobByJobId(e,t){const s=this._currentJobDescs.find((t=>t.id===e));s&&(s.state=t)}async _persistCurrentJobDescs(){await this._mediaMigrationStatePersist.saveJobDescSummaries(this._currentJobDescs.reduce(((e,t)=>(t.currentStep.name!==fl&&e.push(this._toJobDescSummary(t)),e)),[]))}_createStep(e){return sc(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedGetJob)throw Error("[SIMULATE]: Failed to get job from old DB!");const{mediaTableName:t,amount:s,lastMsgId:n}=e.dataToRun,r=t,a=i.ModuleContainer.resolve(ds.a),o=await a.getMediasFromOldDB(r,s,n);return{state:yl,data:o}}catch(t){return this._logger.zsymb(21,10719,30011,"[mm] get from old db step err: {}",null==t?void 0:t.message),{state:Il,data:t}}}:ic(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedAddJob)throw Error("[SIMULATE]: Failed to add job to new DB!");let{mediaTableName:t,data:s,lastMsgId:n,amount:r}=e.dataToRun;const a=t,o=i.ModuleContainer.resolve(ds.a);let d=s;d||(d=await o.getMediasFromOldDB(a,r,n));const l=await o.addMediasFromOldDB(a,d);return{state:yl,data:l}}catch(t){return this._logger.zsymb(21,10719,30012,"[mm] add to new db step err: {}",null==t?void 0:t.message),{state:Il,data:t}}}:nc(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedDeleteJob)throw Error("[SIMULATE]: Failed to delete job from old DB!");const{mediaTableName:t,data:s,lastMsgId:n,amount:r}=e.dataToRun,a=t,o=i.ModuleContainer.resolve(ds.a);return s?{state:yl,data:await o.deleteMediasFromOldDB(a,s)}:{state:yl,data:await o.deleteMediasFromOldDBByRange(a,r,n)}}catch(t){return this._logger.zsymb(21,10719,30013,"[mm] delete from old db step err: {}",null==t?void 0:t.message),{state:Il,data:t}}}:void 0}async _loadData(){if(rc()||!Object(uc.a)())return;const e=await this.getMediaMigrationState();this._logger.zsymb(3,10719,30014,"[mm] MEDIA MIGRATION STATE after load data: {}",e.stateName),this._mediaMigrationState=e;const t=await this._mediaMigrationStatePersist.getSavedJobDescSummaries();t.length>0&&t.forEach((e=>{const t=this._toJobDesc(e);this._currentJobDescs.push(t);const s=this._createJob(t);if(s){const e=this._scheduleJob(t.id,s);this._worker.add(e,{priority:Mc})}})),this._isLoadData=!0}async _statsMediaMigration(){const e=i.ModuleContainer.resolve(ds.a),t=await Promise.all([e.countTotalMediaInOldDB("image"),e.countTotalMediaInOldDB("file"),e.countTotalMediaInOldDB("link")]);let s=ml,n=[];return s=t.reduce(((e,t,s)=>(0===s&&t>0?n.push("image"):1===s&&t>0?n.push("file"):2===s&&t>0&&n.push("link"),e+t)),0)>0?ml:gl,{stateName:s,remainingTableNames:n}}async _runMigration(){if(this._logger.zsymb(0,10719,30015,"[mm] ====================RUN MIGRATION===================="),!Object(uc.a)())return void this._logger.zsymb(0,10719,30016,"[mm] ==========STOP MIGRATION: not use new media DB flow (cfsv)==========");if(rc())return void this._logger.zsymb(0,10719,30017,"[mm] ==========STOP MIGRATION: stop migration (cfsv)==========");if(this._forceStop)return void this._logger.zsymb(0,10719,30018,"[mm] ==========STOP MIGRATION: force stop (in app)==========");if(!this._isLoadData&&(await this._loadData(),!this._isLoadData))return;if(this._mediaMigrationState.stateName===gl)return void this._logger.zsymb(0,10719,30019,"[mm] ==========STOP MIGRATION: migration done==========");const e=this._mediaMigrationState.mediaTableNamesToMigrate.length>0?this._mediaMigrationState.mediaTableNamesToMigrate[0]:"";if(!e){if(!this._currentJobDescs.length)return this._logger.zsymb(0,10719,30020,"[mm] ==========STOP MIGRATION: no media table to migrate=========="),this._stopListenEvents(),void(await this._mediaMigrationStatePersist.clearPersistedJobDescSummaries());this._logger.zsymb(0,10719,30021,"[mm] ==========STOP MIGRATION: no media table to migrate, but still have running jobs==========")}if(this._logger.zsymb(3,10719,30022,"[mm] worker pending: ",this._worker.pending),this._logger.zsymb(3,10719,30023,"[mm] worker size: ",this._worker.size),e){if(_c.value%this._maxWorkerPoolNum==0&&(await this._waitIn(this._delayTimeEachKJobs),this._forceStop||!Object(uc.a)()||rc()))return;const t={id:_c.next(),state:_l,currentStep:{name:fl,dataToRun:{mediaTableName:e,amount:this._mediaNumLimitPerJob,lastMsgId:this._currentMsgIdCursor}}},s=this._createJob(t);if(s){this._currentJobDescs.push(t);const e=this._scheduleJob(t.id,s);this._worker.add(e)}}else if(!this._currentJobDescs.length)return;this._worker.isPaused&&this._worker.start()}_listenEvents(){this._application.addEventListener(V.b.Idle,this._onApplicationIdle),this._application.addEventListener(V.b.Active,this._onApplicationActive),this._application.addEventListener(V.b.Exit,this._onApplicationExit)}_stopListenEvents(){this._application.removeEventListener(V.b.Idle,this._onApplicationIdle),this._application.removeEventListener(V.b.Active,this._onApplicationActive),this._application.removeEventListener(V.b.Exit,this._onApplicationExit)}_onApplicationIdle(){this._setupMigrationConfig({maxWorkerPoolNum:ac(),mediaNumLimitPerJob:lc(),delayTimePerJob:oc(),delayTimeEachKJobs:dc(),minRetryAfter:cc(),maxRetryAfter:hc()})}_onApplicationActive(){this._setupMigrationConfig({maxWorkerPoolNum:ac(),mediaNumLimitPerJob:lc(),delayTimePerJob:oc(),delayTimeEachKJobs:dc(),minRetryAfter:cc(),maxRetryAfter:hc()})}_onApplicationExit(){this.pauseMigration("EXIT_APP")}_toJobDescSummary(e){const{currentStep:t}=e;return{currentStep:{name:t.name,summaryData:{mediaTableName:t.dataToRun.mediaTableName,amount:t.dataToRun.amount,lastMsgId:t.dataToRun.lastMsgId}}}}_toJobDesc(e){let{currentStep:t}=e;return{id:_c.next(),state:_l,currentStep:{name:t.name,dataToRun:Object(f.a)(Object(f.a)({},t.summaryData),{},{data:void 0})}}}_setupMigrationConfig(e){"number"==typeof e.maxWorkerPoolNum&&(this._worker.concurrency=e.maxWorkerPoolNum),"number"==typeof e.mediaNumLimitPerJob&&(this._mediaNumLimitPerJob=e.mediaNumLimitPerJob),"number"==typeof e.delayTimePerJob&&(this._delayTimePerJob=e.delayTimePerJob),"number"==typeof e.delayTimeEachKJobs&&(this._delayTimeEachKJobs=e.delayTimeEachKJobs),"number"==typeof e.minRetryAfter&&(this._minRetryAfter=e.minRetryAfter),"number"==typeof e.maxRetryAfter&&(this._maxRetryAfter=e.maxRetryAfter)}_scheduleJob(e,t){return async()=>new Promise((t=>{const s=setTimeout((()=>{this._currentJobHolders=this._currentJobHolders.filter((t=>t.jobId!==e)),t()}),1e3*this._delayTimePerJob);this._currentJobHolders.push({jobId:e,timeoutId:s,resolver:t})})).then((()=>t()))}_withRetry(e){return t=e,s={retries:1/0,min:1e3*this._minRetryAfter,max:1e3*this._maxRetryAfter,shouldRetryOnError:async e=>{let{error:t,currentState:s}=e;return this._forceStop||rc()||!Object(uc.a)()?(this._updateStateOfCurrentJobByJobId(t.jobId,Cl),!1):"UnknownError"===t.name||"QuotaExceededError"===t.name||22===t.code?(this._updateStateOfCurrentJobByJobId(t.jobId,Cl),this.pauseMigration("DB_ERROR"),!1):(this._logger.zsymb(21,10719,30024,"[mm]: Retry - jobId: {} - jobType: {} - error: {}",t.jobId,t.jobType,t.message),!0)}},async function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];for await(const{sleep:a,duration:o,nTry:d}of bc(s))try{const e=await t(...i);return null!=s&&s.afterRetry&&(null==s||s.afterRetry({nTry:d,duration:o,sleep:a,success:!0,shouldRetry:!1})),e}catch(r){const e=null!=s&&s.shouldRetryOnError?null==s?void 0:s.shouldRetryOnError:()=>Promise.resolve(!0),t=await e({error:r,currentState:{nTry:d,duration:o,sleep:a},input:i});if(null!=s&&s.afterRetry&&(null==s||s.afterRetry({nTry:d,duration:o,sleep:a,shouldRetry:t,success:!1})),!t)throw new vc(fc);await a()}throw new vc(gc)};var t,s}async _waitIn(e){return this._logger.zsymb(3,10719,30025,"[mm]: waiting in {} seconds",e),new Promise((t=>{setTimeout(t,1e3*e)}))}_getTestMediaMigrationFlag(e){const t=T.a.getInstance().getItemForCurrentUser(e);try{return!!t&&JSON.parse(t)}catch(s){return!1}}_throwDBError(){const e=new Error("[SIMULATE]: DB is corrupted or quota is exceeded!");throw e.name="UnknownError",e.code=22,e}})||Ic)||Ic)||Ic)||Ic)||Ic)||Ic)||Ic);var Cc,Tc=s("zLd2");Object(i.injectable)()(Cc=Object(i.singleton)(Tc.c)(Cc=function(e,t){return Object(i.inject)(Jl)(e,void 0,0)}(Cc=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,1)}(Cc=Reflect.metadata("design:type",Function)(Cc=Reflect.metadata("design:paramtypes",[Object,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(Cc=class{constructor(e,t){this._utilsMediaAppService=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaAppService=e,Dt.a.ConvInfoDataManager.addEventListener(zt.b.DeleteConv,this._onDeleteConversation.bind(this)),Dt.a.ConvInfoDataManager.addEventListener(zt.b.EmptyConv,this._onEmptyConversation.bind(this)),this._logger=t.createZLogger(Tc.b,["manage-utils-media-in-ui"]),this._log=Kl(this._logger)}create(e){return this._utilsMediaAppService.create(e)}createOrUpdate(e){return this._utilsMediaAppService.createOrUpdate(e)}async createOrUpdateFromMedias(e){return this._utilsMediaAppService.createOrUpdateFromMedias(e)}_onDeleteConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}_onEmptyConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}})||Cc)||Cc)||Cc)||Cc)||Cc);var Oc,Ec=s("Mlp7");Object(i.injectable)()(Oc=Object(i.singleton)(ds.a)(Oc=function(e,t){return Object(i.inject)(Tc.c)(e,void 0,0)}(Oc=function(e,t){return Object(i.inject)(Vl)(e,void 0,1)}(Oc=function(e,t){return Object(i.inject)(xl)(e,void 0,2)}(Oc=function(e,t){return Object(i.inject)(zd)(e,void 0,3)}(Oc=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,4)}(Oc=Reflect.metadata("design:type",Function)(Oc=Reflect.metadata("design:paramtypes",[void 0===Tc.IUtilsMediaManager?Object:Tc.IUtilsMediaManager,Object,Object,Object,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(Oc=class{constructor(e,t,s,i,n){this._utilsMediaManager=void 0,this._mediaMapperFactory=void 0,this._mediaRepositoryFactory=void 0,this._mediaPrimaryKeyConvertor=void 0,this._logger=void 0,this._utilsMediaManager=e,this._mediaRepositoryFactory=t,this._mediaMapperFactory=s,this._mediaPrimaryKeyConvertor=i,this._logger=n.createZLogger("media-manager",[""])}filter(e,t){return Object(uc.a)()?El.filterMedia(e,t):Ec.a.filter(e,t)}getMediaRepository(e,t){void 0===t&&(t=!0);const s=this._mediaRepositoryFactory.getMediaRepository(e);if(!s&&t)throw Error(`[getMediaRepository]: can't get mediaRepository has mediaType: ${e}!`);return s}getMediaMapper(e,t){void 0===t&&(t=!0);const s=this._mediaMapperFactory.getMediaMapper(e);if(!s&&t)throw Error(`[getMediaMapper]: can't get mediaMapper has mediaType: ${e}!`);return s}async _isMigrationDone(){return(await i.ModuleContainer.resolve(Dl.c).getMediaMigrationState()).stateName===gl}async isExistedMedia(e,t){try{if(!e)throw Error("mediaType is invalid!");if(!t)throw Error("mediaIdObj is invalid!");const s=this.getMediaRepository(e);return await s.isExistedMedia({newId:t.newId||"",oldId:t.oldId||""})}catch(s){return this._logger.zsymb(18,11051,3e4,`[isExistedMedia]: error: ${s.message}`),!1}}async addMedias(e,t,s){void 0===s&&(s=`${Xd.c.UNKNOWN}${Xd.d.UNKNOWN}`);try{if(!e)throw Error("mediaType is undefined!");if(!t||!t.length)return;const i=this.getMediaRepository(e),n=this.getMediaMapper(e),r=t.map((t=>(t.src=s,"image"===e&&(t.subType=L.MSG_SUBTYPE_MEDIA_DOODLE),n.toDomainFromDTO(t)))),a=(await i.insertMulti(r)).success.map((t=>this.getMediaMapper(e).toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(t)));await this._utilsMediaManager.createOrUpdateFromMedias(a)}catch(i){this._logger.zsymb(21,11051,30001,"[addMedias] - err: {}",i.message)}}addMediaToConvOnly(e,t){var s,i,n;if(void 0===t&&(t=`${Xd.c.UNKNOWN}${Xd.d.UNKNOWN}`),!Object(uc.a)())return Ec.a.addMediaToConversationOnly(e);let r=[];if(null!=e&&null!==(s=e.image)&&void 0!==s&&s.length){const s=this.getMediaRepository("image"),i=this.getMediaMapper("image");r.push(null==s?void 0:s.insertMulti(e.image.map((e=>(e.src=t,i.toDomainFromDTO(e))))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("image").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}if(null!=e&&null!==(i=e.link)&&void 0!==i&&i.length){const s=this.getMediaRepository("link"),i=this.getMediaMapper("link");r.push(null==s?void 0:s.insertMulti(e.link.map((e=>{e.src=t;return i.toDomainFromDTO(e)}))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("link").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}if(null!=e&&null!==(n=e.file)&&void 0!==n&&n.length){const s=this.getMediaRepository("file"),i=this.getMediaMapper("file");r.push(s.insertMulti(e.file.map((e=>(e.src=t,i.toDomainFromDTO(e))))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("file").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}return Promise.all(r)}async deleteMediasById(e,t){try{if(!t)throw Error("mediaIdObjs is undefined!");const a=Array.isArray(t)?[...t]:[t];for(const e of a){const{newId:t,oldId:s}=e;if(!t&&s){const t=await this.getMediaFieldsByMsgId(s);e.newId=t?`${t.cliMsgId}_${t.fromUid}_${t.toUid}`:""}}const o=this.getMediaRepository(e,!1),d=[];for(const e of a)d.push(Object(f.a)(Object(f.a)({},e),{},{deleteTo:await this._isMigrationDone()?hl.NEW:hl.UNKNOWN}));if(o)await o.deleteMultiMedias(d);else{var s,n,r;const e=[];e.push(null===(s=i.ModuleContainer.resolve(wl))||void 0===s?void 0:s.deleteMultiMedias(d),null===(n=i.ModuleContainer.resolve(Rl))||void 0===n?void 0:n.deleteMultiMedias(d),null===(r=i.ModuleContainer.resolve(Nl))||void 0===r?void 0:r.deleteMultiMedias(d)),await Promise.all(e)}}catch(a){this._logger.zsymb(18,11051,30002,a)}}async getValidMediasOfConv(e,t,s,i,n){try{if(!t)return Promise.resolve([]);const r={cliMsgId:L.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(L.MessageConstants.MAX_SENDDTTM),msgId:i||L.MessageConstants.MAX_MSG_ID};if(i){const e=await this.getMediaFieldsByMsgId(i);e&&(r.cliMsgId=e.cliMsgId,r.sendDttm=e.sendDttm)}const a=Ec.a.getLastDeleteConv(t,e),o=this.getMediaRepository(e),d=await o.getMediasOfConv(t,r,s,Object(f.a)(Object(f.a)({},n),{},{deletePointOfConv:a}));if(!d.length)return[];const l=this.getMediaMapper(e);return await Promise.all(d.map((e=>l.toDTO(e))))}catch(r){return this._logger.zsymb(18,11051,30003,r),Promise.resolve([])}}async getLastMediasOfConvWithoutCorrectData(e,t,s,i,n){if(void 0===i&&(i=100),!Object(uc.a)())return Ec.a.getLastMediaFromConversation(t,e,i,s);try{if(!t)return Promise.resolve([null,Error("convId is undefined!")]);const r={cliMsgId:L.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(L.MessageConstants.MAX_SENDDTTM),msgId:s||pt.default.load_media.use_max_id||L.MessageConstants.MAX_MSG_ID};if(null!=n&&n.lastItemOpts)r.cliMsgId=n.lastItemOpts.cliMsgId,r.sendDttm=n.lastItemOpts.sendDttm;else if(s){const e=await this.getMediaFieldsByMsgId(s);e&&(r.cliMsgId=e.cliMsgId,r.sendDttm=e.sendDttm)}const a=this.getMediaRepository(e),o=await a.getLastMediasOfConv(t,r,i);return[await Promise.all(o.map((t=>this.getMediaMapper(e).toDTO(t)))),null]}catch(r){return this._logger.zsymb(18,11051,30004,r),[null,r]}}async updateMedia(e,t,s,i){if(!Object(uc.a)()){const n=Object(f.a)(Object(f.a)({},s),{},{msgId:t});return Ec.a.updateMedia(n,e,i)}return this._updateMedia(e,t,s,i)}loadingPendingMedias(){return Object(uc.a)()?new Promise(((e,t)=>{let s=Me.default.getAllPendingMediaIds();if(this._logger.zsymb(3,11051,30005,"[loadingPendingMedias]: {}",JSON.stringify(s)),s&&bt.default.mapHasItem(s)){let t={};for(let e in s)t[e]=this.getMultiMedias(e,s[e]);bt.default.join(t).then(e).catch((t=>{e(null)}))}else e(null)})):Ec.a.loadAllPendingMedia()}async countMediaOfConv(e,t,s){try{t||Promise.resolve({ok:!0,result:0,error:null});const{from:i,to:n}=s;i.cliMsgId=i.cliMsgId?i.cliMsgId:"",i.sendDttm=i.sendDttm?i.sendDttm:0,i.msgId=i.msgId?i.msgId:"",n.cliMsgId=n.cliMsgId?n.cliMsgId:L.MessageConstants.MAX_MSG_ID,n.sendDttm=n.sendDttm?n.sendDttm:parseInt(L.MessageConstants.MAX_SENDDTTM),n.msgId=n.msgId?n.msgId:L.MessageConstants.MAX_MSG_ID;const r=this.getMediaRepository(e);return{ok:!0,result:await r.countMediaOfConv(t,{from:Object(f.a)({},i),to:Object(f.a)({},n)}),error:null}}catch(i){return this._logger.zsymb(18,11051,30006,i),{ok:!1,result:0,error:i}}}async getMediaFieldsByMsgId(e){if(!e)return Promise.resolve(void 0);const t=await K.a.getInstance().Core.Message.get(e);return t?{cliMsgId:"number"==typeof t.cliMsgId?t.cliMsgId.toString():t.cliMsgId,fromUid:t.fromUid,toUid:t.toUid,sendDttm:"string"==typeof t.sendDttm?parseInt(t.sendDttm):t.sendDttm}:Promise.resolve(void 0)}async getAllValidPhotoAndVideosOfConv(e){if(!Object(uc.a)())return Ec.a.getAllMediaFromConv(e);let t=!0,s={cliMsgId:L.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(L.MessageConstants.MAX_SENDDTTM),msgId:L.MessageConstants.MAX_MSG_ID},i=[],n=[];for(;t;){const r=await this.getValidMediasOfConv("image",e,50,s.msgId);t=r.length>=50;let a=s;if(r.length){if(r.forEach((e=>{e&&e.subType==L.MSG_SUBTYPE_MEDIA_VIDEO?i.push(e):!e||e.subType!=L.MSG_SUBTYPE_PHOTO&&e.subType!==L.MSG_SUBTYPE_MEDIA_DOODLE||n.push(e)})),a={cliMsgId:r[r.length-1].cliMsgId,sendDttm:r[r.length-1].sendDttm,msgId:r[r.length-1].msgId},a.msgId==s.msgId)break;s=a}}return{photos:n,videos:i}}async getImageMessagesForPhotoViewer(e,t,s,n,r,a){if(!Object(uc.a)())return Me.default.getImagesForPhotoViewer({userId:e},t,s,n,r,a);try{var o;if(!e||!t)throw Error("convId or lastMsgId is undefined!");const d=await this.getMediaFieldsByMsgId(t);return await(null===(o=i.ModuleContainer.resolve(wl))||void 0===o?void 0:o.getImageMessagesForPhotoViewer(e,s,{sendDttm:(null==d?void 0:d.sendDttm)||parseInt(L.MessageConstants.MAX_SENDDTTM),cliMsgId:(null==d?void 0:d.cliMsgId)||L.MessageConstants.MAX_MSG_ID,msgId:t},n,r,a))}catch(d){return this._logger.zsymb(18,11051,30007,d),[]}}async getLastestAddedFiles(e,t){if(void 0===t&&(t=40),!Object(uc.a)())return Me.default.getLatestFiles(e,t);try{if(!e){e=Date.now();let t=Mi.a.getTimeNow();e=e>t?e:t}const s=L.MessageConstants.MAX_CONVERSATION_ID,n=parseInt(L.MessageConstants.MAX_MSG_ID),r=i.ModuleContainer.resolve(Rl),a=await r.getLastestAddedFiles({convId:s,sendDttm:e,cliMsgId:n},t);if(a.length>0){const e=this.getMediaMapper("file");return await Promise.all(a.map((t=>e.toDTO(t))))}return[]}catch(s){return this._logger.zsymb(18,11051,30008,"[getLastestAddedFiles] - err: ",s),Promise.resolve([])}}async getMultiMedias(e,t){if(!Object(uc.a)())return Me.default.getMediaByIds(e,t);try{if(!t||t.length<0)throw Error("msgIds is undefined or empty!");const s=[],i=t.map((e=>this.getMediaFieldsByMsgId(e).then((async t=>{s.push({newId:t?`${t.cliMsgId}_${t.fromUid}_${t.toUid}`:"",oldId:e,getFrom:await this._isMigrationDone()?cl.NEW:cl.UNKNOWN})}))));if(await Promise.all(i),!s.length)return[];const n=(await this.getMediaRepository(e).getMultiMedias(s)).filter(Boolean);return n.length>0?await Promise.all(n.map((t=>this.getMediaMapper(e).toDTO(t)))):[]}catch(s){return this._logger.zsymb(18,11051,30009,"[getMultiMedias] - err: ",s),[]}}async getMediaById(e,t){try{if(!t)throw Error("mediaId is undefined!");const s=await this.getMediaFieldsByMsgId(t),i=this.getMediaRepository(e),n=await i.getMedia({newId:s?`${s.cliMsgId}_${s.fromUid}_${s.toUid}`:"",oldId:t},void 0,await this._isMigrationDone()?cl.NEW:cl.UNKNOWN);return n?await this.getMediaMapper(e).toDTO(n):void 0}catch(s){return this._logger.zsymb(18,11051,30010,"[getMediaById] - err: ",s),Promise.resolve(void 0)}}async _updateMedia(e,t,s,i){try{if(!t)throw Error("mediaId isn't valid!");if(!s)throw Error("mediaValue isn't valid!");const i=this.getMediaRepository(e),n=await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(t),r=this.getMediaMapper(e).toNewEAttsFromDTOAtts(s);return await i.updateMedia({newId:n,oldId:t},{attributes:Object.keys(r),value:r,ignoreNotFound:!0},await this._isMigrationDone()?ll.NEW:ll.UNKNOWN)}catch(n){return this._logger.zsymb(21,11051,30011,"[_updateMedia] - err: {}",n.message),!1}}async _addMediasWhenTransferMessageOldFlow(e){try{const t=[],s=[],i=[];for(let r=0;r<e.length;r++){const n=e[r],a=n.msgType;switch(a){case L.MSG_PHOTO:case L.MSG_PHOTO_2:case L.MSG_DOODLE:a==L.MSG_DOODLE&&n.message&&(n.message.thumbUrl=n.message.oriUrl),bt.default.isPhotoStickerMessage(n)||s.push({msgId:n.msgId,userId:n.toUid,message:n.message,sendDttm:n.sendDttm,fromUid:n.fromUid,subType:L.MSG_SUBTYPE_PHOTO,type:"image",ttl:n.ttl,cliMsgId:n.cliMsgId});break;case L.MSG_FILE:t.push({msgId:n.msgId,userId:n.toUid,message:n.message,sendDttm:n.sendDttm,fromUid:n.fromUid,type:"file",ttl:n.ttl,cliMsgId:n.cliMsgId});break;case L.MSG_CONTACT:"recommened.link"===n.message.action&&i.push({msgId:n.msgId,userId:n.toUid,message:n.message,sendDttm:n.sendDttm,fromUid:n.fromUid,type:"link",ttl:n.ttl,cliMsgId:n.cliMsgId});break;case L.MSG_VIDEO:s.push({msgId:n.msgId,userId:n.toUid,message:n.message,sendDttm:n.sendDttm,fromUid:n.fromUid,subType:L.MSG_SUBTYPE_MEDIA_VIDEO,type:"image",ttl:n.ttl,cliMsgId:n.cliMsgId})}}let n=[];return s.length>0&&n.push(K.a.getInstance().Core.Image.insertMulti(s)),i.length>0&&n.push(K.a.getInstance().Core.Link.insertMulti(i)),t.length>0&&n.push(K.a.getInstance().Core.File.insertMulti(t)),await Promise.all(n)}catch(t){this._logger.zsymb(18,11051,30012,"[_addMediasWhenTransferMessageOldFlow] - err: ",t.message)}}async _addMediasFromMessages(e,t){try{if(!e||!e.length)return;t=t||`${Xd.c.UNKNOWN}${Xd.d.FROM_MSG}`;const s=[],i=[],n=[],r=this.getMediaMapper("image"),a=this.getMediaMapper("file"),o=this.getMediaMapper("link");e.forEach((e=>{const d=e.msgType;switch(d){case L.MSG_PHOTO:case L.MSG_PHOTO_2:case L.MSG_DOODLE:d===L.MSG_DOODLE?(e.message&&(e.message.thumbUrl=e.message.oriUrl),s.push(r.toDomainFromTMessage(e,L.MSG_SUBTYPE_MEDIA_DOODLE,t))):bt.default.isPhotoStickerMessage(e)||s.push(r.toDomainFromTMessage(e,L.MSG_SUBTYPE_PHOTO,t));break;case L.MSG_FILE:i.push(a.toDomainFromMessage(e,t));break;case L.MSG_CONTACT:"recommened.link"===e.message.action&&n.push(o.toDomainFromMessage(e,t));break;case L.MSG_VIDEO:s.push(r.toDomainFromTMessage(e,L.MSG_SUBTYPE_MEDIA_VIDEO,t))}}));let d=[];return s.length>0&&d.push(this.getMediaRepository("image").insertMulti(s).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("image").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),i.length>0&&d.push(this.getMediaRepository("file").insertMulti(i).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("file").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),n.length>0&&d.push(this.getMediaRepository("link").insertMulti(n).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("link").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),await Promise.all(d)}catch(s){this._logger.zsymb(21,11051,30013,"[addMediasFromMessages] - err: {}",JSON.stringify(s))}}async _addMediasAtExportImportFlowOldFlow(e){if(!e||!e.length)return;const t=[],s=[],i=[];e.forEach((e=>{if(e.msgType===L.MSG_FILE)s.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,localPath:e.localPath,fromUid:e.fromUid,type:"file",ttl:e.ttl});else if(e.msgType===L.MSG_CONTACT)"recommened.link"===e.message.action&&i.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"link",ttl:e.ttl});else if(e.msgType!==L.MSG_PHOTO&&e.msgType!==L.MSG_PHOTO_2&&e.msgType!==L.MSG_DOODLE||bt.default.isPhotoStickerMessage(e))e.msgType===L.MSG_VIDEO&&t.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"image",subType:L.MSG_SUBTYPE_MEDIA_VIDEO,ttl:e.ttl});else{const s={msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"image",subType:L.MSG_SUBTYPE_PHOTO,ttl:e.ttl};e.msgType===L.MSG_DOODLE&&(s.subType=L.MSG_SUBTYPE_MEDIA_DOODLE,s.message.thumbUrl=s.message.oriUrl),t.push(s)}})),s.length&&Me.default.addFilesToConversation(s),i.length&&Me.default.addLinksToConversation(i),t.length&&Me.default.addOrUpdateImagesToConversation(t)}async _addMediasFromMessagesWhenBackupOldFlow(e){if(!e||!e.length)return;const t=[],s=[],i=[];e.forEach((e=>{e.msgType===L.MSG_FILE?s.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,localPath:e.localPath,fromUid:e.fromUid,ttl:e.ttl}):e.msgType===L.MSG_CONTACT&&"recommened.link"===e.message.action?i.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,ttl:e.ttl}):e.msgType!==L.MSG_PHOTO&&e.msgType!==L.MSG_PHOTO_2&&e.msgType!==L.MSG_DOODLE||bt.default.isPhotoStickerMessage(e)||t.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,ttl:e.ttl})})),s.length&&Me.default.addFilesToConversation(s),i.length&&Me.default.addLinksToConversation(i),t.length&&Me.default.addOrUpdateImagesToConversation(t)}async _emptyOldMediaStore(e,t){const s={from:[t,0,""],to:[t,L.MessageConstants.MAX_MSG_ID.length,L.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},i={index:"userId_sendDttm_msgId",direction:ul.CursorDirection.PREV},n=await e.getAllKey(s,i);null!=n&&n.length&&await e.deleteMulti(n)}async _emptyNewMediaStore(e,t){const s={from:[t,0,""],to:[t,parseInt(L.MessageConstants.MAX_SENDDTTM),L.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},i={index:"convId_sendDttm_cliMsgId",direction:ul.CursorDirection.PREV},n=await e.getAllKey(s,i);null!=n&&n.length&&await e.deleteMulti(n)}async updateFile(e,t,s){return Object(uc.a)()?this._updateMedia("file",e,t,s):!!(await Me.default.updateFile(e,t,s))}async getMediaFromConversationWhenDownloadOldMedia(e,t,s,i){if(!Object(uc.a)())return Ec.a.getMediaFromConversation({userId:e},i,t,s);const n=i.substring(0,i.length-1),r=await this.getValidMediasOfConv(n,e,t,s,null);return r.length>0?r.map((e=>({userId:e.userId,sendDttm:e.sendDttm,msgId:e.msgId,message:{href:e.message.href,params:e.message.params||""},type:e.type,subType:"image"===e.type?e.subType:-1}))):[]}getMediaFromConversation(e,t,s,i,n){if(!Object(uc.a)())return Ec.a.getMediaFromConversation({userId:t},e,s,i,n);const r=e.substring(0,e.length-1);return this.getValidMediasOfConv(r,t,s,i,n)}async deleteMediaWhenDeleteMsg(e,t){if(!Object(uc.a)())return void Me.default.deleteMediaItem(e);let s="";if(null!=t&&t.mediaIdKeys){const{cliMsgId:e,fromUid:i,convId:n}=t.mediaIdKeys;s=`${e}_${i}_${n}`}else s=await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(e);this.deleteMediasById("",{newId:s,oldId:e})}async deleteMediaItems(e,t,s){if(!t)return[];if(!Object(uc.a)())return Ec.a.deleteMediaItem(t,e);let i=[];i=null!=s&&s.mediaIdKeysArr&&s.mediaIdKeysArr.length?s.mediaIdKeysArr.map((e=>`${e.cliMsgId}_${e.fromUid}_${e.convId}`)):await Promise.all(t.map((e=>this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(e))));const n=t.map(((e,t)=>({oldId:e,newId:i[t]})));return this.deleteMediasById(e,n)}async addLinksToConversation(e){Object(uc.a)()?this.addMedias("link",e):Me.default.addLinksToConversation(e)}async getFilesFromConversation(e,t,s){return Object(uc.a)()?this.getValidMediasOfConv("file",e,t,s,null):Me.default.getFilesFromConversation({userId:e},t,s)}async addMediasWhenTransferMessage(e,t,s){return s?this._addMediasFromMessages(e,t):this._addMediasWhenTransferMessageOldFlow(e)}async addMediasAtExportImportFlow(e,t){return Object(uc.a)()?this._addMediasFromMessages(e,t):this._addMediasAtExportImportFlowOldFlow(e)}async addMediasFromMessagesWhenBackup(e,t){return Object(uc.a)()?this._addMediasFromMessages(e,t):this._addMediasFromMessagesWhenBackupOldFlow(e)}async deleteImageByMsgId(e,t){if(!Object(uc.a)())return Me.default.deleteImageByMsgId(e);let s="";return s=null!=t&&t.mediaIdKeys?`${t.mediaIdKeys.cliMsgId}_${t.mediaIdKeys.fromUid}_${t.mediaIdKeys.convId}`:await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(e),await this.deleteMediasById("image",{newId:s,oldId:e}),!0}async doAddMediaToConversation(e,t){return Object(uc.a)()?this.addMedias(e,t):Ec.a.doAddMediaToConversation(t,e)}async updateMsgIdForRelativeMedia(e,t,s){const{imageStore:i,fileStore:n,linkStore:r}=e;if(Object(uc.a)()){const e=(e,t,s)=>{this.getMediaById(e,s).then((i=>{i&&(i.msgId=t,this.deleteMediasById(e,{newId:void 0,oldId:s}).then((()=>{this.addMedias(e,[i])})))}))};e("file",t,s),e("image",t,s),e("link",t,s)}else{const e=(e,t,s)=>{e.get(s).then((i=>{i&&(i.msgId=t,e.delete(s).then((()=>{e.insert(i)})))}))};n&&e(n,t,s),i&&e(i,t,s),r&&e(r,t,s)}}async emptyMediaStores(e,t){e&&t&&t.length&&(Object(uc.a)()?t.forEach((t=>{"file"===t?this._emptyNewMediaStore(K.a.getInstance().Media.File,e):"image"===t?this._emptyNewMediaStore(K.a.getInstance().Media.Image,e):"link"===t&&this._emptyNewMediaStore(K.a.getInstance().Media.Link,e)})):t.forEach((t=>{"file"===t?this._emptyOldMediaStore(K.a.getInstance().Core.File,e):"image"===t?this._emptyOldMediaStore(K.a.getInstance().Core.Image,e):"link"===t&&this._emptyOldMediaStore(K.a.getInstance().Core.Link,e)})))}async addMediasFromOldDB(e,t){if(!t||!t.length)return[];const s=this.getMediaRepository(e),i=Ec.a.getAllDeleteConv();let n=t,r=t.map((e=>e.msgId));if(i){const s=t.reduce(((t,s)=>{var n;const{userId:r}=s;if(null!==(n=i[r])&&void 0!==n&&n[e]){const n=s.msgId,a=i[r][e].lastId;a&&n&&a<n&&t.oldMediaEntitiesShouldAddToNewDB.push(s)}else t.oldMediaEntitiesShouldAddToNewDB.push(s);return t.oldMediaIdsShouldDeleteFromOldDB.push(s.msgId),t}),{oldMediaEntitiesShouldAddToNewDB:[],oldMediaIdsShouldDeleteFromOldDB:[]});n=s.oldMediaEntitiesShouldAddToNewDB,r=s.oldMediaIdsShouldDeleteFromOldDB}const a=await s.correctMediasInOldDB(n,{saveBack:!1}),o=this.getMediaMapper(e),d=a.map((e=>o.toDomainFromOldDomain(e))),l=await s.insertMulti(d);if(l.success.length){const e=l.success.map((e=>o.toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));return this._utilsMediaManager.createOrUpdateFromMedias(e),r}return[]}async getMediasFromOldDB(e,t,s){if(await this._isMigrationDone())return[];const i={from:"",to:s,excludeFrom:!0,excludeTo:!0},n={index:"primary",direction:ul.CursorDirection.PREV,limit:t};return this.getMediaRepository(e).getOldDBTable().getAll(i,n)}async deleteMediasFromOldDB(e,t){const s=this.getMediaRepository(e);return(await s.getOldDBTable().deleteMulti(t)).success}async deleteMediasFromOldDBByRange(e,t,s){const i={from:"",to:s,excludeFrom:!0,excludeTo:!0},n={index:"primary",direction:ul.CursorDirection.PREV,limit:t},r=this.getMediaRepository(e),a=await r.getOldDBTable().getAllKey(i,n);return(await r.getOldDBTable().deleteMulti(a)).success}async countTotalMediaInOldDB(e){try{return this.getMediaRepository(e).getOldDBTable().count()}catch(t){return this._logger.zsymb(18,11051,30014,"[countTotalMediaInOldDB] - err: ",t),0}}async _testAddMedias(e,t){void 0===t&&(t=50);let s=[];const i=2*Date.now()+Math.round(1e5*Math.random())+1e3,n=5*Date.now()+Math.round(1e7*Math.random())+1e3,r=["0","123456123111111456","12345111111345","111111111111111","12345111111167890","2121212121112222121","1231231231232222123","22222222222222222","2111111111111222111","322222222222222222","12341234212341123","9753434346787646","1234123412341234","987651235545454545","123123455432123432","21212123443434545","5454544531321323","98909087567564545645"],a=["4037840159631073270",...JSON.parse('["101598415","124139871","147333052","169079931","194945127","200868372","225822710","276214855","355712826","361879215","910825795994501468","g100588026","g112969450","g1149397433596350988","g1352476194718464059","g147262698","g149205131","g158719108","g158754949","g160924468","g164283274","g175572981","g194334627","g230291933","g2426404535463764819","g245533229","g25193586","g257364624","g263690118","g285979907","g285992315","g28757702","g288999008","g289367881","g293290840","g301757910","g302249930","g302577276","g309222362","g312505929","g317894641","g318028102","g320951866","g321466298","g322706780","g325920125","g325933426","g328827910","g331912501","g34509241","g47431271","g5355130437069108654","g55402697","g6911969691454201107","g85951308"]')];switch(e){case"image":for(let e=0;e<t;e++){const t=r[Math.round(Math.random()*(r.length-1))],o=a[Math.round(Math.random()*(a.length-1))],d=i+e,l=n+e;s.push({userId:o,cliMsgId:d,fromUid:t,msgId:l.toString(),message:{hdUrl:"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln",oriUrl:"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln",params:'{"width":800,"height":800,"hd":"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln","rawThumbUrl":"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg"}',thumbUrl:"https://f62-zpg-r.zdn.vn/1518777612491889561/5571c987a1187b462209.jpg?e2esession=YBl+XgC1U90bnMk4yPcU519rhnRW4KoItoeNXLpRsl/secNpaT3Nxkal57Nj3UZhy2rUFgxhf8Pcjwah",title:void 0},type:"image",isExpired:!1,isExpiredAll:!1,subType:Math.round(Math.random())?L.MSG_SUBTYPE_PHOTO:L.MSG_SUBTYPE_MEDIA_VIDEO,sendDttm:Date.now()+e,ttl:0,localPath:null,previewThumb:void 0,updateTime:Date.now(),width:0,height:0})}break;case"file":for(let e=0;e<t;e++){const t=r[Math.round(Math.random()*(r.length-1))],o=a[Math.round(Math.random()*(a.length-1))],d=i+e,l=n+e;s.push({userId:o,cliMsgId:d,fromUid:t,msgId:l.toString(),message:{href:"https://f27-group-zfr.zdn.vn/7f8b522a54e0babee3f1/117090926800068678?e2esession=RSHmz0Kj28vN9gMz6oFilBjFxVFqisUPnj3XpjlolXXpTo3bwJ0hqlUl5uR6Sr/wtHrtcyXqXj/mLYl3",params:'{"fileSize":8178,"checksum":"78c2c03eeab27abbdf28b0fe25088e30","checksumSha":"","fileExt":"xlsx","fdata":"{}","fType":1}',title:"program_matrix_laP5chSikftFYc_LmERud.xlsx"},type:"file",fileType:-1,extType:"",sendDttm:Date.now()+e,ttl:0,updateTime:Date.now(),localPath:null,folderPath:null,previewThumb:"",dimension:null,downloadError:!1,isExpired:!1,isExpiredAll:!1})}break;case"link":for(let e=0;e<t;e++){const t=r[Math.round(Math.random()*(r.length-1))],o=a[Math.round(Math.random()*(a.length-1))],d=i+e,l=n+e;s.push({userId:o,cliMsgId:d,fromUid:t,msgId:l.toString(),message:{action:"recommened.link",childnumber:0,description:"http://tinhte.vn",href:"http://tinhte.vn",oriUrl:"http://tinhte.vn",params:'{"mediaTitle":"http://tinhte.vn","artist":"","src":"tinhte.vn","stream_icon":"","streamUrl":"","type":0,"subType":3}',thumb:"",thumbUrl:"",title:"tinhte.vn",type:""},type:"link",sendDttm:Date.now()+e,ttl:0,updateTime:Date.now(),previewThumb:""})}}const o=this._getMediaDB(e,!1);await(null==o?void 0:o.insertMulti(s))}_getMediaDB(e,t){const s=K.a.getInstance();switch(e){case"image":return t?s.Media.Image:s.Core.Image;case"file":return t?s.Media.File:s.Core.File;case"link":return t?s.Media.Link:s.Core.Link}}})||Oc)||Oc)||Oc)||Oc)||Oc)||Oc)||Oc)||Oc);var Sc,wc=s("lT2C"),Lc=s("C8zZ"),Dc=s("wmCV"),Fc=s("xdZB");let Rc=Object(Bt.b)(Lc.GroupPollManager)(Sc=function(e,t){return i.ModuleContainer.inject(Nt.b)(e,void 0,0)}(Sc=Reflect.metadata("design:type",Function)(Sc=Reflect.metadata("design:paramtypes",[void 0===Nt.b?Object:Nt.b])(Sc=class{constructor(e){this.convDataManager=e,this._Logger=void 0,this.pollCache=void 0,this.pollCache=new U.default({maxSize:1e4}),this.setUpEvent()}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.pollV3,[ns.b.groupPollManager])),this._Logger}updatePollCache(e,t){this.pollCache.set(e,t)}removePollCacheBelongsToConv(e){Array.from(this.pollCache.entriesAscending()).forEach((t=>{let[s,i]=t;i.group_id===bt.default.getGroupIdFromConversationId(e)&&this.pollCache.delete(s)}))}setUpEvent(){this.convDataManager.addEventListener(zt.b.DeleteConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(zt.b.EmptyConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(zt.b.LeaveGroup,(e=>{this.removePollCacheBelongsToConv(e.convId)}))}isAdmin(e,t){var s;const i=ts.default.getGroupByIdSync(e);if(!i)return!1;if(t===i.creatorId)return!0;let n=!1;return null===(s=i.topMember)||void 0===s||s.forEach((e=>{e.id===t&&e.isAdmin&&(n=!0)})),n}isAllowSetTopic(e){var t;const s=ts.default.getGroupByIdSync(e);return!!s&&!(!pt.default.group_topics.enable||null!==(t=s.setting)&&void 0!==t&&t.setTopicOnly)}isEnablePin(e){return this.isAdmin(e,Je.default.getUidMe())||this.isAllowSetTopic(e)}isEnableClose(e,t){const s=Je.default.getUidMe();return this.isAdmin(e,s)||s===t}createPollRequestData(e){const{pollData:t,groupId:s,src:i}=e,n={question:t.question,options:t.options,expired_time:t.expiredTime,pinAct:t.pinAct,allow_multi_choices:t.allowMultiChoices,allow_add_new_option:t.allowAddNewOption,is_hide_vote_preview:t.isHideVotePreview,is_anonymous:t.isAnonymous,poll_type:t.pollType};return{groupId:bt.default.getGroupIdFromConversationId(s),pollData:n,src:i}}async createPoll(e){const t=e.pollData.pinAct,{groupId:s,pollData:i,src:n}=this.createPollRequestData(e);try{const r=await vt.default.createPoll(s,i,n);t&&this.pinPoll(r.poll_id,e.groupId,r.question)}catch(r){throw this.Logger.zsymb(18,10716,3e4,r),r}}getPollDetailSync(e){return this.pollCache.get(e)}async getPollDetail(e,t){let s=this.getPollDetailSync(e);if(s)return s;if(s=await Me.default.getPollInfo(e),!s){if(t)return this.getPollDetailFromServer(e);throw Error("Poll isn't existed in DB")}return this.pollCache.set(e,s),s}async getPollDetailFromServer(e,t){const s=await vt.default.getPollDetail(t,e,!1);if(!s)throw Error("Poll isn't existed in Server");return this.pollCache.set(e,s),s}async pinPoll(e,t,s){let i=s;if(!i){let t=this.getPollDetailSync(e);if(t||(t=await this.getPollDetail(e)),!t)throw Error("Poll isn't existed");i=t.question}Dc.a.pinFromBoard({userId:t},{poll_id:e,isPoll:!0,question:i},null,null,Fc.a.getWinIdByConvId(t))}unpinPoll(e,t){Dc.a.unpinFromBoard(t,{poll_id:e,isPoll:!0})}async lockPoll(e){const t=this.getPollDetailSync(e);if(!t||!t.closed)try{vt.default.lockPoll(e)}catch(s){this.Logger.zsymb(18,10716,30001,"[lockPoll] ",e,s)}}async sharePollInGroup(e){try{vt.default.sharePoll(e)}catch(t){this.Logger.zsymb(18,10716,30002,"[sharePollInGroup] ",e,t)}}async votePoll(e){const{newOptions:t,pollId:s,votedOptionIds:i}=e,n=bt.default.getGroupIdFromConversationId(e.groupId);try{t.length>0?await vt.default.addNewOptionPoll(n,s,JSON.stringify(t),i):await vt.default.vote(n,s,i)}catch(r){throw this.Logger.zsymb(18,10716,30003,"[votePoll] ",r,s),r}}})||Sc)||Sc)||Sc)||Sc;var Ac,Pc=s("ILDi");let Nc=Object(Bt.b)(Lc.GroupPollInfoManager)(Ac=Reflect.metadata("design:type",Function)(Ac=Reflect.metadata("design:paramtypes",[])(Ac=class{constructor(){this.updateEmitter=void 0,this.viewedMoreFromMsgIds=void 0,this.updateEmitter=new zr.a,this.viewedMoreFromMsgIds=new Set}getPollParams(e){let t=null;try{var s;t=JSON.parse(null==e||null===(s=e.message)||void 0===s?void 0:s.params)}catch(i){t={}}return t}getLastMessagePoll(e,t,s){let i=t;return s.forEach((s=>{s.msgType!==t.msgType||this.getPollParams(s).pollId!==e||(i=s)})),i}getContinuosPollInfoSection(e,t){const s=[];let i=0;return t.forEach((t=>{var n;t.msgType===L.MSG_POLL&&this.getPollParams(t).pollId===e?(s[i]||(s[i]=[]),s[i].push(t)):null!==(n=s[i])&&void 0!==n&&n[0]&&(i+=1)})),s.filter((e=>e.length>pt.default.groupPoll.max_info_msg_display))}isShowPollCard(e,t,s){const i=this.getLastMessagePoll(e,t,s);return Li.b.isSameMsg(t,i)}getPollInfoShowStatus(e,t,s){const i=this.getContinuosPollInfoSection(e,s);for(const n of i)for(let e=n.length-1;e>=0;e--)if(Li.b.isSameMsg(t,n[e]))return e!==n.length-1?"HIDE":n[e-1]&&this.viewedMoreFromMsgIds.has(n[e-1].msgId)?"SHOW":"SHOW_VIEW_MORE";return"SHOW"}viewMore(e,t,s){let i=[];const n=this.getContinuosPollInfoSection(e,s);for(const r of n)if(r[r.length-1].msgId===t){i=r.map((e=>e.msgId));break}this.updateEmitter.emit("EXPAND_MSG_INFO",{msgIds:i}),this.viewedMoreFromMsgIds.add(t)}clearViewedMoreHistory(e){this.viewedMoreFromMsgIds.delete(e)}})||Ac)||Ac)||Ac;i.ModuleContainer.registerSingleton(wc.a,Rc),i.ModuleContainer.registerSingleton(Pc.a,Nc);var jc,Uc=s("tw7i");let Bc=Object(i.injectable)()(jc=function(e,t){return Object(i.inject)(Uc.d)(e,void 0,0)}(jc=Reflect.metadata("design:type",Function)(jc=Reflect.metadata("design:paramtypes",[Object])(jc=class{constructor(e){this.queue=e}push(e,t){const s={msgId:e,action:t};this.queue.push(s)}})||jc)||jc)||jc)||jc;class kc extends Error{constructor(e){let{message:t,name:s,options:i}=e;super(t),this.code=void 0,this.name=void 0,this.name=s,i&&i.code&&(this.code=i.code),i&&i.stack&&(this.stack=(new Error).stack),Object.setPrototypeOf(this,kc.prototype)}}var Gc=(e,t)=>{const s={code:e.code,stack:t};return new kc({name:e.name,options:s,message:e.message})};const xc={name:"CANNOT_GET_MSG_FROM_DB",code:1,message:"Cannot get message from Message Core database"},zc={name:"QUEUE_TASK_EMPTY",code:2,message:"Action log info queue is empty"},Vc={name:"TASK_IS_RUNNING",code:3,message:"Media action log info queue has task is running"};var $c=s("JJxn"),Wc=s("tmLI"),qc=s("UQla"),Kc=s("n4Tl");var Hc=s("HPXo");class Qc{constructor(){this.msg=void 0,this.subType=void 0,this.entryPoint=void 0,this.convType=void 0,this.mediaStatus=void 0,this.forceStatus=void 0}withMessage(e){return this.msg=e,this}withSubType(e){return this.subType=e,this}withEntryPoint(e){return this.entryPoint=e,this}withStatus(e){return this.mediaStatus=e&&function(e){let t="";return null!=e&&e.isExpired&&(t=qc.s.Expired),null!=e&&e.isExpiredSoon&&(t=qc.s.ExpiredSoon),null!=e&&e.autoDownloadPath&&(t=qc.s.DownloadedAuto),(null!=e&&e.localPath||null!=e&&e.folderPath)&&(t=qc.s.DownloadedManual),t}(e),this}withForceStatus(e){return void 0===e&&(e=""),this.forceStatus=e,this}build(){var e,t,s,i;const n=function(e){const t=Object(Wc.m)(null==e?void 0:e.params)||"";return t?(null==t?void 0:t.fileSize)&&+t.fileSize/1024:-1}(this.msg.message),r=(null===(e=this.msg)||void 0===e?void 0:e.toUid)&&(a=null===(t=this.msg)||void 0===t?void 0:t.toUid,bt.default.isOAType(Je.default.getProfileFriendSync(a))?$c.a.OA:bt.default.getConversationType(a));var a;const o=r===$c.a.GROUP&&function(e){let t;const s=ts.default.getGroupByIdSync(e);return null!=s&&s.topMember&&(null==s?void 0:s.topMember.length)>0&&(t=null==s?void 0:s.topMember.length),t}(this.msg.toUid),d=this.msg.msgType===L.MSG_VIDEO?function(e){let t=e;return t||(t=Kc.a.Success),t}(this.mediaStatus):r===$c.a.CLOUD?function(e,t){let s=e;return e!==qc.q.DownloadedAuto&&e!==qc.q.DownloadedManual&&t<=pt.default.mediaStatus.cloud.limitBigFile&&(s=qc.q.CloudSaved),s}(this.mediaStatus,n):this.mediaStatus,l={msg_type:$c.l[this.msg.msgType],entry_point:this.entryPoint,size:n,sent_time:this.msg.sendDttm,is_e2ee:(h=null===(s=this.msg)||void 0===s?void 0:s.e2eeStatus,h===L.MSG_E2EE?$c.e.YES:$c.e.NO),is_sender:(c=null===(i=this.msg)||void 0===i?void 0:i.fromUid,"0"!=c?$c.f.RECEIVER:$c.f.SENDER),conv_type:$c.j[r],sync_source:$c.k[this.msg.src],msg_id:this.msg.msgId};var c,h;switch(o&&(l.group_size=o),this.subType){case $c.o.MediaExpiredWhenAction:l.original_status=Hc.a.get(this.msg.msgId);break;case $c.o.MediaStatusInView:this.msg.msgType===L.MSG_PHOTO||this.msg.msgType===L.MSG_PHOTO_2||this.msg.msgType===L.MSG_FILE&&null!=this&&this.forceStatus?l.file_status=null==this?void 0:this.forceStatus:l.file_status=d}return l}}var Jc=class{verify(e){return!!Object.values($c.e).includes(e.is_e2ee)&&(!!Object.values($c.f).includes(e.is_sender)&&(!!Object.values($c.f).includes(e.is_sender)&&(!!Object.values($c.j).includes(e.conv_type)&&(!!Object.values($c.k).includes(e.sync_source)&&!!Object.values($c.l).includes(e.msg_type)))))}},Zc=s("a4lh"),Xc=s("o1u6"),Yc=s("lJL2");const eh=[L.MSG_FILE,L.MSG_VIDEO,L.MSG_VOICE];var th;let sh=Object(i.injectable)()(th=function(e,t){return Object(i.inject)(Uc.d)(e,void 0,0)}(th=function(e,t){return Object(i.inject)(H.ZLoggerFactory)(e,void 0,1)}(th=Reflect.metadata("design:type",Function)(th=Reflect.metadata("design:paramtypes",[Object,void 0===H.ZLoggerFactory?Object:H.ZLoggerFactory])(th=class{constructor(e,t){this.queue=e,this.logger=void 0,this.DB=void 0,this.isRunning=void 0,this.logger=t.createZLogger(ns.b.mediaStatus,["action-log-consumer"]),this.DB=K.a.getInstance(),this.isRunning=!1}async run(){if(!(this.queue.length<=0)){if(this.isRunning)return Gc(Vc);this.isRunning=!0,requestAnimationFrame((async()=>{try{const e=this.queue.pop();if(!e)return Gc(zc);const t=e.msgId,s=e.action,i=await this.DB.Core.Message.get(t);let n;if(!i)return Gc(xc);null!=s&&s.forceStatus||(n=eh.includes(i.msgType)&&(Yc.a.get(t)||await Xc.a.status(t,[])));const r=(new Qc).withEntryPoint(s.entryPoint).withSubType(s.subType).withMessage(i).withStatus(n).withForceStatus((null==s?void 0:s.forceStatus)||"").build();(new Jc).verify(r)&&Zc.a.LogActionInfo(s.subType,r)}catch(e){this.logger.zsymb(3,11679,3e4,"error {}",JSON.stringify(e))}finally{this.isRunning=!1,this.run()}}))}}})||th)||th)||th)||th)||th;var ih;let nh=Object(i.injectable)()(ih=function(e,t){return Object(i.inject)(Uc.c)(e,void 0,0)}(ih=function(e,t){return Object(i.inject)(Uc.a)(e,void 0,1)}(ih=Reflect.metadata("design:type",Function)(ih=Reflect.metadata("design:paramtypes",[Object,Object])(ih=class{constructor(e,t){this.producer=e,this.consumer=t}run(e,t){this.producer.push(e,t),this.consumer.run()}})||ih)||ih)||ih)||ih)||ih;i.ModuleContainer.registerSingleton(Uc.d,class{constructor(){this.queue=void 0,this.queue=[]}push(e){this.queue.push(e)}pop(){return this.queue.pop()}get length(){return this.queue.length}}),i.ModuleContainer.registerSingleton(Uc.c,Bc),i.ModuleContainer.registerSingleton(Uc.a,sh),i.ModuleContainer.registerSingleton(Uc.b,nh);var rh=s("imbw"),ah=s("1EWQ");const oh=1,dh=2,lh=3;let ch,hh,uh,gh,mh,ph,fh;var vh;!function(e){e[e.TEXT=0]="TEXT",e[e.STICKER=1]="STICKER",e[e.PHOTO=2]="PHOTO",e[e.LINK=3]="LINK",e[e.FILE=4]="FILE",e[e.GIF=5]="GIF",e[e.CONTACT=6]="CONTACT"}(ch||(ch={})),function(e){e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD"}(hh||(hh={})),function(e){e[e.SINGLE=0]="SINGLE",e[e.GROUP=1]="GROUP"}(uh||(uh={})),function(e){e[e.CONTEXT_MENU=0]="CONTEXT_MENU",e[e.BUBBLE=1]="BUBBLE"}(gh||(gh={})),function(e){e[e.RESEND=1]="RESEND",e[e.DELETE=2]="DELETE"}(mh||(mh={})),function(e){e[e.NO_RESEND=1]="NO_RESEND",e[e.RESEND_SINGLE=2]="RESEND_SINGLE",e[e.RESEND_ALL=3]="RESEND_ALL"}(ph||(ph={})),function(e){e[e.NO_DELETE=1]="NO_DELETE",e[e.DELETE_SINGLE=2]="DELETE_SINGLE",e[e.DELETE_ALL=3]="DELETE_ALL"}(fh||(fh={}));let bh=Object(Bt.b)(rh.a)(vh=Reflect.metadata("design:type",Function)(vh=Reflect.metadata("design:paramtypes",[])(vh=class{constructor(){this.lastNetworkBannerAppearTime=void 0,this.logger=void 0,this.lastNetworkBannerAppearTime=null}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger("auto-retry",["action-log"])),this.logger}logAction999(e){const{type:t,payload:s}=e;let i;switch(t){case"ShowManualRetry":i=oh;break;case"InteractManualRetry":i=dh;break;case"ShowBannerNetwork":i=lh}Ze.e.logActionInfoV2(Ze.b.AutoRetry,i,s)}getChatTypeFromConvId(e){return bt.default.isGroup(e)?hh.CHAT_GROUP:ah.a.isSendToMe(e)?hh.MY_CLOUD:hh.CHAT_11}getRetryMsgType(e){switch(e){case L.MSG_TEXT:return ch.TEXT;case L.MSG_GIF:return ch.GIF;case L.MSG_FILE:case L.MSG_VIDEO:return ch.FILE;case L.MSG_PHOTO:case L.MSG_PHOTO_GROUP:return ch.PHOTO;case L.MSG_CONTACT:return ch.CONTACT;case L.MSG_STICKER:case L.MSG_STICKER_GROUP:case L.MSG_STICKER_2:return ch.STICKER;case L.MSG_LINK_CLIENT:return ch.LINK;default:return}}getMsgCombineType(e){return[L.MSG_PHOTO_GROUP,L.MSG_STICKER_GROUP].includes(e)?uh.GROUP:uh.SINGLE}showManualRetryReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"ShowManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),error_id:e.errorCode,is_groupping:this.getMsgCombineType(e.msgType)}})}networkBannerAppearCapture(){this.lastNetworkBannerAppearTime=Mi.a.getTimeNow()}networkBannerDisappearReport(){const e=Mi.a.getTimeNow();if(null===this.lastNetworkBannerAppearTime)return;const t=e-this.lastNetworkBannerAppearTime;t<=0||(this.logAction999({type:"ShowBannerNetwork",payload:{showed_time:this.lastNetworkBannerAppearTime,off_time:e,duration:t}}),this.lastNetworkBannerAppearTime=null)}resendErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:gh[e.source],is_resend:this.getMsgCombineType(e.msgType)===uh.GROUP?ph.RESEND_ALL:ph.RESEND_SINGLE,is_deleted:fh.NO_DELETE,action_type:mh.RESEND}})}deleteErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:gh[e.source],is_resend:ph.NO_RESEND,is_deleted:this.getMsgCombineType(e.msgType)===uh.GROUP?fh.DELETE_ALL:fh.DELETE_SINGLE,action_type:mh.DELETE}})}})||vh)||vh)||vh;i.ModuleContainer.registerSingleton(rh.a,bh);var yh,Ih=s("Z1oQ"),_h=s("QbTC"),Mh=s("xtzN"),Ch=s("n32m"),Th=s("hKna");let Oh=Object(Bt.b)(Ch.RetryErrorController)(yh=Reflect.metadata("design:type",Function)(yh=Reflect.metadata("design:paramtypes",[])(yh=class{constructor(){this.logger=void 0,this.errNetworkCounterMap=void 0,this.errNetworkCounterMap=new Map}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.autoRetry,["retry-error-controller"])),this.logger}getErrNetworkRetryCount(e){if(!e)return 0;const t=this.errNetworkCounterMap.get(e);if(void 0!==t)return 0===t?(this.errNetworkCounterMap.delete(e),0):t;const s=pt.default.retryConfig.max_err_network_retry_count;return this.errNetworkCounterMap.set(e,s),s}decreaseErrNetworkRetryCount(e){if(!e)return;const t=this.getErrNetworkRetryCount(e);t>0?this.errNetworkCounterMap.set(e,t-1):this.errNetworkCounterMap.delete(e)}deleteErrNetworkRetryCountItem(e){e&&this.errNetworkCounterMap.delete(e)}logRetryError(e,t){this.Logger.zsymb(18,11217,3e4,e,t)}shouldRetry(e,t,s){if(!e||Th.a.includes(e.code))return!1;if(!Th.c.includes(e.code))return!1;const i=Th.d.NO_NETWORK_ERROR_CODE.includes(e.code);if(i&&(!pt.default.retry_err_no_network||In.b.getStateNetwork()!==In.a.CHECKING&&In.b.getStateNetwork()!==In.a.DISCONNECT))return!1;const n=this.getRetryErrorCodeGroupName(e.code);if(n&&this.getRetryErrorCodeMapping()[n].off)return!1;const r=i&&this.getErrNetworkRetryCount(s)>0;if(0===t.count&&!r)return!1;const a=this.getRetryTimeout(t);return!!(a&&Mi.a.getTimeNow()-t.timestamp<a)&&(t.count&&!i&&t.count--,i&&this.decreaseErrNetworkRetryCount(s),!0)}getRetryTimeout(e){let t=0;return pt.default.retryConfig&&pt.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===L.RETRY_MSG_TIMEOUT_DEFAULT?t=pt.default.retryConfig.time_retry_default:e.timeout===L.RETRY_MSG_TIMEOUT_LONG&&(t=pt.default.retryConfig.time_retry_long)),t}getRetryErrorCodeGroupName(e){return Object.keys(Th.d).find((t=>Th.d[t].includes(e)))}getNoRetryErrorCodeGroupName(e){return Object.keys(Th.b).find((t=>Th.b[t].includes(e)))}getRetryErrorCodeMapping(){return pt.default.retryConfig.retry_strategy&&"object"==typeof pt.default.retryConfig.retry_strategy?Object.keys(pt.default.retryConfig.retry_strategy).reduce(((e,t)=>(e[t.toUpperCase()]=pt.default.retryConfig.retry_strategy[t],e)),{}):Th.e}})||yh)||yh)||yh;var Eh,Sh=s("yoj5");let wh=Object(Bt.b)(_h.a)(Eh=Reflect.metadata("design:type",Function)(Eh=Reflect.metadata("design:paramtypes",[])(Eh=class{constructor(){this.logger=void 0,this.waitingSocketOpenQueue=void 0,this.retryCountMapping=void 0,this.isDoneOffline=void 0,this.handleWaitingConnectionRetry=()=>{const e=[...this.waitingSocketOpenQueue];this.waitingSocketOpenQueue=[];for(const t of e){const e=Sh.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.unlockProcessOffline=()=>{this.isDoneOffline=!0,Ws.default.getSocketState()===Th.g.OPEN&&this.handleWaitingConnectionRetry()},this.waitingSocketOpenQueue=[],this.retryCountMapping=new Map,this.isDoneOffline=!1,It.default.subscribe(((e,t)=>{if(e===_t.WebsocketActions.CONNECTION_STATE_CHANGE){const{state:e,prevState:s}=t;void 0!==s&&e===Th.g.OPEN&&this.isDoneOffline&&this.handleWaitingConnectionRetry()}})),Ws.default.subcribe(Ws.CallbackID.ON_DONE_OFFLINE,this.unlockProcessOffline)}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger("auto-retry-socket",["retry-error-controller"])),this.logger}getRetryTimeout(e){let t=0;return pt.default.retryConfig&&pt.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===L.RETRY_MSG_TIMEOUT_DEFAULT?t=pt.default.retryConfig.time_retry_default:e.timeout===L.RETRY_MSG_TIMEOUT_LONG&&(t=pt.default.retryConfig.time_retry_long)),t}getErrorCode(e){let t=e.code;return e.code===Th.f.ERR_CONNECTION_TIMED_OUT&&In.b.getStateNetwork()!==In.a.CONNECTED&&(t=Th.f.ERR_NO_NETWORK),t}shouldRetry(e,t,s){if(!e||!t||!s||s.count<=0)return!1;let i=this.getErrorCode(e);if(i===Th.f.ERR_CONNECTION_TIMED_OUT||i===Th.f.ERR_SOCKET_CLOSED||i===Th.f.ERR_NO_NETWORK){var n;const e=null!==(n=this.retryCountMapping.get(t))&&void 0!==n?n:0;let r=pt.default.retryConfig.max_retry_count;if(i===Th.f.ERR_SOCKET_CLOSED&&(r=pt.default.retryConfig.max_err_network_retry_count),void 0!==e&&e<r){const e=this.getRetryTimeout(s);return!!(e&&Mi.a.getTimeNow()-s.timestamp<e)&&(s.count&&s.count--,!0)}return!1}return!1}pushToRetryQueue(e,t,s){const n=i.ModuleContainer.resolve(Ih.a).getRetryErrorCodeMapping();this.logRetryError(e.code,s);const r=this.getErrorCode(e);if(r!==Th.f.ERR_CONNECTION_TIMED_OUT){var a;if(r===Th.f.ERR_SOCKET_CLOSED||r===Th.f.ERR_NO_NETWORK)return this.retryCountMapping.set(s,null!==(a=this.retryCountMapping.get(s))&&void 0!==a?a:1),void this.waitingSocketOpenQueue.push(t)}else{var o,d;const e=(null!==(o=this.retryCountMapping.get(s))&&void 0!==o?o:0)+1,i=(null!==(d=n.CONNECTION_TIMED_OUT_ERROR_CODE.delay)&&void 0!==d?d:3e4)*e+Sh.getGapTime();setTimeout((()=>{this.retryCountMapping.set(s,e),t()}),i)}}logRetryError(e,t){this.Logger.zsymb(18,11216,3e4,e,t)}cleanUpItemQueue(e){this.retryCountMapping.delete(e)}})||Eh)||Eh)||Eh;i.ModuleContainer.registerSingleton(Ih.a,Oh),i.ModuleContainer.registerSingleton(_h.a,wh),i.ModuleContainer.registerSingleton(Mh.a,class{constructor(){this.waitingNetworkQueue=void 0,this.waitingCheckStatusQueue=void 0,this.waitingTimeout=void 0,this.onConnectionBack=()=>{const e=[...this.waitingNetworkQueue];this.waitingNetworkQueue=[];for(const t of e){const e=Sh.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.clearWaitingStatusTimeout=()=>{null!==this.waitingTimeout&&(window.clearTimeout(this.waitingTimeout),this.waitingTimeout=null)},this.moveWaitingCheckStatusToWaitingConnection=()=>{this.clearWaitingStatusTimeout(),this.waitingNetworkQueue.push(...this.waitingCheckStatusQueue),this.waitingCheckStatusQueue=[]},this.processWaitingCheckStatus=()=>{this.clearWaitingStatusTimeout();const e=[...this.waitingCheckStatusQueue];this.waitingCheckStatusQueue=[];for(const t of e){const e=Sh.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.waitingNetworkQueue=[],this.waitingCheckStatusQueue=[],this.waitingTimeout=null,Qt.p.listenEvent(Qt.j,(e=>{e===In.a.CONNECTED?(this.processWaitingCheckStatus(),this.onConnectionBack()):e===In.a.DISCONNECT&&this.moveWaitingCheckStatusToWaitingConnection()}))}pushToRetryQueue(e){In.b.getStateNetwork()===In.a.CONNECTED?(this.waitingCheckStatusQueue.push(e),null===this.waitingTimeout&&(this.waitingTimeout=window.setTimeout((()=>{this.waitingTimeout=null,this.processWaitingCheckStatus()}),pt.default.retryConfig.max_waiting_check_status_time))):this.waitingNetworkQueue.push(e)}});var Lh=s("dhS6"),Dh=s("WzIS"),Fh=s("sLvT");let Rh;!function(e){e[e.ONE=0]="ONE",e[e.MULTI=1]="MULTI"}(Rh||(Rh={}));const Ah=e=>new Promise(((t,s)=>{setTimeout((()=>{t(e||3e3)}),e||3e3)}));var Ph;let Nh=Object(Bt.b)(Lh.a)(Ph=Reflect.metadata("design:type",Function)(Ph=Reflect.metadata("design:paramtypes",[])(Ph=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger(ns.b.uiBannerController,[ns.b.uiBannerQueue])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.queue=void 0,this.uiState=new Map,this.isFirtTriggerShowOnQueueCycle=void 0,this._Logger=void 0,this.name=Lh.b,this.key="convId",this.queue=[],this.isFirtTriggerShowOnQueueCycle=!0}enBannerQueue(e,t){const s=this.queryBannerQueueItem(e.key);switch(s&&this.removeBannerQueueItem(s.key),t){case Dh.a.NORMAL:this.queue.push(e);break;case Dh.a.HIGH:this.queue.unshift(e)}}isEmptySyncSourceQueue(){return 0===this.queue.length}deBannerQueue(){return this.queue.shift()}removeBannerQueueItem(e){this.queue=[...this.queue].filter((t=>t.key!==e))}queryBannerQueueItem(e){return this.queue.find((t=>t.key===e))}handleShowUIBanner(e,t){Fh.a.isEnableSingleUIBanner()?this.showSingleUI(e,t):this.showMultiUI(e,t)}isExistingShow(){try{const e=Object.fromEntries(this.uiState);for(const t in e)if(e[t])return t;return null}catch(e){return null}}async showSingleUI(e,t){let s;this.enBannerQueue({key:e,priority:t},t);const i=this.isExistingShow();if(i&&(s=this.queryBannerQueueItem(i)),Fh.a.isEnableForceCloseNormalBanner()&&i&&t===Dh.a.HIGH&&s)return this.removeBannerQueueItem(s.key),this.uiState.set(s.key,!1),Object(st.g)(this.name,s.key),this.uiState.set(e,!0),void Object(st.g)(this.name,e);!i&&this.isFirtTriggerShowOnQueueCycle&&(this.uiState.set(e,!0),Object(st.g)(this.name,e),this.Logger.zsymb(0,10714,3e4,"[showSingleUI] Dont have displaying banner so show: "+e+", current queue = "+JSON.stringify(this.queue)))}showMultiUI(e,t){this.enBannerQueue({key:e,priority:t},t),this.uiState.set(e,!0),Object(st.g)(this.name,e)}handleHideUIBanner(e){Fh.a.isEnableSingleUIBanner()?this.hideSingleUI(e):this.hideMultiUI(e)}hideSingleUI(e){if(this.removeBannerQueueItem(e),this.uiState.get(e)){this.uiState.set(e,!1),Object(st.g)(this.name,e);Boolean(this.queue[0])?setTimeout((()=>{const e=this.queue[0];e&&!this.isExistingShow()?(this.uiState.set(e.key,!0),Object(st.g)(this.name,e.key),this.Logger.zsymb(0,10714,30001,"[hideSingleUI] Pop next banner to show: "+e.key+", current queue = "+JSON.stringify(this.queue))):this.isFirtTriggerShowOnQueueCycle=!0}),Fh.a.getTimeDelayOnNextBanner()):this.isFirtTriggerShowOnQueueCycle=!0}}hideMultiUI(e){this.removeBannerQueueItem(e),this.uiState.set(e,!1),Object(st.g)(this.name,e)}async onShowBanner(e,t,s){s&&await Ah(s);const i=Fh.a.getTimeDelayOnStartApp();this.isFirtTriggerShowOnQueueCycle&&i?(await Ah(i),this.handleShowUIBanner(e,t)):this.handleShowUIBanner(e,t),this.isFirtTriggerShowOnQueueCycle=!1}async onHideBanner(e,t){t&&await Ah(t),this.handleHideUIBanner(e)}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.uiState.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||Ph)||Ph)||Ph;i.ModuleContainer.registerSingleton(Lh.a,Nh);var jh=s("+eUS");const Uh="render"!==__ZaBUNDLENAME__&&"WEB"!==__ZaBUNDLENAME__&&"shared-worker"!==__ZaBUNDLENAME__&&"main"!==__ZaBUNDLENAME__;setTimeout((async function(){if(Uh)return;const e=i.ModuleContainer.resolve(H.ZLoggerFactory).createZLogger("bootstrap",["shared"]);e.zsymb(3,8152,3e4,"running application bootstrap");try{const t=i.ModuleContainer.resolve(V.a);await t.start();let s=(()=>{switch(__ZaBUNDLENAME__){case"WEB":return ul.RunMode.Browser;case"render":return ul.RunMode.Host;case"shared-worker":return ul.RunMode.Client;case"main":return ul.RunMode.Background;default:return ul.RunMode.Unknown}})();Object(jh.a)(s),s===ul.RunMode.Browser&&function(){const e=Object(E.a)();O.a.includes(e)||i.ModuleContainer.resolve(pe).setupWriters()}(),"shared-worker"===__ZaBUNDLENAME__&&await t.init(),e.zsymb(3,8152,30001,"application bootstrap success")}catch(t){e.zsymb(0,8152,30002,(()=>["application bootstrap fail",{reason:t}]))}}),0);s("Lp8g")},rhBN:function(e,t,s){"use strict";var i,n=s("jDHv"),r=s("UK4g"),a=s("YEoC"),o=s("DI/x"),d=s("tHMN"),l=s("LzQZ");let c=n.ModuleContainer.injectable()(i=function(e,t){return n.ModuleContainer.inject(d.b)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===d.b?Object:d.b])(i=class{constructor(e){this.engine=e,this.currentId=1,this.transactions=void 0,this.transactions=new Map}get(e){const t=this.transactions.get(e);if(!t)throw new o.h("The transaction has already committed!");return t}async beginTransaction(e,t,s){const i=this.currentId++,n=new Error,o=await this.engine.do({type:a.d.BeginTransaction,database:e,table:t[0],transaction:i,priority:a.c.BLOCKING,retry:r.i,timing:{},meta:{step:-1,timeout:r.k,error:n},params:{tables:t,mode:s},trace:()=>{}});return this.transactions.set(i,o),o}commitTransaction(e){const t=this.transactions.get(e);return!t||t.closed?(t&&this.transactions.delete(e),Promise.resolve()):new Promise(((s,i)=>{t.onClose((()=>{this.transactions.delete(e),t.error?i(t.error):s()}))}))}})||i)||i)||i)||i;n.ModuleContainer.registerSingleton(l.a,c)},zpw2:function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return h}));var i=s("jDHv"),n=s("Uzj0"),r=s("wH4e"),a=s("SGbk"),o=s("d951"),d=s("TTNl"),l=s("JMlY"),c=s("ipeT");class h{constructor(e,t,s){this.databaseName=e,this.databaseSchema=t,this.numOfActiveQueries=0,this.pendingQueries=[],this.pending=!1,this.idleListeners=[],this._engine=null;const i=n.c.map(t,((t,i)=>new c.a(e,i,r.NO_TRANSACTION_ID,this.doQuery.bind(this),s)));Object.entries(i).forEach((e=>{let[t,s]=e;Object.defineProperty(this,t,{value:s,writable:!1})})),Object.defineProperty(this,"runTransaction",{value:this.runTransaction.bind(this,this.databaseName,this.databaseSchema)}),this.closeThisDatabase=Object(a.a)(this.closeThisDatabase.bind(this)),this.deleteThisDatabase=Object(a.a)(this.deleteThisDatabase.bind(this))}get engine(){return this._engine||(this._engine=i.ModuleContainer.resolve(d.a)),this._engine}get isIdle(){return 0===this.numOfActiveQueries}dispatchIdleEvent(){this.idleListeners.forEach((e=>e())),this.idleListeners=[]}addIdleListenerOnce(e){this.isIdle?e():this.idleListeners.push(e)}stop(){this.pending=!0}resume(){this.pendingQueries.forEach((e=>{e.execute()})),this.pendingQueries=[],this.pending=!1}waitUntilIdle(){return new Promise((e=>{this.addIdleListenerOnce((()=>e()))}))}trapIdleTracking(e){return this.numOfActiveQueries+=1,e.finally((()=>{this.numOfActiveQueries-=1,this.isIdle&&this.dispatchIdleEvent()}))}doQuery(e){const t=()=>this.trapIdleTracking(this.engine.do(e));if(this.pending){const e=()=>t(),s=new o.a(e);return this.pendingQueries.push(s),s.getResult()}return t()}async closeThisDatabase(){this.stop(),await this.waitUntilIdle();const e=i.ModuleContainer.resolve(d.a);await e.closeDatabase(this.databaseName),this.resume()}async deleteThisDatabase(){this.stop(),await this.waitUntilIdle();const e=i.ModuleContainer.resolve(d.a);await e.deleteDatabase(this.databaseName),this.resume()}runTransaction(t,s,n,a,o){void 0===o&&(o=r.TransactionMode.READWRITE);const d=i.ModuleContainer.resolve(l.a),h=this.doQuery.bind(this);return new Promise(((i,l)=>{try{!async function(i,l){const u=n.map((e=>"string"==typeof e?e:e.name)),g=await d.beginTransaction(t,u,o),m=u.map((e=>{if(!s[e])throw new r.MissingTableConfigError(e);const i=s[e];return new c.a(t,i,g.id,h)}));await a(m),e((()=>{d.commitTransaction(g.id).then(i).catch(l)}))}(i,l)}catch(u){l(u)}}))}}}).call(this,s("NWH6").setImmediate)}}]);
//# sourceMappingURL=../sourcemaps/lazy/web-startup.a140716b3807b0d47db7.js.map